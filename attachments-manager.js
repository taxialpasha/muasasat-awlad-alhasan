
/**
 * ูุธุงู ุฅุฏุงุฑุฉ ุงููุฑููุงุช ูุงููุซุงุฆู ุงููุชูุงูู
 * ููู ูููุตู ูุฅุฏุงุฑุฉ ุฌููุน ุงููุฑููุงุช ูุงููุซุงุฆู ูู ุงููุธุงู
 * ูุฏุนู ุงูุตูุฑุ PDFุ Wordุ Excel ูุน ูุนุงููุฉ ูุญูุงูุฉ ูุถุบุท
 * 
 * ุงูุงุณุชุฎุฏุงู: ูู ุจุชุถููู ูุฐุง ุงูููู ูู HTML ุงูุฎุงุต ุจู
 * <script src="attachments-manager.js"></script>
 */

// ==============================
// ุฅุนุฏุงุฏุงุช ูุธุงู ุงููุฑููุงุช ุงูุงูุชุฑุงุถูุฉ
// ==============================
const DEFAULT_ATTACHMENT_SETTINGS = {
    // ุฅุนุฏุงุฏุงุช ุงูุฑูุน
    maxFileSize: 10 * 1024 * 1024, // 10 MB
    maxFilesPerCase: 20, // ุญุฏ ุฃูุตู 20 ููู ููู ุญุงูุฉ
    allowedFileTypes: [
        'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',
        'application/pdf',
        'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'text/plain', 'text/csv'
    ],
    
    // ุฅุนุฏุงุฏุงุช ุงูุถุบุท
    compressImages: true,
    imageQuality: 0.8, // ุฌูุฏุฉ ุงูุถุบุท (0.1 - 1.0)
    maxImageWidth: 1920,
    maxImageHeight: 1080,
    
    // ุฅุนุฏุงุฏุงุช ุงูุฃูุงู
    enableEncryption: false, // ุชุดููุฑ ุงููููุงุช ุงูุญุณุงุณุฉ
    passwordProtection: false, // ุญูุงูุฉ ุจูููุฉ ูุฑูุฑ
    virusScan: false, // ูุญุต ุงูููุฑูุณุงุช (ูุญุงูุงุฉ)
    
    // ุฅุนุฏุงุฏุงุช ุงูุนุฑุถ
    showThumbnails: true, // ูุนุงููุฉ ูุตุบุฑุฉ
    gridView: true, // ุนุฑุถ ุดุจูู
    sortBy: 'date', // ุชุฑุชูุจ ุญุณุจ (date, name, size, type)
    sortOrder: 'desc', // ุชุฑุชูุจ (asc, desc)
    
    // ุฅุนุฏุงุฏุงุช ุงูุชุฎุฒูู
    useLocalStorage: true, // ุชุฎุฒูู ูุญูู
    autoBackup: true, // ูุณุฎ ุงุญุชูุงุทู ุชููุงุฆู
    backupInterval: 24 * 60 * 60 * 1000, // ูู 24 ุณุงุนุฉ
    
    // ุฅุนุฏุงุฏุงุช ุงููุงุฌูุฉ
    showAttachmentButton: true, // ุฒุฑ ุงููุฑููุงุช
    buttonPosition: 'top', // ูููุน ุงูุฒุฑ (top, bottom, floating)
    compactMode: false, // ูุถุน ูุถุบูุท
    darkMode: false // ุงููุถุน ุงููุธูู
};

// ==============================
// ูุชุบูุฑุงุช ุงููุธุงู
// ==============================
let currentAttachmentSettings = { ...DEFAULT_ATTACHMENT_SETTINGS };
let attachmentsData = new Map(); // ุฎุฑูุทุฉ ุงููุฑููุงุช ุญุณุจ ุงูุญุงูุฉ
let attachmentButtons = new Map(); // ุฃุฒุฑุงุฑ ุงููุฑููุงุช
let attachmentManager = null; // ูุฏูุฑ ุงููุฑููุงุช ุงูุฑุฆูุณู
let currentCaseId = null; // ID ุงูุญุงูุฉ ุงูุญุงููุฉ
let attachmentViewer = null; // ุนุงุฑุถ ุงููุฑููุงุช

// ูุงุนุฏุฉ ุจูุงูุงุช ุงููุฑููุงุช
let attachmentDatabase = {
    files: new Map(), // ุงููููุงุช ุงููุนููุฉ
    metadata: new Map(), // ุจูุงูุงุช ุงููููุงุช
    folders: new Map(), // ุงููุฌูุฏุงุช
    thumbnails: new Map(), // ุงููุนุงููุงุช ุงููุตุบุฑุฉ
    index: new Map() // ููุฑุณ ููุจุญุซ ุงูุณุฑูุน
};

// ุฃููุงุน ุงููููุงุช ุงููุฏุนููุฉ
const FILE_TYPES = {
    images: {
        extensions: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'],
        icon: '๐ผ๏ธ',
        color: '#e74c3c',
        category: 'ุตูุฑ'
    },
    documents: {
        extensions: ['pdf'],
        icon: '๐',
        color: '#e74c3c',
        category: 'ูุณุชูุฏุงุช'
    },
    word: {
        extensions: ['doc', 'docx'],
        icon: '๐',
        color: '#2980b9',
        category: 'ููุฑุฏ'
    },
    excel: {
        extensions: ['xls', 'xlsx', 'csv'],
        icon: '๐',
        color: '#27ae60',
        category: 'ุงูุณู'
    },
    text: {
        extensions: ['txt'],
        icon: '๐',
        color: '#95a5a6',
        category: 'ูุต'
    },
    other: {
        extensions: ['*'],
        icon: '๐',
        color: '#95a5a6',
        category: 'ุฃุฎุฑู'
    }
};

// ==============================
// ุชููุฆุฉ ูุธุงู ุงููุฑููุงุช
// ==============================
function initializeAttachmentSystem() {
    try {
        console.log('๐ ุจุฏุก ุชููุฆุฉ ูุธุงู ุงููุฑููุงุช...');
        
        // ุชุญููู ุงูุฅุนุฏุงุฏุงุช ุงููุญููุธุฉ
        loadAttachmentSettings();
        
        // ุชุญููู ูุงุนุฏุฉ ุจูุงูุงุช ุงููุฑููุงุช
        loadAttachmentDatabase();
        
        // ุฅูุดุงุก ูุฏูุฑ ุงููุฑููุงุช
        createAttachmentManager();
        
        // ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงููุฑููุงุช
        addAttachmentButtons();
        
        // ุฅุนุฏุงุฏ ูุนุงูุฌุงุช ุงูุณุญุจ ูุงูุฅููุงุช
        setupDragAndDrop();
        
        // ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ
        setupAttachmentEventListeners();
        
        // ุจุฏุก ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู
        startAutoBackup();
        
        console.log('โ ุชู ุชููุฆุฉ ูุธุงู ุงููุฑููุงุช ุจูุฌุงุญ');
        showAttachmentToast('๐ ูุธุงู ุฅุฏุงุฑุฉ ุงููุฑููุงุช ุฌุงูุฒ ููุงุณุชุฎุฏุงู', 'success');
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชููุฆุฉ ูุธุงู ุงููุฑููุงุช:', error);
        showAttachmentToast('ูุดู ูู ุชููุฆุฉ ูุธุงู ุงููุฑููุงุช', 'error');
    }
}

// ==============================
// ุฅูุดุงุก ูุฏูุฑ ุงููุฑููุงุช ุงูุฑุฆูุณู
// ==============================
function createAttachmentManager() {
    const manager = document.createElement('div');
    manager.id = 'attachment-manager';
    manager.innerHTML = `
        <div class="attachment-overlay">
            <div class="attachment-container">
                <div class="attachment-header">
                    <div class="attachment-title">
                        <h3>๐ ุฅุฏุงุฑุฉ ุงููุฑููุงุช ูุงููุซุงุฆู</h3>
                        <span class="case-info" id="current-case-info">ูู ูุชู ุชุญุฏูุฏ ุญุงูุฉ</span>
                    </div>
                    <div class="attachment-actions">
                        <button class="attachment-btn upload-btn" onclick="triggerFileUpload()">
                            <i class="fas fa-upload"></i> ุฑูุน ูููุงุช
                        </button>
                        <button class="attachment-btn folder-btn" onclick="createNewFolder()">
                            <i class="fas fa-folder-plus"></i> ูุฌูุฏ ุฌุฏูุฏ
                        </button>
                        <button class="attachment-btn settings-btn" onclick="showAttachmentSettings()">
                            <i class="fas fa-cog"></i> ุงูุฅุนุฏุงุฏุงุช
                        </button>
                        <button class="attachment-btn close-btn" onclick="closeAttachmentManager()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="attachment-toolbar">
                    <div class="attachment-search">
                        <input type="text" id="attachment-search" placeholder="ุงูุจุญุซ ูู ุงููุฑููุงุช..." onkeyup="searchAttachments()">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="attachment-filters">
                        <select id="attachment-filter-type" onchange="filterAttachments()">
                            <option value="all">ุฌููุน ุงูุฃููุงุน</option>
                            <option value="images">ุงูุตูุฑ</option>
                            <option value="documents">ุงููุณุชูุฏุงุช</option>
                            <option value="word">ููุฑุฏ</option>
                            <option value="excel">ุงูุณู</option>
                        </select>
                        <select id="attachment-sort" onchange="sortAttachments()">
                            <option value="date-desc">ุงูุฃุญุฏุซ ุฃููุงู</option>
                            <option value="date-asc">ุงูุฃูุฏู ุฃููุงู</option>
                            <option value="name-asc">ุงูุงุณู ุฃ-ู</option>
                            <option value="name-desc">ุงูุงุณู ู-ุฃ</option>
                            <option value="size-desc">ุงูุฃูุจุฑ ุญุฌูุงู</option>
                            <option value="size-asc">ุงูุฃุตุบุฑ ุญุฌูุงู</option>
                        </select>
                    </div>
                    <div class="attachment-view-controls">
                        <button class="view-btn ${currentAttachmentSettings.gridView ? 'active' : ''}" onclick="toggleViewMode('grid')" title="ุนุฑุถ ุดุจูู">
                            <i class="fas fa-th"></i>
                        </button>
                        <button class="view-btn ${!currentAttachmentSettings.gridView ? 'active' : ''}" onclick="toggleViewMode('list')" title="ุนุฑุถ ูุงุฆูุฉ">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
                
                <div class="attachment-content">
                    <div class="attachment-dropzone" id="attachment-dropzone">
                        <div class="dropzone-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>ุงุณุญุจ ูุฃููุช ุงููููุงุช ููุง</h4>
                            <p>ุฃู <button class="upload-link" onclick="triggerFileUpload()">ุงุฎุชุฑ ุงููููุงุช</button></p>
                            <div class="upload-info">
                                <small>ุงูุญุฏ ุงูุฃูุตู: ${formatFileSize(currentAttachmentSettings.maxFileSize)} ููู ููู</small>
                                <small>ุงูุฃููุงุน ุงููุฏุนููุฉ: ุงูุตูุฑุ PDFุ Wordุ Excel</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="attachment-list" id="attachment-list">
                        <!-- ุงููุฑููุงุช ุณุชุธูุฑ ููุง -->
                    </div>
                </div>
                
                <div class="attachment-footer">
                    <div class="attachment-stats">
                        <span id="attachment-count">0 ูููุงุช</span>
                        <span id="attachment-size">0 ุจุงูุช</span>
                        <span id="attachment-folders">0 ูุฌูุฏุงุช</span>
                    </div>
                    <div class="attachment-bulk-actions">
                        <button class="attachment-btn" onclick="selectAllAttachments()">
                            <i class="fas fa-check-square"></i> ุชุญุฏูุฏ ุงููู
                        </button>
                        <button class="attachment-btn" onclick="deleteSelectedAttachments()">
                            <i class="fas fa-trash"></i> ุญุฐู ุงููุญุฏุฏ
                        </button>
                        <button class="attachment-btn" onclick="downloadSelectedAttachments()">
                            <i class="fas fa-download"></i> ุชุญููู ุงููุญุฏุฏ
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ุญูู ุฑูุน ุงููููุงุช ุงููุฎูู -->
        <input type="file" id="attachment-file-input" multiple accept="${getAcceptedFileTypes()}" style="display: none;">
    `;
    
    // ุฅุถุงูุฉ ุงูุฃููุงุท
    addAttachmentStyles();
    
    document.body.appendChild(manager);
    attachmentManager = manager;
    
    // ุฅุนุฏุงุฏ ูุนุงูุฌ ุฑูุน ุงููููุงุช
    setupFileUploadHandler();
}

// ==============================
// ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงููุฑููุงุช
// ==============================
function addAttachmentButtons() {
    if (!currentAttachmentSettings.showAttachmentButton) return;
    
    // ุงูุจุญุซ ุนู ููุงุทู ุงูููุงุฐุฌ ูุงูุญุงูุงุช
    const formSections = document.querySelectorAll('.form-container, .content-header, .case-container');
    
    formSections.forEach(section => {
        if (!section.querySelector('.attachment-button')) {
            addAttachmentButtonToSection(section);
        }
    });
    
    // ูุฑุงูุจุฉ ุฅุถุงูุฉ ุฃูุณุงู ุฌุฏูุฏุฉ
    observeNewSections();
}

function addAttachmentButtonToSection(section) {
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'attachment-button';
    button.innerHTML = `
        <i class="fas fa-paperclip"></i>
        <span>ุงููุฑููุงุช</span>
        <span class="attachment-count-badge" id="attachment-badge-${generateSectionId(section)}">0</span>
    `;
    
    button.onclick = () => {
        const caseId = extractCaseId(section);
        openAttachmentManager(caseId);
    };
    
    // ุฅุถุงูุฉ ุงูุฒุฑ ุญุณุจ ุงููููุน ุงููุญุฏุฏ
    if (currentAttachmentSettings.buttonPosition === 'top') {
        section.insertBefore(button, section.firstChild);
    } else if (currentAttachmentSettings.buttonPosition === 'bottom') {
        section.appendChild(button);
    } else if (currentAttachmentSettings.buttonPosition === 'floating') {
        button.classList.add('floating-attachment-btn');
        document.body.appendChild(button);
    }
    
    attachmentButtons.set(section, button);
}

// ==============================
// ุฅุนุฏุงุฏ ุงูุณุญุจ ูุงูุฅููุงุช
// ==============================
function setupDragAndDrop() {
    const dropzone = document.getElementById('attachment-dropzone');
    if (!dropzone) return;
    
    // ููุน ุงูุณููู ุงูุงูุชุฑุงุถู ูููุชุตูุญ
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // ุฅุถุงูุฉ ุชุฃุซูุฑุงุช ุจุตุฑูุฉ
    ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, unhighlight, false);
    });
    
    // ูุนุงูุฌุฉ ุงูุฅููุงุช
    dropzone.addEventListener('drop', handleDrop, false);
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight(e) {
    const dropzone = document.getElementById('attachment-dropzone');
    dropzone.classList.add('drag-over');
}

function unhighlight(e) {
    const dropzone = document.getElementById('attachment-dropzone');
    dropzone.classList.remove('drag-over');
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    handleFileUpload([...files]);
}

// ==============================
// ูุนุงูุฌุฉ ุฑูุน ุงููููุงุช
// ==============================
function setupFileUploadHandler() {
    const fileInput = document.getElementById('attachment-file-input');
    if (!fileInput) return;
    
    fileInput.addEventListener('change', function(e) {
        const files = [...e.target.files];
        handleFileUpload(files);
        
        // ุฅุนุงุฏุฉ ุชุนููู ุงููููุฉ ููุณูุงุญ ุจุฑูุน ููุณ ุงูููู ูุฑุฉ ุฃุฎุฑู
        this.value = '';
    });
}

function triggerFileUpload() {
    const fileInput = document.getElementById('attachment-file-input');
    if (fileInput) {
        fileInput.click();
    }
}

async function handleFileUpload(files) {
    if (!files || files.length === 0) return;
    
    if (!currentCaseId) {
        showAttachmentToast('ูุฑุฌู ุชุญุฏูุฏ ุญุงูุฉ ุฃููุงู', 'warning');
        return;
    }
    
    // ุฅุธูุงุฑ ุดุฑูุท ุงูุชูุฏู
    showUploadProgress();
    
    let uploadedCount = 0;
    let failedCount = 0;
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        try {
            // ุงูุชุญูู ูู ุตุญุฉ ุงูููู
            if (!validateFile(file)) {
                failedCount++;
                continue;
            }
            
            // ูุนุงูุฌุฉ ุงูููู
            const processedFile = await processFile(file);
            
            // ุญูุธ ุงูููู
            await saveFile(processedFile, currentCaseId);
            
            uploadedCount++;
            updateUploadProgress(((i + 1) / files.length) * 100);
            
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุฑูุน ุงูููู:', file.name, error);
            failedCount++;
        }
    }
    
    // ุฅุฎูุงุก ุดุฑูุท ุงูุชูุฏู
    hideUploadProgress();
    
    // ุฅุธูุงุฑ ุงููุชุงุฆุฌ
    if (uploadedCount > 0) {
        showAttachmentToast(`ุชู ุฑูุน ${uploadedCount} ููู ุจูุฌุงุญ`, 'success');
        refreshAttachmentList();
        updateAttachmentStats();
    }
    
    if (failedCount > 0) {
        showAttachmentToast(`ูุดู ูู ุฑูุน ${failedCount} ููู`, 'error');
    }
}

// ==============================
// ุงูุชุญูู ูู ุตุญุฉ ุงููููุงุช
// ==============================
function validateFile(file) {
    // ุงูุชุญูู ูู ุงูุญุฌู
    if (file.size > currentAttachmentSettings.maxFileSize) {
        showAttachmentToast(`ุงูููู "${file.name}" ูุจูุฑ ุฌุฏุงู (${formatFileSize(file.size)})`, 'error');
        return false;
    }
    
    // ุงูุชุญูู ูู ุงูููุน
    if (!currentAttachmentSettings.allowedFileTypes.includes(file.type)) {
        showAttachmentToast(`ููุน ุงูููู "${file.name}" ุบูุฑ ูุฏุนูู`, 'error');
        return false;
    }
    
    // ุงูุชุญูู ูู ุนุฏุฏ ุงููููุงุช
    const currentFiles = attachmentsData.get(currentCaseId) || [];
    if (currentFiles.length >= currentAttachmentSettings.maxFilesPerCase) {
        showAttachmentToast(`ุชู ุงููุตูู ููุญุฏ ุงูุฃูุตู ูู ุงููููุงุช (${currentAttachmentSettings.maxFilesPerCase})`, 'error');
        return false;
    }
    
    return true;
}

// ==============================
// ูุนุงูุฌุฉ ุงููููุงุช
// ==============================
async function processFile(file) {
    let processedFile = {
        id: generateFileId(),
        originalFile: file,
        name: file.name,
        size: file.size,
        type: file.type,
        lastModified: file.lastModified,
        uploadDate: new Date().toISOString(),
        category: getFileCategory(file.type),
        tags: [],
        description: '',
        isProtected: false,
        isCompressed: false
    };
    
    // ูุนุงูุฌุฉ ุงูุตูุฑ
    if (processedFile.category === 'images') {
        processedFile = await processImage(processedFile);
    }
    
    // ุฅูุดุงุก ูุนุงููุฉ ูุตุบุฑุฉ
    processedFile.thumbnail = await generateThumbnail(processedFile);
    
    // ุชุญููู ุงูููู ุฅูู Base64 ููุชุฎุฒูู
    processedFile.data = await fileToBase64(processedFile.originalFile);
    
    // ุฅุฒุงูุฉ ุงูููู ุงูุฃุตูู ูุชูููุฑ ุงูุฐุงูุฑุฉ
    delete processedFile.originalFile;
    
    return processedFile;
}

async function processImage(fileObj) {
    if (!currentAttachmentSettings.compressImages) {
        return fileObj;
    }
    
    try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        return new Promise((resolve) => {
            img.onload = function() {
                // ุญุณุงุจ ุงูุฃุจุนุงุฏ ุงูุฌุฏูุฏุฉ
                let { width, height } = calculateNewDimensions(
                    img.width, 
                    img.height, 
                    currentAttachmentSettings.maxImageWidth, 
                    currentAttachmentSettings.maxImageHeight
                );
                
                canvas.width = width;
                canvas.height = height;
                
                // ุฑุณู ุงูุตูุฑุฉ ุงููุถุบูุทุฉ
                ctx.drawImage(img, 0, 0, width, height);
                
                // ุชุญููู ุฅูู Blob
                canvas.toBlob((blob) => {
                    fileObj.data = blob;
                    fileObj.size = blob.size;
                    fileObj.isCompressed = true;
                    fileObj.compressedWidth = width;
                    fileObj.compressedHeight = height;
                    fileObj.originalWidth = img.width;
                    fileObj.originalHeight = img.height;
                    
                    resolve(fileObj);
                }, fileObj.type, currentAttachmentSettings.imageQuality);
            };
            
            img.src = URL.createObjectURL(fileObj.originalFile);
        });
        
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุถุบุท ุงูุตูุฑุฉ:', error);
        return fileObj;
    }
}

function calculateNewDimensions(originalWidth, originalHeight, maxWidth, maxHeight) {
    let width = originalWidth;
    let height = originalHeight;
    
    // ุฅุฐุง ูุงูุช ุงูุตูุฑุฉ ุฃูุจุฑ ูู ุงูุญุฏ ุงููุณููุญ
    if (width > maxWidth || height > maxHeight) {
        const aspectRatio = width / height;
        
        if (width > height) {
            width = maxWidth;
            height = width / aspectRatio;
        } else {
            height = maxHeight;
            width = height * aspectRatio;
        }
    }
    
    return { width: Math.round(width), height: Math.round(height) };
}

// ==============================
// ุฅูุดุงุก ุงููุนุงููุงุช ุงููุตุบุฑุฉ
// ==============================
async function generateThumbnail(fileObj) {
    const category = fileObj.category;
    
    if (category === 'images') {
        return await generateImageThumbnail(fileObj);
    } else if (category === 'documents') {
        return await generatePDFThumbnail(fileObj);
    } else {
        return generateDefaultThumbnail(fileObj);
    }
}

async function generateImageThumbnail(fileObj) {
    try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        return new Promise((resolve) => {
            img.onload = function() {
                const size = 150; // ุญุฌู ุงููุนุงููุฉ ุงููุตุบุฑุฉ
                canvas.width = size;
                canvas.height = size;
                
                // ุญุณุงุจ ุงูููุถุน ููุงุญุชูุงุธ ุจุงููุณุจุฉ
                const aspectRatio = img.width / img.height;
                let drawWidth = size;
                let drawHeight = size;
                let drawX = 0;
                let drawY = 0;
                
                if (aspectRatio > 1) {
                    drawHeight = size / aspectRatio;
                    drawY = (size - drawHeight) / 2;
                } else {
                    drawWidth = size * aspectRatio;
                    drawX = (size - drawWidth) / 2;
                }
                
                // ุฑุณู ุฎูููุฉ
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, size, size);
                
                // ุฑุณู ุงูุตูุฑุฉ
                ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
            
            if (fileObj.data instanceof Blob) {
                img.src = URL.createObjectURL(fileObj.data);
            } else {
                img.src = fileObj.data;
            }
        });
        
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุฅูุดุงุก ูุนุงููุฉ ุงูุตูุฑุฉ:', error);
        return generateDefaultThumbnail(fileObj);
    }
}

async function generatePDFThumbnail(fileObj) {
    // ูุญุงูุงุฉ ูุนุงููุฉ PDF (ูุชุทูุจ ููุชุจุฉ PDF.js ูู ุงูุชุทุจูู ุงูุญูููู)
    return generateDefaultThumbnail(fileObj);
}

function generateDefaultThumbnail(fileObj) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const size = 150;
    
    canvas.width = size;
    canvas.height = size;
    
    // ุฎูููุฉ ููููุฉ ุญุณุจ ููุน ุงูููู
    const fileTypeInfo = getFileTypeInfo(fileObj.type);
    ctx.fillStyle = fileTypeInfo.color;
    ctx.fillRect(0, 0, size, size);
    
    // ุฑุณู ุงูุฃููููุฉ
    ctx.font = '48px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = 'white';
    ctx.fillText(fileTypeInfo.icon, size/2, size/2 - 10);
    
    // ุฑุณู ุงูุชุฏุงุฏ ุงูููู
    const extension = fileObj.name.split('.').pop().toUpperCase();
    ctx.font = '14px Arial';
    ctx.fillText(extension, size/2, size/2 + 30);
    
    return canvas.toDataURL('image/jpeg', 0.8);
}

// ==============================
// ุญูุธ ุงููููุงุช
// ==============================
async function saveFile(fileObj, caseId) {
    try {
        // ุญูุธ ุงูููู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
        attachmentDatabase.files.set(fileObj.id, fileObj);
        
        // ุญูุธ ุงูุจูุงูุงุช ุงููุตููุฉ
        attachmentDatabase.metadata.set(fileObj.id, {
            id: fileObj.id,
            caseId: caseId,
            name: fileObj.name,
            size: fileObj.size,
            type: fileObj.type,
            category: fileObj.category,
            uploadDate: fileObj.uploadDate,
            tags: fileObj.tags,
            description: fileObj.description,
            isProtected: fileObj.isProtected
        });
        
        // ุญูุธ ุงููุนุงููุฉ ุงููุตุบุฑุฉ
        if (fileObj.thumbnail) {
            attachmentDatabase.thumbnails.set(fileObj.id, fileObj.thumbnail);
        }
        
        // ุฅุถุงูุฉ ุฅูู ูุงุฆูุฉ ูุฑููุงุช ุงูุญุงูุฉ
        if (!attachmentsData.has(caseId)) {
            attachmentsData.set(caseId, []);
        }
        attachmentsData.get(caseId).push(fileObj.id);
        
        // ุชุญุฏูุซ ุงูููุฑุณ ููุจุญุซ
        updateSearchIndex(fileObj);
        
        // ุญูุธ ูู ุงูุชุฎุฒูู ุงููุญูู
        await saveToLocalStorage();
        
        console.log('โ ุชู ุญูุธ ุงูููู:', fileObj.name);
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูููู:', error);
        throw error;
    }
}

// ==============================
// ุนุฑุถ ุงููุฑููุงุช
// ==============================
function refreshAttachmentList() {
    const listContainer = document.getElementById('attachment-list');
    if (!listContainer || !currentCaseId) return;
    
    const caseAttachments = attachmentsData.get(currentCaseId) || [];
    
    if (caseAttachments.length === 0) {
        listContainer.innerHTML = `
            <div class="empty-attachments">
                <i class="fas fa-folder-open"></i>
                <h4>ูุง ุชูุฌุฏ ูุฑููุงุช</h4>
                <p>ุงุจุฏุฃ ุจุฑูุน ุงููููุงุช ููุญุงูุฉ ุงูุญุงููุฉ</p>
            </div>
        `;
        return;
    }
    
    // ุฌูุจ ุจูุงูุงุช ุงููููุงุช
    const files = caseAttachments.map(id => attachmentDatabase.metadata.get(id)).filter(Boolean);
    
    // ุชุฑุชูุจ ุงููููุงุช
    const sortedFiles = sortFiles(files);
    
    // ุฅูุดุงุก ุงูุนุฑุถ
    if (currentAttachmentSettings.gridView) {
        listContainer.innerHTML = createGridView(sortedFiles);
    } else {
        listContainer.innerHTML = createListView(sortedFiles);
    }
    
    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    updateAttachmentStats();
}

function createGridView(files) {
    return `
        <div class="attachment-grid">
            ${files.map(file => createFileCard(file)).join('')}
        </div>
    `;
}

function createListView(files) {
    return `
        <div class="attachment-list-view">
            <div class="list-header">
                <div class="col-name">ุงูุงุณู</div>
                <div class="col-size">ุงูุญุฌู</div>
                <div class="col-date">ุงูุชุงุฑูุฎ</div>
                <div class="col-actions">ุงูุฅุฌุฑุงุกุงุช</div>
            </div>
            ${files.map(file => createFileRow(file)).join('')}
        </div>
    `;
}

function createFileCard(file) {
    const thumbnail = attachmentDatabase.thumbnails.get(file.id) || getDefaultThumbnail(file.type);
    const typeInfo = getFileTypeInfo(file.type);
    
    return `
        <div class="file-card" data-file-id="${file.id}">
            <div class="file-thumbnail">
                <img src="${thumbnail}" alt="${file.name}" onclick="previewFile('${file.id}')">
                <div class="file-type-badge" style="background: ${typeInfo.color}">
                    ${typeInfo.icon}
                </div>
                ${file.isProtected ? '<div class="protected-badge"><i class="fas fa-lock"></i></div>' : ''}
            </div>
            <div class="file-info">
                <div class="file-name" title="${file.name}">${truncateText(file.name, 15)}</div>
                <div class="file-meta">
                    <span class="file-size">${formatFileSize(file.size)}</span>
                    <span class="file-date">${formatDate(file.uploadDate)}</span>
                </div>
            </div>
            <div class="file-actions">
                <button class="action-btn" onclick="previewFile('${file.id}')" title="ูุนุงููุฉ">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn" onclick="downloadFile('${file.id}')" title="ุชุญููู">
                    <i class="fas fa-download"></i>
                </button>
                <button class="action-btn" onclick="editFileInfo('${file.id}')" title="ุชุนุฏูู">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" onclick="deleteFile('${file.id}')" title="ุญุฐู">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
}

function createFileRow(file) {
    const typeInfo = getFileTypeInfo(file.type);
    
    return `
        <div class="file-row" data-file-id="${file.id}">
            <div class="col-name">
                <div class="file-icon" style="color: ${typeInfo.color}">
                    ${typeInfo.icon}
                </div>
                <span class="file-name" onclick="previewFile('${file.id}')">${file.name}</span>
                ${file.isProtected ? '<i class="fas fa-lock protected-icon"></i>' : ''}
            </div>
            <div class="col-size">${formatFileSize(file.size)}</div>
            <div class="col-date">${formatDate(file.uploadDate)}</div>
            <div class="col-actions">
                <button class="action-btn" onclick="previewFile('${file.id}')" title="ูุนุงููุฉ">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn" onclick="downloadFile('${file.id}')" title="ุชุญููู">
                    <i class="fas fa-download"></i>
                </button>
                <button class="action-btn" onclick="editFileInfo('${file.id}')" title="ุชุนุฏูู">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-btn" onclick="deleteFile('${file.id}')" title="ุญุฐู">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
}

// ==============================
// ูุธุงุฆู ุฅุฏุงุฑุฉ ุงููุฑููุงุช
// ==============================
function openAttachmentManager(caseId = null) {
    if (!attachmentManager) {
        createAttachmentManager();
    }
    
    currentCaseId = caseId;
    
    // ุชุญุฏูุซ ูุนูููุงุช ุงูุญุงูุฉ
    updateCaseInfo(caseId);
    
    // ุนุฑุถ ุงููุฏูุฑ
    const overlay = attachmentManager.querySelector('.attachment-overlay');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฑููุงุช
    refreshAttachmentList();
}

function closeAttachmentManager() {
    if (attachmentManager) {
        const overlay = attachmentManager.querySelector('.attachment-overlay');
        overlay.classList.remove('show');
        document.body.style.overflow = 'auto';
    }
    
    currentCaseId = null;
}

function previewFile(fileId) {
    const file = attachmentDatabase.files.get(fileId);
    if (!file) {
        showAttachmentToast('ุงูููู ุบูุฑ ููุฌูุฏ', 'error');
        return;
    }
    
    // ุฅูุดุงุก ูุงูุฐุฉ ุงููุนุงููุฉ
    createFileViewer(file);
}

function downloadFile(fileId) {
    const file = attachmentDatabase.files.get(fileId);
    if (!file) {
        showAttachmentToast('ุงูููู ุบูุฑ ููุฌูุฏ', 'error');
        return;
    }
    
    try {
        let dataUrl;
        
        if (file.data instanceof Blob) {
            dataUrl = URL.createObjectURL(file.data);
        } else if (typeof file.data === 'string' && file.data.startsWith('data:')) {
            dataUrl = file.data;
        } else {
            // ุชุญููู Base64 ุฅูู Blob
            const base64Data = file.data.split(',')[1];
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: file.type });
            dataUrl = URL.createObjectURL(blob);
        }
        
        // ุฅูุดุงุก ุฑุงุจุท ุงูุชุญููู
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = file.name;
        link.click();
        
        // ุชูุธูู ุงูุฐุงูุฑุฉ
        if (dataUrl.startsWith('blob:')) {
            setTimeout(() => URL.revokeObjectURL(dataUrl), 1000);
        }
        
        showAttachmentToast(`ุชู ุชุญููู ุงูููู: ${file.name}`, 'success');
        
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุงูููู:', error);
        showAttachmentToast('ูุดู ูู ุชุญููู ุงูููู', 'error');
    }
}

function deleteFile(fileId) {
    const file = attachmentDatabase.metadata.get(fileId);
    if (!file) {
        showAttachmentToast('ุงูููู ุบูุฑ ููุฌูุฏ', 'error');
        return;
    }
    
    if (confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูููู "${file.name}"ุ`)) {
        try {
            // ุญุฐู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
            attachmentDatabase.files.delete(fileId);
            attachmentDatabase.metadata.delete(fileId);
            attachmentDatabase.thumbnails.delete(fileId);
            
            // ุญุฐู ูู ูุงุฆูุฉ ูุฑููุงุช ุงูุญุงูุฉ
            const caseAttachments = attachmentsData.get(file.caseId);
            if (caseAttachments) {
                const index = caseAttachments.indexOf(fileId);
                if (index > -1) {
                    caseAttachments.splice(index, 1);
                }
            }
            
            // ุชุญุฏูุซ ุงูููุฑุณ
            updateSearchIndex();
            
            // ุญูุธ ุงูุชุบููุฑุงุช
            saveToLocalStorage();
            
            // ุชุญุฏูุซ ุงูุนุฑุถ
            refreshAttachmentList();
            
            showAttachmentToast(`ุชู ุญุฐู ุงูููู: ${file.name}`, 'success');
            
        } catch (error) {
            console.error('ุฎุทุฃ ูู ุญุฐู ุงูููู:', error);
            showAttachmentToast('ูุดู ูู ุญุฐู ุงูููู', 'error');
        }
    }
}

// ==============================
// ูุธุงุฆู ูุณุงุนุฏุฉ
// ==============================
function generateFileId() {
    return 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function generateSectionId(section) {
    return 'section_' + Math.random().toString(36).substr(2, 9);
}

function extractCaseId(section) {
    // ูุญุงููุฉ ุงุณุชุฎุฑุงุฌ ูุนุฑู ุงูุญุงูุฉ ูู ุงูุณูุงู
    const formData = getFormData && getFormData();
    if (formData && formData.id) {
        return formData.id;
    }
    
    // ุฅูุดุงุก ูุนุฑู ุงูุชุฑุงุถู ููุญุงูุฉ ุงูุญุงููุฉ
    return 'current_case';
}

function getFileCategory(mimeType) {
    for (const [category, info] of Object.entries(FILE_TYPES)) {
        if (category === 'other') continue;
        
        const extensions = info.extensions;
        for (const ext of extensions) {
            if (mimeType.includes(ext.replace('.', ''))) {
                return category;
            }
        }
    }
    return 'other';
}

function getFileTypeInfo(mimeType) {
    const category = getFileCategory(mimeType);
    return FILE_TYPES[category] || FILE_TYPES.other;
}

function getAcceptedFileTypes() {
    return currentAttachmentSettings.allowedFileTypes.join(',');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 ุจุงูุช';
    
    const k = 1024;
    const sizes = ['ุจุงูุช', 'ููููุจุงูุช', 'ููุฌุงุจุงูุช', 'ุฌูุฌุงุจุงูุช'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'ููุฐ ูุญุธุงุช';
    if (diff < 3600000) return `ููุฐ ${Math.floor(diff / 60000)} ุฏูููุฉ`;
    if (diff < 86400000) return `ููุฐ ${Math.floor(diff / 3600000)} ุณุงุนุฉ`;
    if (diff < 604800000) return `ููุฐ ${Math.floor(diff / 86400000)} ููู`;
    
    return date.toLocaleDateString('ar-EG');
}

function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substr(0, maxLength) + '...';
}

async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// ==============================
// ุงูุจุญุซ ูุงูููุชุฑุฉ
// ==============================
function searchAttachments() {
    const searchTerm = document.getElementById('attachment-search').value.toLowerCase();
    const fileCards = document.querySelectorAll('.file-card, .file-row');
    
    fileCards.forEach(card => {
        const fileName = card.querySelector('.file-name').textContent.toLowerCase();
        if (fileName.includes(searchTerm)) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function filterAttachments() {
    const filterType = document.getElementById('attachment-filter-type').value;
    const fileCards = document.querySelectorAll('.file-card, .file-row');
    
    fileCards.forEach(card => {
        const fileId = card.getAttribute('data-file-id');
        const fileMetadata = attachmentDatabase.metadata.get(fileId);
        
        if (filterType === 'all' || fileMetadata.category === filterType) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function sortAttachments() {
    const sortValue = document.getElementById('attachment-sort').value;
    const [sortBy, sortOrder] = sortValue.split('-');
    
    currentAttachmentSettings.sortBy = sortBy;
    currentAttachmentSettings.sortOrder = sortOrder;
    
    refreshAttachmentList();
}

function sortFiles(files) {
    const { sortBy, sortOrder } = currentAttachmentSettings;
    
    return files.sort((a, b) => {
        let comparison = 0;
        
        switch (sortBy) {
            case 'name':
                comparison = a.name.localeCompare(b.name, 'ar');
                break;
            case 'size':
                comparison = a.size - b.size;
                break;
            case 'date':
                comparison = new Date(a.uploadDate) - new Date(b.uploadDate);
                break;
            default:
                comparison = 0;
        }
        
        return sortOrder === 'desc' ? -comparison : comparison;
    });
}

// ==============================
// ุฅุฏุงุฑุฉ ุงูุชุฎุฒูู ุงููุญูู
// ==============================
async function saveToLocalStorage() {
    try {
        const data = {
            attachments: Object.fromEntries(attachmentsData),
            files: Object.fromEntries(attachmentDatabase.files),
            metadata: Object.fromEntries(attachmentDatabase.metadata),
            thumbnails: Object.fromEntries(attachmentDatabase.thumbnails),
            settings: currentAttachmentSettings,
            lastUpdate: new Date().toISOString()
        };
        
        // ุถุบุท ุงูุจูุงูุงุช ูุจู ุงูุญูุธ
        const compressedData = JSON.stringify(data);
        localStorage.setItem('charity_attachments', compressedData);
        
        console.log('๐พ ุชู ุญูุธ ุงููุฑููุงุช ูู ุงูุชุฎุฒูู ุงููุญูู');
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงููุฑููุงุช:', error);
        
        if (error.name === 'QuotaExceededError') {
            showAttachmentToast('ูุณุงุญุฉ ุงูุชุฎุฒูู ููุชูุฆุฉ. ูุฑุฌู ุญุฐู ุจุนุถ ุงููููุงุช.', 'error');
        } else {
            showAttachmentToast('ูุดู ูู ุญูุธ ุงููุฑููุงุช', 'error');
        }
    }
}

function loadAttachmentDatabase() {
    try {
        const data = localStorage.getItem('charity_attachments');
        if (!data) return;
        
        const parsedData = JSON.parse(data);
        
        // ุชุญููู ุงูุจูุงูุงุช
        attachmentsData = new Map(Object.entries(parsedData.attachments || {}));
        attachmentDatabase.files = new Map(Object.entries(parsedData.files || {}));
        attachmentDatabase.metadata = new Map(Object.entries(parsedData.metadata || {}));
        attachmentDatabase.thumbnails = new Map(Object.entries(parsedData.thumbnails || {}));
        
        // ุชุญููู ุงูุฅุนุฏุงุฏุงุช
        if (parsedData.settings) {
            currentAttachmentSettings = { ...DEFAULT_ATTACHMENT_SETTINGS, ...parsedData.settings };
        }
        
        console.log('๐ ุชู ุชุญููู ูุงุนุฏุฉ ุจูุงูุงุช ุงููุฑููุงุช');
        
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ุงููุฑููุงุช:', error);
        showAttachmentToast('ูุดู ูู ุชุญููู ุงููุฑููุงุช ุงููุญููุธุฉ', 'error');
    }
}

function loadAttachmentSettings() {
    try {
        const settings = localStorage.getItem('charity_attachment_settings');
        if (settings) {
            currentAttachmentSettings = { ...DEFAULT_ATTACHMENT_SETTINGS, ...JSON.parse(settings) };
        }
    } catch (error) {
        console.error('ุฎุทุฃ ูู ุชุญููู ุฅุนุฏุงุฏุงุช ุงููุฑููุงุช:', error);
    }
}

// ==============================
// ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู
// ==============================
function startAutoBackup() {
    if (!currentAttachmentSettings.autoBackup) return;
    
    setInterval(async () => {
        try {
            await createAttachmentBackup();
            console.log('โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ุชููุงุฆูุฉ ูููุฑููุงุช');
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ุงููุณุฎ ุงูุงุญุชูุงุทู ุงูุชููุงุฆู:', error);
        }
    }, currentAttachmentSettings.backupInterval);
}

async function createAttachmentBackup() {
    const backupData = {
        version: '1.0.0',
        timestamp: new Date().toISOString(),
        attachments: Object.fromEntries(attachmentsData),
        metadata: Object.fromEntries(attachmentDatabase.metadata),
        settings: currentAttachmentSettings
    };
    
    const backupJson = JSON.stringify(backupData, null, 2);
    const backupBlob = new Blob([backupJson], { type: 'application/json' });
    
    // ุญูุธ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
    const backupName = `attachments_backup_${new Date().toISOString().split('T')[0]}.json`;
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(backupBlob);
    link.download = backupName;
    link.click();
    
    URL.revokeObjectURL(link.href);
}

// ==============================
// ูุธุงุฆู ุงููุงุฌูุฉ
// ==============================
function updateCaseInfo(caseId) {
    const caseInfoElement = document.getElementById('current-case-info');
    if (!caseInfoElement) return;
    
    if (caseId) {
        const attachmentCount = (attachmentsData.get(caseId) || []).length;
        caseInfoElement.textContent = `ุงูุญุงูุฉ: ${caseId} (${attachmentCount} ูุฑูู)`;
    } else {
        caseInfoElement.textContent = 'ูู ูุชู ุชุญุฏูุฏ ุญุงูุฉ';
    }
}

function updateAttachmentStats() {
    const countElement = document.getElementById('attachment-count');
    const sizeElement = document.getElementById('attachment-size');
    const foldersElement = document.getElementById('attachment-folders');
    
    if (!currentCaseId) return;
    
    const caseAttachments = attachmentsData.get(currentCaseId) || [];
    const totalSize = caseAttachments.reduce((sum, fileId) => {
        const metadata = attachmentDatabase.metadata.get(fileId);
        return sum + (metadata ? metadata.size : 0);
    }, 0);
    
    if (countElement) countElement.textContent = `${caseAttachments.length} ูููุงุช`;
    if (sizeElement) sizeElement.textContent = formatFileSize(totalSize);
    if (foldersElement) foldersElement.textContent = '0 ูุฌูุฏุงุช'; // ูุคูุช
}

function toggleViewMode(mode) {
    currentAttachmentSettings.gridView = mode === 'grid';
    
    // ุชุญุฏูุซ ุฃุฒุฑุงุฑ ุงูุนุฑุถ
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    event.target.classList.add('active');
    
    // ุชุญุฏูุซ ุงูุนุฑุถ
    refreshAttachmentList();
}

function showUploadProgress() {
    // ุฅุถุงูุฉ ุดุฑูุท ุงูุชูุฏู
    const progressBar = document.createElement('div');
    progressBar.id = 'upload-progress';
    progressBar.innerHTML = `
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text">ุฌุงุฑู ุงูุฑูุน...</div>
        </div>
    `;
    
    document.body.appendChild(progressBar);
}

function updateUploadProgress(percentage) {
    const progressFill = document.querySelector('#upload-progress .progress-fill');
    const progressText = document.querySelector('#upload-progress .progress-text');
    
    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }
    
    if (progressText) {
        progressText.textContent = `ุฌุงุฑู ุงูุฑูุน... ${Math.round(percentage)}%`;
    }
}

function hideUploadProgress() {
    const progressBar = document.getElementById('upload-progress');
    if (progressBar) {
        progressBar.remove();
    }
}

function showAttachmentToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `attachment-toast ${type}`;
    toast.innerHTML = `
        <div class="toast-icon">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
        </div>
        <div class="toast-message">${message}</div>
    `;
    
    document.body.appendChild(toast);
    
    // ุฅุธูุงุฑ ุงูุฅุดุนุงุฑ
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // ุฅุฎูุงุก ุงูุฅุดุนุงุฑ ุจุนุฏ 4 ุซูุงู
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 4000);
}

// ==============================
// ุฅุถุงูุฉ ุงูุฃููุงุท
// ==============================
function addAttachmentStyles() {
    if (document.getElementById('attachment-styles')) return;
    
    const styles = document.createElement('style');
    styles.id = 'attachment-styles';
    styles.textContent = `
        /* ุฃููุงุท ุฃุฒุฑุงุฑ ุงููุฑููุงุช */
        .attachment-button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            margin: 10px 0;
            position: relative;
        }
        
        .attachment-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .attachment-count-badge {
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            position: absolute;
            top: -5px;
            right: -5px;
        }
        
        .floating-attachment-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            justify-content: center;
        }
        
        /* ูุงูุฐุฉ ุฅุฏุงุฑุฉ ุงููุฑููุงุช */
        .attachment-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .attachment-overlay.show {
            display: flex;
        }
        
        .attachment-container {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .attachment-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .attachment-title h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .case-info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .attachment-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .attachment-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .attachment-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .close-btn {
            background: rgba(231, 76, 60, 0.8);
            padding: 8px 10px;
        }
        
        .close-btn:hover {
            background: rgba(231, 76, 60, 1);
        }
        
        /* ุดุฑูุท ุงูุฃุฏูุงุช */
        .attachment-toolbar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e3e6f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .attachment-search {
            position: relative;
            flex: 1;
            min-width: 200px;
        }
        
        .attachment-search input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: 2px solid #e3e6f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .attachment-search input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .attachment-search i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .attachment-filters {
            display: flex;
            gap: 10px;
        }
        
        .attachment-filters select {
            padding: 8px 12px;
            border: 2px solid #e3e6f0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .attachment-view-controls {
            display: flex;
            gap: 5px;
        }
        
        .view-btn {
            background: #e3e6f0;
            border: none;
            color: #6c757d;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .view-btn.active,
        .view-btn:hover {
            background: #3498db;
            color: white;
        }
        
        /* ููุทูุฉ ุงููุญุชูู */
        .attachment-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* ููุทูุฉ ุงูุณุญุจ ูุงูุฅููุงุช */
        .attachment-dropzone {
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .attachment-dropzone.drag-over {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
        }
        
        .dropzone-content i {
            font-size: 48px;
            color: #bdc3c7;
            margin-bottom: 15px;
        }
        
        .dropzone-content h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-link {
            background: none;
            border: none;
            color: #3498db;
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
        }
        
        .upload-info {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .upload-info small {
            color: #6c757d;
            font-size: 12px;
        }
        
        /* ุนุฑุถ ุงููููุงุช - ุงูุดุจูุฉ */
        .attachment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .file-card {
            background: white;
            border: 1px solid #e3e6f0;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-card:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .file-thumbnail {
            position: relative;
            width: 100%;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .file-type-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }
        
        .protected-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 25px;
            height: 25px;
            background: rgba(231, 76, 60, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .file-info {
            margin-bottom: 10px;
        }
        
        .file-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .file-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6c757d;
        }
        
        .file-actions {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }
        
        .action-btn {
            background: #f8f9fa;
            border: 1px solid #e3e6f0;
            color: #6c757d;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .action-btn:hover {
            background: #e3e6f0;
            color: #495057;
        }
        
        .action-btn.delete-btn:hover {
            background: #e74c3c;
            color: white;
        }
        
        /* ุนุฑุถ ุงููููุงุช - ุงููุงุฆูุฉ */
        .attachment-list-view {
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .list-header {
            background: #f8f9fa;
            padding: 15px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 20px;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 1px solid #e3e6f0;
        }
        
        .file-row {
            padding: 15px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 20px;
            border-bottom: 1px solid #f8f9fa;
            align-items: center;
        }
        
        .file-row:hover {
            background: #f8f9fa;
        }
        
        .col-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-icon {
            font-size: 20px;
        }
        
        .file-name {
            cursor: pointer;
            color: #3498db;
            text-decoration: none;
        }
        
        .file-name:hover {
            text-decoration: underline;
        }
        
        .protected-icon {
            color: #e74c3c;
            font-size: 12px;
        }
        
        .col-actions {
            display: flex;
            gap: 5px;
        }
        
        /* ุงูุญุงูุฉ ุงููุงุฑุบุฉ */
        .empty-attachments {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-attachments i {
            font-size: 64px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }
        
        .empty-attachments h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        /* ุงูุชุฐููู */
        .attachment-footer {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #e3e6f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .attachment-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .attachment-bulk-actions {
            display: flex;
            gap: 10px;
        }
        
        .attachment-bulk-actions .attachment-btn {
            background: #e3e6f0;
            color: #6c757d;
            padding: 6px 10px;
            font-size: 12px;
        }
        
        .attachment-bulk-actions .attachment-btn:hover {
            background: #d6d8db;
        }
        
        /* ุดุฑูุท ุงูุชูุฏู */
        #upload-progress {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e3e6f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-weight: 500;
            color: #2c3e50;
        }
        
        /* ุงูุฅุดุนุงุฑุงุช */
        .attachment-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #3498db;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 10002;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
            word-wrap: break-word;
        }
        
        .attachment-toast.show {
            transform: translateX(0);
        }
        
        .attachment-toast.success {
            background: #27ae60;
        }
        
        .attachment-toast.error {
            background: #e74c3c;
        }
        
        .attachment-toast.warning {
            background: #f39c12;
        }
        
        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .toast-message {
            flex: 1;
            font-size: 14px;
        }
        
        /* ุชุญุณููุงุช ููููุงุชู */
        @media (max-width: 768px) {
            .attachment-overlay {
                padding: 10px;
            }
            
            .attachment-container {
                max-height: 95vh;
            }
            
            .attachment-header {
                padding: 15px;
                flex-direction: column;
                align-items: stretch;
            }
            
            .attachment-actions {
                justify-content: center;
            }
            
            .attachment-toolbar {
                padding: 10px 15px;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .attachment-search {
                min-width: auto;
            }
            
            .attachment-filters {
                justify-content: center;
            }
            
            .attachment-content {
                padding: 15px;
            }
            
            .attachment-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .file-card {
                padding: 10px;
            }
            
            .file-thumbnail {
                height: 100px;
            }
            
            .list-header,
            .file-row {
                grid-template-columns: 2fr 1fr 1fr;
                gap: 10px;
            }
            
            .col-size {
                display: none;
            }
            
            .attachment-footer {
                padding: 10px 15px;
                flex-direction: column;
                align-items: stretch;
            }
            
            .attachment-stats {
                justify-content: center;
                gap: 15px;
            }
            
            .attachment-bulk-actions {
                justify-content: center;
            }
            
            .attachment-toast {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
        
        /* ุชุญุณููุงุช ููุดุงุดุงุช ุงูุตุบูุฑุฉ ุฌุฏุงู */
        @media (max-width: 480px) {
            .attachment-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .list-header,
            .file-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .col-date {
                display: none;
            }
            
            .file-actions {
                flex-wrap: wrap;
            }
            
            .action-btn {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
        }
    `;
    
    document.head.appendChild(styles);
}

// ==============================
// ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ
// ==============================
function setupAttachmentEventListeners() {
    // ูุฑุงูุจุฉ ุชุบููุฑุงุช ุงูุตูุญุฉ ูุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุฌุฏูุฏุฉ
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1 && node.querySelector) {
                    const newSections = node.querySelectorAll('.form-container, .content-header, .case-container');
                    newSections.forEach(section => {
                        if (!section.querySelector('.attachment-button')) {
                            addAttachmentButtonToSection(section);
                        }
                    });
                }
            });
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
    
    // ุงุฎุชุตุงุฑุงุช ููุญุฉ ุงูููุงุชูุญ
    document.addEventListener('keydown', function(e) {
        // Ctrl + Alt + A ููุชุญ ูุฏูุฑ ุงููุฑููุงุช
        if (e.ctrlKey && e.altKey && e.key === 'A') {
            e.preventDefault();
            openAttachmentManager();
        }
        
        // Escape ูุฅุบูุงู ูุฏูุฑ ุงููุฑููุงุช
        if (e.key === 'Escape' && attachmentManager) {
            const overlay = attachmentManager.querySelector('.attachment-overlay');
            if (overlay.classList.contains('show')) {
                closeAttachmentManager();
            }
        }
    });
}

function observeNewSections() {
    // ูุฑุงูุจุฉ ุฅุถุงูุฉ ุฃูุณุงู ุฌุฏูุฏุฉ
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) {
                    const newSections = node.querySelectorAll ? 
                        node.querySelectorAll('.form-container, .content-header, .case-container') : [];
                    
                    newSections.forEach(section => {
                        if (!attachmentButtons.has(section)) {
                            addAttachmentButtonToSection(section);
                        }
                    });
                    
                    // ุฅุฐุง ูุงู ุงูุนูุตุฑ ููุณู ูุณูุงู
                    if (node.matches && node.matches('.form-container, .content-header, .case-container')) {
                        if (!attachmentButtons.has(node)) {
                            addAttachmentButtonToSection(node);
                        }
                    }
                }
            });
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
}

// ==============================
// ุชููุฆุฉ ุงููุธุงู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
// ==============================
document.addEventListener('DOMContentLoaded', function() {
    // ุชุฃุฎูุฑ ุงูุชููุฆุฉ ููุชุฃูุฏ ูู ุชุญููู ุงููุธุงู ุงูุฑุฆูุณู
    setTimeout(() => {
        initializeAttachmentSystem();
    }, 2000);
});

// ==============================
// ุฅุชุงุญุฉ ุงููุธุงุฆู ุนุงูููุงู
// ==============================
window.attachmentSystem = {
    open: openAttachmentManager,
    close: closeAttachmentManager,
    upload: handleFileUpload,
    download: downloadFile,
    delete: deleteFile,
    preview: previewFile,
    backup: createAttachmentBackup,
    settings: currentAttachmentSettings,
    database: attachmentDatabase
};

// ==============================
// ูุนุงูุฌ ุงูุฃุฎุทุงุก
// ==============================
window.addEventListener('error', function(e) {
    if (e.filename && e.filename.includes('attachments-manager')) {
        console.error('ุฎุทุฃ ูู ูุธุงู ุงููุฑููุงุช:', e.error);
    }
});

console.log('๐ ุชู ุชุญููู ูุธุงู ุฅุฏุงุฑุฉ ุงููุฑููุงุช ูุงููุซุงุฆู ุจูุฌุงุญ!');
console.log('๐ก ุงุณุชุฎุฏู Ctrl+Alt+A ููุชุญ ูุฏูุฑ ุงููุฑููุงุช');
console.log('๐ง ุงุณุชุฎุฏู attachmentSystem ููุชุญูู ุงูุจุฑูุฌู');
