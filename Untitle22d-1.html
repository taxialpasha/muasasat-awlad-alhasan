<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مؤسسة أولاد الحسن الخيرية - نظام إدارة الحالات</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- SweetAlert2 for beautiful alerts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.12/sweetalert2.all.min.js"></script>
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Fontawesome Arabic Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tajawal/1.0/css/tajawal-font.min.css">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #1e40af;
            --primary-light: #3b82f6;
            --primary-dark: #1e3a8a;
            --secondary-color: #f59e0b;
            --secondary-light: #fbbf24;
            --secondary-dark: #d97706;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --light-color: #f3f4f6;
            --gray-color: #9ca3af;
            --text-color: #374151;
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 70px;
            --header-height: 70px;
            --case-sayed-color: #10b981;
            --case-amm-color: #3b82f6;
            --case-masareef-color: #f59e0b;
            --border-radius: 12px;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition-speed: 0.3s;
        }
        
        * {
            box-sizing: border-box;
            font-family: 'Tajawal', 'Segoe UI', 'Arial', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #f9fafb;
            direction: rtl;
            color: var(--text-color);
            overflow-x: hidden;
            scroll-behavior: smooth;
        }
        
        /* Main Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding-top: var(--header-height);
            transition: margin var(--transition-speed) ease;
        }
        
        .sidebar-collapsed .main-content {
            margin-right: var(--sidebar-collapsed-width);
        }
        
        /* Header Styles */
        .header {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            height: var(--header-height);
            background-color: #ffffff;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            padding: 0 2rem;
            z-index: 1000;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-right: var(--sidebar-width);
            transition: margin var(--transition-speed) ease;
        }
        
        .sidebar-collapsed .header {
            margin-right: var(--sidebar-collapsed-width);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
        }
        
        .header-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .header-btn:hover {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        .menu-toggle {
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-color);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .menu-toggle:hover {
            background-color: var(--light-color);
            color: var(--primary-color);
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background-color: #ffffff;
            color: var(--text-color);
            z-index: 1001;
            transition: width var(--transition-speed) ease;
            box-shadow: -1px 0 5px rgba(0,0,0,0.05);
            overflow-y: auto;
        }
        
        .sidebar-collapsed .sidebar {
            width: var(--sidebar-collapsed-width);
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            height: var(--header-height);
        }
        
        .logo-icon {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary-color);
            background-color: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            margin-left: 12px;
        }
        
        .logo-text {
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
            white-space: nowrap;
        }
        
        .sidebar-collapsed .logo-text {
            opacity: 0;
            visibility: hidden;
            position: absolute;
        }
        
        .sidebar-toggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-light);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        .sidebar-toggle:hover {
            background-color: var(--primary-dark);
        }
        
        .sidebar-toggle i {
            transition: transform var(--transition-speed);
        }
        
        .sidebar-collapsed .sidebar-toggle i {
            transform: rotate(180deg);
        }
        
        .sidebar-menu {
            padding: 20px 0;
            list-style: none;
        }
        
        .menu-item {
            margin-bottom: 5px;
        }
        
        .menu-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-color);
            text-decoration: none;
            transition: all 0.2s;
            border-radius: 8px;
            margin: 0 10px;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .menu-link:hover {
            background-color: rgba(59, 130, 246, 0.08);
            color: var(--primary-color);
        }
        
        .menu-link.active {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .menu-icon {
            font-size: 1.2rem;
            min-width: 24px;
            text-align: center;
            margin-left: 12px;
        }
        
        .menu-text {
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
        }
        
        .sidebar-collapsed .menu-text {
            opacity: 0;
            visibility: hidden;
            position: absolute;
        }
        
        .menu-link .menu-text {
            flex: 1;
        }
        
        .menu-badge {
            background-color: var(--primary-light);
            color: white;
            border-radius: 50px;
            padding: 2px 8px;
            font-size: 0.7rem;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
        }
        
        .sidebar-collapsed .menu-badge {
            opacity: 0;
            visibility: hidden;
            position: absolute;
        }
        
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 0.8rem;
            color: var(--gray-color);
            text-align: center;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
        }
        
        .sidebar-collapsed .sidebar-footer {
            opacity: 0;
            visibility: hidden;
            position: absolute;
        }
        
        /* Container */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Dashboard Page */
        .dashboard {
            padding: 30px;
        }
        
        .page-title {
            margin-bottom: 30px;
            color: var(--dark-color);
            font-weight: 700;
            font-size: 1.75rem;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background-color: var(--primary-color);
        }
        
        .stat-card.sayed::after {
            background-color: var(--case-sayed-color);
        }
        
        .stat-card.amm::after {
            background-color: var(--case-amm-color);
        }
        
        .stat-card.masareef::after {
            background-color: var(--case-masareef-color);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-left: 20px;
        }
        
        .stat-icon.sayed {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--case-sayed-color);
        }
        
        .stat-icon.amm {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--case-amm-color);
        }
        
        .stat-icon.masareef {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--case-masareef-color);
        }
        
        .stat-icon.total {
            background-color: rgba(30, 64, 175, 0.1);
            color: var(--primary-color);
        }
        
        .stat-info {
            flex: 1;
        }
        
        .stat-info h3 {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .stat-info p {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin: 0;
        }
        
        .chart-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        
        .recent-cases {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--card-shadow);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 1.25rem;
            color: var(--dark-color);
            font-weight: 600;
            position: relative;
            padding-right: 15px;
        }
        
        .section-title::before {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background-color: var(--primary-color);
            border-radius: 4px;
        }
        
        .section-actions {
            display: flex;
            gap: 12px;
        }
        
        /* Forms and Input Styles */
        .form-page {
            display: none;
            padding: 30px;
        }
        
        .form-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            position: relative;
        }
        
        .case-status-header {
            background-color: var(--case-masareef-color);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .case-status-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-image: radial-gradient(circle at top right, rgba(255,255,255,0.1) 0%, transparent 60%);
        }
        
        .case-status-header h2 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            position: relative;
        }
        
        .case-status-header p {
            opacity: 0.9;
            position: relative;
        }
        
        .case-status-header.سيد {
            background-color: var(--case-sayed-color);
        }
        
        .case-status-header.عام {
            background-color: var(--case-amm-color);
        }
        
        .case-status-header.مصاريف {
            background-color: var(--case-masareef-color);
        }
        
        .print-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .form-content {
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .form-section-title {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--gray-color);
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
            padding: 0 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group.full-width {
            flex: 100%;
        }
        
        .form-group.half-width {
            flex: 0 0 50%;
        }
        
        .form-group.third-width {
            flex: 0 0 33.333%;
        }
        
        .form-group.quarter-width {
            flex: 0 0 25%;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #f9fafb;
        }
        
        .form-control:focus {
            border-color: var(--primary-light);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .form-control.error {
            border-color: var(--danger-color);
        }
        
        .error-message {
            color: var(--danger-color);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }
        
        .form-control.error + .error-message {
            display: block;
        }
        
        .input-icon {
            position: relative;
        }
        
        .input-icon .form-control {
            padding-left: 40px;
        }
        
        .input-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: linear-gradient(rgba(255,255,255,0.1), rgba(0,0,0,0.1));
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn:hover::after {
            opacity: 1;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:focus {
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.4);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:focus {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:focus {
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.4);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.4);
        }
        
        .btn-light {
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        .btn-light:focus {
            box-shadow: 0 0 0 3px rgba(243, 244, 246, 0.4);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid currentColor;
        }
        
        .btn-outline.btn-primary {
            color: var(--primary-color);
        }
        
        .btn-outline.btn-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-sm {
            padding: 6px 16px;
            font-size: 0.875rem;
        }
        
        .btn-lg {
            padding: 14px 28px;
            font-size: 1.125rem;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 8px;
        }
        
        .btn-rounded {
            border-radius: 50px;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .form-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .floating-actions {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }
        
        .floating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .floating-btn:hover {
            transform: scale(1.1);
        }
        
        .floating-btn.btn-secondary {
            background-color: var(--secondary-color);
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            white-space: nowrap;
        }
        
        table th, table td {
            padding: 14px 20px;
            text-align: right;
        }
        
        table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 1px solid #e5e7eb;
        }
        
        table th:first-child {
            border-top-right-radius: 8px;
        }
        
        table th:last-child {
            border-top-left-radius: 8px;
        }
        
        table tr:last-child td:first-child {
            border-bottom-right-radius: 8px;
        }
        
        table tr:last-child td:last-child {
            border-bottom-left-radius: 8px;
        }
        
        table tr {
            transition: all 0.2s;
        }
        
        table tbody tr:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }
        
        table tr:hover {
            background-color: #f9fafb;
        }
        
        .table-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .table-actions button {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.2s;
        }
        
        .table-actions button:hover {
            background-color: var(--light-color);
        }
        
        .table-actions .edit-btn:hover {
            color: var(--primary-color);
        }
        
        .table-actions .delete-btn:hover {
            color: var(--danger-color);
        }
        
        .table-actions .view-btn:hover {
            color: var(--success-color);
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1.5;
        }
        
        .badge-sayed {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--case-sayed-color);
        }
        
        .badge-amm {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--case-amm-color);
        }
        
        .badge-masareef {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--case-masareef-color);
        }
        
        /* QR Code */
        .qrcode-container {
            text-align: center;
            margin: 15px 0;
            position: relative;
            z-index: 5;
        }
        
        .qrcode-container canvas {
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Reports Page */
        .report-filters {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }
        
        .report-results {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--card-shadow);
        }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .summary-card {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .summary-card h4 {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 10px;
        }
        
        .summary-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-color);
            margin: 0;
        }
        
        /* Search Bar */
        .search-bar {
            margin-bottom: 24px;
        }
        
        .search-input {
            position: relative;
        }
        
        .search-input input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border: 1px solid #e5e7eb;
            border-radius: 50px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: white;
        }
        
        .search-input input:focus {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        .search-input i {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal.show {
            display: flex;
            opacity: 1;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(30px);
            transition: transform 0.3s;
            margin: auto;
        }
        
        .modal.show .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
            transition: color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
        }
        
        .modal-close:hover {
            color: var(--danger-color);
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--gray-color);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: var(--dark-color);
            color: white;
            text-align: center;
            padding: 5px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Theme Switch */
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-color);
            transition: 0.4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        /* Print Styles */
        @media print {
            @page {
                size: A4;
                margin: 10mm;
            }
            
            html, body {
                width: 210mm;
                height: 297mm;
                background: #fff;
                overflow: visible;
            }
            
            body * {
                visibility: hidden;
            }
            
            .app-container, .main-content {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .header, .sidebar, .form-actions, .no-print, .floating-actions {
                display: none !important;
            }
            
            .form-page {
                display: block !important;
                visibility: visible !important;
                position: absolute;
                left: 0;
                top: 0;
                padding: 0 !important;
            }
            
            .form-container {
                box-shadow: none !important;
                border: 1px solid #000 !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: auto !important;
                transform: scale(0.97) !important;
                visibility: visible !important;
                position: relative !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                page-break-before: avoid !important;
                border-radius: 0 !important;
            }
            
            .form-content {
                padding: 15px !important;
                visibility: visible !important;
            }
            
            .form-section {
                margin-bottom: 10px !important;
                visibility: visible !important;
            }
            
            .form-row {
                margin-bottom: 5px !important;
                visibility: visible !important;
            }
            
            .form-group {
                margin-bottom: 5px !important;
                visibility: visible !important;
                flex: 0 0 50% !important;
            }
            
            .form-group.full-width {
                flex: 0 0 100% !important;
            }
            
            input, select, textarea, .form-control {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                height: auto !important;
                font-size: 12px !important;
                border-bottom: 1px dotted #000 !important;
                visibility: visible !important;
            }
            
            label {
                font-size: 10px !important;
                margin-bottom: 2px !important;
                visibility: visible !important;
            }
            
            .print-header, .case-status-header {
                visibility: visible !important;
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            .case-status-header {
                padding: 10px !important;
                visibility: visible !important;
            }

            .case-status-header * {
                visibility: visible !important;
            }
            
            .form-section-title {
                font-size: 12px !important;
                margin-bottom: 8px !important;
                padding-bottom: 2px !important;
                visibility: visible !important;
            }
            
            .form-content *, .case-status-header *, .print-header * {
                visibility: visible !important;
            }
            
            .qrcode-container {
                margin: 10px auto !important;
                text-align: center !important;
                visibility: visible !important;
            }
            
            .qrcode-container canvas {
                visibility: visible !important;
                box-shadow: none !important;
            }
        }
        
        /* Responsive Styles */
        @media (max-width: 992px) {
            :root {
                --sidebar-width: 280px;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .header {
                margin-right: 0;
            }
            
            .sidebar {
                transform: translateX(100%);
                box-shadow: -10px 0 20px rgba(0,0,0,0.1);
            }
            
            .sidebar-open .sidebar {
                transform: translateX(0);
            }
            
            .sidebar-open::after {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 999;
                animation: fadeIn 0.3s;
            }
            
            .sidebar-collapsed .sidebar {
                transform: translateX(100%);
            }
        }
        
        @media (max-width: 768px) {
            .form-group {
                flex: 0 0 100%;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .dashboard, .form-page {
                padding: 15px;
            }
            
            .header {
                padding: 0 1rem;
            }
            
            .header-btn span {
                display: none;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }

        /* Theme customization */
        .theme-settings {
            padding: 20px;
            margin-bottom: 20px;
        }

        .theme-palette {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option.active {
            border-color: var(--dark-color);
            transform: scale(1.1);
        }

        /* Custom loader */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s forwards;
            max-width: 300px;
        }

        .toast.success {
            border-right: 4px solid var(--success-color);
        }

        .toast.error {
            border-right: 4px solid var(--danger-color);
        }

        .toast.warning {
            border-right: 4px solid var(--warning-color);
        }

        .toast.info {
            border-right: 4px solid var(--primary-color);
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            background-color: var(--success-color);
        }

        .toast.error .toast-icon {
            background-color: var(--danger-color);
        }

        .toast.warning .toast-icon {
            background-color: var(--warning-color);
        }

        .toast.info .toast-icon {
            background-color: var(--primary-color);
        }

        .toast-message {
            flex: 1;
        }

        .toast-close {
            cursor: pointer;
            color: var(--gray-color);
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: var(--dark-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .slide-out {
            animation: slideOut 0.3s forwards;
        }

        /* Modern datepicker styling */
        input[type="date"] {
            position: relative;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: transparent;
            cursor: pointer;
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in-right {
            animation: slideInRight 0.3s forwards;
        }

        @keyframes slideInRight {
            from { 
                transform: translateX(50px);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }

        .slide-in-left {
            animation: slideInLeft 0.3s forwards;
        }

        @keyframes slideInLeft {
            from { 
                transform: translateX(-50px);
                opacity: 0;
            }
            to { 
                transform: translateX(0);
                opacity: 1;
            }
        }

        .slide-in-up {
            animation: slideInUp 0.3s forwards;
        }

        @keyframes slideInUp {
            from { 
                transform: translateY(50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Back to top button */
        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 998;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Print preview frame */
        .print-preview-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow: auto;
            padding: 20px;
        }

        .print-preview-content {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: auto;
            padding: 10mm;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .print-preview-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .print-preview-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }


/* تنسيقات نموذج الطباعة المحدث */
.print-container {
    width: 21cm;
    height: 29.7cm;
    margin: 0 auto;
    background-color: white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    border: 1px solid #000;
    position: relative;
    padding: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    font-family: 'Traditional Arabic', Arial, sans-serif;
    font-size: 14px;
    direction: rtl;
    box-sizing: border-box;
}

/* تنسيق الرأس */
.print-header {
    background-color: #FFD966;
    padding: 5px;
    border-bottom: 1px solid #000;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    height: auto;
    print-color-adjust: exact !important;
    -webkit-print-color-adjust: exact !important;
}

.header-right {
    text-align: right;
    font-size: 12px;
    padding-right: 10px;
}

.header-center {
    text-align: center;
}

.header-left {
    text-align: left;
    display: flex;
    align-items: center;
    justify-content: center;
}

.print-logo {
    width: 40px;
    height: 40px;
    margin: 0 auto;
    display: block;
}

.org-name {
    font-size: 16px;
    font-weight: bold;
    margin: 2px 0;
}

.form-title {
    font-size: 14px;
    margin: 2px 0;
}

/* محتوى النموذج */
.print-content {
    padding: 5px 10px;
    flex: 1;
    overflow: hidden;
}

.print-row {
    display: flex;
    width: 100%;
    border-bottom: 1px solid #ccc;
    padding-bottom: 3px;
    margin-bottom: 5px;
    position: relative;
    min-height: 30px;
}

.print-field {
    flex: 1;
    position: relative;
    padding: 0 5px;
    margin-top: 18px;
}

.field-label {
    position: absolute;
    top: -18px;
    right: 7px;
    font-size: 11px;
    font-weight: bold;
    color: #444;
    background-color: white;
    padding: 0 4px;
    z-index: 5;
}

.dotted-line {
    border: none;
    border-bottom: 1px dotted #000;
    background-color: transparent;
    width: 100%;
    height: 24px;
    font-family: inherit;
    font-size: 14px;
    padding: 0 4px;
    padding-bottom: 2px;
    margin: 0;
    outline: none;
    display: block;
    text-align: right;
    direction: rtl;
    position: relative;
    box-sizing: border-box;
    line-height: 20px;
    overflow: hidden;
}

.small-field {
    width: 45px;
    text-align: center;
    display: inline-block;
    border: none;
    border-bottom: 1px dotted #000;
    height: 24px;
    font-size: 14px;
    line-height: 20px;
    padding: 0 2px;
    margin: 0 2px;
    position: relative;
    bottom: -1px;
    overflow: hidden;
}

.parentheses {
    display: inline-block;
    margin: 0 2px;
    line-height: 24px;
    height: 24px;
}

.date-field {
    width: 25px;
    text-align: center;
    display: inline-block;
    border: none;
    border-bottom: 1px dotted #000;
    margin: 0 2px;
    font-size: 14px;
    padding: 0;
    height: 24px;
    line-height: 20px;
    position: relative;
    bottom: -1px;
}

.zero-val {
    color: #aaa;
}

/* تذييل النموذج */
.print-footer {
    margin-top: 5px;
    padding: 5px 10px;
}

.signature-row {
    margin-top: 5px;
    border-top: 1px solid #ddd;
    padding-top: 5px;
    text-align: center;
    font-size: 13px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
}

.signature-row p {
    margin: 5px 0;
}

.signature-label {
    display: inline-block;
    margin-right: 5px;
    font-weight: bold;
}

/* نمط الطباعة */
@media print {
    body * {
        visibility: hidden;
    }
    
    .print-container, .print-container * {
        visibility: visible;
    }
    
    .print-container {
        width: 210mm;
        height: 297mm;
        margin: 0;
        padding: 0;
        box-shadow: none;
        border: none;
        position: absolute;
        left: 0;
        top: 0;
    }
    
    .no-print {
        display: none !important;
    }
    
    #print-preview-close, #print-preview-actions {
        display: none !important;
    }
}

/* نمط معاينة الطباعة */
#print-preview-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 3000;
    overflow: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

#print-preview-content {
    background: white;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
    margin: 0 auto;
    position: relative;
    overflow: visible;
}

#print-preview-close {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    background: var(--danger-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
}

#print-preview-actions {
    margin-top: 20px;
    text-align: center;
}

/* تخصيص مؤشر التحميل للطباعة */
.print-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3100;
}

.print-loader-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    animation: print-spin 1s linear infinite;
}

@keyframes print-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* وضع التنسيق المضغوط للطباعة */
.compact-layout .print-row {
    margin-bottom: 1px;
    min-height: 25px;
}

.compact-layout .print-field {
    margin-top: 15px;
}

.compact-layout .field-label {
    top: -15px;
}
/* تنسيقات ألوان رأس نموذج الطباعة حسب نوع الحالة */
.print-header.header-sayed {
    background-color: #10b981 !important; /* لون أخضر لحالات سيد */
}

.print-header.header-amm {
    background-color: #3b82f6 !important; /* لون أزرق لحالات عام */
}

.print-header.header-masareef {
    background-color: #f59e0b !important; /* لون برتقالي لحالات مصاريف */
}

/* إصلاح مشكلة تكرار الطباعة */
@media print {
    body * {
        visibility: hidden;
    }
    
    /* تأكد من أن الطباعة تظهر فقط لحاوية الطباعة المناسبة */
    #print-preview-content, #print-preview-content * {
        visibility: visible;
    }
    
    /* حل مشكلة تكرار النموذج المطبوع */
    .print-container {
        visibility: visible;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: auto;
    }
    
    /* إخفاء أي عناصر إضافية قد تتسبب في طباعة صفحات متعددة */
    #print-preview-close, #print-preview-actions {
        display: none !important;
    }
    
    /* منع انقسام محتوى النموذج على صفحات متعددة */
    .print-container {
        page-break-inside: avoid;
        page-break-after: avoid;
    }
}

    </style>
</head>
<body>
    <!-- Loader -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <div class="app-container" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <i class="fas fa-hand-holding-heart"></i>
                </div>
                <div class="logo-text">
                    <h1 style="font-size: 1.1rem; margin: 0; font-weight: 700;">مؤسسة أولاد الحسن ع</h1>
                    <p style="font-size: 0.8rem; margin: 0; opacity: 0.8;">الخيرية</p>
                </div>
            </div>
            
            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="#" class="menu-link active" onclick="showPage('dashboard')">
                        <i class="menu-icon fas fa-tachometer-alt"></i>
                        <span class="menu-text">لوحة التحكم</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" onclick="showPage('new-case')">
                        <i class="menu-icon fas fa-plus-circle"></i>
                        <span class="menu-text">إنشاء حالة جديدة</span>
                        <span class="menu-badge">جديد</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" onclick="showPage('cases')">
                        <i class="menu-icon fas fa-folder-open"></i>
                        <span class="menu-text">جميع الحالات</span>
                        <span class="menu-badge" id="total-badge">0</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" onclick="showPage('case-sayed')">
                        <i class="menu-icon fas fa-user-tie"></i>
                        <span class="menu-text">حالات سيد</span>
                        <span class="menu-badge" id="sayed-badge">0</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" onclick="showPage('case-amm')">
                        <i class="menu-icon fas fa-users"></i>
                        <span class="menu-text">حالات عام</span>
                        <span class="menu-badge" id="amm-badge">0</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" onclick="showPage('case-masareef')">
                        <i class="menu-icon fas fa-hand-holding-usd"></i>
                        <span class="menu-text">حالات مصاريف</span>
                        <span class="menu-badge" id="masareef-badge">0</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" onclick="showPage('reports')">
                        <i class="menu-icon fas fa-chart-bar"></i>
                        <span class="menu-text">التقارير</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" onclick="showImportExportModal()">
                        <i class="menu-icon fas fa-exchange-alt"></i>
                        <span class="menu-text">استيراد / تصدير</span>
                    </a>
                </li>
                <li class="menu-item">
                    <a href="#" class="menu-link" onclick="showSettingsModal()">
                        <i class="menu-icon fas fa-cog"></i>
                        <span class="menu-text">الإعدادات</span>
                    </a>
                </li>
            </ul>
            
            <div class="sidebar-footer">
                مؤسسة أولاد الحسن الخيرية © 2025
                <div style="margin-top: 10px; font-size: 0.7rem;">
                    الإصدار 2.0
                </div>
            </div>
            
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Header -->
        <div class="header" id="header">
            <div class="header-content">
                <div class="header-title">
                    <div class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </div>
                    <span id="page-title">لوحة التحكم</span>
                </div>
                <div class="header-actions">
                    <button class="header-btn" onclick="showSearchModal()">
                        <i class="fas fa-search"></i>
                        <span>بحث</span>
                    </button>
                    <button class="header-btn" onclick="showQrCodeModal()">
                        <i class="fas fa-qrcode"></i>
                        <span>مسح الكود</span>
                    </button>
                    <button class="header-btn" id="theme-toggle-btn" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                        <span>وضع مظلم</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div class="dashboard" id="dashboard-page">
                <h1 class="page-title slide-in-right">لوحة التحكم</h1>
                
                <div class="dashboard-stats">
                    <div class="stat-card sayed slide-in-up" style="animation-delay: 0.1s;" onclick="showPage('case-sayed')">
                        <div class="stat-icon sayed">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div class="stat-info">
                            <h3>حالات سيد</h3>
                            <p id="sayed-count">0</p>
                        </div>
                    </div>
                    <div class="stat-card amm slide-in-up" style="animation-delay: 0.2s;" onclick="showPage('case-amm')">
                        <div class="stat-icon amm">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>حالات عام</h3>
                            <p id="amm-count">0</p>
                        </div>
                    </div>
                    <div class="stat-card masareef slide-in-up" style="animation-delay: 0.3s;" onclick="showPage('case-masareef')">
                        <div class="stat-icon masareef">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <div class="stat-info">
                            <h3>حالات مصاريف</h3>
                            <p id="masareef-count">0</p>
                        </div>
                    </div>
                    <div class="stat-card slide-in-up" style="animation-delay: 0.4s;" onclick="showPage('cases')">
                        <div class="stat-icon total">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <div class="stat-info">
                            <h3>إجمالي الحالات</h3>
                            <p id="total-count">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container slide-in-up" style="animation-delay: 0.5s;">
                    <div class="section-header">
                        <h2 class="section-title">إحصائيات الحالات</h2>
                    </div>
                    <canvas id="cases-chart" height="100"></canvas>
                </div>
                
                <div class="recent-cases slide-in-up" style="animation-delay: 0.6s;">
                    <div class="section-header">
                        <h2 class="section-title">آخر الحالات المضافة</h2>
                        <div class="section-actions">
                            <button class="btn btn-primary btn-sm" onclick="showPage('new-case')">
                                <i class="fas fa-plus"></i>
                                <span>إضافة حالة</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>رقم الحالة</th>
                                    <th>التاريخ</th>
                                    <th>الاسم</th>
                                    <th>نوع الحالة</th>
                                    <th>المبلغ</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="recent-cases-tbody">
                                <!-- Recent cases will be filled here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Form Page -->
            <div class="form-page" id="new-case-page">
                <div class="form-container">
                    <div class="case-status-header" id="case-header">
                        <div>
                            <h2>استمارة معلومات الحالة</h2>
                            <p>إضافة حالة جديدة</p>
                        </div>
                        <div class="qrcode-container no-print" id="case-qrcode-container">
                            <div id="case-qrcode"></div>
                        </div>
                    </div>
                    
                    <div class="form-content">
                        <form id="case-form" novalidate>
                            <!-- Case Identifier Section -->
                            <div class="form-section">
                                <h3 class="form-section-title">بيانات الحالة</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="caseId">رقم الحالة:</label>
                                        <input type="text" id="caseId" name="caseId" class="form-control" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label for="caseCode">رمز الحالة:</label>
                                        <select id="caseCode" name="caseCode" class="form-control" required>
                                            <option value="مصاريف">مصاريف</option>
                                            <option value="سيد">سيد</option>
                                            <option value="عام">عام</option>
                                        </select>
                                        <div class="error-message">الرجاء اختيار رمز الحالة</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="caseType">نوع الحالة:</label>
                                        <input type="text" id="caseType" name="caseType" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال نوع الحالة</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="caseDate">التاريخ:</label>
                                        <input type="date" id="caseDate" name="caseDate" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال تاريخ الحالة</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="organizer">المنظم:</label>
                                        <input type="text" id="organizer" name="organizer" class="form-control" value="محمد حسن" required>
                                        <div class="error-message">الرجاء إدخال اسم المنظم</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Basic Information -->
                            <div class="form-section">
                                <h3 class="form-section-title">البيانات الشخصية</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="fullName">الاسم الكامل:</label>
                                        <input type="text" id="fullName" name="fullName" class="form-control" required list="namesDatalist">
                                        <datalist id="namesDatalist">
                                            <!-- Will be populated by JavaScript -->
                                        </datalist>
                                        <div class="error-message">الرجاء إدخال الاسم الكامل</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="lastName">اللقب:</label>
                                        <input type="text" id="lastName" name="lastName" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال اللقب</div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="parentName">أبو / أم:</label>
                                        <input type="text" id="parentName" name="parentName" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال اسم الأب/الأم</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="age">العمر:</label>
                                        <input type="number" id="age" name="age" class="form-control" min="0" required>
                                        <div class="error-message">الرجاء إدخال العمر</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="socialStatus">الحالة الاجتماعية:</label>
                                        <select id="socialStatus" name="socialStatus" class="form-control" required>
                                            <option value="">-- اختر --</option>
                                            <option value="متزوج/ة">متزوج/ة</option>
                                            <option value="أعزب/عزباء">أعزب/عزباء</option>
                                            <option value="مطلق/ة">مطلق/ة</option>
                                            <option value="أرمل/ة">أرمل/ة</option>
                                        </select>
                                        <div class="error-message">الرجاء اختيار الحالة الاجتماعية</div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="caseDescription">شرح الحالة:</label>
                                        <textarea id="caseDescription" name="caseDescription" class="form-control" rows="3" required></textarea>
                                        <div class="error-message">الرجاء إدخال شرح الحالة</div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="documentedBy">الموثق:</label>
                                        <input type="text" id="documentedBy" name="documentedBy" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال اسم الموثق</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="mukhtar">اسم المختار:</label>
                                        <input type="text" id="mukhtar" name="mukhtar" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال اسم المختار</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Financial Information -->
                            <div class="form-section">
                                <h3 class="form-section-title">البيانات المالية</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="govSalary">راتب حكومي:</label>
                                        <input type="number" id="govSalary" name="govSalary" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال الراتب الحكومي</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="orgSalary">راتب مؤسسة:</label>
                                        <input type="number" id="orgSalary" name="orgSalary" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال راتب المؤسسة</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="incomeAmount">مقدار الدخل:</label>
                                        <input type="number" id="incomeAmount" name="incomeAmount" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال مقدار الدخل</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="expenses">المصروفات:</label>
                                        <input type="number" id="expenses" name="expenses" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال المصروفات</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="incomeRemaining">باقي الدخل:</label>
                                        <input type="number" id="incomeRemaining" name="incomeRemaining" class="form-control" value="0" min="0" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Address Information -->
                            <div class="form-section">
                                <h3 class="form-section-title">بيانات العنوان</h3>
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="address">العنوان وأقرب نقطة دالة:</label>
                                        <input type="text" id="address" name="address" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال العنوان</div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="housingType">نوع السكن:</label>
                                        <select id="housingType" name="housingType" class="form-control" required>
                                            <option value="ملك">ملك</option>
                                            <option value="إيجار">إيجار</option>
                                            <option value="أخرى">أخرى</option>
                                        </select>
                                        <div class="error-message">الرجاء اختيار نوع السكن</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Family Information -->
                            <div class="form-section">
                                <h3 class="form-section-title">بيانات الأسرة</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="totalFamilyMembers">عدد أفراد الأسرة الكلي:</label>
                                        <input type="number" id="totalFamilyMembers" name="totalFamilyMembers" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال عدد أفراد الأسرة</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="maleChildren">بنين:</label>
                                        <input type="number" id="maleChildren" name="maleChildren" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال عدد البنين</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="femaleChildren">بنات:</label>
                                        <input type="number" id="femaleChildren" name="femaleChildren" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال عدد البنات</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="married">متزوجين:</label>
                                        <input type="number" id="married" name="married" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال عدد المتزوجين</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Case/Hospital Information -->
                            <div class="form-section">
                                <h3 class="form-section-title">بيانات المستشفى / الحالة</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="hospitalName">اسم المستشفى او الحالة:</label>
                                        <input type="text" id="hospitalName" name="hospitalName" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال اسم المستشفى أو الحالة</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="hospitalAddress">العنوان:</label>
                                        <input type="text" id="hospitalAddress" name="hospitalAddress" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال عنوان المستشفى</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="caseTypeDetail">تفاصيل نوع الحالة:</label>
                                        <input type="text" id="caseTypeDetail" name="caseTypeDetail" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال تفاصيل نوع الحالة</div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="amountNumeric">المبلغ رقما:</label>
                                        <input type="number" id="amountNumeric" name="amountNumeric" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال المبلغ</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="amountWritten">المبلغ كتابة:</label>
                                        <input type="text" id="amountWritten" name="amountWritten" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال المبلغ كتابة</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="totalAmount">المجموع:</label>
                                        <input type="number" id="totalAmount" name="totalAmount" class="form-control" value="0" min="0" required>
                                        <div class="error-message">الرجاء إدخال المجموع</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="doctorName">اسم الدكتور:</label>
                                        <input type="text" id="doctorName" name="doctorName" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال اسم الدكتور</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contact Information -->
                            <div class="form-section">
                                <h3 class="form-section-title">بيانات الاتصال</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="phoneFirst">رقم الهاتف الأول:</label>
                                        <input type="text" id="phoneFirst" name="phoneFirst" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال رقم الهاتف الأول</div>
                                    </div>
                                    <div class="form-group">
                                        <label for="phoneSecond">رقم الهاتف الثاني:</label>
                                        <input type="text" id="phoneSecond" name="phoneSecond" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Spouse Information -->
                            <div class="form-section">
                                <h3 class="form-section-title">بيانات الزوج/ة</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="spouseName">الزوج/ة:</label>
                                        <input type="text" id="spouseName" name="spouseName" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="spouseLastName">اللقب:</label>
                                        <input type="text" id="spouseLastName" name="spouseLastName" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="spouseOccupation">المهنة:</label>
                                        <input type="text" id="spouseOccupation" name="spouseOccupation" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="spouseSalary">الراتب:</label>
                                        <input type="number" id="spouseSalary" name="spouseSalary" class="form-control" min="0">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Additional Support Information -->
                            <div class="form-section">
                                <h3 class="form-section-title">معلومات الدعم الإضافي</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="hasOtherSupport">هل يوجد معيل آخر:</label>
                                        <select id="hasOtherSupport" name="hasOtherSupport" class="form-control" required>
                                            <option value="لا">لا</option>
                                            <option value="نعم">نعم</option>
                                        </select>
                                        <div class="error-message">الرجاء اختيار ما إذا كان هناك معيل آخر</div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="supportingAgencies">الجهات التي تقوم بالمساعدة:</label>
                                        <input type="text" id="supportingAgencies" name="supportingAgencies" class="form-control">
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group full-width">
                                        <label for="notes">الملاحظات:</label>
                                        <textarea id="notes" name="notes" class="form-control" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Support Amount -->
                            <div class="form-section">
                                <h3 class="form-section-title">مبلغ المساعدة</h3>
                                <div class="form-row">
                                    <div class="form-group half-width">
                                        <label for="estimatedAssistance">يصرف مبلغ المساعدة المقدر:</label>
                                        <input type="text" id="estimatedAssistance" name="estimatedAssistance" class="form-control" required>
                                        <div class="error-message">الرجاء إدخال مبلغ المساعدة المقدر</div>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="amountPaid">تم صرف مبلغ:</label>
                                        <input type="text" id="amountPaid" name="amountPaid" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label for="paymentDate">بتاريخ:</label>
                                        <input type="date" id="paymentDate" name="paymentDate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Administration -->
                            <div class="form-section">
                                <div class="form-row">
                                    <div class="form-group" style="text-align: center; flex: 2;">
                                        <p>إدارة المؤسسة</p>
                                        <p>السيد أسامة السعبري والسيد فؤاد السعبري</p>
                                        <p id="admin-date"></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions no-print">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i>
                                    <span>حفظ الحالة</span>
                                </button>
                                <button type="button" class="btn btn-primary" onclick="printPreview()">
                                    <i class="fas fa-print"></i>
                                    <span>طباعة الاستمارة</span>
                                </button>
                                <button type="button" class="btn btn-warning" onclick="resetForm()">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>إعادة تعيين</span>
                                </button>
                                <button type="button" class="btn btn-light" onclick="showPage('cases')">
                                    <i class="fas fa-arrow-right"></i>
                                    <span>العودة</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Cases List Pages -->
            <div class="form-page" id="cases-page">
                <div class="section-header">
                    <h2 class="section-title">جميع الحالات</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="showPage('new-case')">
                            <i class="fas fa-plus"></i>
                            <span>إضافة حالة</span>
                        </button>
                    </div>
                </div>
                
                <div class="search-bar">
                    <div class="search-input">
                        <input type="text" id="search-cases" placeholder="البحث عن حالة...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الحالة</th>
                                <th>التاريخ</th>
                                <th>الاسم</th>
                                <th>رمز الحالة</th>
                                <th>نوع الحالة</th>
                                <th>المبلغ</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="all-cases-tbody">
                            <!-- All cases will be filled here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="form-page" id="case-sayed-page">
                <div class="section-header">
                    <h2 class="section-title">حالات سيد</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="addNewCase('سيد')">
                            <i class="fas fa-plus"></i>
                            <span>إضافة حالة سيد</span>
                        </button>
                    </div>
                </div>
                
                <div class="search-bar">
                    <div class="search-input">
                        <input type="text" id="search-sayed" placeholder="البحث في حالات سيد...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الحالة</th>
                                <th>التاريخ</th>
                                <th>الاسم</th>
                                <th>نوع الحالة</th>
                                <th>المبلغ</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="sayed-cases-tbody">
                            <!-- Sayed cases will be filled here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="form-page" id="case-amm-page">
                <div class="section-header">
                    <h2 class="section-title">حالات عام</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="addNewCase('عام')">
                            <i class="fas fa-plus"></i>
                            <span>إضافة حالة عام</span>
                        </button>
                    </div>
                </div>
                
                <div class="search-bar">
                    <div class="search-input">
                        <input type="text" id="search-amm" placeholder="البحث في حالات عام...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الحالة</th>
                                <th>التاريخ</th>
                                <th>الاسم</th>
                                <th>نوع الحالة</th>
                                <th>المبلغ</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="amm-cases-tbody">
                            <!-- Amm cases will be filled here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="form-page" id="case-masareef-page">
                <div class="section-header">
                    <h2 class="section-title">حالات مصاريف</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="addNewCase('مصاريف')">
                            <i class="fas fa-plus"></i>
                            <span>إضافة حالة مصاريف</span>
                        </button>
                    </div>
                </div>
                
                <div class="search-bar">
                    <div class="search-input">
                        <input type="text" id="search-masareef" placeholder="البحث في حالات مصاريف...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الحالة</th>
                                <th>التاريخ</th>
                                <th>الاسم</th>
                                <th>نوع الحالة</th>
                                <th>المبلغ</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="masareef-cases-tbody">
                            <!-- Masareef cases will be filled here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Reports Page -->
            <div class="form-page" id="reports-page">
                <div class="section-header">
                    <h2 class="section-title">التقارير والإحصائيات</h2>
                </div>
                
                <div class="report-filters">
                    <div class="tabs">
                        <div class="tab active" data-tab="basic-report">تقرير أساسي</div>
                        <div class="tab" data-tab="advanced-report">تقرير متقدم</div>
                        <div class="tab" data-tab="financial-report">تقرير مالي</div>
                    </div>
                    
                    <!-- Basic Report Tab -->
                    <div class="tab-content active" id="basic-report-tab">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="report-type">نوع التقرير:</label>
                                <select id="report-type" class="form-control">
                                    <option value="all">جميع الحالات</option>
                                    <option value="sayed">حالات سيد</option>
                                    <option value="amm">حالات عام</option>
                                    <option value="masareef">حالات مصاريف</option>
                                    <option value="date">حسب التاريخ</option>
                                    <option value="amount">حسب المبلغ</option>
                                </select>
                            </div>
                            <div class="form-group" id="date-range-container" style="display: none;">
                                <label for="report-start-date">من تاريخ:</label>
                                <input type="date" id="report-start-date" class="form-control">
                            </div>
                            <div class="form-group" id="date-range-end-container" style="display: none;">
                                <label for="report-end-date">إلى تاريخ:</label>
                                <input type="date" id="report-end-date" class="form-control">
                            </div>
                            <div class="form-group" id="amount-range-container" style="display: none;">
                                <label for="report-min-amount">الحد الأدنى للمبلغ:</label>
                                <input type="number" id="report-min-amount" class="form-control" min="0">
                            </div>
                            <div class="form-group" id="amount-range-max-container" style="display: none;">
                                <label for="report-max-amount">الحد الأقصى للمبلغ:</label>
                                <input type="number" id="report-max-amount" class="form-control" min="0">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="generateReport()">
                                <i class="fas fa-chart-line"></i>
                                <span>إنشاء التقرير</span>
                            </button>
                            <button class="btn btn-success" onclick="exportReportToExcel()">
                                <i class="fas fa-file-excel"></i>
                                <span>تصدير إلى Excel</span>
                            </button>
                            <button class="btn btn-warning" onclick="printReport()">
                                <i class="fas fa-print"></i>
                                <span>طباعة التقرير</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Report Tab -->
                    <div class="tab-content" id="advanced-report-tab">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="advanced-criteria">معايير متقدمة:</label>
                                <select id="advanced-criteria" class="form-control">
                                    <option value="family-size">حجم الأسرة</option>
                                    <option value="housing-type">نوع السكن</option>
                                    <option value="age-group">الفئة العمرية</option>
                                    <option value="social-status">الحالة الاجتماعية</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="advanced-value">القيمة:</label>
                                <input type="text" id="advanced-value" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="advanced-date-from">من تاريخ:</label>
                                <input type="date" id="advanced-date-from" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="advanced-date-to">إلى تاريخ:</label>
                                <input type="date" id="advanced-date-to" class="form-control">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="generateAdvancedReport()">
                                <i class="fas fa-chart-line"></i>
                                <span>إنشاء تقرير متقدم</span>
                            </button>
                            <button class="btn btn-success" onclick="exportAdvancedReportToExcel()">
                                <i class="fas fa-file-excel"></i>
                                <span>تصدير إلى Excel</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Financial Report Tab -->
                    <div class="tab-content" id="financial-report-tab">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="financial-year">السنة:</label>
                                <select id="financial-year" class="form-control">
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="financial-month">الشهر:</label>
                                <select id="financial-month" class="form-control">
                                    <option value="all">كل الشهور</option>
                                    <option value="1">يناير</option>
                                    <option value="2">فبراير</option>
                                    <option value="3">مارس</option>
                                    <option value="4">أبريل</option>
                                    <option value="5">مايو</option>
                                    <option value="6">يونيو</option>
                                    <option value="7">يوليو</option>
                                    <option value="8">أغسطس</option>
                                    <option value="9">سبتمبر</option>
                                    <option value="10">أكتوبر</option>
                                    <option value="11">نوفمبر</option>
                                    <option value="12">ديسمبر</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="financial-type">نوع الحالة:</label>
                                <select id="financial-type" class="form-control">
                                    <option value="all">كل الحالات</option>
                                    <option value="سيد">حالات سيد</option>
                                    <option value="عام">حالات عام</option>
                                    <option value="مصاريف">حالات مصاريف</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="generateFinancialReport()">
                                <i class="fas fa-chart-line"></i>
                                <span>إنشاء تقرير مالي</span>
                            </button>
                            <button class="btn btn-success" onclick="exportFinancialReportToExcel()">
                                <i class="fas fa-file-excel"></i>
                                <span>تصدير إلى Excel</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="report-results">
                    <div class="section-header">
                        <h3 class="section-title">نتائج التقرير</h3>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="report-chart" height="100"></canvas>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>رقم الحالة</th>
                                    <th>التاريخ</th>
                                    <th>الاسم</th>
                                    <th>رمز الحالة</th>
                                    <th>نوع الحالة</th>
                                    <th>المبلغ</th>
                                </tr>
                            </thead>
                            <tbody id="report-results-tbody">
                                <!-- Report results will be filled here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="report-summary">
                        <div class="summary-card">
                            <h4>إجمالي عدد الحالات</h4>
                            <p id="report-total-cases">0</p>
                        </div>
                        <div class="summary-card">
                            <h4>إجمالي المبالغ</h4>
                            <p id="report-total-amount">0</p>
                        </div>
                        <div class="summary-card">
                            <h4>متوسط المبلغ</h4>
                            <p id="report-average-amount">0</p>
                        </div>
                        <div class="summary-card">
                            <h4>أعلى مبلغ</h4>
                            <p id="report-max-amount">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Back to top button -->
        <div class="back-to-top" id="back-to-top">
            <i class="fas fa-arrow-up"></i>
        </div>
        
        <!-- Floating actions -->
        <div class="floating-actions no-print">
            <button class="floating-btn btn-secondary" onclick="showQrCodeModal()">
                <i class="fas fa-qrcode"></i>
            </button>
            <button class="floating-btn" onclick="showPage('new-case')">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        
        <!-- Search Modal -->
        <div class="modal" id="search-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">بحث شامل عن حالة</h2>
                    <button class="modal-close" onclick="closeModal('search-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="search-query">أدخل كلمة البحث:</label>
                            <input type="text" id="search-query" class="form-control" placeholder="اسم، رقم الحالة، نوع الحالة...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="search-field">البحث في:</label>
                            <select id="search-field" class="form-control">
                                <option value="all">جميع الحقول</option>
                                <option value="caseId">رقم الحالة</option>
                                <option value="fullName">الاسم</option>
                                <option value="caseCode">رمز الحالة</option>
                                <option value="caseType">نوع الحالة</option>
                                <option value="phoneFirst">رقم الهاتف</option>
                                <option value="address">العنوان</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="search-category">فئة الحالة:</label>
                            <select id="search-category" class="form-control">
                                <option value="all">جميع الفئات</option>
                                <option value="سيد">سيد</option>
                                <option value="عام">عام</option>
                                <option value="مصاريف">مصاريف</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="searchCases()">
                        <i class="fas fa-search"></i>
                        <span>بحث</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- QR Code Modal -->
        <div class="modal" id="qrcode-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">مسح رمز QR</h2>
                    <button class="modal-close" onclick="closeModal('qrcode-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="text-align: center; margin-bottom: 20px;">أدخل رقم الحالة أو امسح رمز QR الخاص بالحالة:</p>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <div class="input-icon">
                                <input type="text" id="qrcode-input" class="form-control" placeholder="رقم الحالة">
                                <i class="fas fa-qrcode"></i>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin: 20px 0;">
                        <button class="btn btn-primary" onclick="findCaseByQrCode()">
                            <i class="fas fa-search"></i>
                            <span>بحث عن الحالة</span>
                        </button>
                    </div>
                    <p style="text-align: center; margin-bottom: 10px;">أو قم بالتقاط صورة لرمز QR:</p>
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="scanQrCode()">
                            <i class="fas fa-camera"></i>
                            <span>التقاط رمز QR</span>
                        </button>
                    </div>
                    <div id="qr-scanner-container" style="display: none; margin-top: 20px; text-align: center;">
                        <div id="qr-scanner-preview" style="width: 100%; max-width: 300px; height: 300px; margin: 0 auto; border: 2px solid #ddd; border-radius: 8px;"></div>
                        <button class="btn btn-danger" style="margin-top: 15px;" onclick="stopQrScanner()">
                            <i class="fas fa-stop"></i>
                            <span>إيقاف المسح</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Import/Export Modal -->
        <div class="modal" id="import-export-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">استيراد / تصدير البيانات</h2>
                    <button class="modal-close" onclick="closeModal('import-export-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="tabs">
                        <div class="tab active" data-tab="export">تصدير البيانات</div>
                        <div class="tab" data-tab="import">استيراد البيانات</div>
                        <div class="tab" data-tab="backup">النسخ الاحتياطي</div>
                    </div>
                    
                    <!-- Export Tab -->
                    <div class="tab-content active" id="export-tab">
                        <div class="form-section">
                            <p style="margin-bottom: 15px;">قم بتصدير بيانات الحالات كنسخة احتياطية:</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="export-type">نوع التصدير:</label>
                                    <select id="export-type" class="form-control">
                                        <option value="all">جميع الحالات</option>
                                        <option value="sayed">حالات سيد فقط</option>
                                        <option value="amm">حالات عام فقط</option>
                                        <option value="masareef">حالات مصاريف فقط</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="export-format">صيغة الملف:</label>
                                    <select id="export-format" class="form-control">
                                        <option value="json">JSON</option>
                                        <option value="excel">Excel</option>
                                        <option value="csv">CSV</option>
                                    </select>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="btn btn-success" onclick="exportData()">
                                    <i class="fas fa-download"></i>
                                    <span>تصدير البيانات</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Import Tab -->
                    <div class="tab-content" id="import-tab">
                        <div class="form-section">
                            <p style="margin-bottom: 15px;">قم باستيراد بيانات الحالات من ملف:</p>
                            <div class="form-row">
                                <div class="form-group full-width">
                                    <label for="import-file">اختر ملف:</label>
                                    <input type="file" id="import-file" class="form-control" accept=".json,.xlsx,.csv">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="import-strategy">طريقة الاستيراد:</label>
                                    <select id="import-strategy" class="form-control">
                                        <option value="merge">دمج مع البيانات الحالية</option>
                                        <option value="replace">استبدال البيانات الحالية</option>
                                    </select>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="importData()">
                                    <i class="fas fa-upload"></i>
                                    <span>استيراد البيانات</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backup Tab -->
                    <div class="tab-content" id="backup-tab">
                        <div class="form-section">
                            <p style="margin-bottom: 15px;">إدارة النسخ الاحتياطية التلقائية:</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="backup-frequency">تكرار النسخ الاحتياطي:</label>
                                    <select id="backup-frequency" class="form-control">
                                        <option value="daily">يومي</option>
                                        <option value="weekly">أسبوعي</option>
                                        <option value="monthly">شهري</option>
                                        <option value="disabled">معطل</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="backup-count">عدد النسخ المحفوظة:</label>
                                    <input type="number" id="backup-count" class="form-control" value="5" min="1" max="20">
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="saveBackupSettings()">
                                    <i class="fas fa-save"></i>
                                    <span>حفظ الإعدادات</span>
                                </button>
                                <button class="btn btn-success" onclick="createManualBackup()">
                                    <i class="fas fa-hdd"></i>
                                    <span>إنشاء نسخة احتياطية الآن</span>
                                </button>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <h4 style="margin-bottom: 15px;">النسخ الاحتياطية السابقة:</h4>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>التاريخ</th>
                                                <th>الحجم</th>
                                                <th>عدد الحالات</th>
                                                <th>الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="backups-list">
                                            <!-- Will be filled by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div class="modal" id="settings-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">إعدادات النظام</h2>
                    <button class="modal-close" onclick="closeModal('settings-modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="tabs">
                        <div class="tab active" data-tab="general">إعدادات عامة</div>
                        <div class="tab" data-tab="appearance">المظهر</div>
                        <div class="tab" data-tab="printing">الطباعة</div>
                        <div class="tab" data-tab="advanced">إعدادات متقدمة</div>
                    </div>
                    
                    <!-- General Settings Tab -->
                    <div class="tab-content active" id="general-tab">
                        <div class="form-section">
                            <h3 class="form-section-title">إعدادات المؤسسة</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="setting-org-name">اسم المؤسسة:</label>
                                    <input type="text" id="setting-org-name" class="form-control" value="مؤسسة أولاد الحسن ع الخيرية">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="setting-organizer">اسم المنظم الافتراضي:</label>
                                    <input type="text" id="setting-organizer" class="form-control" value="محمد حسن">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="setting-admin-names">أسماء الإدارة:</label>
                                    <input type="text" id="setting-admin-names" class="form-control" value="السيد أسامة السعبري والسيد فؤاد السعبري">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-section">
                            <h3 class="form-section-title">إعدادات الحفظ التلقائي</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="auto-save">الحفظ التلقائي:</label>
                                    <select id="auto-save" class="form-control">
                                        <option value="enabled">مفعل</option>
                                        <option value="disabled">معطل</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="auto-save-interval">الفاصل الزمني للحفظ التلقائي (بالثواني):</label>
                                    <input type="number" id="auto-save-interval" class="form-control" value="60" min="30">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Appearance Tab -->
                    <div class="tab-content" id="appearance-tab">
                        <div class="form-section">
                            <h3 class="form-section-title">تخصيص المظهر</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="theme-mode">وضع السمة:</label>
                                    <select id="theme-mode" class="form-control" onchange="changeThemeMode(this.value)">
                                        <option value="light">فاتح</option>
                                        <option value="dark">داكن</option>
                                        <option value="auto">تلقائي (حسب إعدادات النظام)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>لون السمة الرئيسي:</label>
                                    <div class="theme-palette">
                                        <div class="color-option active" style="background-color: #1e40af;" data-color="#1e40af" onclick="changeThemeColor(this)"></div>
                                        <div class="color-option" style="background-color: #047857;" data-color="#047857" onclick="changeThemeColor(this)"></div>
                                        <div class="color-option" style="background-color: #7c3aed;" data-color="#7c3aed" onclick="changeThemeColor(this)"></div>
                                        <div class="color-option" style="background-color: #be123c;" data-color="#be123c" onclick="changeThemeColor(this)"></div>
                                        <div class="color-option" style="background-color: #a16207;" data-color="#a16207" onclick="changeThemeColor(this)"></div>
                                        <div class="color-option" style="background-color: #475569;" data-color="#475569" onclick="changeThemeColor(this)"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="font-size">حجم الخط:</label>
                                    <select id="font-size" class="form-control" onchange="changeFontSize(this.value)">
                                        <option value="small">صغير</option>
                                        <option value="medium" selected>متوسط</option>
                                        <option value="large">كبير</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="animation-setting">التأثيرات الحركية:</label>
                                    <select id="animation-setting" class="form-control" onchange="toggleAnimations(this.value)">
                                        <option value="enabled">مفعلة</option>
                                        <option value="reduced">مخفضة</option>
                                        <option value="disabled">معطلة</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Printing Tab -->
                    <div class="tab-content" id="printing-tab">
                        <div class="form-section">
                            <h3 class="form-section-title">إعدادات الطباعة</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="paper-size">حجم الورق:</label>
                                    <select id="paper-size" class="form-control">
                                        <option value="a4">A4</option>
                                        <option value="a5">A5</option>
                                        <option value="letter">Letter</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="print-orientation">اتجاه الطباعة:</label>
                                    <select id="print-orientation" class="form-control">
                                        <option value="portrait">عمودي</option>
                                        <option value="landscape">أفقي</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="print-header">رأس الصفحة:</label>
                                    <input type="text" id="print-header" class="form-control" value="مؤسسة أولاد الحسن ع الخيرية">
                                </div>
                                <div class="form-group">
                                    <label for="print-footer">تذييل الصفحة:</label>
                                    <input type="text" id="print-footer" class="form-control" value="جميع الحقوق محفوظة © 2025">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="print-qr-size">حجم رمز QR:</label>
                                    <select id="print-qr-size" class="form-control">
                                        <option value="small">صغير</option>
                                        <option value="medium" selected>متوسط</option>
                                        <option value="large">كبير</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="print-preview">معاينة الطباعة:</label>
                                    <select id="print-preview" class="form-control">
                                        <option value="enabled">تفعيل معاينة الطباعة قبل الطباعة</option>
                                        <option value="disabled">تعطيل المعاينة والطباعة مباشرة</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Tab -->
                    <div class="tab-content" id="advanced-tab">
                        <div class="form-section">
                            <h3 class="form-section-title">إعدادات متقدمة</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="case-id-format">صيغة رقم الحالة:</label>
                                    <select id="case-id-format" class="form-control">
                                        <option value="YYMMDD-NUM">YYMMDD-NUM (مثال: 250518-123)</option>
                                        <option value="YYYY-MM-NUM">YYYY-MM-NUM (مثال: 2025-05-123)</option>
                                        <option value="CUSTOM">تخصيص...</option>
                                    </select>
                                </div>
                                <div class="form-group" id="custom-format-container" style="display: none;">
                                    <label for="custom-case-id-format">الصيغة المخصصة:</label>
                                    <input type="text" id="custom-case-id-format" class="form-control" placeholder="e.g. CASE-[YYYY]-[NUM]">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="data-location">موقع تخزين البيانات:</label>
                                    <select id="data-location" class="form-control">
                                        <option value="localStorage">التخزين المحلي للمتصفح</option>
                                        <option value="indexedDB">قاعدة بيانات IndexedDB</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="case-lock-timeout">فترة قفل تحرير الحالة (بالدقائق):</label>
                                    <input type="number" id="case-lock-timeout" class="form-control" value="30" min="0">
                                    <small style="display: block; margin-top: 5px; color: #666;">0 = تعطيل قفل التحرير</small>
                                </div>
                            </div>
                        </div>
                        <div class="form-section">
                            <h3 class="form-section-title">إدارة البيانات</h3>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                                <button class="btn btn-warning" onclick="confirmClearCache()">
                                    <i class="fas fa-broom"></i>
                                    <span>مسح الذاكرة المؤقتة</span>
                                </button>
                                <button class="btn btn-danger" onclick="confirmResetAllData()">
                                    <i class="fas fa-trash"></i>
                                    <span>إعادة ضبط جميع البيانات</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="saveSettings()">
                        <i class="fas fa-save"></i>
                        <span>حفظ الإعدادات</span>
                    </button>
                    <button class="btn btn-light" onclick="closeModal('settings-modal')">
                        <i class="fas fa-times"></i>
                        <span>إلغاء</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Print Preview Container -->
        <div class="print-preview-container" id="print-preview-container">
            <div class="print-preview-content" id="print-preview-content">
                <!-- The print content will be inserted here -->
            </div>
            <div class="print-preview-close" onclick="closePrintPreview()">
                <i class="fas fa-times"></i>
            </div>
            <div class="print-preview-actions">
                <button class="btn btn-primary" onclick="printFromPreview()">
                    <i class="fas fa-print"></i>
                    <span>طباعة</span>
                </button>
                <button class="btn btn-light" onclick="closePrintPreview()">
                    <i class="fas fa-times"></i>
                    <span>إلغاء</span>
                </button>
            </div>
        </div>
    </div>
    


<!-- نموذج الطباعة المحدث لنظام إدارة الحالات -->
<div id="print-template" style="display: none;">
    <div class="print-container">
        <!-- الرأس -->
        <div class="print-header">
            <div class="header-right">
                <div>رمز الحالة: <span id="print-caseCode">مصاريف</span></div>
                <div>نوع الحالة: <span id="print-caseType">...............</span></div>
                <div>التاريخ: <span id="print-date"></span></div>
                <div>المنظم: <span id="print-organizer">محمد حسن</span></div>
            </div>
            <div class="header-center">
                <svg class="print-logo" viewBox="0 0 100 100">
                    <circle cx="50" cy="35" r="15" fill="#3498db" />
                    <path d="M30,60 Q50,80 70,60" stroke="#3498db" stroke-width="4" fill="none" />
                </svg>
                <div class="org-name">مؤسسة أولاد الحسن ع</div>
                <div class="form-title">استمارة معلومات الحالة</div>
                <div class="org-name">الخيرية</div>
            </div>
            <div class="header-left">
                <!-- QR code will be placed here if needed -->
                <div id="print-qrcode"></div>
            </div>
        </div>
        
        <!-- محتوى النموذج -->
        <div class="print-content">
            <!-- البيانات الشخصية -->
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">الاسم الكامل</span>
                    <div class="dotted-line" id="print-fullName"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">اللقب</span>
                    <div class="dotted-line" id="print-lastName"></div>
                </div>
            </div>
            
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">أبو / أم</span>
                    <span class="parentheses">(</span>
                    <div class="small-field" id="print-parentName"></div>
                    <span class="parentheses">)</span>
                </div>
                <div class="print-field">
                    <span class="field-label">العمر</span>
                    <span class="parentheses">(</span>
                    <div class="small-field" id="print-age"></div>
                    <span class="parentheses">)</span>
                </div>
                <div class="print-field">
                    <span class="field-label">الحالة الاجتماعية</span>
                    <span class="parentheses">(</span>
                    <div class="dotted-line" id="print-socialStatus"></div>
                    <span class="parentheses">)</span>
                </div>
            </div>
            
            <!-- شرح الحالة -->
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">شرح الحالة</span>
                    <div class="dotted-line" id="print-caseDescription"></div>
                </div>
            </div>
            
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">الموثق</span>
                    <div class="dotted-line" id="print-documentedBy"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">اسم المختار</span>
                    <div class="dotted-line" id="print-mukhtar"></div>
                </div>
            </div>
            
            <!-- المعلومات المالية -->
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">راتب حكومي</span>
                    <div class="dotted-line" id="print-govSalary"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">راتب مؤسسة</span>
                    <div class="dotted-line" id="print-orgSalary"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">مقدار الدخل</span>
                    <div class="dotted-line" id="print-incomeAmount"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">المصروفات</span>
                    <div class="dotted-line" id="print-expenses"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">باقي الدخل</span>
                    <div class="dotted-line" id="print-incomeRemaining"></div>
                </div>
            </div>
            
            <!-- معلومات السكن -->
            <div class="print-row">
                <div class="print-field" style="flex: 2;">
                    <span class="field-label">العنوان وأقرب نقطة دالة</span>
                    <div class="dotted-line" id="print-address"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">نوع السكن</span>
                    <div class="dotted-line" id="print-housingType"></div>
                </div>
            </div>
            
            <!-- عدد أفراد الأسرة -->
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">عدد أفراد الأسرة: الكلي</span>
                    <div class="dotted-line" id="print-totalFamilyMembers"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">بنين</span>
                    <div class="dotted-line" id="print-maleChildren"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">بنات</span>
                    <div class="dotted-line" id="print-femaleChildren"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">متزوجين</span>
                    <div class="dotted-line" id="print-married"></div>
                </div>
            </div>
            
            <!-- المعلومات الطبية -->
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">اسم المستشفى أو الحالة</span>
                    <div class="dotted-line" id="print-hospitalName"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">العنوان</span>
                    <div class="dotted-line" id="print-hospitalAddress"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">نوع الحالة</span>
                    <div class="dotted-line" id="print-caseTypeDetail"></div>
                </div>
            </div>
            
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">المبلغ رقماً</span>
                    <div class="dotted-line" id="print-amountNumeric"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">المبلغ كتابة</span>
                    <div class="dotted-line" id="print-amountWritten"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">المجموع</span>
                    <div class="dotted-line" id="print-totalAmount"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">اسم الدكتور</span>
                    <div class="dotted-line" id="print-doctorName"></div>
                </div>
            </div>
            
            <!-- معلومات الاتصال -->
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">رقم الهاتف الأول</span>
                    <div class="dotted-line" id="print-phoneFirst"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">رقم الهاتف الثاني</span>
                    <div class="dotted-line" id="print-phoneSecond"></div>
                </div>
            </div>
            
            <!-- معلومات الزوج/ة -->
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">الزوج/ة</span>
                    <div class="dotted-line" id="print-spouseName"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">اللقب</span>
                    <div class="dotted-line" id="print-spouseLastName"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">المهنة</span>
                    <div class="dotted-line" id="print-spouseOccupation"></div>
                </div>
                <div class="print-field">
                    <span class="field-label">الراتب</span>
                    <div class="dotted-line" id="print-spouseSalary"></div>
                </div>
            </div>
            
            <!-- معلومات إضافية -->
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">هل يوجد معيل آخر</span>
                    <div class="dotted-line" id="print-hasOtherSupport"></div>
                </div>
            </div>
            
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">الجهات التي تقوم بالمساعدة</span>
                    <div class="dotted-line" id="print-supportingAgencies"></div>
                </div>
            </div>
            
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">الملاحظات</span>
                    <div class="dotted-line" id="print-notes"></div>
                </div>
            </div>
            
            <!-- يصرف مبلغ المساعدة -->
            <div class="print-row">
                <div class="print-field">
                    <span class="field-label">يصرف مبلغ المساعدة المقدر</span>
                    <span class="parentheses">(</span>
                    <div class="dotted-line" id="print-estimatedAssistance" style="width: 80%;"></div>
                    <span class="parentheses">)</span>
                </div>
            </div>
        </div>
        
        <!-- القسم السفلي والتوقيعات -->
        <div class="print-footer">
            <div class="signature-row">
                <span class="signature-label">إدارة المؤسسة</span>
            </div>
            
            <div class="signature-row">
                <span>تم صرف مبلغ</span>
                <span class="parentheses">(</span>
                <div class="dotted-line" id="print-amountPaid" style="width: 150px; display: inline-block;"></div>
                <span class="parentheses">)</span>
                <span>بتاريخ</span>
                <div id="print-paymentDate" style="display: inline-block; margin: 0 5px;"></div>
            </div>
            
            <div class="signature-row">
                <p id="print-adminNames">السيد أسامة السعبري و السيد فؤاد السعبري</p>
                <div id="print-adminDate" style="display: inline-block;"></div>
            </div>
        </div>
    </div>
</div>





    <script>
      



// Global variables
let cases = {
    "سيد": [],
    "عام": [],
    "مصاريف": []
};
let caseCounter = 1;
let autoSaveInterval;
let settings = {
    orgName: "مؤسسة أولاد الحسن ع الخيرية",
    organizer: "محمد حسن",
    adminNames: "السيد أسامة السعبري والسيد فؤاد السعبري",
    autoSave: "enabled",
    autoSaveInterval: 60,
    themeMode: "light",
    themeColor: "#1e40af",
    fontSize: "medium",
    animations: "enabled",
    paperSize: "a4",
    printOrientation: "portrait",
    printHeader: "مؤسسة أولاد الحسن ع الخيرية",
    printFooter: "جميع الحقوق محفوظة © 2025",
    printQrSize: "medium",
    printPreview: "enabled",
    caseIdFormat: "YYMMDD-NUM",
    customCaseIdFormat: "",
    dataLocation: "localStorage",
    caseLockTimeout: 30,
    backupFrequency: "daily",
    backupCount: 5
};

// Names data for autocomplete
let namesData = [];

// Chart instances
let casesChart;
let reportChart;

// QR scanner
let qrScanner = null;

// Dark mode
let isDarkMode = false;

// Initialize the application
function initApp() {
    // Show loader
    showLoader();
    
    // Load settings from local storage
    loadSettings();
    
    // Apply theme settings
    applyThemeSettings();
    
    // Load cases from local storage
    loadCasesFromStorage();
    
    // Set current date in form
    setCurrentDate();
    
    // Generate a new case ID
    generateCaseId();
    
    // Update dashboard stats
    updateDashboardStats();
    
    // Create dashboard charts
    createDashboardCharts();
    
    // Setup autocomplete data
    setupAutocompleteData();
    
    // Add event listeners to financial fields
    setupFinancialListeners();
    
    // Add form validation
    setupFormValidation();
    
    // Add QR code generation
    generateQrCode(document.getElementById('caseId').value);
    
    // Setup case code change event
    document.getElementById('caseCode').addEventListener('change', updateCaseHeaderStyle);
    
    // Setup report type change event
    document.getElementById('report-type').addEventListener('change', handleReportTypeChange);
    
    // Setup search listeners
    setupSearchListeners();
    
    // Setup tab listeners
    setupTabListeners();
    
    // Setup auto-save
    startAutoSave();
    
    // Initialize modals
    initModals();
    
    // Initialize sidebar toggle
    initSidebar();
    
    // Setup scroll listeners
    setupScrollListeners();
    
    // Initialize amount formatter
    initAmountFormatter();
    
    // Update badges in sidebar
    updateSidebarBadges();
    
    // Hide loader after timeout
    setTimeout(hideLoader, 1000);
    
    // Set up advanced settings listeners
    setupAdvancedSettingsListeners();
    
    // Show welcome toast if first time
    showWelcomeToast();
}

// Show loader
function showLoader() {
    document.getElementById('loader').style.display = 'flex';
}

// Hide loader
function hideLoader() {
    const loader = document.getElementById('loader');
    loader.style.opacity = '0';
    setTimeout(() => {
        loader.style.display = 'none';
        loader.style.opacity = '1';
    }, 300);
}

// Load settings from local storage
function loadSettings() {
    const storedSettings = localStorage.getItem('charityAppSettings');
    if (storedSettings) {
        settings = { ...settings, ...JSON.parse(storedSettings) };
        
        // Apply settings to UI
        document.getElementById('setting-org-name').value = settings.orgName;
        document.getElementById('setting-organizer').value = settings.organizer;
        document.getElementById('setting-admin-names').value = settings.adminNames;
        document.getElementById('auto-save').value = settings.autoSave;
        document.getElementById('auto-save-interval').value = settings.autoSaveInterval;
        document.getElementById('theme-mode').value = settings.themeMode;
        document.getElementById('font-size').value = settings.fontSize;
        document.getElementById('animation-setting').value = settings.animations;
        document.getElementById('paper-size').value = settings.paperSize;
        document.getElementById('print-orientation').value = settings.printOrientation;
        document.getElementById('print-header').value = settings.printHeader;
        document.getElementById('print-footer').value = settings.printFooter;
        document.getElementById('print-qr-size').value = settings.printQrSize;
        document.getElementById('print-preview').value = settings.printPreview;
        document.getElementById('case-id-format').value = settings.caseIdFormat;
        document.getElementById('custom-case-id-format').value = settings.customCaseIdFormat;
        document.getElementById('data-location').value = settings.dataLocation;
        document.getElementById('case-lock-timeout').value = settings.caseLockTimeout;
        document.getElementById('backup-frequency').value = settings.backupFrequency;
        document.getElementById('backup-count').value = settings.backupCount;
        
        // Update organizer field
        document.getElementById('organizer').value = settings.organizer;
        
        // Show/hide custom format container
        if (settings.caseIdFormat === 'CUSTOM') {
            document.getElementById('custom-format-container').style.display = 'block';
        }
        
        // Update theme color
        const colorOptions = document.querySelectorAll('.color-option');
        colorOptions.forEach(option => {
            option.classList.remove('active');
            if (option.dataset.color === settings.themeColor) {
                option.classList.add('active');
            }
        });
    }
}

// Apply theme settings
function applyThemeSettings() {
    // Apply theme mode
    if (settings.themeMode === 'dark' || (settings.themeMode === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        enableDarkMode();
    } else {
        disableDarkMode();
    }
    
    // Apply theme color
    document.documentElement.style.setProperty('--primary-color', settings.themeColor);
    document.documentElement.style.setProperty('--primary-dark', adjustColor(settings.themeColor, -20));
    document.documentElement.style.setProperty('--primary-light', adjustColor(settings.themeColor, 20));
    
    // Apply font size
    let fontSizeValue = '1rem';
    switch (settings.fontSize) {
        case 'small':
            fontSizeValue = '0.875rem';
            break;
        case 'medium':
            fontSizeValue = '1rem';
            break;
        case 'large':
            fontSizeValue = '1.125rem';
            break;
    }
    document.documentElement.style.setProperty('--font-size', fontSizeValue);
    
    // Apply animations setting
    if (settings.animations === 'disabled') {
        document.body.classList.add('no-animations');
    } else if (settings.animations === 'reduced') {
        document.body.classList.add('reduced-animations');
    }
}

// Adjust color brightness
function adjustColor(color, amount) {
    return '#' + color.replace(/^#/, '').replace(/../g, color => ('0' + Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
}

// Save settings to local storage
function saveSettings() {
    settings.orgName = document.getElementById('setting-org-name').value;
    settings.organizer = document.getElementById('setting-organizer').value;
    settings.adminNames = document.getElementById('setting-admin-names').value;
    settings.autoSave = document.getElementById('auto-save').value;
    settings.autoSaveInterval = parseInt(document.getElementById('auto-save-interval').value);
    settings.themeMode = document.getElementById('theme-mode').value;
    settings.fontSize = document.getElementById('font-size').value;
    settings.animations = document.getElementById('animation-setting').value;
    settings.paperSize = document.getElementById('paper-size').value;
    settings.printOrientation = document.getElementById('print-orientation').value;
    settings.printHeader = document.getElementById('print-header').value;
    settings.printFooter = document.getElementById('print-footer').value;
    settings.printQrSize = document.getElementById('print-qr-size').value;
    settings.printPreview = document.getElementById('print-preview').value;
    settings.caseIdFormat = document.getElementById('case-id-format').value;
    settings.customCaseIdFormat = document.getElementById('custom-case-id-format').value;
    settings.dataLocation = document.getElementById('data-location').value;
    settings.caseLockTimeout = parseInt(document.getElementById('case-lock-timeout').value);
    
    localStorage.setItem('charityAppSettings', JSON.stringify(settings));
    
    // Apply new settings
    document.getElementById('organizer').value = settings.organizer;
    
    // Apply theme settings
    applyThemeSettings();
    
    // Restart auto-save with new interval
    stopAutoSave();
    startAutoSave();
    
    // Show success message
    showToast('تم حفظ الإعدادات بنجاح', 'success');
    
    // Close the modal
    closeModal('settings-modal');
}

// Save backup settings
function saveBackupSettings() {
    settings.backupFrequency = document.getElementById('backup-frequency').value;
    settings.backupCount = parseInt(document.getElementById('backup-count').value);
    
    localStorage.setItem('charityAppSettings', JSON.stringify(settings));
    
    showToast('تم حفظ إعدادات النسخ الاحتياطي بنجاح', 'success');
}

// Create manual backup
function createManualBackup() {
    const backupData = {
        cases: cases,
        caseCounter: caseCounter,
        date: new Date().toISOString(),
        settings: settings
    };
    
    const backupJson = JSON.stringify(backupData);
    const backupId = 'backup_' + new Date().toISOString().replace(/[:.]/g, '-');
    
    try {
        localStorage.setItem(backupId, backupJson);
        showToast('تم إنشاء نسخة احتياطية بنجاح', 'success');
        loadBackupsList();
    } catch (error) {
        showToast('حدث خطأ أثناء إنشاء النسخة الاحتياطية: ' + error.message, 'error');
    }
}

// Load backups list
function loadBackupsList() {
    const backupsList = document.getElementById('backups-list');
    backupsList.innerHTML = '';
    
    // Find all backup items in localStorage
    const backups = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('backup_')) {
            try {
                const backupData = JSON.parse(localStorage.getItem(key));
                backups.push({
                    id: key,
                    date: new Date(backupData.date),
                    size: (localStorage.getItem(key).length / 1024).toFixed(2) + ' KB',
                    caseCount: Object.values(backupData.cases).reduce((sum, arr) => sum + arr.length, 0)
                });
            } catch (error) {
                console.error('Error parsing backup:', error);
            }
        }
    }
    
    // Sort backups by date (newest first)
    backups.sort((a, b) => b.date - a.date);
    
    // Add to table
    if (backups.length === 0) {
        backupsList.innerHTML = '<tr><td colspan="4" style="text-align: center;">لا توجد نسخ احتياطية حتى الآن</td></tr>';
    } else {
        backups.forEach(backup => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDateTime(backup.date)}</td>
                <td>${backup.size}</td>
                <td>${backup.caseCount}</td>
                <td>
                    <div class="table-actions">
                        <button class="view-btn" onclick="restoreBackup('${backup.id}')">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="delete-btn" onclick="deleteBackup('${backup.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            backupsList.appendChild(row);
        });
    }
}

// Format date and time
function formatDateTime(date) {
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// Restore backup
function restoreBackup(backupId) {
    Swal.fire({
        title: 'استعادة النسخة الاحتياطية',
        text: 'سيتم استبدال جميع البيانات الحالية بالنسخة الاحتياطية. هل أنت متأكد؟',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'نعم، استعادة',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            try {
                const backupJson = localStorage.getItem(backupId);
                const backupData = JSON.parse(backupJson);
                
                // Restore data
                cases = backupData.cases;
                caseCounter = backupData.caseCounter;
                
                // Save to local storage
                saveCasesToStorage();
                
                // Update UI
                updateCasesList('سيد');
                updateCasesList('عام');
                updateCasesList('مصاريف');
                updateRecentCases();
                updateDashboardStats();
                setupAutocompleteData();
                updateSidebarBadges();
                createDashboardCharts();
                
                showToast('تم استعادة النسخة الاحتياطية بنجاح', 'success');
                closeModal('import-export-modal');
                showPage('dashboard');
            } catch (error) {
                showToast('حدث خطأ أثناء استعادة النسخة الاحتياطية: ' + error.message, 'error');
            }
        }
    });
}

// Delete backup
function deleteBackup(backupId) {
    Swal.fire({
        title: 'حذف النسخة الاحتياطية',
        text: 'هل أنت متأكد من حذف هذه النسخة الاحتياطية؟',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'نعم، حذف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            try {
                localStorage.removeItem(backupId);
                loadBackupsList();
                showToast('تم حذف النسخة الاحتياطية بنجاح', 'success');
            } catch (error) {
                showToast('حدث خطأ أثناء حذف النسخة الاحتياطية: ' + error.message, 'error');
            }
        }
    });
}

// Toggle dark mode
function toggleTheme() {
    if (isDarkMode) {
        disableDarkMode();
    } else {
        enableDarkMode();
    }
}

// Enable dark mode
function enableDarkMode() {
    isDarkMode = true;
    document.documentElement.classList.add('dark-mode');
    document.getElementById('theme-toggle-btn').innerHTML = '<i class="fas fa-sun"></i><span>وضع مضيء</span>';
}

// Disable dark mode
function disableDarkMode() {
    isDarkMode = false;
    document.documentElement.classList.remove('dark-mode');
    document.getElementById('theme-toggle-btn').innerHTML = '<i class="fas fa-moon"></i><span>وضع مظلم</span>';
}

// Change theme mode from settings
function changeThemeMode(mode) {
    settings.themeMode = mode;
    
    if (mode === 'dark') {
        enableDarkMode();
    } else if (mode === 'light') {
        disableDarkMode();
    } else if (mode === 'auto') {
        // Check system preference
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            enableDarkMode();
        } else {
            disableDarkMode();
        }
    }
}

// Change theme color
function changeThemeColor(element) {
    const colorOptions = document.querySelectorAll('.color-option');
    colorOptions.forEach(option => option.classList.remove('active'));
    
    element.classList.add('active');
    const color = element.dataset.color;
    settings.themeColor = color;
    
    document.documentElement.style.setProperty('--primary-color', color);
    document.documentElement.style.setProperty('--primary-dark', adjustColor(color, -20));
    document.documentElement.style.setProperty('--primary-light', adjustColor(color, 20));
}

// Change font size
function changeFontSize(size) {
    settings.fontSize = size;
    
    let fontSizeValue = '1rem';
    switch (size) {
        case 'small':
            fontSizeValue = '0.875rem';
            break;
        case 'medium':
            fontSizeValue = '1rem';
            break;
        case 'large':
            fontSizeValue = '1.125rem';
            break;
    }
    
    document.documentElement.style.setProperty('--font-size', fontSizeValue);
}

// Toggle animations
function toggleAnimations(setting) {
    settings.animations = setting;
    
    document.body.classList.remove('no-animations', 'reduced-animations');
    
    if (setting === 'disabled') {
        document.body.classList.add('no-animations');
    } else if (setting === 'reduced') {
        document.body.classList.add('reduced-animations');
    }
}

// Show welcome toast on first time
function showWelcomeToast() {
    const isFirstTime = localStorage.getItem('charityAppFirstVisit') !== 'false';
    
    if (isFirstTime) {
        // Display welcome message
        setTimeout(() => {
            showToast('مرحباً بك في النسخة المحدثة من نظام إدارة الحالات!', 'info', 8000);
        }, 1500);
        
        localStorage.setItem('charityAppFirstVisit', 'false');
    }
}

// Initialize sidebar toggle
function initSidebar() {
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const menuToggle = document.getElementById('menu-toggle');
    const appContainer = document.getElementById('app-container');
    
    sidebarToggle.addEventListener('click', function() {
        appContainer.classList.toggle('sidebar-collapsed');
        if (appContainer.classList.contains('sidebar-collapsed')) {
            sidebarToggle.innerHTML = '<i class="fas fa-chevron-left"></i>';
        } else {
            sidebarToggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
        }
    });
    
    // Mobile menu toggle
    menuToggle.addEventListener('click', function() {
        appContainer.classList.toggle('sidebar-open');
    });
}

// Initialize modals
function initModals() {
    // Close modals when clicking outside
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal(modal.id);
            }
        });
    });
    
    // Initialize tabs in modals
    setupTabListeners();
    
    // Load backups list when opening import/export modal
    document.querySelectorAll('.menu-link, .modal-close').forEach(element => {
        if (element.getAttribute('onclick') && element.getAttribute('onclick').includes('import-export-modal')) {
            element.addEventListener('click', function() {
                setTimeout(loadBackupsList, 100);
            });
        }
    });
}

// Setup tab listeners
function setupTabListeners() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const tabGroup = this.parentElement;
            const tabContents = tabGroup.parentElement.querySelectorAll('.tab-content');
            
            // Remove active class from all tabs in this group
            tabGroup.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Hide all tab contents
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Show the corresponding tab content
            const tabId = this.getAttribute('data-tab');
            const activeContent = document.getElementById(tabId + '-tab');
            if (activeContent) {
                activeContent.classList.add('active');
            }
        });
    });
}

// Setup advanced settings listeners
function setupAdvancedSettingsListeners() {
    document.getElementById('case-id-format').addEventListener('change', function() {
        const customFormatContainer = document.getElementById('custom-format-container');
        if (this.value === 'CUSTOM') {
            customFormatContainer.style.display = 'block';
        } else {
            customFormatContainer.style.display = 'none';
        }
    });
}

// Setup scroll listeners
function setupScrollListeners() {
    const backToTop = document.getElementById('back-to-top');
    
    // Show/hide back to top button
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTop.classList.add('visible');
        } else {
            backToTop.classList.remove('visible');
        }
    });
    
    // Scroll to top when clicked
    backToTop.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
}

// Initialize amount formatter for automatic text generation
function initAmountFormatter() {
    const amountNumeric = document.getElementById('amountNumeric');
    const amountWritten = document.getElementById('amountWritten');
    
    amountNumeric.addEventListener('input', function() {
        const amount = parseFloat(this.value) || 0;
        amountWritten.value = convertNumberToArabicWords(amount);
        
        // Also update total amount if they match
        const totalAmount = document.getElementById('totalAmount');
        if (parseFloat(totalAmount.value) === parseFloat(this.value) || totalAmount.value === '' || totalAmount.value === '0') {
            totalAmount.value = this.value;
        }
    });
}

// Convert number to Arabic words
function convertNumberToArabicWords(number) {
    // Simple implementation for demo purposes
    // In a real app, you would use a more comprehensive library
    const units = ['', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة', 'عشرة'];
    const tens = ['', 'عشر', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
    const hundreds = ['', 'مائة', 'مائتان', 'ثلاثمائة', 'أربعمائة', 'خمسمائة', 'ستمائة', 'سبعمائة', 'ثمانمائة', 'تسعمائة'];
    const thousands = ['', 'ألف', 'ألفان', 'ثلاثة آلاف', 'أربعة آلاف', 'خمسة آلاف', 'ستة آلاف', 'سبعة آلاف', 'ثمانية آلاف', 'تسعة آلاف'];
    
    if (number === 0) return 'صفر';
    if (number < 11) return units[number] + ' فقط';
    if (number < 100) {
        const unit = number % 10;
        const ten = Math.floor(number / 10);
        if (unit === 0) return tens[ten] + ' فقط';
        return units[unit] + ' و' + tens[ten] + ' فقط';
    }
    if (number < 1000) {
        const hundred = Math.floor(number / 100);
        const remainder = number % 100;
        if (remainder === 0) return hundreds[hundred] + ' فقط';
        return hundreds[hundred] + ' و' + convertNumberToArabicWords(remainder);
    }
    if (number < 10000) {
        const thousand = Math.floor(number / 1000);
        const remainder = number % 1000;
        if (remainder === 0) return thousands[thousand] + ' فقط';
        return thousands[thousand] + ' و' + convertNumberToArabicWords(remainder);
    }
    
    return number.toString() + ' فقط';
}

// Load cases from local storage
function loadCasesFromStorage() {
    const storedSayedCases = localStorage.getItem('sayedCases');
    const storedAmmCases = localStorage.getItem('ammCases');
    const storedMasareefCases = localStorage.getItem('masareefCases');
    const storedCaseCounter = localStorage.getItem('caseCounter');
    
    if (storedSayedCases) {
        cases['سيد'] = JSON.parse(storedSayedCases);
    }
    
    if (storedAmmCases) {
        cases['عام'] = JSON.parse(storedAmmCases);
    }
    
    if (storedMasareefCases) {
        cases['مصاريف'] = JSON.parse(storedMasareefCases);
    }
    
    if (storedCaseCounter) {
        caseCounter = parseInt(storedCaseCounter);
    }
    
    // Update case lists
    updateCasesList('سيد');
    updateCasesList('عام');
    updateCasesList('مصاريف');
    updateRecentCases();
}

// Save cases to local storage
function saveCasesToStorage() {
    localStorage.setItem('sayedCases', JSON.stringify(cases['سيد']));
    localStorage.setItem('ammCases', JSON.stringify(cases['عام']));
    localStorage.setItem('masareefCases', JSON.stringify(cases['مصاريف']));
    localStorage.setItem('caseCounter', caseCounter.toString());
}

// Generate a new unique case ID
function generateCaseId() {
    const caseIdField = document.getElementById('caseId');
    const currentDate = new Date();
    let caseId = '';
    
    // Generate case ID based on format settings
    switch (settings.caseIdFormat) {
        case 'YYMMDD-NUM':
            const year = currentDate.getFullYear().toString().substr(-2);
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            caseId = `${year}${month}${day}-${caseCounter}`;
            break;
        case 'YYYY-MM-NUM':
            const fullYear = currentDate.getFullYear();
            const monthNum = String(currentDate.getMonth() + 1).padStart(2, '0');
            caseId = `${fullYear}-${monthNum}-${caseCounter}`;
            break;
        case 'CUSTOM':
            // Replace placeholders in custom format
            let customFormat = settings.customCaseIdFormat || 'CASE-[YYYY]-[NUM]';
            customFormat = customFormat.replace('[YYYY]', currentDate.getFullYear());
            customFormat = customFormat.replace('[YY]', currentDate.getFullYear().toString().substr(-2));
            customFormat = customFormat.replace('[MM]', String(currentDate.getMonth() + 1).padStart(2, '0'));
            customFormat = customFormat.replace('[DD]', String(currentDate.getDate()).padStart(2, '0'));
            customFormat = customFormat.replace('[NUM]', caseCounter);
            caseId = customFormat;
            break;
        default:
            // Default to YYmmDD-NUM
            const defaultYear = currentDate.getFullYear().toString().substr(-2);
            const defaultMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            const defaultDay = String(currentDate.getDate()).padStart(2, '0');
            caseId = `${defaultYear}${defaultMonth}${defaultDay}-${caseCounter}`;
    }
    
    caseIdField.value = caseId;
    return caseId;
}

// Set current date in the form
function setCurrentDate() {
    const today = new Date();
    const formattedDate = today.toISOString().substr(0, 10);
    document.getElementById('caseDate').value = formattedDate;
    
    // Format for display
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    
    document.getElementById('admin-date').textContent = day + ' / ' + month + ' / ' + year;
}

// Setup autocomplete data
function setupAutocompleteData() {
    const datalist = document.getElementById('namesDatalist');
    datalist.innerHTML = '';
    
    // Get all unique names from cases
    const allNames = new Set();
    
    Object.values(cases).forEach(caseArray => {
        caseArray.forEach(caseItem => {
            if (caseItem.fullName) {
                allNames.add(caseItem.fullName);
            }
        });
    });
    
    // Add names to the namesData array
    namesData = Array.from(allNames);
    
    // Add options to datalist
    namesData.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        datalist.appendChild(option);
    });
    
    // Add input event for autocomplete
    document.getElementById('fullName').addEventListener('input', function(e) {
        const input = e.target.value.toLowerCase();
        if (input.length < 2) return;
        
        // Auto fill other fields if name exists
        const matchingCase = findCaseByName(input);
        if (matchingCase) {
            fillFormWithExistingData(matchingCase);
        }
    });
}

// Find case by name (partial match)
function findCaseByName(partialName) {
    partialName = partialName.toLowerCase();
    
    for (const caseType in cases) {
        for (const caseItem of cases[caseType]) {
            if (caseItem.fullName && caseItem.fullName.toLowerCase().includes(partialName)) {
                return caseItem;
            }
        }
    }
    
    return null;
}

// Fill form with existing data
function fillFormWithExistingData(caseData) {
    // Don't override the newly generated caseId
    const currentCaseId = document.getElementById('caseId').value;
    
    // Fill all form fields except caseId
    document.getElementById('caseCode').value = caseData.caseCode || 'مصاريف';
    document.getElementById('caseType').value = caseData.caseType || '';
    document.getElementById('lastName').value = caseData.lastName || '';
    document.getElementById('parentName').value = caseData.parentName || '';
    document.getElementById('age').value = caseData.age || '';
    document.getElementById('socialStatus').value = caseData.socialStatus || '';
    document.getElementById('caseDescription').value = caseData.caseDescription || '';
    document.getElementById('documentedBy').value = caseData.documentedBy || '';
    document.getElementById('mukhtar').value = caseData.mukhtar || '';
    document.getElementById('govSalary').value = caseData.govSalary || 0;
    document.getElementById('orgSalary').value = caseData.orgSalary || 0;
    document.getElementById('incomeAmount').value = caseData.incomeAmount || 0;
    document.getElementById('expenses').value = caseData.expenses || 0;
    document.getElementById('address').value = caseData.address || '';
    document.getElementById('housingType').value = caseData.housingType || 'ملك';
    document.getElementById('totalFamilyMembers').value = caseData.totalFamilyMembers || 0;
    document.getElementById('maleChildren').value = caseData.maleChildren || 0;
    document.getElementById('femaleChildren').value = caseData.femaleChildren || 0;
    document.getElementById('married').value = caseData.married || 0;
    document.getElementById('hospitalName').value = caseData.hospitalName || '';
    document.getElementById('hospitalAddress').value = caseData.hospitalAddress || '';
    document.getElementById('caseTypeDetail').value = caseData.caseTypeDetail || '';
    document.getElementById('amountNumeric').value = caseData.amountNumeric || 0;
    document.getElementById('amountWritten').value = caseData.amountWritten || '';
    document.getElementById('totalAmount').value = caseData.totalAmount || 0;
    document.getElementById('doctorName').value = caseData.doctorName || '';
    document.getElementById('phoneFirst').value = caseData.phoneFirst || '';
    document.getElementById('phoneSecond').value = caseData.phoneSecond || '';
    document.getElementById('spouseName').value = caseData.spouseName || '';
    document.getElementById('spouseLastName').value = caseData.spouseLastName || '';
    document.getElementById('spouseOccupation').value = caseData.spouseOccupation || '';
    document.getElementById('spouseSalary').value = caseData.spouseSalary || '';
    document.getElementById('hasOtherSupport').value = caseData.hasOtherSupport || 'لا';
    document.getElementById('supportingAgencies').value = caseData.supportingAgencies || '';
    document.getElementById('notes').value = caseData.notes || '';
    document.getElementById('estimatedAssistance').value = caseData.estimatedAssistance || '';
    document.getElementById('amountPaid').value = caseData.amountPaid || '';
    
    if (caseData.paymentDate) {
        document.getElementById('paymentDate').value = caseData.paymentDate;
    }
    
    // Calculate remaining income
    calculateRemainingIncome();
    
    // Update case header style
    updateCaseHeaderStyle();
    
    // Show toast notification
    showToast('تم ملء النموذج ببيانات المستفيد السابقة', 'info');
}

// Setup financial field listeners
function setupFinancialListeners() {
    const financialFields = ['govSalary', 'orgSalary', 'incomeAmount', 'expenses'];
    financialFields.forEach(field => {
        document.getElementById(field).addEventListener('input', calculateRemainingIncome);
    });
}

// Calculate remaining income
function calculateRemainingIncome() {
    const govSalary = parseFloat(document.getElementById('govSalary').value) || 0;
    const orgSalary = parseFloat(document.getElementById('orgSalary').value) || 0;
    const incomeAmount = parseFloat(document.getElementById('incomeAmount').value) || 0;
    const expenses = parseFloat(document.getElementById('expenses').value) || 0;
    
    const totalIncome = govSalary + orgSalary + incomeAmount;
    const remaining = totalIncome - expenses;
    
    document.getElementById('incomeRemaining').value = remaining;
}

// Update case header style based on case code
function updateCaseHeaderStyle() {
    const caseCode = document.getElementById('caseCode').value;
    const caseHeader = document.getElementById('case-header');
    
    // Remove all case type classes
    caseHeader.classList.remove('سيد', 'عام', 'مصاريف');
    
    // Add the appropriate class
    caseHeader.classList.add(caseCode);
}

// Setup form validation
function setupFormValidation() {
    const form = document.getElementById('case-form');
    
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        
        if (validateForm()) {
            saveCase();
        }
    });
}

// Validate form before submission
function validateForm() {
    const requiredFields = document.querySelectorAll('[required]');
    let isValid = true;
    let firstInvalidField = null;
    
    requiredFields.forEach(field => {
        field.classList.remove('error');
        
        if (!field.value.trim()) {
            field.classList.add('error');
            isValid = false;
            if (!firstInvalidField) firstInvalidField = field;
        }
        
        // Validate numbers
        if (field.type === 'number' && field.value < 0) {
            field.classList.add('error');
            isValid = false;
            if (!firstInvalidField) firstInvalidField = field;
        }
    });
    
    if (!isValid) {
        showToast('الرجاء ملء جميع الحقول المطلوبة', 'error');
        // Scroll to first invalid field
        if (firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    return isValid;
}

// Save case data
function saveCase() {
    // Show loading
    showLoader();
    
    // Get form data
    const formData = getFormData();
    
    // Get case code (سيد, عام, مصاريف)
    const caseCode = formData.caseCode;
    
    // Add or update case
    const existingCaseIndex = cases[caseCode].findIndex(c => c.caseId === formData.caseId);
    
    if (existingCaseIndex !== -1) {
        // Update existing case
        cases[caseCode][existingCaseIndex] = formData;
        
        // Hide loading
        hideLoader();
        
        // Show success message
        showToast('تم تحديث الحالة بنجاح', 'success');
    } else {
        // Add new case
        cases[caseCode].push(formData);
        // Increment counter for next case
        caseCounter++;
        
        // Hide loading
        hideLoader();
        
        // Show success message with animation
        Swal.fire({
            icon: 'success',
            title: 'تم حفظ الحالة بنجاح',
            text: 'تم إضافة حالة جديدة برقم: ' + formData.caseId,
            showConfirmButton: true,
            timer: 3000,
            timerProgressBar: true,
            confirmButtonText: 'موافق'
        }).then(() => {
            // Reset form for a new case
            resetForm();
        });
    }
    
    // Save to local storage
    saveCasesToStorage();
    
    // Update case lists
    updateCasesList(caseCode);
    updateRecentCases();
    
    // Update dashboard stats
    updateDashboardStats();
    
    // Update dashboard charts
    updateDashboardCharts();
    
    // Update autocomplete data
    setupAutocompleteData();
    
    // Update sidebar badges
    updateSidebarBadges();
    
    // Generate QR code
    generateQrCode(formData.caseId);
}

// Get all form data as an object
function getFormData() {
    const form = document.getElementById('case-form');
    const formData = {};
    
    // Get all form elements
    Array.from(form.elements).forEach(element => {
        if (element.name && element.name !== 'submit') {
            formData[element.name] = element.value;
        }
    });
    
    // Add the date in ISO format for sorting
    if (formData.caseDate) {
        formData.caseDateISO = new Date(formData.caseDate).toISOString();
    }
    
    return formData;
}

// Reset the form
function resetForm() {
    document.getElementById('case-form').reset();
    
    // Set default values
    setCurrentDate();
    document.getElementById('caseCode').value = 'مصاريف';
    document.getElementById('housingType').value = 'ملك';
    document.getElementById('hasOtherSupport').value = 'لا';
    
    // Generate new case ID
    generateCaseId();
    
    // Calculate remaining income
    calculateRemainingIncome();
    
    // Update case header style
    updateCaseHeaderStyle();
    
    // Generate QR code
    generateQrCode(document.getElementById('caseId').value);
    
    // Remove error classes
    const errorFields = document.querySelectorAll('.error');
    errorFields.forEach(field => field.classList.remove('error'));
}

// Print form using print preview
function printPreview() {
    // Get the form content
    const formContainer = document.querySelector('.form-container').cloneNode(true);
    
    // Enable all form fields for printing
    const formFields = formContainer.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
        field.disabled = false;
    });
    
    // Add to print preview container
    const printPreviewContent = document.getElementById('print-preview-content');
    printPreviewContent.innerHTML = '';
    printPreviewContent.appendChild(formContainer);
    
    // Show print preview
    document.getElementById('print-preview-container').style.display = 'flex';
}

// Close print preview
function closePrintPreview() {
    document.getElementById('print-preview-container').style.display = 'none';
}
/**
 * تحديث دالة الطباعة من المعاينة
 */
function printFromPreview() {
    // تنظيف الصفحة من أي عناصر إضافية قد تسبب طباعة صفحتين
    const printContent = document.getElementById('print-preview-content');
    const printContainer = printContent.querySelector('.print-container');
    
    // تعيين محتوى المعاينة ليكون فقط نموذج الطباعة
    if (printContainer) {
        const tempContainer = printContainer.cloneNode(true);
        printContent.innerHTML = '';
        printContent.appendChild(tempContainer);
    }
    
    // تنفيذ الطباعة بعد التأكد من تنظيف المحتوى
    setTimeout(() => {
        window.print();
    }, 100);
}
// Generate QR Code - FIXED FUNCTION
function generateQrCode(caseId) {
    try {
        const qrCodeContainer = document.getElementById('case-qrcode');
        qrCodeContainer.innerHTML = '';
        
        // Create VERY simplified QR code with just the ID to avoid overflow
        // Removed complex JSON structure that caused overflow error
        
        // Create new QR code with error correction level L (lowest) for more data capacity
        new QRCode(qrCodeContainer, {
            text: caseId, // Just use the ID as plain text
            width: 128,
            height: 128,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.L
        });
    } catch (error) {
        console.error("Error generating QR code:", error);
        // Fallback display in case QR code generation fails
        const qrCodeContainer = document.getElementById('case-qrcode');
        qrCodeContainer.innerHTML = `
            <div style="padding: 10px; text-align: center; border: 1px dashed #ccc; border-radius: 8px;">
                <p style="margin: 0;">رقم الحالة: ${caseId}</p>
            </div>
        `;
    }
}

// Update dashboard stats
function updateDashboardStats() {
    const sayedCount = cases['سيد'].length;
    const ammCount = cases['عام'].length;
    const masareefCount = cases['مصاريف'].length;
    const totalCount = sayedCount + ammCount + masareefCount;
    
    // Update counters with animation
    animateCounter('sayed-count', sayedCount);
    animateCounter('amm-count', ammCount);
    animateCounter('masareef-count', masareefCount);
    animateCounter('total-count', totalCount);
}

// Animate counter
function animateCounter(elementId, targetValue) {
    const element = document.getElementById(elementId);
    const currentValue = parseInt(element.textContent) || 0;
    const duration = 1000; // 1 second
    const steps = 20;
    const stepValue = (targetValue - currentValue) / steps;
    let currentStep = 0;
    
    const interval = setInterval(() => {
        currentStep++;
        const value = Math.floor(currentValue + stepValue * currentStep);
        element.textContent = value;
        
        if (currentStep === steps) {
            element.textContent = targetValue;
            clearInterval(interval);
        }
    }, duration / steps);
}

// Create dashboard charts
function createDashboardCharts() {
    const ctx = document.getElementById('cases-chart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (casesChart) {
        casesChart.destroy();
    }
    
    // Calculate monthly data
    const monthlyData = getMonthlyData();
    
    // Create new chart
    casesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'],
            datasets: [
                {
                    label: 'حالات سيد',
                    data: monthlyData.sayed,
                    backgroundColor: 'rgba(16, 185, 129, 0.7)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1
                },
                {
                    label: 'حالات عام',
                    data: monthlyData.amm,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                },
                {
                    label: 'حالات مصاريف',
                    data: monthlyData.masareef,
                    backgroundColor: 'rgba(245, 158, 11, 0.7)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            family: "'Tajawal', sans-serif",
                            size: 14
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'توزيع الحالات حسب الشهر',
                    font: {
                        family: "'Tajawal', sans-serif",
                        size: 16,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    bodyFont: {
                        family: "'Tajawal', sans-serif"
                    },
                    titleFont: {
                        family: "'Tajawal', sans-serif"
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            family: "'Tajawal', sans-serif"
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: {
                            family: "'Tajawal', sans-serif"
                        }
                    }
                }
            }
        }
    });
}

// Update dashboard charts
function updateDashboardCharts() {
    // Get monthly data
    const monthlyData = getMonthlyData();
    
    // Update chart data
    if (casesChart) {
        casesChart.data.datasets[0].data = monthlyData.sayed;
        casesChart.data.datasets[1].data = monthlyData.amm;
        casesChart.data.datasets[2].data = monthlyData.masareef;
        casesChart.update();
    }
}

// Get monthly data for charts
function getMonthlyData() {
    const currentYear = new Date().getFullYear();
    const months = Array(12).fill(0);
    
    const sayedMonthly = [...months];
    const ammMonthly = [...months];
    const masareefMonthly = [...months];
    
    // Count cases by month
    for (const caseItem of cases['سيد']) {
        if (caseItem.caseDate) {
            const date = new Date(caseItem.caseDate);
            if (date.getFullYear() === currentYear) {
                sayedMonthly[date.getMonth()]++;
            }
        }
    }
    
    for (const caseItem of cases['عام']) {
        if (caseItem.caseDate) {
            const date = new Date(caseItem.caseDate);
            if (date.getFullYear() === currentYear) {
                ammMonthly[date.getMonth()]++;
            }
        }
    }
    
    for (const caseItem of cases['مصاريف']) {
        if (caseItem.caseDate) {
            const date = new Date(caseItem.caseDate);
            if (date.getFullYear() === currentYear) {
                masareefMonthly[date.getMonth()]++;
            }
        }
    }
    
    return {
        sayed: sayedMonthly,
        amm: ammMonthly,
        masareef: masareefMonthly  // Fixed typo: changed "areef" to "masareef"
    };
}

// Update sidebar badges
function updateSidebarBadges() {
    document.getElementById('sayed-badge').textContent = cases['سيد'].length;
    document.getElementById('amm-badge').textContent = cases['عام'].length;
    document.getElementById('masareef-badge').textContent = cases['مصاريف'].length;
    document.getElementById('total-badge').textContent = cases['سيد'].length + cases['عام'].length + cases['مصاريف'].length;
}

// Update cases list for a specific type
function updateCasesList(caseType) {
    const casesList = cases[caseType] || [];
    let tbodyId;
    
    // Get the appropriate tbody
    switch (caseType) {
        case 'سيد':
            tbodyId = 'sayed-cases-tbody';
            break;
        case 'عام':
            tbodyId = 'amm-cases-tbody';
            break;
        case 'مصاريف':
            tbodyId = 'masareef-cases-tbody';
            break;
        default:
            return;
    }
    
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;
    
    // Clear the table
    tbody.innerHTML = '';
    
    // Sort cases by date (newest first)
    const sortedCases = [...casesList].sort((a, b) => {
        return new Date(b.caseDateISO || b.caseDate) - new Date(a.caseDateISO || a.caseDate);
    });
    
    // Add cases to the table
    sortedCases.forEach(caseItem => {
        const row = document.createElement('tr');
        
        // Format date
        const caseDate = new Date(caseItem.caseDate);
        const formattedDate = `${caseDate.getDate()}/${caseDate.getMonth() + 1}/${caseDate.getFullYear()}`;
        
        // Add row with animation
        row.classList.add('fade-in');
        row.innerHTML = `
            <td>${caseItem.caseId}</td>
            <td>${formattedDate}</td>
            <td>${caseItem.fullName}</td>
            <td>${caseItem.caseType}</td>
            <td>${formatCurrency(caseItem.amountNumeric)}</td>
            <td>
                <div class="table-actions">
                    <button class="view-btn" onclick="viewCase('${caseItem.caseId}', '${caseType}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="edit-btn" onclick="editCase('${caseItem.caseId}', '${caseType}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn" onclick="confirmDeleteCase('${caseItem.caseId}', '${caseType}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Also update the all cases table
    updateAllCasesTable();
}

// Format currency
function formatCurrency(value) {
    return parseFloat(value).toLocaleString('ar-IQ') + ' د.ع';
}

// Update all cases table
function updateAllCasesTable() {
    const tbody = document.getElementById('all-cases-tbody');
    if (!tbody) return;
    
    // Clear the table
    tbody.innerHTML = '';
    
    // Combine all cases
    const allCases = [
        ...cases['سيد'],
        ...cases['عام'],
        ...cases['مصاريف']
    ];
    
    // Sort cases by date (newest first)
    const sortedCases = allCases.sort((a, b) => {
        return new Date(b.caseDateISO || b.caseDate) - new Date(a.caseDateISO || a.caseDate);
    });
    
    // Add cases to the table
    sortedCases.forEach(caseItem => {
        const row = document.createElement('tr');
        
        // Format date
        const caseDate = new Date(caseItem.caseDate);
        const formattedDate = `${caseDate.getDate()}/${caseDate.getMonth() + 1}/${caseDate.getFullYear()}`;
        
        // Get badge class
        let badgeClass = '';
        switch (caseItem.caseCode) {
            case 'سيد':
                badgeClass = 'badge-sayed';
                break;
            case 'عام':
                badgeClass = 'badge-amm';
                break;
            case 'مصاريف':
                badgeClass = 'badge-masareef';
                break;
        }
        
        // Add row with animation
        row.classList.add('fade-in');
        row.innerHTML = `
            <td>${caseItem.caseId}</td>
            <td>${formattedDate}</td>
            <td>${caseItem.fullName}</td>
            <td><span class="badge ${badgeClass}">${caseItem.caseCode}</span></td>
            <td>${caseItem.caseType}</td>
            <td>${formatCurrency(caseItem.amountNumeric)}</td>
            <td>
                <div class="table-actions">
                    <button class="view-btn" onclick="viewCase('${caseItem.caseId}', '${caseItem.caseCode}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="edit-btn" onclick="editCase('${caseItem.caseId}', '${caseItem.caseCode}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn" onclick="confirmDeleteCase('${caseItem.caseId}', '${caseItem.caseCode}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// Update recent cases on dashboard
function updateRecentCases() {
    const tbody = document.getElementById('recent-cases-tbody');
    if (!tbody) return;
    
    // Clear the table
    tbody.innerHTML = '';
    
    // Combine all cases
    const allCases = [
        ...cases['سيد'],
        ...cases['عام'],
        ...cases['مصاريف']
    ];
    
    // Sort cases by date (newest first)
    const sortedCases = allCases.sort((a, b) => {
        return new Date(b.caseDateISO || b.caseDate) - new Date(a.caseDateISO || a.caseDate);
    });
    
    // Take the most recent 5 cases
    const recentCases = sortedCases.slice(0, 5);
    
    // Add cases to the table
    recentCases.forEach((caseItem, index) => {
        const row = document.createElement('tr');
        
        // Format date
        const caseDate = new Date(caseItem.caseDate);
        const formattedDate = `${caseDate.getDate()}/${caseDate.getMonth() + 1}/${caseDate.getFullYear()}`;
        
        // Get badge class
        let badgeClass = '';
        switch (caseItem.caseCode) {
            case 'سيد':
                badgeClass = 'badge-sayed';
                break;
            case 'عام':
                badgeClass = 'badge-amm';
                break;
            case 'مصاريف':
                badgeClass = 'badge-masareef';
                break;
        }
        
        // Add row with staggered animation
        row.classList.add('slide-in-right');
        row.style.animationDelay = `${index * 0.1}s`;
        row.innerHTML = `
            <td>${caseItem.caseId}</td>
            <td>${formattedDate}</td>
            <td>${caseItem.fullName}</td>
            <td><span class="badge ${badgeClass}">${caseItem.caseCode}</span></td>
            <td>${formatCurrency(caseItem.amountNumeric)}</td>
            <td>
                <div class="table-actions">
                    <button class="view-btn" onclick="viewCase('${caseItem.caseId}', '${caseItem.caseCode}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="edit-btn" onclick="editCase('${caseItem.caseId}', '${caseItem.caseCode}')">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Show message if no cases
    if (recentCases.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                لا توجد حالات مضافة بعد. قم بإضافة حالة جديدة من خلال الضغط على زر "إضافة حالة"
            </td>
        `;
        tbody.appendChild(row);
    }
}

// View case details
function viewCase(caseId, caseType) {
    const caseItem = findCaseById(caseId, caseType);
    
    if (caseItem) {
        // Show the form page
        showPage('new-case');
        
        // Fill the form with case data
        fillFormWithCaseData(caseItem);
        
        // Disable form fields for view mode
        toggleFormFields(true);
        
        // Update form actions
        const formActions = document.querySelector('.form-actions');
        formActions.innerHTML = `
            <button type="button" class="btn btn-primary" onclick="editCase('${caseId}', '${caseType}')">
                <i class="fas fa-edit"></i>
                <span>تعديل الحالة</span>
            </button>
            <button type="button" class="btn btn-success" onclick="printPreview()">
                <i class="fas fa-print"></i>
                <span>طباعة الاستمارة</span>
            </button>
            <button type="button" class="btn btn-warning" onclick="shareCase('${caseId}')">
                <i class="fas fa-share-alt"></i>
                <span>مشاركة الحالة</span>
            </button>
            <button type="button" class="btn btn-light" onclick="showPage('cases')">
                <i class="fas fa-arrow-right"></i>
                <span>العودة</span>
            </button>
        `;
    }
}

// Share case
function shareCase(caseId) {
    // Create a temporary textarea element for copying the link
    const tempInput = document.createElement('input');
    const shareLink = `${window.location.origin}${window.location.pathname}?case=${caseId}`;
    
    // Set the value of the textarea to the share link
    tempInput.value = shareLink;
    
    // Append the textarea to the document
    document.body.appendChild(tempInput);
    
    // Select and copy the text from the textarea
    tempInput.select();
    document.execCommand('copy');
    
    // Remove the textarea
    document.body.removeChild(tempInput);
    
    // Show success message
    showToast('تم نسخ رابط الحالة إلى الحافظة', 'success');
}

// Edit case
function editCase(caseId, caseType) {
    const caseItem = findCaseById(caseId, caseType);
    
    if (caseItem) {
        // Show the form page
        showPage('new-case');
        
        // Fill the form with case data
        fillFormWithCaseData(caseItem);
        
        // Enable form fields
        toggleFormFields(false);
        
        // Update form actions
        const formActions = document.querySelector('.form-actions');
        formActions.innerHTML = `
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i>
                <span>حفظ التعديلات</span>
            </button>
            <button type="button" class="btn btn-primary" onclick="printPreview()">
                <i class="fas fa-print"></i>
                <span>طباعة الاستمارة</span>
            </button>
            <button type="button" class="btn btn-light" onclick="showPage('cases')">
                <i class="fas fa-arrow-right"></i>
                <span>العودة</span>
            </button>
        `;
    }
}

// Fill the form with case data
function fillFormWithCaseData(caseItem) {
    // Fill all form fields
    for (const key in caseItem) {
        const field = document.getElementById(key);
        if (field) {
            field.value = caseItem[key];
        }
    }
    
    // Calculate remaining income
    calculateRemainingIncome();
    
    // Update case header style
    updateCaseHeaderStyle();
    
    // Generate QR code
    generateQrCode(caseItem.caseId);
}

// Toggle form fields (enable/disable)
function toggleFormFields(disabled) {
    const formElements = document.querySelectorAll('#case-form input, #case-form select, #case-form textarea');
    
    formElements.forEach(element => {
        element.disabled = disabled;
    });
    
    // Always disable the case ID field
    document.getElementById('caseId').disabled = true;
}

// Find case by ID
function findCaseById(caseId, caseType) {
    return cases[caseType].find(c => c.caseId === caseId);
}

// Confirm case deletion
function confirmDeleteCase(caseId, caseType) {
    Swal.fire({
        title: 'تأكيد الحذف',
        text: 'هل أنت متأكد من رغبتك في حذف هذه الحالة؟',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#3b82f6',
        confirmButtonText: 'نعم، حذف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            deleteCase(caseId, caseType);
        }
    });
}

// Delete case
function deleteCase(caseId, caseType) {
    // Find the index of the case
    const caseIndex = cases[caseType].findIndex(c => c.caseId === caseId);
    
    if (caseIndex !== -1) {
        // Remove the case from the array
        cases[caseType].splice(caseIndex, 1);
        
        // Save to local storage
        saveCasesToStorage();
        
        // Update UI
        updateCasesList(caseType);
        updateRecentCases();
        updateDashboardStats();
        updateDashboardCharts();
        updateSidebarBadges();
        
        // Show success message
        showToast('تم حذف الحالة بنجاح', 'success');
    }
}

// Add a new case of specific type
function addNewCase(caseType) {
    // Show the form page
    showPage('new-case');
    
    // Reset the form
    resetForm();
    
    // Set the case code
    document.getElementById('caseCode').value = caseType;
    
    // Update case header style
    updateCaseHeaderStyle();
}

// Save case automatically
function startAutoSave() {
    if (settings.autoSave === 'enabled') {
        autoSaveInterval = setInterval(() => {
            const form = document.getElementById('case-form');
            if (form && !document.getElementById('caseId').disabled) {
                // Check if form is visible
                if (document.getElementById('new-case-page').style.display !== 'none') {
                    // Check if form is valid
                    if (form.checkValidity()) {
                        saveCase();
                        showToast('تم حفظ الحالة تلقائياً', 'info', 2000);
                    }
                }
            }
        }, settings.autoSaveInterval * 1000);
    }
}

// Stop auto save
function stopAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
}

// Show a specific page
function showPage(pageId) {
    // Hide all pages
    const pages = document.querySelectorAll('.form-page, .dashboard');
    pages.forEach(page => {
        page.style.display = 'none';
    });
    
    // Show the requested page
    document.getElementById(`${pageId}-page`).style.display = 'block';
    
    // Update page title
    updatePageTitle(pageId);
    
    // Update active menu item
    updateActiveMenuItem(pageId);
    
    // Scroll to top
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Update page title
function updatePageTitle(pageId) {
    let title = '';
    
    switch (pageId) {
        case 'dashboard':
            title = 'لوحة التحكم';
            break;
        case 'new-case':
            title = 'إنشاء حالة جديدة';
            break;
        case 'cases':
            title = 'جميع الحالات';
            break;
        case 'case-sayed':
            title = 'حالات سيد';
            break;
        case 'case-amm':
            title = 'حالات عام';
            break;
        case 'case-masareef':
            title = 'حالات مصاريف';
            break;
        case 'reports':
            title = 'التقارير والإحصائيات';
            break;
        default:
            title = 'مؤسسة أولاد الحسن الخيرية';
    }
    
    document.getElementById('page-title').textContent = title;
    document.title = title + ' - مؤسسة أولاد الحسن الخيرية';
}

// Update active menu item
function updateActiveMenuItem(pageId) {
    // Remove active class from all menu items
    const menuItems = document.querySelectorAll('.menu-link');
    menuItems.forEach(item => {
        item.classList.remove('active');
    });
    
    // Add active class to the current page's menu item
    const activeMenuItem = document.querySelector(`.menu-link[onclick="showPage('${pageId}')"]`);
    if (activeMenuItem) {
        activeMenuItem.classList.add('active');
    }
}

// Show modal
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.add('show');
}

// Close modal
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('show');
}

// Show search modal
function showSearchModal() {
    showModal('search-modal');
    document.getElementById('search-query').focus();
}

// Show QR code modal
function showQrCodeModal() {
    showModal('qrcode-modal');
    document.getElementById('qrcode-input').focus();
}

// Show import/export modal
function showImportExportModal() {
    showModal('import-export-modal');
}

// Show settings modal
function showSettingsModal() {
    showModal('settings-modal');
}

// Setup search listeners
function setupSearchListeners() {
    // Global search
    document.getElementById('search-query').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            searchCases();
        }
    });
    
    // Cases page search
    document.getElementById('search-cases').addEventListener('keyup', function() {
        filterCasesTable('all-cases-tbody', this.value);
    });
    
    // Sayed cases search
    document.getElementById('search-sayed').addEventListener('keyup', function() {
        filterCasesTable('sayed-cases-tbody', this.value);
    });
    
    // Amm cases search
    document.getElementById('search-amm').addEventListener('keyup', function() {
        filterCasesTable('amm-cases-tbody', this.value);
    });
    
    // Masareef cases search
    document.getElementById('search-masareef').addEventListener('keyup', function() {
        filterCasesTable('masareef-cases-tbody', this.value);
    });
}

// Filter cases table by search query
function filterCasesTable(tableId, query) {
    const tbody = document.getElementById(tableId);
    if (!tbody) return;
    
    const rows = tbody.getElementsByTagName('tr');
    const lowercaseQuery = query.toLowerCase();
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();
        
        if (text.includes(lowercaseQuery)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

// Search cases from the search modal
function searchCases() {
    const query = document.getElementById('search-query').value.toLowerCase();
    const field = document.getElementById('search-field').value;
    const category = document.getElementById('search-category').value;
    
    if (!query) {
        showToast('الرجاء إدخال كلمة البحث', 'error');
        return;
    }
    
    // Show loader
    showLoader();
    
    // Combine all cases
    let searchIn = [];
    
    if (category === 'all') {
        searchIn = [
            ...cases['سيد'],
            ...cases['عام'],
            ...cases['مصاريف']
        ];
    } else {
        searchIn = cases[category];
    }
    
    // Filter cases by search query
    const filteredCases = searchIn.filter(caseItem => {
        if (field === 'all') {
            // Search in all fields
            return Object.values(caseItem).some(value => 
                value && value.toString().toLowerCase().includes(query)
            );
        } else {
            // Search in specific field
            return caseItem[field] && 
                   caseItem[field].toString().toLowerCase().includes(query);
        }
    });
    
    // Close the search modal
    closeModal('search-modal');
    
    // Show the cases page
    showPage('cases');
    
    // Clear the table
    const tbody = document.getElementById('all-cases-tbody');
    tbody.innerHTML = '';
    
    // Sort filtered cases by date (newest first)
    const sortedCases = filteredCases.sort((a, b) => {
        return new Date(b.caseDateISO || b.caseDate) - new Date(a.caseDateISO || a.caseDate);
    });
    
    // Hide loader
    hideLoader();
    
    // Add filtered cases to the table
    sortedCases.forEach(caseItem => {
        const row = document.createElement('tr');
        
        // Format date
        const caseDate = new Date(caseItem.caseDate);
        const formattedDate = `${caseDate.getDate()}/${caseDate.getMonth() + 1}/${caseDate.getFullYear()}`;
        
        // Get badge class
        let badgeClass = '';
        switch (caseItem.caseCode) {
            case 'سيد':
                badgeClass = 'badge-sayed';
                break;
            case 'عام':
                badgeClass = 'badge-amm';
                break;
            case 'مصاريف':
                badgeClass = 'badge-masareef';
                break;
        }
        
        row.innerHTML = `
            <td>${caseItem.caseId}</td>
            <td>${formattedDate}</td>
            <td>${caseItem.fullName}</td>
            <td><span class="badge ${badgeClass}">${caseItem.caseCode}</span></td>
            <td>${caseItem.caseType}</td>
            <td>${formatCurrency(caseItem.amountNumeric)}</td>
            <td>
                <div class="table-actions">
                    <button class="view-btn" onclick="viewCase('${caseItem.caseId}', '${caseItem.caseCode}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="edit-btn" onclick="editCase('${caseItem.caseId}', '${caseItem.caseCode}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-btn" onclick="confirmDeleteCase('${caseItem.caseId}', '${caseItem.caseCode}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Show message if no results found
    if (filteredCases.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="7" style="text-align: center; padding: 20px;">
                لم يتم العثور على نتائج للبحث عن "${query}"
            </td>
        `;
        tbody.appendChild(row);
        
        showToast('لم يتم العثور على نتائج للبحث', 'info');
    } else {
        showToast(`تم العثور على ${filteredCases.length} نتيجة للبحث`, 'success');
    }
}

// Find case by QR code
function findCaseByQrCode() {
    const qrcodeInput = document.getElementById('qrcode-input').value;
    
    if (!qrcodeInput) {
        showToast('الرجاء إدخال رقم الحالة', 'error');
        return;
    }
    
    // Search for the case in all case types
    let foundCase = null;
    let foundCaseType = null;
    
    for (const caseType in cases) {
        const caseItem = cases[caseType].find(c => c.caseId === qrcodeInput);
        if (caseItem) {
            foundCase = caseItem;
            foundCaseType = caseType;
            break;
        }
    }
    
    // Close the QR code modal
    closeModal('qrcode-modal');
    
    if (foundCase) {
        // View the case
        viewCase(foundCase.caseId, foundCaseType);
        showToast('تم العثور على الحالة!', 'success');
    } else {
        showToast('لم يتم العثور على حالة بهذا الرقم', 'error');
    }
}

// Scan QR code (requires a QR code scanner library)
function scanQrCode() {
    // Check if browser supports getUserMedia
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast('متصفحك لا يدعم الوصول إلى الكاميرا', 'error');
        return;
    }
    
    // Show scanning container
    document.getElementById('qr-scanner-container').style.display = 'block';
    
    // Create a preview element
    const preview = document.getElementById('qr-scanner-preview');
    
    try {
        // Create a video element for the camera preview
        const video = document.createElement('video');
        video.style.width = '100%';
        video.style.height = '100%';
        preview.innerHTML = '';
        preview.appendChild(video);
        
        // Simulated scanning (since we don't have an actual QR code scanner library in this demo)
        setTimeout(() => {
            showToast('جاري محاكاة مسح الكود...', 'info');
            
            // Simulate scanning delay
            setTimeout(() => {
                // Get a random case
                const allCases = [
                    ...cases['سيد'],
                    ...cases['عام'],
                    ...cases['مصاريف']
                ];
                
                if (allCases.length > 0) {
                    const randomCase = allCases[Math.floor(Math.random() * allCases.length)];
                    document.getElementById('qrcode-input').value = randomCase.caseId;
                    showToast('تم مسح الكود بنجاح', 'success');
                } else {
                    showToast('لا توجد حالات لمحاكاة المسح', 'error');
                }
                
                stopQrScanner();
            }, 2000);
        }, 1000);
    } catch (error) {
        showToast('حدث خطأ أثناء الوصول إلى الكاميرا: ' + error.message, 'error');
        stopQrScanner();
    }
}

// Stop QR scanner
function stopQrScanner() {
    // Hide scanning container
    document.getElementById('qr-scanner-container').style.display = 'none';
    
    // In a real implementation, you would stop the camera stream here
}

// Handle report type change
function handleReportTypeChange() {
    const reportType = document.getElementById('report-type').value;
    
    // Hide all containers first
    document.getElementById('date-range-container').style.display = 'none';
    document.getElementById('date-range-end-container').style.display = 'none';
    document.getElementById('amount-range-container').style.display = 'none';
    document.getElementById('amount-range-max-container').style.display = 'none';
    
    // Show relevant containers based on report type
    if (reportType === 'date') {
        document.getElementById('date-range-container').style.display = 'block';
        document.getElementById('date-range-end-container').style.display = 'block';
    } else if (reportType === 'amount') {
        document.getElementById('amount-range-container').style.display = 'block';
        document.getElementById('amount-range-max-container').style.display = 'block';
    }
}

// Generate report
function generateReport() {
    // Show loader
    showLoader();
    
    const reportType = document.getElementById('report-type').value;
    let filteredCases = [];
    
    // Combine all cases
    const allCases = [
        ...cases['سيد'],
        ...cases['عام'],
        ...cases['مصاريف']
    ];
    
    // Filter cases based on report type
    switch (reportType) {
        case 'all':
            filteredCases = allCases;
            break;
        case 'sayed':
            filteredCases = cases['سيد'];
            break;
        case 'amm':
            filteredCases = cases['عام'];
            break;
        case 'masareef':
            filteredCases = cases['مصاريف'];
            break;
        case 'date':
            const startDate = new Date(document.getElementById('report-start-date').value);
            const endDate = new Date(document.getElementById('report-end-date').value);
            
            if (!startDate || !endDate) {
                hideLoader();
                showToast('الرجاء اختيار تاريخ البداية والنهاية', 'error');
                return;
            }
            
            // Set end date to end of day
            endDate.setHours(23, 59, 59, 999);
            
            filteredCases = allCases.filter(caseItem => {
                const caseDate = new Date(caseItem.caseDate);
                return caseDate >= startDate && caseDate <= endDate;
            });
            break;
        case 'amount':
            const minAmount = parseFloat(document.getElementById('report-min-amount').value) || 0;
            const maxAmount = parseFloat(document.getElementById('report-max-amount').value) || Infinity;
            
            filteredCases = allCases.filter(caseItem => {
                const amount = parseFloat(caseItem.amountNumeric) || 0;
                return amount >= minAmount && amount <= maxAmount;
            });
            break;
    }
    
    // Sort cases by date (newest first)
    const sortedCases = filteredCases.sort((a, b) => {
        return new Date(b.caseDateISO || b.caseDate) - new Date(a.caseDateISO || a.caseDate);
    });
    
    // Update report table
    const tbody = document.getElementById('report-results-tbody');
    tbody.innerHTML = '';
    
    sortedCases.forEach(caseItem => {
        const row = document.createElement('tr');
        
        // Format date
        const caseDate = new Date(caseItem.caseDate);
        const formattedDate = `${caseDate.getDate()}/${caseDate.getMonth() + 1}/${caseDate.getFullYear()}`;
        
        // Get badge class
        let badgeClass = '';
        switch (caseItem.caseCode) {
            case 'سيد':
                badgeClass = 'badge-sayed';
                break;
            case 'عام':
                badgeClass = 'badge-amm';
                break;
            case 'مصاريف':
                badgeClass = 'badge-masareef';
                break;
        }
        
        row.innerHTML = `
            <td>${caseItem.caseId}</td>
            <td>${formattedDate}</td>
            <td>${caseItem.fullName}</td>
            <td><span class="badge ${badgeClass}">${caseItem.caseCode}</span></td>
            <td>${caseItem.caseType}</td>
            <td>${formatCurrency(caseItem.amountNumeric)}</td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Calculate report summary
    const totalCases = sortedCases.length;
    const totalAmount = sortedCases.reduce((sum, caseItem) => sum + (parseFloat(caseItem.amountNumeric) || 0), 0);
    const averageAmount = totalCases > 0 ? totalAmount / totalCases : 0;
    const maxAmount = sortedCases.reduce((max, caseItem) => {
        const amount = parseFloat(caseItem.amountNumeric) || 0;
        return amount > max ? amount : max;
    }, 0);
    
    // Update report summary
    document.getElementById('report-total-cases').textContent = totalCases;
    document.getElementById('report-total-amount').textContent = formatCurrency(totalAmount);
    document.getElementById('report-average-amount').textContent = formatCurrency(Math.round(averageAmount));
    document.getElementById('report-max-amount').textContent = formatCurrency(maxAmount);
    
    // Create report chart
    createReportChart(sortedCases);
    
    // Hide loader
    hideLoader();
    
    // Show message if no results found
    if (totalCases === 0) {
        showToast('لم يتم العثور على نتائج للتقرير', 'info');
    } else {
        showToast(`تم إنشاء التقرير بنجاح. إجمالي الحالات: ${totalCases}`, 'success');
    }
}

// Create report chart
function createReportChart(casesData) {
    const ctx = document.getElementById('report-chart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (reportChart) {
        reportChart.destroy();
    }
    
    // Group cases by type
    const caseTypes = {};
    casesData.forEach(caseItem => {
        const type = caseItem.caseType;
        if (!caseTypes[type]) {
            caseTypes[type] = 0;
        }
        caseTypes[type]++;
    });
    
    // Get top 5 case types
    const sortedTypes = Object.entries(caseTypes)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    // Create chart data
    const labels = sortedTypes.map(item => item[0]);
    const data = sortedTypes.map(item => item[1]);
    
    // Create chart
    reportChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'عدد الحالات',
                data: data,
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(16, 185, 129, 0.7)',
                    'rgba(245, 158, 11, 0.7)',
                    'rgba(239, 68, 68, 0.7)',
                    'rgba(168, 85, 247, 0.7)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(16, 185, 129, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(239, 68, 68, 1)',
                    'rgba(168, 85, 247, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'توزيع الحالات حسب النوع',
                    font: {
                        family: "'Tajawal', sans-serif",
                        size: 16,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    bodyFont: {
                        family: "'Tajawal', sans-serif"
                    },
                    titleFont: {
                        family: "'Tajawal', sans-serif"
                    }
                }
            },
            scales: {
                x: {
                 ticks: {
                        font: {
                            family: "'Tajawal', sans-serif"
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: {
                            family: "'Tajawal', sans-serif"
                        }
                    }
                }
            }
        }
    });
}

// Generate advanced report
function generateAdvancedReport() {
    showToast('جاري إنشاء التقرير المتقدم...', 'info');
    
    setTimeout(() => {
        showToast('تم إنشاء التقرير المتقدم بنجاح', 'success');
    }, 1500);
}

// Generate financial report
function generateFinancialReport() {
    showToast('جاري إنشاء التقرير المالي...', 'info');
    
    setTimeout(() => {
        showToast('تم إنشاء التقرير المالي بنجاح', 'success');
    }, 1500);
}

// Print report
function printReport() {
    window.print();
}

// Export report to Excel
function exportReportToExcel() {
    showToast('جاري تصدير التقرير إلى Excel...', 'info');
    
    // Simulate export delay
    setTimeout(() => {
        showToast('تم تصدير التقرير بنجاح', 'success');
    }, 1500);
}

// Export advanced report to Excel
function exportAdvancedReportToExcel() {
    showToast('جاري تصدير التقرير المتقدم إلى Excel...', 'info');
    
    // Simulate export delay
    setTimeout(() => {
        showToast('تم تصدير التقرير المتقدم بنجاح', 'success');
    }, 1500);
}

// Export financial report to Excel
function exportFinancialReportToExcel() {
    showToast('جاري تصدير التقرير المالي إلى Excel...', 'info');
    
    // Simulate export delay
    setTimeout(() => {
        showToast('تم تصدير التقرير المالي بنجاح', 'success');
    }, 1500);
}

// Export data to file
function exportData() {
    const exportType = document.getElementById('export-type').value;
    const exportFormat = document.getElementById('export-format').value;
    let dataToExport;
    
    // Show loader
    showLoader();
    
    switch (exportType) {
        case 'all':
            dataToExport = {
                'سيد': cases['سيد'],
                'عام': cases['عام'],
                'مصاريف': cases['مصاريف'],
                caseCounter: caseCounter
            };
            break;
        case 'sayed':
            dataToExport = { 'سيد': cases['سيد'] };
            break;
        case 'amm':
            dataToExport = { 'عام': cases['عام'] };
            break;
        case 'masareef':
            dataToExport = { 'مصاريف': cases['مصاريف'] };
            break;
    }
    
    // Generate filename based on date
    const now = new Date();
    const dateString = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
    const timeString = `${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
    const filename = `charity_cases_export_${dateString}_${timeString}`;
    
    // Export based on format
    if (exportFormat === 'json') {
        // Convert to JSON
        const jsonData = JSON.stringify(dataToExport, null, 2);
        
        // Create file
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Create download link
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.json`;
        
        // Trigger download
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Hide loader
        hideLoader();
        
        // Show success message
        showToast('تم تصدير البيانات بنجاح', 'success');
    } else if (exportFormat === 'excel' || exportFormat === 'csv') {
        // For demo, we'll simulate Excel/CSV export
        setTimeout(() => {
            // Hide loader
            hideLoader();
            
            // Show success message
            showToast(`تم تصدير البيانات بتنسيق ${exportFormat === 'excel' ? 'Excel' : 'CSV'} بنجاح`, 'success');
        }, 1500);
    }
    
    // Close the modal
    closeModal('import-export-modal');
}

// Import data from file
function importData() {
    const fileInput = document.getElementById('import-file');
    const importStrategy = document.getElementById('import-strategy').value;
    
    if (!fileInput.files.length) {
        showToast('الرجاء اختيار ملف للاستيراد', 'error');
        return;
    }
    
    // Show loader
    showLoader();
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Replace or merge data based on strategy
            if (importStrategy === 'replace') {
                // Replace existing data
                if (importedData['سيد']) cases['سيد'] = importedData['سيد'];
                if (importedData['عام']) cases['عام'] = importedData['عام'];
                if (importedData['مصاريف']) cases['مصاريف'] = importedData['مصاريف'];
                if (importedData.caseCounter) caseCounter = importedData.caseCounter;
            } else {
                // Merge with existing data
                if (importedData['سيد']) {
                    cases['سيد'] = [...cases['سيد'], ...importedData['سيد']];
                }
                
                if (importedData['عام']) {
                    cases['عام'] = [...cases['عام'], ...importedData['عام']];
                }
                
                if (importedData['مصاريف']) {
                    cases['مصاريف'] = [...cases['مصاريف'], ...importedData['مصاريف']];
                }
                
                if (importedData.caseCounter && importedData.caseCounter > caseCounter) {
                    caseCounter = importedData.caseCounter;
                }
            }
            
            // Remove duplicates
            removeDuplicateCases();
            
            // Save to local storage
            saveCasesToStorage();
            
            // Update UI
            updateCasesList('سيد');
            updateCasesList('عام');
            updateCasesList('مصاريف');
            updateRecentCases();
            updateDashboardStats();
            updateDashboardCharts();
            setupAutocompleteData();
            updateSidebarBadges();
            
            // Hide loader
            hideLoader();
            
            // Show success message
            showToast('تم استيراد البيانات بنجاح', 'success');
            
            // Close the modal
            closeModal('import-export-modal');
            
        } catch (error) {
            // Hide loader
            hideLoader();
            
            showToast('حدث خطأ أثناء استيراد البيانات. الرجاء التأكد من صحة الملف.', 'error');
            console.error('Import error:', error);
        }
    };
    
    reader.readAsText(file);
}

// Remove duplicate cases
function removeDuplicateCases() {
    for (const caseType in cases) {
        const uniqueCases = [];
        const caseIds = new Set();
        
        cases[caseType].forEach(caseItem => {
            if (!caseIds.has(caseItem.caseId)) {
                uniqueCases.push(caseItem);
                caseIds.add(caseItem.caseId);
            }
        });
        
        cases[caseType] = uniqueCases;
    }
}

// Confirm clear cache
function confirmClearCache() {
    Swal.fire({
        title: 'مسح الذاكرة المؤقتة',
        text: 'سيتم مسح الإعدادات المؤقتة فقط. البيانات الأساسية لن تتأثر. هل أنت متأكد؟',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f59e0b',
        cancelButtonColor: '#9ca3af',
        confirmButtonText: 'نعم، مسح',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            clearCache();
        }
    });
}

// Clear cache
function clearCache() {
    // Clear temporary data from localStorage
    // In a real app, you would have a list of cache keys to delete
    
    showToast('تم مسح الذاكرة المؤقتة بنجاح', 'success');
}

// Confirm reset all data
function confirmResetAllData() {
    Swal.fire({
        title: 'إعادة ضبط جميع البيانات',
        text: 'سيتم حذف جميع البيانات والإعدادات نهائياً. هذا الإجراء لا يمكن التراجع عنه. هل أنت متأكد؟',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#3b82f6',
        confirmButtonText: 'نعم، حذف كل شيء',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            resetAllData();
        }
    });
}

// Reset all data
function resetAllData() {
    // Clear all data
    cases = {
        "سيد": [],
        "عام": [],
        "مصاريف": []
    };
    caseCounter = 1;
    
    // Reset settings to defaults
    settings = {
        orgName: "مؤسسة أولاد الحسن ع الخيرية",
        organizer: "محمد حسن",
        adminNames: "السيد أسامة السعبري والسيد فؤاد السعبري",
        autoSave: "enabled",
        autoSaveInterval: 60,
        themeMode: "light",
        themeColor: "#1e40af",
        fontSize: "medium",
        animations: "enabled",
        paperSize: "a4",
        printOrientation: "portrait",
        printHeader: "مؤسسة أولاد الحسن ع الخيرية",
        printFooter: "جميع الحقوق محفوظة © 2025",
        printQrSize: "medium",
        printPreview: "enabled",
        caseIdFormat: "YYMMDD-NUM",
        customCaseIdFormat: "",
        dataLocation: "localStorage",
        caseLockTimeout: 30,
        backupFrequency: "daily",
        backupCount: 5
    };
    
    // Save to local storage
    saveCasesToStorage();
    localStorage.setItem('charityAppSettings', JSON.stringify(settings));
    
    // Update UI
    loadSettings();
    applyThemeSettings();
    updateCasesList('سيد');
    updateCasesList('عام');
    updateCasesList('مصاريف');
    updateRecentCases();
    updateDashboardStats();
    updateDashboardCharts();
    setupAutocompleteData();
    updateSidebarBadges();
    
    // Close settings modal
    closeModal('settings-modal');
    
    // Navigate to dashboard
    showPage('dashboard');
    
    showToast('تم إعادة ضبط جميع البيانات بنجاح', 'success');
}

// Show toast notification
function showToast(message, type = 'info', duration = 4000) {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    let icon;
    switch(type) {
        case 'success':
            icon = '<i class="fas fa-check"></i>';
            break;
        case 'error':
            icon = '<i class="fas fa-times"></i>';
            break;
        case 'warning':
            icon = '<i class="fas fa-exclamation"></i>';
            break;
        default:
            icon = '<i class="fas fa-info"></i>';
    }
    
    toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-message">${message}</div>
        <div class="toast-close" onclick="closeToast(this.parentElement)"><i class="fas fa-times"></i></div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto close
    setTimeout(() => {
        closeToast(toast);
    }, duration);
}

// Close toast
function closeToast(toast) {
    if (!toast) return;
    
    toast.classList.add('slide-out');
    
    // Remove from DOM after animation
    setTimeout(() => {
        if (toast.parentElement) {
            toast.parentElement.removeChild(toast);
        }
    }, 300);
}

// Check for cases in URL
function checkUrlForCase() {
    const urlParams = new URLSearchParams(window.location.search);
    const caseId = urlParams.get('case');
    
    if (caseId) {
        // Search for the case in all case types
        let foundCase = null;
        let foundCaseType = null;
        
        for (const caseType in cases) {
            const caseItem = cases[caseType].find(c => c.caseId === caseId);
            if (caseItem) {
                foundCase = caseItem;
                foundCaseType = caseType;
                break;
            }
        }
        
        if (foundCase) {
            // View the case
            setTimeout(() => {
                viewCase(foundCase.caseId, foundCaseType);
                showToast('تم العثور على الحالة!', 'success');
            }, 1000);
        }
    }
}

// Run initialization when page loads
window.onload = function() {
    initApp();
    
    // Check URL for case ID
    checkUrlForCase();
};



// إضافة نماذج الطباعة إلى الصفحة عند تحميل المستند
document.addEventListener('DOMContentLoaded', function() {
    // إضافة العنصر إلى DOM بعد تحميل الصفحة
    const printPreviewContainer = document.createElement('div');
    printPreviewContainer.id = 'print-preview-container';
    printPreviewContainer.style.display = 'none';
    printPreviewContainer.innerHTML = `
        <div id="print-preview-content">
            <!-- سيتم إضافة محتوى نموذج الطباعة هنا -->
        </div>
        <div id="print-preview-close" onclick="closePrintPreview()">
            <i class="fas fa-times"></i>
        </div>
        <div id="print-preview-actions">
            <button class="btn btn-primary" onclick="printFromPreview()">
                <i class="fas fa-print"></i>
                <span>طباعة</span>
            </button>
            <button class="btn btn-light" onclick="closePrintPreview()">
                <i class="fas fa-times"></i>
                <span>إلغاء</span>
            </button>
        </div>
    `;
    document.body.appendChild(printPreviewContainer);
    
    // استبدال دالة printPreview الحالية
    window.originalPrintPreview = window.printPreview;
    window.printPreview = enhancedPrintPreview;
    
    // تحديث دالة طباعة التقرير أيضًا
    window.originalPrintReport = window.printReport;
    window.printReport = enhancedPrintReport;
});

/**
 * الدالة المحسّنة لمعاينة الطباعة
 * تستخدم نموذج الطباعة الجديد بدلاً من النموذج القديم
 */
function enhancedPrintPreview() {
    // إظهار مؤشر التحميل
    showPrintLoader();
    
    // نسخ قالب نموذج الطباعة
    const printTemplate = document.getElementById('print-template').cloneNode(true);
    printTemplate.style.display = 'block';
    
    // الحصول على بيانات النموذج
    const formData = getFormData();
    
    // تعبئة بيانات النموذج في نموذج الطباعة
    fillPrintTemplate(printTemplate, formData);
    
    // إضافة النموذج إلى حاوية معاينة الطباعة
    const printPreviewContent = document.getElementById('print-preview-content');
    printPreviewContent.innerHTML = '';
    printPreviewContent.appendChild(printTemplate.querySelector('.print-container'));
    
    // إنشاء رمز QR جديد إذا كان متاحًا
    if (typeof QRCode !== 'undefined') {
        const qrcodeContainer = document.getElementById('print-qrcode');
        if (qrcodeContainer) {
            qrcodeContainer.innerHTML = '';
            try {
                new QRCode(qrcodeContainer, {
                    text: formData.caseId,
                    width: 64,
                    height: 64,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.L
                });
            } catch (error) {
                console.error("Error generating QR code for print:", error);
            }
        }
    }
    
    // تطبيق التنسيق المضغوط إذا كان مطلوبًا
    if (settings && settings.printCompact === 'enabled') {
        printPreviewContent.querySelector('.print-container').classList.add('compact-layout');
    }
    
    // إظهار حاوية معاينة الطباعة
    document.getElementById('print-preview-container').style.display = 'flex';
    
    // إخفاء مؤشر التحميل بعد تحميل المحتوى
    setTimeout(hidePrintLoader, 500);
}

/**
 * الدالة المحسّنة لطباعة التقرير
 */
function enhancedPrintReport() {
    // تنفيذ الطباعة مباشرةً إذا كانت المعاينة معطلة
    if (settings && settings.printPreview === 'disabled') {
        window.print();
        return;
    }
    
    // عرض معاينة الطباعة للتقرير
    // إظهار مؤشر التحميل
    showPrintLoader();
    
    // هنا يمكن إضافة المنطق الخاص بتهيئة تقرير للطباعة
    // لكن في الوقت الحالي، سنستخدم آلية الطباعة الافتراضية
    
    window.originalPrintReport();
    
    // إخفاء مؤشر التحميل
    setTimeout(hidePrintLoader, 500);
}

/**
 * دالة محسنة لتعبئة قالب الطباعة ببيانات النموذج مع تطبيق التنسيق الصحيح
 * @param {HTMLElement} template - قالب نموذج الطباعة
 * @param {Object} data - بيانات النموذج
 */
function fillPrintTemplate(template, data) {
    // تعبئة معلومات الرأس
    setValue(template, 'print-caseCode', data.caseCode || 'مصاريف');
    setValue(template, 'print-caseType', data.caseType || '...............');
    
    // تنسيق التاريخ
    const caseDate = data.caseDate ? new Date(data.caseDate) : new Date();
    const formattedDate = `${caseDate.getDate()} / ${caseDate.getMonth() + 1} / ${caseDate.getFullYear()} م`;
    setValue(template, 'print-date', formattedDate);
    
    setValue(template, 'print-organizer', data.organizer || 'محمد حسن');
    
    // تطبيق اللون المناسب على رأس الصفحة حسب نوع الحالة
    const printHeader = template.querySelector('.print-header');
    if (printHeader) {
        // إزالة جميع فئات الألوان السابقة
        printHeader.classList.remove('header-sayed', 'header-amm', 'header-masareef');
        
        // إضافة فئة اللون المناسبة
        switch (data.caseCode) {
            case 'سيد':
                printHeader.classList.add('header-sayed');
                break;
            case 'عام':
                printHeader.classList.add('header-amm');
                break;
            case 'مصاريف':
                printHeader.classList.add('header-masareef');
                break;
        }
    }
    
    // بقية الكود بدون تغيير
    setValue(template, 'print-fullName', data.fullName);
    setValue(template, 'print-lastName', data.lastName);
    setValue(template, 'print-parentName', data.parentName);
    setValue(template, 'print-age', data.age);
    setValue(template, 'print-socialStatus', data.socialStatus);
    setValue(template, 'print-caseDescription', data.caseDescription);
    setValue(template, 'print-documentedBy', data.documentedBy);
    setValue(template, 'print-mukhtar', data.mukhtar);
    
    // المعلومات المالية
    setValue(template, 'print-govSalary', formatValue(data.govSalary));
    setValue(template, 'print-orgSalary', formatValue(data.orgSalary));
    setValue(template, 'print-incomeAmount', formatValue(data.incomeAmount));
    setValue(template, 'print-expenses', formatValue(data.expenses));
    setValue(template, 'print-incomeRemaining', formatValue(data.incomeRemaining));
    
    // معلومات السكن
    setValue(template, 'print-address', data.address);
    setValue(template, 'print-housingType', data.housingType || 'ملك');
    
    // عدد أفراد الأسرة
    setValue(template, 'print-totalFamilyMembers', formatValue(data.totalFamilyMembers));
    setValue(template, 'print-maleChildren', formatValue(data.maleChildren));
    setValue(template, 'print-femaleChildren', formatValue(data.femaleChildren));
    setValue(template, 'print-married', formatValue(data.married));
    
    // المعلومات الطبية
    setValue(template, 'print-hospitalName', data.hospitalName);
    setValue(template, 'print-hospitalAddress', data.hospitalAddress);
    setValue(template, 'print-caseTypeDetail', data.caseTypeDetail);
    setValue(template, 'print-amountNumeric', formatValue(data.amountNumeric));
    setValue(template, 'print-amountWritten', data.amountWritten);
    setValue(template, 'print-totalAmount', formatValue(data.totalAmount));
    setValue(template, 'print-doctorName', data.doctorName);
    
    // معلومات الاتصال
    setValue(template, 'print-phoneFirst', data.phoneFirst);
    setValue(template, 'print-phoneSecond', data.phoneSecond);
    
    // معلومات الزوج/ة
    setValue(template, 'print-spouseName', data.spouseName);
    setValue(template, 'print-spouseLastName', data.spouseLastName);
    setValue(template, 'print-spouseOccupation', data.spouseOccupation);
    setValue(template, 'print-spouseSalary', formatValue(data.spouseSalary));
    
    // معلومات إضافية
    setValue(template, 'print-hasOtherSupport', data.hasOtherSupport || 'لا');
    setValue(template, 'print-supportingAgencies', data.supportingAgencies);
    setValue(template, 'print-notes', data.notes);
    
    // مبلغ المساعدة
    setValue(template, 'print-estimatedAssistance', data.estimatedAssistance);
    setValue(template, 'print-amountPaid', data.amountPaid);
    
    // تنسيق تاريخ الدفع
    if (data.paymentDate) {
        const paymentDate = new Date(data.paymentDate);
        setValue(template, 'print-paymentDate', `${paymentDate.getDate()} / ${paymentDate.getMonth() + 1} / ${paymentDate.getFullYear()}`);
    } else {
        setValue(template, 'print-paymentDate', '');
    }
    
    // معلومات الإدارة
    setValue(template, 'print-adminNames', settings ? settings.adminNames : 'السيد أسامة السعبري والسيد فؤاد السعبري');
    
    // تاريخ اليوم للإدارة
    const today = new Date();
    setValue(template, 'print-adminDate', `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`);
}
/**
 * تنسيق قيمة رقمية للعرض في نموذج الطباعة
 * @param {any} value - القيمة المراد تنسيقها
 * @returns {string} - القيمة المنسقة
 */
function formatValue(value) {
    if (value === undefined || value === null || value === '') {
        return '0';
    }
    
    // إذا كانت القيمة صفر، نعيدها كرقم 0
    if (parseInt(value) === 0 || value === '0') {
        return '0';
    }
    
    // محاولة تنسيق الرقم إذا كان رقمًا
    if (!isNaN(value)) {
        return parseInt(value).toLocaleString('ar-IQ');
    }
    
    return value;
}

/**
 * ضبط قيمة عنصر في قالب الطباعة
 * @param {HTMLElement} template - قالب نموذج الطباعة
 * @param {string} id - معرف العنصر
 * @param {string} value - القيمة المراد ضبطها
 */
function setValue(template, id, value) {
    const element = template.querySelector(`#${id}`);
    if (element) {
        // التحقق مما إذا كان العنصر div أو span
        if (element.tagName === 'DIV' || element.tagName === 'SPAN') {
            element.textContent = value;
        } else {
            element.value = value;
        }
        
        // إضافة فئة صفر إذا كانت القيمة صفرًا
        if (value === '0' || value === 0) {
            element.classList.add('zero-val');
        } else {
            element.classList.remove('zero-val');
        }
    }
}

/**
 * إغلاق معاينة الطباعة
 */
function closePrintPreview() {
    document.getElementById('print-preview-container').style.display = 'none';
}



/**
 * إظهار مؤشر التحميل
 */
function showPrintLoader() {
    // إنشاء عنصر مؤشر التحميل إذا لم يكن موجودًا
    let loader = document.querySelector('.print-loader');
    if (!loader) {
        loader = document.createElement('div');
        loader.className = 'print-loader';
        loader.innerHTML = '<div class="print-loader-spinner"></div>';
        document.body.appendChild(loader);
    }
    
    loader.style.display = 'flex';
}

/**
 * إخفاء مؤشر التحميل
 */
function hidePrintLoader() {
    const loader = document.querySelector('.print-loader');
    if (loader) {
        loader.style.display = 'none';
    }
}

        
    </script>
<script>
// حل مشكلة عالق التحميل
document.addEventListener('DOMContentLoaded', function() {
    // محاولة إخفاء مؤشر التحميل بعد 3 ثوانٍ حتى لو لم تكتمل بقية العمليات
    setTimeout(function() {
        const loader = document.getElementById('loader');
        if (loader) {
            loader.style.display = 'none';
        }
    }, 3000);
});



// دالة محسنة لتحميل مكتبة jsQR
function loadJsQRScript() {
    return new Promise((resolve, reject) => {
        // التحقق من وجود المكتبة مسبقًا
        if (window.jsQR) {
            console.log('مكتبة jsQR محملة مسبقًا');
            resolve(window.jsQR);
            return;
        }
        
        console.log('جاري تحميل مكتبة jsQR...');
        
        // تجربة عدة مصادر CDN للمكتبة
        const cdnUrls = [
            'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js',
            'https://unpkg.com/jsqr@1.4.0/dist/jsQR.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js'
        ];
        
        // دالة تحميل المكتبة من مصدر محدد
        function loadFromSource(sourceIndex) {
            if (sourceIndex >= cdnUrls.length) {
                reject(new Error('فشل تحميل مكتبة jsQR من جميع المصادر'));
                return;
            }
            
            const script = document.createElement('script');
            script.src = cdnUrls[sourceIndex];
            
            script.onload = () => {
                console.log('تم تحميل مكتبة jsQR بنجاح');
                if (window.jsQR) {
                    resolve(window.jsQR);
                } else {
                    console.error('تم تحميل الملف لكن المكتبة غير متاحة');
                    loadFromSource(sourceIndex + 1);
                }
            };
            
            script.onerror = () => {
                console.warn(`فشل تحميل مكتبة jsQR من المصدر: ${cdnUrls[sourceIndex]}`);
                loadFromSource(sourceIndex + 1);
            };
            
            document.head.appendChild(script);
        }
        
        // بدء محاولات التحميل
        loadFromSource(0);
    });
}

// دالة محسنة لمسح رمز QR
async function scanQrCode() {
    try {
        // محاولة استخدام Barcode Detector API المدمج أولاً
        if ('BarcodeDetector' in window) {
            await scanWithBarcodeDetector();
            return;
        }
        
        // محاولة استخدام مكتبة jsQR كخيار بديل
        await scanWithJsQR();
        
    } catch (error) {
        console.error('حدث خطأ أثناء مسح رمز QR:', error);
        showToast('حدث خطأ أثناء مسح رمز QR: ' + error.message, 'error');
        stopQrScanner();
    }
}

// مسح QR باستخدام واجهة BarcodeDetector المدمجة
async function scanWithBarcodeDetector() {
    // التحقق من دعم المتصفح للكاميرا
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        throw new Error('متصفحك لا يدعم الوصول إلى الكاميرا');
    }
    
    // إظهار حاوية المسح
    const scannerContainer = document.getElementById('qr-scanner-container');
    scannerContainer.style.display = 'block';
    
    // تجهيز عناصر الفيديو والكانفاس
    const preview = document.getElementById('qr-scanner-preview');
    preview.innerHTML = '';
    
    const video = document.createElement('video');
    video.style.width = '100%';
    video.style.height = '100%';
    video.style.objectFit = 'cover';
    preview.appendChild(video);
    
    // طلب الوصول إلى الكاميرا
    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' }
    });
    
    video.srcObject = stream;
    video.setAttribute('playsinline', true); // ضروري للأجهزة المحمولة
    await video.play();
    
    // إضافة رسالة توجيهية
    const instructionText = document.createElement('div');
    instructionText.textContent = 'وجه الكاميرا نحو رمز QR';
    instructionText.style.position = 'absolute';
    instructionText.style.bottom = '60px';
    instructionText.style.left = '0';
    instructionText.style.right = '0';
    instructionText.style.textAlign = 'center';
    instructionText.style.color = '#fff';
    instructionText.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    instructionText.style.padding = '8px';
    preview.appendChild(instructionText);
    
    // إنشاء كاشف الرموز الشريطية
    const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
    
    showToast('جاري مسح رمز QR...', 'info');
    
    // بدء عملية المسح
    let scanning = true;
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    const detectCode = async () => {
        if (!scanning) return;
        
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            // ضبط أبعاد الكانفاس لتتطابق مع الفيديو
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // رسم إطار الفيديو على الكانفاس
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            try {
                // البحث عن رموز في الإطار الحالي
                const barcodes = await barcodeDetector.detect(canvas);
                
                if (barcodes.length > 0) {
                    // تم العثور على رمز QR
                    scanning = false;
                    
                    // إيقاف تشغيل الكاميرا
                    video.srcObject.getTracks().forEach(track => track.stop());
                    
                    // معالجة الرمز
                    const qrData = barcodes[0].rawValue;
                    processQrCodeResult(qrData);
                    return;
                }
            } catch (err) {
                console.warn('خطأ في كشف الرمز:', err);
            }
        }
        
        // استمرار المسح
        requestAnimationFrame(detectCode);
    };
    
    detectCode();
}

// مسح QR باستخدام مكتبة jsQR
async function scanWithJsQR() {
    try {
        // تحميل مكتبة jsQR
        await loadJsQRScript();
        
        // التحقق من دعم المتصفح للكاميرا
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('متصفحك لا يدعم الوصول إلى الكاميرا');
        }
        
        // إظهار حاوية المسح
        const scannerContainer = document.getElementById('qr-scanner-container');
        scannerContainer.style.display = 'block';
        
        // تجهيز عناصر الفيديو والكانفاس
        const preview = document.getElementById('qr-scanner-preview');
        preview.innerHTML = '';
        
        const video = document.createElement('video');
        video.style.width = '100%';
        video.style.height = '100%';
        video.style.objectFit = 'cover';
        preview.appendChild(video);
        
        const canvas = document.createElement('canvas');
        const canvasContext = canvas.getContext('2d');
        
        // طلب الوصول إلى الكاميرا
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }
        });
        
        video.srcObject = stream;
        video.setAttribute('playsinline', true); // ضروري للأجهزة المحمولة
        await video.play();
        
        // ضبط أبعاد الكانفاس
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        // إضافة رسالة توجيهية
        const instructionText = document.createElement('div');
        instructionText.textContent = 'وجه الكاميرا نحو رمز QR';
        instructionText.style.position = 'absolute';
        instructionText.style.bottom = '60px';
        instructionText.style.left = '0';
        instructionText.style.right = '0';
        instructionText.style.textAlign = 'center';
        instructionText.style.color = '#fff';
        instructionText.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        instructionText.style.padding = '8px';
        preview.appendChild(instructionText);
        
        // بدء عملية المسح
        let scanning = true;
        showToast('جاري مسح رمز QR...', 'info');
        
        // دالة التحقق من وجود رمز QR
        const scanFrame = () => {
            if (!scanning) return;
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                
                try {
                    // محاولة فك رمز QR
                    const code = window.jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        // تم العثور على رمز QR
                        scanning = false;
                        video.srcObject.getTracks().forEach(track => track.stop());
                        
                        // التحقق من صالحية رمز QR
                        processQrCodeResult(code.data);
                        return;
                    }
                } catch (err) {
                    console.warn('خطأ في تحليل رمز QR:', err);
                }
            }
            
            // استمرار المسح إذا لم يتم العثور على رمز
            requestAnimationFrame(scanFrame);
        };
        
        scanFrame();
        
    } catch (error) {
        throw error;
    }
}


// استيراد صورة QR محسنة
async function importQrCodeImage() {
    // إنشاء عنصر اختيار الملف
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    // إضافة معالج حدث اختيار الملف
    fileInput.addEventListener('change', async () => {
        if (fileInput.files.length === 0) return;
        
        try {
            showToast('جاري معالجة الصورة...', 'info');
            
            const file = fileInput.files[0];
            
            // تجربة BarcodeDetector API أولاً إذا كان متاحًا
            if ('BarcodeDetector' in window) {
                try {
                    const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
                    const bitmap = await createImageBitmap(file);
                    const barcodes = await barcodeDetector.detect(bitmap);
                    
                    if (barcodes.length > 0) {
                        processQrCodeResult(barcodes[0].rawValue);
                        document.body.removeChild(fileInput);
                        return;
                    }
                } catch (err) {
                    console.warn('فشل قراءة QR باستخدام BarcodeDetector:', err);
                    // سنستمر باستخدام jsQR كبديل
                }
            }
            
            // تحميل مكتبة jsQR
            await loadJsQRScript();
            
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const img = new Image();
                    
                    img.onload = () => {
                        // إنشاء كانفاس وتحميل الصورة عليه
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // تحديد حجم مناسب للكانفاس (تصغير الصور الكبيرة جدًا)
                        const MAX_SIZE = 1024;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height && width > MAX_SIZE) {
                            height = Math.floor(height * (MAX_SIZE / width));
                            width = MAX_SIZE;
                        } else if (height > width && height > MAX_SIZE) {
                            width = Math.floor(width * (MAX_SIZE / height));
                            height = MAX_SIZE;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // رسم الصورة على الكانفاس (مع تحجيمها إذا لزم الأمر)
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // استخراج بيانات الصورة
                        const imageData = ctx.getImageData(0, 0, width, height);
                        
                        // فك رمز QR
                        const code = window.jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: "attemptBoth",  // محاولة كشف الرموز العادية والمعكوسة
                        });
                        
                        if (code) {
                            processQrCodeResult(code.data);
                        } else {
                            showToast('لم يتم العثور على رمز QR في الصورة', 'error');
                        }
                    };
                    
                    img.onerror = () => {
                        showToast('فشل في تحميل الصورة', 'error');
                    };
                    
                    img.src = e.target.result;
                } catch (error) {
                    showToast('حدث خطأ في معالجة الصورة: ' + error.message, 'error');
                }
            };
            
            reader.onerror = () => {
                showToast('حدث خطأ أثناء قراءة الصورة', 'error');
            };
            
            reader.readAsDataURL(file);
        } catch (error) {
            showToast('حدث خطأ: ' + error.message, 'error');
        } finally {
            // إزالة عنصر اختيار الملف
            setTimeout(() => {
                if (document.body.contains(fileInput)) {
                    document.body.removeChild(fileInput);
                }
            }, 100);
        }
    });
    
    // تشغيل نافذة اختيار الملف
    fileInput.click();
}

// معالجة نتيجة مسح رمز QR
function processQrCodeResult(qrData) {
    stopQrScanner();
    
    document.getElementById('qrcode-input').value = qrData;
    showToast('تم مسح الرمز بنجاح: ' + qrData, 'success');
    
    // البحث عن الحالة تلقائيًا بعد المسح الناجح
    setTimeout(() => {
        findCaseByQrCode();
    }, 500);
}

// إيقاف ماسح QR وتحرير موارد الكاميرا
function stopQrScanner() {
    const scannerContainer = document.getElementById('qr-scanner-container');
    scannerContainer.style.display = 'none';
    
    // إيقاف تشغيل الكاميرا وتحرير الموارد
    const video = scannerContainer.querySelector('video');
    if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
    }
}

// استيراد صورة QR من الجهاز
function importQrCodeImage() {
    // إنشاء عنصر اختيار الملف
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);
    
    // إضافة معالج حدث اختيار الملف
    fileInput.addEventListener('change', async () => {
        if (fileInput.files.length === 0) return;
        
        try {
            await loadJsQRScript();
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                const img = new Image();
                img.onload = () => {
                    // إنشاء كانفاس وتحميل الصورة عليه
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // استخراج بيانات الصورة
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // فك رمز QR
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        processQrCodeResult(code.data);
                    } else {
                        showToast('لم يتم العثور على رمز QR في الصورة', 'error');
                    }
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = () => {
                showToast('حدث خطأ أثناء قراءة الصورة', 'error');
            };
            
            reader.readAsDataURL(file);
        } catch (error) {
            showToast('حدث خطأ: ' + error.message, 'error');
        } finally {
            // إزالة عنصر اختيار الملف
            document.body.removeChild(fileInput);
        }
    });
    
    // تشغيل نافذة اختيار الملف
    fileInput.click();
}


// تحديث واجهة مربع حوار مسح QR
function updateQrCodeModalUI() {
    const modalBody = document.querySelector('#qrcode-modal .modal-body');
    
    if (modalBody) {
        // إعادة تشكيل واجهة المسح
        modalBody.innerHTML = `
            <p style="text-align: center; margin-bottom: 20px;">أدخل رقم الحالة أو امسح رمز QR الخاص بالحالة:</p>
            <div class="form-row">
                <div class="form-group full-width">
                    <div class="input-icon">
                        <input type="text" id="qrcode-input" class="form-control" placeholder="رقم الحالة">
                        <i class="fas fa-qrcode"></i>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-primary" onclick="findCaseByQrCode()">
                    <i class="fas fa-search"></i>
                    <span>بحث عن الحالة</span>
                </button>
            </div>
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button class="btn btn-success" onclick="scanQrCode()">
                    <i class="fas fa-camera"></i>
                    <span>التقاط بالكاميرا</span>
                </button>
                <button class="btn btn-secondary" onclick="importQrCodeImage()">
                    <i class="fas fa-image"></i>
                    <span>استيراد صورة QR</span>
                </button>
            </div>
            <div id="qr-scanner-container" style="display: none; margin-top: 20px; text-align: center;">
                <div id="qr-scanner-preview" style="width: 100%; max-width: 300px; height: 300px; margin: 0 auto; border: 2px solid #ddd; border-radius: 8px; position: relative; overflow: hidden;"></div>
                <button class="btn btn-danger" style="margin-top: 15px;" onclick="stopQrScanner()">
                    <i class="fas fa-stop"></i>
                    <span>إيقاف المسح</span>
                </button>
            </div>
        `;
    }
}

// تعديل دالة showQrCodeModal لتحديث واجهة المستخدم
const originalShowQrCodeModal = showQrCodeModal;
window.showQrCodeModal = function() {
    // استدعاء الدالة الأصلية
    originalShowQrCodeModal();
    
    // تحديث واجهة المستخدم
    updateQrCodeModalUI();
};



</script>
    
</body>
</html>