<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الحالات الخيرية المحدث</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        /* تنسيقات عامة */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Traditional Arabic', Arial, sans-serif;
            font-size: 18px;
            direction: rtl;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1, h2, h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            font-size: 18px;
        }

        /* ==============================
           تنسيقات الأزرار
        ============================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn i {
            margin-left: 5px;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-light {
            background-color: #ecf0f1;
            color: #333;
        }

        .btn-light:hover {
            background-color: #bdc3c7;
        }

        /* ==============================
           تنسيقات نماذج الإدخال
        ============================== */
        .form-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .form-col {
            flex: 1;
            padding: 0 10px;
            min-width: 200px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 18px;
        }

        .form-control {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 18px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
        }

        /* خاصية إخفاء/إظهار خانة الإيجار */
        .hidden {
            display: none !important;
        }

        /* تنسيق عداد الأحرف */
        .char-counter {
            font-size: 14px;
            color: #666;
            text-align: left;
            margin-top: 5px;
        }

        .char-counter.warning {
            color: #e67e22;
        }

        .char-counter.danger {
            color: #e74c3c;
        }

        /* ==============================
           تنسيقات أقسام النموذج
        ============================== */
        .form-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #3498db;
            padding-right: 10px;
            border-right: 4px solid #3498db;
        }

        /* ==============================
           تنسيقات أزرار الإجراءات
        ============================== */
        .action-buttons {
            margin: 20px 0;
            text-align: center;
        }

        /* ==============================
           تنسيقات مؤشر التحميل
        ============================== */
        .print-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .print-loader-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ==============================
           تنسيقات نافذة معاينة الطباعة
        ============================== */
        #print-preview-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9990;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: auto;
        }

        #print-preview-content {
            background-color: white;
            max-width: 21cm;
            width: 100vw;
            min-width: 21cm;
            min-height: 29.7cm;
            height: auto;
            max-height: 90vh;
            position: relative;
            overflow: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }

        #print-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 20px;
            z-index: 9995;
        }

        #print-preview-actions {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9995;
        }

        /* ==============================
           تنسيقات نموذج الطباعة
        ============================== */
        .print-container {
            width: 21cm;
            min-height: 29.7cm;
            max-width: 21cm;
            margin: 0;
            background-color: white;
            position: relative;
            padding: 0;
            font-family: 'Traditional Arabic', Arial, sans-serif;
            direction: rtl;
            box-sizing: border-box;
            border: 6px double #2e7d32;
            box-shadow: 0 0 0 8px #fff, 0 0 0 12px #2e7d32;
            display: flex;
            flex-direction: column;
            font-size: 18px;
        }

        /* ==============================
           رأس الصفحة للطباعة
        ============================== */
        .print-header {
            background-color: #ffeb3b;
            display: flex;
            padding: 8px 0;
            border: 1.5px solid #000;
            border-bottom: 2px solid #000;
            min-height: 120px;
            flex-shrink: 0;
            margin-bottom: 15px;
            margin-top: 0;
            font-size: 18px;
        }

        .header-right {
            width: 25%;
            text-align: center;
            padding: 5px 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            padding-bottom: 2px;
        }

        .header-center {
            width: 50%;
            text-align: center;
            padding: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            padding-bottom: 2px;
            position: relative;
        }

        .header-center-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 5px;
        }

        .header-org-name {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .header-qr {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 10px;
        }

        .header-qr canvas {
            width: 70px !important;
            height: 70px !important;
            border: 1px solid #333;
        }

        .header-qr-number {
            font-size: 10px;
            font-weight: bold;
            margin-top: 2px;
            color: #333;
            text-align: center;
        }

        .header-logo {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .header-logo img {
            width: 80px !important;
            height: 80px !important;
        }

        .header-center-title {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            font-weight: bold;
            width: 100%;
            text-align: center;
        }

        .header-left {
            width: 25%;
            padding: 5px;
            border-right: 1.5px solid #000;
            font-size: 20px;
            padding-bottom: 2px;
        }

        .header-table {
            width: 100%;
            border-collapse: collapse;
            height: 100%;
            font-size: 20px;
        }

        .header-table tr {
            border-bottom: 1px solid #000;
        }

        .header-table tr:last-child {
            border-bottom: none;
        }

        .header-table td {
            padding: 3px 8px;
            text-align: right;
            font-size: 20px;
            vertical-align: middle;
        }

        .org-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .charity-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* ==============================
           محتوى الطباعة
        ============================== */
        .print-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-bottom: 15px;
        }

        .content-row {
            display: flex;
            border-bottom: 1px solid #ccc;
            min-height: 35px;
            padding: 5px 0;
            align-items: flex-start;
        }

        .content-row-noborder {
            border-bottom: none;
        }

        .content-row-thick-border {
            border-bottom: none;
        }

        .content-cell {
            padding: 3px 8px;
            text-align: right;
            display: flex;
            align-items: flex-start;
            word-break: break-word;
            white-space: pre-line;
            overflow-wrap: break-word;
            box-sizing: border-box;
            font-size: 18px;
            flex-direction: column;
        }

        .content-cell-full {
            flex: 1;
        }

        .content-cell-half {
            flex: 0.5;
        }

        .content-cell-third {
            flex: 0.33;
        }

        .content-cell-quarter {
            flex: 0.25;
        }

        .content-cell-fifth {
            flex: 0.2;
        }

        .content-cell-sixth {
            flex: 0.16;
        }

        .label {
            color: #0066cc;
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 18px;
        }

        .value {
            font-size: 18px;
            line-height: 1.4;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .parentheses-value {
            margin: 0 3px;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            min-width: 60px;
            justify-content: center;
        }

        .parentheses-value::before {
            content: '(';
            margin-left: 3px;
            font-size: 18px;
        }

        .parentheses-value::after {
            content: ')';
            margin-right: 3px;
            font-size: 18px;
        }

        .thick-divider {
            height: 3px;
            background-color: #000;
            margin: 8px 0;
            width: 100%;
        }

        /* ==============================
           تذييل الطباعة
        ============================== */
        .print-footer {
            margin-top: auto;
            padding: 20px 0 15px 0;
            flex-shrink: 0;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 1px;
        }

        .footer-left, .footer-right {
            flex: 1;
            text-align: center;
        }

        .footer-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 1px;
        }

        .admin-names {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
            display: inline-block;
            vertical-align: middle;
        }

        .admin-date {
            font-size: 18px;
        }

        .payment-info {
            font-size: 18px;
            font-weight: bold;
            display: inline-block;
            vertical-align: middle;
            margin-left: 30px;
        }

        .footer-content {
            align-items: center;
        }

        .assistance-amount {
            margin-top: 0;
            margin-bottom: 0;
            padding: 10px 0 0 0;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        /* ==============================
           إعدادات الطباعة
        ============================== */
        @media print {
            @page {
                size: A4 portrait;
                margin: 0 !important;
                padding: 0 !important;
            }

            body * {
                visibility: hidden !important;
            }

            #print-preview-content, 
            #print-preview-content * {
                visibility: visible !important;
            }

            html, body {
                width: 100% !important;
                height: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: visible !important;
                background: white !important;
            }

            #print-preview-content {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 21cm !important;
                min-width: 21cm !important;
                max-width: 21cm !important;
                min-height: 29.7cm !important;
                max-height: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                overflow: visible !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: flex-start !important;
            }

            .print-container {
                width: 21cm !important;
                min-height: 29.7cm !important;
                max-width: 25cm !important;
                margin: 0 !important;
                padding: 0 !important;
                border: 2px solid #000 !important;
                box-sizing: border-box !important;
                display: flex !important;
                flex-direction: column !important;
                background: white !important;
                overflow: visible !important;
                font-size: 18px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .print-header {
                min-height: 80px !important;
                padding-top: 2px !important;
                padding-bottom: 2px !important;
                margin-bottom: 6px !important;
                font-size: 18px !important;
            }

            .header-right,
            .header-center,
            .header-left {
                font-size: 18px !important;
                padding-top: 2px !important;
                padding-bottom: 2px !important;
            }

            .header-logo img {
                width: 70px !important;
                height: 70px !important;
            }

            .header-qr canvas {
                width: 60px !important;
                height: 60px !important;
            }

            .header-table,
            .header-table td {
                font-size: 18px !important;
                padding-top: 2px !important;
                padding-bottom: 2px !important;
            }

            .org-name,
            .charity-name {
                font-size: 18px !important;
                margin-bottom: 2px !important;
            }

            .print-content {
                flex: 1 !important;
                margin-bottom: 10px !important;
            }

            .content-row {
                min-height: 25px !important;
                font-size: 18px !important;
                padding: 3px 0 !important;
                page-break-inside: avoid !important;
            }

            .content-cell {
                padding: 2mm 3mm !important;
                font-size: 18px !important;
            }

            .label, .value {
                font-size: 18px !important;
            }

            .parentheses-value {
                font-size: 18px !important;
                min-width: 50px !important;
            }

            .print-footer {
                flex-shrink: 0 !important;
                margin-top: auto !important;
                padding: 20px 0 15px 0 !important;
            }

            .footer-content {
                margin-top: 15px !important;
                align-items: center !important;
            }

            .assistance-amount {
                margin-top: 0 !important;
                margin-bottom: 0 !important;
                padding: 8px 0 0 0 !important;
                font-size: 18px !important;
            }

            .footer-title, .admin-names, .admin-date, .payment-info {
                font-size: 18px !important;
            }

            .payment-info {
                display: inline-block !important;
                vertical-align: middle !important;
                margin-left: 30px !important;
            }

            .admin-names {
                display: inline-block !important;
                vertical-align: middle !important;
            }

            .thick-divider {
                height: 2pt !important;
                margin: 5px 0 !important;
            }

            .no-print {
                display: none !important;
                visibility: hidden !important;
            }

            * {
                font-family: 'Traditional Arabic', Arial, sans-serif !important;
                direction: rtl !important;
                -webkit-font-smoothing: antialiased !important;
                -moz-osx-font-smoothing: grayscale !important;
            }

            body > :not(#print-preview-container) {
                display: none !important;
            }
            #print-preview-container {
                display: block !important;
                position: static !important;
                background: none !important;
                width: 100% !important;
                height: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                z-index: 1 !important;
            }
            #print-preview-actions,
            #print-preview-close,
            .toast-container,
            .print-loader {
                display: none !important;
            }
        }

        /* ==============================
           إشعارات (Toast)
        ============================== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            background-color: white;
            color: #333;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            min-width: 250px;
            max-width: 350px;
            animation: fadeIn 0.3s ease;
            font-size: 18px;
        }

        .toast.success {
            border-right: 4px solid #2ecc71;
        }

        .toast.error {
            border-right: 4px solid #e74c3c;
        }

        .toast.info {
            border-right: 4px solid #3498db;
        }

        .toast i {
            margin-left: 10px;
            font-size: 20px;
        }

        .toast.success i { color: #2ecc71; }
        .toast.error i { color: #e74c3c; }
        .toast.info i { color: #3498db; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ==============================
           ألوان الهيدر حسب نوع الحالة
        ============================== */
        .header-sayed {
            background-color: #b9f6ca !important;
            border: 2px solid #000 !important;
            border-bottom: 3px solid #000 !important;
        }

        .header-aam {
            background-color: #b3e5fc !important;
            border: 2px solid #000 !important;
            border-bottom: 3px solid #000 !important;
        }

        .header-expenses {
            background-color: #ffeb3b !important;
            border: 2px solid #000 !important;
            border-bottom: 3px solid #000 !important;
        }

        @media print {
            .header-sayed {
                background-color: #b9f6ca !important;
                border: 2px solid #000 !important;
                border-bottom: 3px solid #000 !important;
            }

            .header-aam {
                background-color: #b3e5fc !important;
                border: 2px solid #000 !important;
                border-bottom: 3px solid #000 !important;
            }

            .header-expenses {
                background-color: #ffeb3b !important;
                border: 2px solid #000 !important;
                border-bottom: 3px solid #000 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>نظام إدارة الحالات الخيرية المحدث</h1>
        
        <!-- نموذج إدخال البيانات -->
        <div class="form-container">
            <form id="case-form">
                <div class="form-section">
                    <div class="form-section-title">معلومات الحالة الأساسية</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">رمز الحالة</label>
                                <select class="form-control" id="caseCode">
                                    <option value="مصاريف">مصاريف</option>
                                    <option value="سيد">سيد</option>
                                    <option value="عام">عام</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">نوع الحالة</label>
                                <input type="text" class="form-control" id="caseType" placeholder="مهرجان استشهاد امير المؤمنين">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">التاريخ</label>
                                <input type="date" class="form-control" id="caseDate">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">المنظم</label>
                                <input type="text" class="form-control" id="organizer" value="أبو كرار">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">البيانات الشخصية</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">الاسم الكامل</label>
                                <input type="text" class="form-control" id="fullName">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">اللقب</label>
                                <input type="text" class="form-control" id="lastName">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">أبو / أم</label>
                                <input type="text" class="form-control" id="parentName">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">العمر</label>
                                <input type="number" class="form-control" id="age">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">الحالة الاجتماعية</label>
                                <select class="form-control" id="socialStatus">
                                    <option value="متزوج/ة">متزوج/ة</option>
                                    <option value="أعزب/عزباء">أعزب/عزباء</option>
                                    <option value="مطلق/ة">مطلق/ة</option>
                                    <option value="أرمل/ة">أرمل/ة</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">العنوان وأقرب نقطة دالة</label>
                                <input type="text" class="form-control" id="address">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">الموثق</label>
                                <input type="text" class="form-control" id="verifier">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">اسم المختار</label>
                                <input type="text" class="form-control" id="mukhtarName">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">شرح الحالة</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">شرح الحالة</label>
                                <textarea class="form-control" id="caseDescription" rows="3" maxlength="400" placeholder="أدخل شرح الحالة (حد أقصى 400 حرف)"></textarea>
                                <div class="char-counter" id="descriptionCounter">0 / 400</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">المعلومات المالية</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">راتب حكومي</label>
                                <input type="number" class="form-control" id="govSalary" onchange="calculateIncomeRemaining()">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">راتب مؤسسة</label>
                                <input type="number" class="form-control" id="orgSalary" onchange="calculateIncomeRemaining()">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">مقدار الدخل</label>
                                <input type="number" class="form-control" id="incomeAmount" onchange="calculateIncomeRemaining()">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">المصروفات</label>
                                <input type="number" class="form-control" id="expenses" onchange="calculateIncomeRemaining()">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">باقي الدخل</label>
                                <input type="number" class="form-control" id="incomeRemaining" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">معلومات السكن والعائلة</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">نوع السكن</label>
                                <select class="form-control" id="housingType" onchange="toggleRentField()">
                                    <option value="ملك">ملك</option>
                                    <option value="إيجار">إيجار</option>
                                    <option value="وراثة">وراثة</option>
                                    <option value="مع مشترك">مع مشترك</option>
                                    <option value="تجاوز">تجاوز</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col" id="rentAmountCol">
                            <div class="form-group">
                                <label class="form-label">مقدار الإيجار</label>
                                <input type="number" class="form-control" id="rentAmount">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">عدد أفراد الأسرة</label>
                                <input type="number" class="form-control" id="totalFamilyMembers">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">بنين</label>
                                <input type="number" class="form-control" id="maleChildren">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">بنات</label>
                                <input type="number" class="form-control" id="femaleChildren">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">متزوجين</label>
                                <input type="number" class="form-control" id="married">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">المعلومات الطبية</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">اسم المستشفى</label>
                                <input type="text" class="form-control" id="hospitalName">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">عنوان المستشفى</label>
                                <input type="text" class="form-control" id="hospitalAddress">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">نوع الحالة الطبية</label>
                                <input type="text" class="form-control" id="caseTypeDetail">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">اسم الدكتور</label>
                                <input type="text" class="form-control" id="doctorName">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">المبلغ رقماً</label>
                                <input type="number" class="form-control" id="amountNumeric" value="150">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">المبلغ كتابة</label>
                                <input type="text" class="form-control" id="amountWritten">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">المجموع</label>
                                <input type="number" class="form-control" id="totalAmount">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">معلومات الاتصال</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">رقم الهاتف الأول</label>
                                <input type="text" class="form-control" id="phoneFirst" value="00000000000">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">رقم الهاتف الثاني</label>
                                <input type="text" class="form-control" id="phoneSecond" value="00000000000">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">الجهات التي تقوم بالمساعدة</label>
                                <input type="text" class="form-control" id="supportingAgencies">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">معلومات الزوج/ة</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">الزوج/ة</label>
                                <input type="text" class="form-control" id="spouseName">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">اللقب</label>
                                <input type="text" class="form-control" id="spouseLastName">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">المهنة</label>
                                <input type="text" class="form-control" id="spouseJob">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">الراتب</label>
                                <input type="number" class="form-control" id="spouseSalary">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">معلومات إضافية</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">هل يوجد معيل آخر</label>
                                <select class="form-control" id="hasOtherSupport">
                                    <option value="لا">لا</option>
                                    <option value="نعم">نعم</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">اسم المعيل</label>
                                <input type="text" class="form-control" id="supporterName">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">صلة القرابة</label>
                                <input type="text" class="form-control" id="supporterRelation">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">الملاحظات</label>
                                <textarea class="form-control" id="notes" rows="3" maxlength="300" placeholder="أدخل الملاحظات (حد أقصى 300 حرف)"></textarea>
                                <div class="char-counter" id="notesCounter">0 / 300</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">مبلغ المساعدة</div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label class="form-label">يصرف مبلغ المساعدة المقدر</label>
                                <input type="text" class="form-control" id="estimatedAssistance">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button type="button" class="btn btn-primary" onclick="saveForm()">
                        <i class="fas fa-save"></i>
                        حفظ البيانات
                    </button>
                    <button type="button" class="btn btn-success" onclick="enhancedPrintPreview()">
                        <i class="fas fa-print"></i>
                        معاينة الطباعة
                    </button>
                    <button type="button" class="btn btn-light" onclick="resetForm()">
                        <i class="fas fa-redo"></i>
                        إعادة تعيين
                    </button>
                    <button type="button" class="btn btn-info" onclick="fillFakeData()">
                        <i class="fas fa-magic"></i>
                        معلومات وهمية
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نافذة معاينة الطباعة -->
    <div id="print-preview-container">
        <div id="print-preview-content">
            <!-- سيتم إنشاء المحتوى ديناميكياً -->
        </div>
        <div id="print-preview-close" onclick="closePrintPreview()">
            <i class="fas fa-times"></i>
        </div>
        <div id="print-preview-actions">
            <button class="btn btn-primary" onclick="printFromPreview()">
                <i class="fas fa-print"></i>
                <span>طباعة</span>
            </button>
            <button class="btn btn-light" onclick="closePrintPreview()">
                <i class="fas fa-times"></i>
                <span>إلغاء</span>
            </button>
        </div>
    </div>

    <!-- حاوية الإشعارات -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- مؤشر التحميل -->
    <div class="print-loader">
        <div class="print-loader-spinner"></div>
    </div>
    
    <script>
        // متغيرات عامة
        let formCounter = 1;
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تعيين تاريخ اليوم في حقل التاريخ
            const today = new Date();
            const formattedDate = today.toISOString().substr(0, 10);
            document.getElementById('caseDate').value = formattedDate;
            
            // إخفاء مؤشر التحميل
            document.querySelector('.print-loader').style.display = 'none';
            
            // إضافة مستمع الحدث عند تغيير رمز الحالة
            document.getElementById('caseCode').addEventListener('change', updateHeaderColor);
            
            // إخفاء خانة الإيجار في البداية
            toggleRentField();
            
            // إضافة مستمعي أحداث لعدادات الأحرف
            setupCharacterCounters();
            
            // تهيئة عداد الاستمارات
            initializeFormCounter();
        });
        
        // تهيئة عداد الاستمارات
        function initializeFormCounter() {
            if (window.savedFormCounter) {
                formCounter = window.savedFormCounter;
            }
        }
        
        // إعداد عدادات الأحرف
        function setupCharacterCounters() {
            const descriptionField = document.getElementById('caseDescription');
            const notesField = document.getElementById('notes');
            const descriptionCounter = document.getElementById('descriptionCounter');
            const notesCounter = document.getElementById('notesCounter');
            
            // عداد شرح الحالة
            descriptionField.addEventListener('input', function() {
                updateCharacterCounter(this, descriptionCounter, 400);
            });
            
            // عداد الملاحظات
            notesField.addEventListener('input', function() {
                updateCharacterCounter(this, notesCounter, 300);
            });
        }
        
        // تحديث عداد الأحرف
        function updateCharacterCounter(field, counter, maxLength) {
            const currentLength = field.value.length;
            counter.textContent = `${currentLength} / ${maxLength}`;
            
            // تغيير لون العداد حسب النسبة
            if (currentLength > maxLength * 0.9) {
                counter.className = 'char-counter danger';
            } else if (currentLength > maxLength * 0.7) {
                counter.className = 'char-counter warning';
            } else {
                counter.className = 'char-counter';
            }
        }
        
        // تبديل عرض خانة الإيجار
        function toggleRentField() {
            const housingType = document.getElementById('housingType').value;
            const rentAmountCol = document.getElementById('rentAmountCol');
            
            if (housingType === 'إيجار') {
                rentAmountCol.classList.remove('hidden');
            } else {
                rentAmountCol.classList.add('hidden');
                document.getElementById('rentAmount').value = '';
            }
        }
        
        // حساب باقي الدخل
        function calculateIncomeRemaining() {
            const govSalary = parseInt(document.getElementById('govSalary').value) || 0;
            const orgSalary = parseInt(document.getElementById('orgSalary').value) || 0;
            const incomeAmount = parseInt(document.getElementById('incomeAmount').value) || 0;
            const expenses = parseInt(document.getElementById('expenses').value) || 0;
            
            const totalIncome = govSalary + orgSalary + incomeAmount;
            const remaining = totalIncome - expenses;
            
            document.getElementById('incomeRemaining').value = remaining;
        }
        
        // إنشاء QR Code
        function generateQRCode(data) {
            const canvas = document.createElement('canvas');
            const qr = new QRious({
                element: canvas,
                value: data,
                size: 70,
                background: 'white',
                foreground: 'black'
            });
            return canvas;
        }
        
        // حفظ النموذج
        function saveForm() {
            try {
                const formData = getFormData();
                
                // حفظ البيانات في متغير (بدلاً من localStorage)
                window.savedFormData = formData;
                window.savedFormCounter = formCounter;
                
                // إظهار إشعار نجاح
                showToast('تم حفظ البيانات بنجاح', 'success');
                
                // زيادة عداد الاستمارات للاستمارة التالية
                formCounter++;
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                showToast('حدث خطأ أثناء حفظ البيانات', 'error');
            }
        }
        
        // إعادة تعيين النموذج
        function resetForm() {
            try {
                // إعادة تعيين حقول النموذج
                document.getElementById('case-form').reset();
                
                // تعيين تاريخ اليوم
                const today = new Date();
                const formattedDate = today.toISOString().substr(0, 10);
                document.getElementById('caseDate').value = formattedDate;
                
                // تعيين القيم الافتراضية
                document.getElementById('organizer').value = 'أبو كرار';
                document.getElementById('amountNumeric').value = '150';
                document.getElementById('phoneFirst').value = '00000000000';
                document.getElementById('phoneSecond').value = '00000000000';
                
                // إخفاء خانة الإيجار
                toggleRentField();
                
                // إعادة تعيين عدادات الأحرف
                document.getElementById('descriptionCounter').textContent = '0 / 400';
                document.getElementById('notesCounter').textContent = '0 / 300';
                document.getElementById('descriptionCounter').className = 'char-counter';
                document.getElementById('notesCounter').className = 'char-counter';
                
                // إظهار إشعار
                showToast('تم إعادة تعيين النموذج', 'info');
            } catch (error) {
                console.error('خطأ في إعادة تعيين النموذج:', error);
                showToast('حدث خطأ أثناء إعادة تعيين النموذج', 'error');
            }
        }
        
        // الحصول على بيانات النموذج
        function getFormData() {
            const formData = {};
            
            // الحصول على جميع عناصر الإدخال
            const inputs = document.querySelectorAll('#case-form input, #case-form select, #case-form textarea');
            
            // استخراج القيم
            inputs.forEach(input => {
                if (input.id) {
                    formData[input.id] = input.value;
                }
            });
            
            // إضافة رقم الاستمارة
            formData.formNumber = formCounter;
            
            return formData;
        }
        
        // إظهار معاينة الطباعة المحسنة
        function enhancedPrintPreview() {
            // إظهار مؤشر التحميل
            showPrintLoader();
            
            // الحصول على بيانات النموذج
            const formData = getFormData();
            
            // إنشاء نموذج الطباعة المحدث
            const printContent = createEnhancedPrintTemplate(formData);
            
            // إضافة النموذج إلى حاوية معاينة الطباعة
            const printPreviewContent = document.getElementById('print-preview-content');
            printPreviewContent.innerHTML = '';
            printPreviewContent.appendChild(printContent);

            // إظهار حاوية معاينة الطباعة
            document.getElementById('print-preview-container').style.display = 'flex';
            
            // إخفاء مؤشر التحميل بعد تحميل المحتوى
            setTimeout(hidePrintLoader, 300);
        }
        
        // إنشاء قالب الطباعة المحسن
        function createEnhancedPrintTemplate(data) {
            // إنشاء حاوية الطباعة
            const container = document.createElement('div');
            container.className = 'print-container';
            container.style.fontSize = '18px';

            // تنسيق التاريخ
            const caseDate = data.caseDate ? new Date(data.caseDate) : new Date();
            const formattedDate = `${caseDate.getDate()} / ${caseDate.getMonth() + 1} / ${caseDate.getFullYear()} م`;

            // إنشاء رأس الصفحة مع لون ديناميكي حسب رمز الحالة
            const header = document.createElement('div');
            header.className = 'print-header';
            header.style.fontSize = '18px';
            
            // تطبيق اللون والحدود حسب نوع الحالة
            if (data.caseCode === 'سيد') {
                header.classList.add('header-sayed');
            } else if (data.caseCode === 'عام') {
                header.classList.add('header-aam');
            } else {
                header.classList.add('header-expenses');
            }

            // الجهة اليمنى للهيدر - فارغة للتوازن
            const headerRight = document.createElement('div');
            headerRight.className = 'header-right';
            headerRight.style.fontSize = '20px';
            headerRight.style.paddingBottom = '2px';

            // الجهة الوسطى للهيدر - التصميم الجديد مع QR Code
            const headerCenter = document.createElement('div');
            headerCenter.className = 'header-center';
            headerCenter.style.fontSize = '20px';
            headerCenter.style.paddingBottom = '2px';
            
            // إنشاء QR Code
            const qrData = `استمارة رقم: ${data.formNumber || formCounter}\nالاسم: ${data.fullName || ''}\nالتاريخ: ${formattedDate}\nرمز الحالة: ${data.caseCode || ''}`;
            const qrCanvas = generateQRCode(qrData);
            
            // تصميم منطقة الوسط
            const centerContentHTML = `
                <div class="header-center-content">
                    <div class="header-org-name">
                        <div class="org-name" style="font-size:20px;">مؤسسة أولاد الحسن ع</div>
                        <div class="charity-name" style="font-size:20px;">الثقافية الخيرية</div>
                    </div>
                    <div class="header-qr">
                        <div class="header-qr-number" style="font-size:10px;">استمارة رقم: ${data.formNumber || formCounter}</div>
                    </div>
                    <div class="header-logo">
                        <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/%D9%85%D9%84%D9%81%20%D8%B5%D9%88%D8%B1%20%D8%AA%D8%B7%D8%A8%D9%82%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B1%20%D8%B3%D9%85%D8%A7%20%D8%A8%D8%A7%D8%A8%D9%84%2Ffile_0000000077b4622f9294f80fafefb564%20(1).png?alt=media&token=d79da964-2f40-4edd-a17e-6f9c71816b49" alt="شعار المؤسسة" style="width:80px;height:80px;">
                    </div>
                </div>
                <div class="header-center-title">استمارة معلومات الحالة</div>
            `;
            
            headerCenter.innerHTML = centerContentHTML;
            
            // إضافة QR Code إلى المكان المناسب
            setTimeout(() => {
                const qrContainer = headerCenter.querySelector('.header-qr');
                if (qrContainer) {
                    qrContainer.appendChild(qrCanvas);
                }
            }, 100);

            // الجهة اليسرى - جدول معلومات الحالة
            const headerLeft = document.createElement('div');
            headerLeft.className = 'header-left';
            headerLeft.style.fontSize = '20px';
            headerLeft.style.paddingBottom = '2px';

            const headerTable = document.createElement('table');
            headerTable.className = 'header-table';
            headerTable.style.fontSize = '20px';

            // بيانات الحالة
            const headerRows = [
                { label: 'رمز الحالة:', value: data.caseCode || 'مصاريف' },
                { label: 'نوع الحالة:', value: data.caseType || 'مهرجان استشهاد امير المؤمنين' },
                { label: 'التاريخ:', value: formattedDate },
                { label: 'المنظم:', value: data.organizer || 'أبو كرار' }
            ];

            headerRows.forEach(row => {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.innerHTML = `<span class="label" style="font-size:20px;">${row.label}</span> <span style="font-size:20px;">${row.value}</span>`;
                tr.appendChild(td);
                headerTable.appendChild(tr);
            });

            headerLeft.appendChild(headerTable);

            // إضافة الأقسام إلى الهيدر
            header.appendChild(headerRight);
            header.appendChild(headerCenter);
            header.appendChild(headerLeft);

            header.style.marginBottom = '6px';
            header.style.paddingBottom = '2px';

            container.appendChild(header);

            // إنشاء محتوى الاستمارة
            const content = document.createElement('div');
            content.className = 'print-content';
            content.style.fontSize = '18px';
            content.style.paddingTop = '12px';

            // سطر 1: الاسم الكامل، اللقب، أبو/أم، العمر
            const nameRow = document.createElement('div');
            nameRow.className = 'content-row';
            nameRow.style.fontSize = '18px';
            nameRow.style.marginBottom = '10px';
            nameRow.innerHTML = `
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">الاسم الكامل:</span>
                    <span class="value" style="font-size:18px;">${data.fullName || ''}</span>
                </div>
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">اللقب:</span>
                    <span class="value" style="font-size:18px;">${data.lastName || ''}</span>
                </div>
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">أبو / أم:</span>
                    <span class="parentheses-value" style="font-size:18px;">${data.parentName || ''}</span>
                </div>
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">العمر:</span>
                    <span class="parentheses-value" style="font-size:18px;">${data.age || ''}</span>
                </div>
            `;
            content.appendChild(nameRow);

            // سطر 2: الحالة الاجتماعية، الموثق، اسم المختار، العنوان
            const socialRow = document.createElement('div');
            socialRow.className = 'content-row';
            socialRow.style.fontSize = '18px';
            socialRow.style.marginBottom = '10px';
            socialRow.innerHTML = `
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">الحالة الاجتماعية:</span>
                    <span class="value" style="font-size:18px;">${data.socialStatus || ''}</span>
                </div>
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">الموثق:</span>
                    <span class="value" style="font-size:18px;">${data.verifier || ''}</span>
                </div>
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">اسم المختار:</span>
                    <span class="value" style="font-size:18px;">${data.mukhtarName || ''}</span>
                </div>
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">العنوان:</span>
                    <span class="value" style="font-size:18px;">${data.address || ''}</span>
                </div>
            `;
            content.appendChild(socialRow);

            // سطر 3: شرح الحالة (عرض كامل مع معالجة النص الطويل)
            if (data.caseDescription) {
                const descRow = document.createElement('div');
                descRow.className = 'content-row';
                descRow.style.fontSize = '18px';
                descRow.style.marginBottom = '10px';
                descRow.innerHTML = `
                    <div class="content-cell content-cell-full" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">شرح الحالة:</span>
                        <span class="value" style="font-size:18px; line-height:1.5;">${data.caseDescription}</span>
                    </div>
                `;
                content.appendChild(descRow);

                const spacer1 = document.createElement('div');
                spacer1.style.height = '12px';
                content.appendChild(spacer1);
            }

            // سطر 4: المعلومات المالية (5 حقول)
            const financeRow = document.createElement('div');
            financeRow.className = 'content-row';
            financeRow.style.fontSize = '18px';
            financeRow.style.marginBottom = '10px';
            financeRow.innerHTML = `
                <div class="content-cell content-cell-fifth" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">راتب حكومي:</span>
                    <span class="value" style="font-size:18px;">${formatNumber(data.govSalary)}</span>
                </div>
                <div class="content-cell content-cell-fifth" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">راتب مؤسسة:</span>
                    <span class="value" style="font-size:18px;">${formatNumber(data.orgSalary)}</span>
                </div>
                <div class="content-cell content-cell-fifth" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">مقدار الدخل:</span>
                    <span class="value" style="font-size:18px;">${formatNumber(data.incomeAmount)}</span>
                </div>
                <div class="content-cell content-cell-fifth" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">المصروفات:</span>
                    <span class="value" style="font-size:18px;">${formatNumber(data.expenses)}</span>
                </div>
                <div class="content-cell content-cell-fifth" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">باقي الدخل:</span>
                    <span class="value" style="font-size:18px;">${formatNumber(data.incomeRemaining)}</span>
                </div>
            `;
            content.appendChild(financeRow);

            // سطر 5: نوع السكن وتفاصيل العائلة (مع إضافة مقدار الإيجار عند الحاجة)
            const familyRow = document.createElement('div');
            familyRow.className = 'content-row';
            familyRow.style.fontSize = '18px';
            familyRow.style.marginBottom = '10px';
            
            let familyRowContent = `
                <div class="content-cell content-cell-sixth" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">نوع السكن:</span>
                    <span class="value" style="font-size:18px;">${data.housingType || ''}</span>
                </div>`;
            
            // إضافة مقدار الإيجار إذا كان نوع السكن إيجار
            if (data.housingType === 'إيجار' && data.rentAmount) {
                familyRowContent += `
                    <div class="content-cell content-cell-sixth" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">مقدار الإيجار:</span>
                        <span class="value" style="font-size:18px;">${formatNumber(data.rentAmount)}</span>
                    </div>`;
                
                // تقليل حجم باقي الخانات عند وجود الإيجار
                familyRowContent += `
                    <div class="content-cell content-cell-sixth" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">عدد أفراد الأسرة:</span>
                        <span class="value" style="font-size:18px;">${data.totalFamilyMembers || ''}</span>
                    </div>
                    <div class="content-cell content-cell-sixth" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">بنين:</span>
                        <span class="value" style="font-size:18px;">${data.maleChildren || ''}</span>
                    </div>
                    <div class="content-cell content-cell-sixth" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">بنات:</span>
                        <span class="value" style="font-size:18px;">${data.femaleChildren || ''}</span>
                    </div>
                    <div class="content-cell content-cell-sixth" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">متزوجين:</span>
                        <span class="value" style="font-size:18px;">${data.married || ''}</span>
                    </div>`;
            } else {
                // التخطيط العادي بدون مقدار الإيجار
                familyRowContent += `
                    <div class="content-cell content-cell-fifth" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">عدد أفراد الأسرة:</span>
                        <span class="value" style="font-size:18px;">${data.totalFamilyMembers || ''}</span>
                    </div>
                    <div class="content-cell content-cell-fifth" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">بنين:</span>
                        <span class="value" style="font-size:18px;">${data.maleChildren || ''}</span>
                    </div>
                    <div class="content-cell content-cell-fifth" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">بنات:</span>
                        <span class="value" style="font-size:18px;">${data.femaleChildren || ''}</span>
                    </div>
                    <div class="content-cell content-cell-fifth" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">متزوجين:</span>
                        <span class="value" style="font-size:18px;">${data.married || ''}</span>
                    </div>`;
            }
            
            familyRow.innerHTML = familyRowContent;
            content.appendChild(familyRow);

            // خط فاصل
            const divider1 = document.createElement('div');
            divider1.className = 'thick-divider';
            divider1.style.margin = '12px 0';
            content.appendChild(divider1);

            // سطر 6: معلومات المستشفى والطبيب
            const hospitalRow = document.createElement('div');
            hospitalRow.className = 'content-row';
            hospitalRow.style.fontSize = '18px';
            hospitalRow.style.marginBottom = '10px';
            hospitalRow.innerHTML = `
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">اسم المستشفى:</span>
                    <span class="value" style="font-size:18px;">${data.hospitalName || ''}</span>
                </div>
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">العنوان:</span>
                    <span class="value" style="font-size:18px;">${data.hospitalAddress || ''}</span>
                </div>
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">نوع الحالة:</span>
                    <span class="value" style="font-size:18px;">${data.caseTypeDetail || ''}</span>
                </div>
                <div class="content-cell content-cell-quarter" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">اسم الدكتور:</span>
                    <span class="value" style="font-size:18px;">${data.doctorName || ''}</span>
                </div>
            `;
            content.appendChild(hospitalRow);

            // سطر 7: المبالغ المالية
            const amountRow = document.createElement('div');
            amountRow.className = 'content-row';
            amountRow.style.fontSize = '18px';
            amountRow.style.marginBottom = '10px';
            amountRow.innerHTML = `
                <div class="content-cell content-cell-third" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">المبلغ رقماً:</span>
                    <span class="value" style="font-size:18px;">${data.amountNumeric || ''}</span>
                </div>
                <div class="content-cell content-cell-third" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">المبلغ كتابة:</span>
                    <span class="value" style="font-size:18px;">${data.amountWritten || ''}</span>
                </div>
                <div class="content-cell content-cell-third" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">المجموع:</span>
                    <span class="value" style="font-size:18px;">${formatNumber(data.totalAmount)}</span>
                </div>
            `;
            content.appendChild(amountRow);

            // خط فاصل ثاني
            const divider2 = document.createElement('div');
            divider2.className = 'thick-divider';
            divider2.style.margin = '12px 0';
            content.appendChild(divider2);

            // سطر 8: أرقام الهاتف والجهات المساعدة
            const contactRow = document.createElement('div');
            contactRow.className = 'content-row';
            contactRow.style.fontSize = '18px';
            contactRow.style.marginBottom = '10px';
            contactRow.innerHTML = `
                <div class="content-cell content-cell-third" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">رقم الهاتف الأول:</span>
                    <span class="value" style="font-size:18px;">${data.phoneFirst || ''}</span>
                </div>
                <div class="content-cell content-cell-third" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">رقم الهاتف الثاني:</span>
                    <span class="value" style="font-size:18px;">${data.phoneSecond || ''}</span>
                </div>
                <div class="content-cell content-cell-third" style="font-size:18px;">
                    <span class="label" style="font-size:18px;">الجهات المساعدة:</span>
                    <span class="value" style="font-size:18px;">${data.supportingAgencies || ''}</span>
                </div>
            `;
            content.appendChild(contactRow);

            // سطر 9: معلومات الزوج/ة
            if (data.spouseName || data.spouseLastName || data.spouseJob || data.spouseSalary) {
                const spouseRow = document.createElement('div');
                spouseRow.className = 'content-row';
                spouseRow.style.fontSize = '18px';
                spouseRow.style.marginBottom = '10px';
                spouseRow.innerHTML = `
                    <div class="content-cell content-cell-quarter" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">الزوج/ة:</span>
                        <span class="value" style="font-size:18px;">${data.spouseName || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">اللقب:</span>
                        <span class="value" style="font-size:18px;">${data.spouseLastName || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">المهنة:</span>
                        <span class="value" style="font-size:18px;">${data.spouseJob || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">الراتب:</span>
                        <span class="value" style="font-size:18px;">${formatNumber(data.spouseSalary)}</span>
                    </div>
                `;
                content.appendChild(spouseRow);
            }

            // سطر 10: المعيل الآخر
            if (data.hasOtherSupport === 'نعم' || data.supporterName || data.supporterRelation) {
                const supportRow = document.createElement('div');
                supportRow.className = 'content-row';
                supportRow.style.fontSize = '18px';
                supportRow.style.marginBottom = '10px';
                supportRow.innerHTML = `
                    <div class="content-cell content-cell-third" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">هل يوجد معيل آخر:</span>
                        <span class="value" style="font-size:18px;">${data.hasOtherSupport || 'لا'}</span>
                    </div>
                    <div class="content-cell content-cell-third" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">اسم المعيل:</span>
                        <span class="value" style="font-size:18px;">${data.supporterName || ''}</span>
                    </div>
                    <div class="content-cell content-cell-third" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">صلة القرابة:</span>
                        <span class="value" style="font-size:18px;">${data.supporterRelation || ''}</span>
                    </div>
                `;
                content.appendChild(supportRow);
            }

            // سطر 11: الملاحظات مع معالجة النص الطويل
            if (data.notes) {
                const notesRow = document.createElement('div');
                notesRow.className = 'content-row';
                notesRow.style.fontSize = '18px';
                notesRow.style.marginBottom = '10px';
                notesRow.innerHTML = `
                    <div class="content-cell content-cell-full" style="font-size:18px;">
                        <span class="label" style="font-size:18px;">الملاحظات:</span>
                        <span class="value" style="font-size:18px; line-height:1.5;">${data.notes}</span>
                    </div>
                `;
                content.appendChild(notesRow);

                const spacer2 = document.createElement('div');
                spacer2.style.height = '12px';
                content.appendChild(spacer2);

                const assistanceRow = document.createElement('div');
                assistanceRow.className = 'assistance-amount';
                assistanceRow.style.fontSize = '18px';
                assistanceRow.style.textAlign = 'right';
                assistanceRow.style.marginTop = '18px';
                assistanceRow.style.marginBottom = '10px';
                assistanceRow.innerHTML = `
                    <span class="label" style="font-size:18px;">يصرف مبلغ المساعدة المقدر:</span>
                    <span class="parentheses-value" style="font-size:18px;">${data.estimatedAssistance || ''}</span>
                `;
                content.appendChild(assistanceRow);
            } else {
                const assistanceRow = document.createElement('div');
                assistanceRow.className = 'assistance-amount';
                assistanceRow.style.fontSize = '18px';
                assistanceRow.style.textAlign = 'right';
                assistanceRow.style.marginTop = '18px';
                assistanceRow.style.marginBottom = '10px';
                assistanceRow.innerHTML = `
                    <span class="label" style="font-size:18px;">يصرف مبلغ المساعدة المقدر:</span>
                    <span class="parentheses-value" style="font-size:18px;">${data.estimatedAssistance || ''}</span>
                `;
                content.appendChild(assistanceRow);
            }

            const spacerFooter = document.createElement('div');
            spacerFooter.style.flex = '1 1 auto';
            content.appendChild(spacerFooter);

            container.appendChild(content);

            // تذييل الصفحة
            const footer = document.createElement('div');
            footer.className = 'print-footer';
            footer.style.fontSize = '18px';
            footer.style.position = 'relative';
            footer.style.bottom = '0';
            footer.style.width = '100%';
            footer.style.background = 'white';
            footer.style.marginTop = '8px';
            footer.style.padding = '10px 0 5px 0';

            const today = new Date();
            const footerDate = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;

            footer.innerHTML = `
                <div class="footer-content" style="font-size:18px; margin-top:0;">
                    <div class="footer-right" style="font-size:18px;">
                        <div class="payment-info" style="font-size:18px; margin-bottom: 4px;">
                            تم صرف مبلغ <span class="parentheses-value" style="font-size:18px;">${data.estimatedAssistance || ''}</span> بتاريخ ${footerDate}
                        </div>
                    </div>
                    <div class="footer-left" style="font-size:18px;">
                        <div class="footer-title" style="font-size:18px; margin-bottom: 4px;">إدارة المؤسسة</div>
                        <div class="admin-names" style="font-size:18px; margin-bottom: 4px;">السيد أسامة السعبري &nbsp;&nbsp;&nbsp; السيد فؤاد السعبري</div>
                        <div class="admin-date" style="font-size:18px; margin-bottom:0;">${footerDate}</div>
                    </div>
                </div>
            `;

            container.appendChild(footer);

            return container;
        }

        // تحويل الأرقام إلى إنجليزية
        function toEnglishDigits(str) {
            if (typeof str !== 'string') str = String(str);
            return str.replace(/[\u0660-\u0669\u06F0-\u06F9]/g, function(c) {
                return String.fromCharCode(c.charCodeAt(0) & 0xf);
            });
        }

        // تنسيق الأرقام
        function formatNumber(value) {
            if (value === undefined || value === null || value === '') {
                return '';
            }
            if (parseInt(value) === 0) {
                return '0';
            }
            if (!isNaN(value)) {
                return toEnglishDigits(parseInt(value).toLocaleString('en-US'));
            }
            return toEnglishDigits(value);
        }
        
        // إغلاق معاينة الطباعة
        function closePrintPreview() {
            document.getElementById('print-preview-container').style.display = 'none';
        }
        
        // الطباعة من المعاينة
        function printFromPreview() {
            window.print();
        }
        
        // إظهار مؤشر التحميل
        function showPrintLoader() {
            document.querySelector('.print-loader').style.display = 'flex';
        }
        
        // إخفاء مؤشر التحميل
        function hidePrintLoader() {
            document.querySelector('.print-loader').style.display = 'none';
        }
        
        // إظهار رسالة إشعار
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'info-circle';
            switch (type) {
                case 'success':
                    icon = 'check-circle';
                    break;
                case 'error':
                    icon = 'exclamation-circle';
                    break;
            }
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // تحديث لون الهيدر (إذا كانت هناك حاجة)
        function updateHeaderColor() {
            // يمكن إضافة منطق هنا لتحديث ألوان الواجهة حسب نوع الحالة
            const caseCode = document.getElementById('caseCode').value;
            console.log('تم تغيير رمز الحالة إلى:', caseCode);
        }

        // دالة مساعدة لتحويل النص إلى تنسيق مناسب للطباعة
        function formatTextForPrint(text, maxLength = 400) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            // تقسيم النص إلى أسطر متعددة إذا كان طويلاً
            const words = text.split(' ');
            let lines = [];
            let currentLine = '';
            for (let word of words) {
                if ((currentLine + word).length <= maxLength / 3) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                }
            }
            if (currentLine) lines.push(currentLine);
            return lines.join('\n');
        }

        // دالة لحفظ QR Code كصورة (اختيارية)
        function downloadQRCode(canvas, filename = 'qr-code.png') {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL();
            link.click();
        }

        // دالة للتحقق من صحة البيانات قبل الحفظ
        function validateForm() {
            const requiredFields = [
                { id: 'fullName', name: 'الاسم الكامل' },
                { id: 'caseType', name: 'نوع الحالة' }
            ];
            for (let field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    showToast(`يرجى ملء حقل ${field.name}`, 'error');
                    element.focus();
                    return false;
                }
            }
            return true;
        }

        // دالة لتصدير البيانات كـ JSON
        function exportFormData() {
            try {
                const formData = getFormData();
                const dataStr = JSON.stringify(formData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `form-${formData.formNumber || formCounter}-${new Date().toISOString().substr(0, 10)}.json`;
                link.click();
                showToast('تم تصدير البيانات بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تصدير البيانات:', error);
                showToast('حدث خطأ أثناء تصدير البيانات', 'error');
            }
        }

        // دالة لاستيراد البيانات من ملف JSON
        function importFormData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    // ملء النموذج بالبيانات المستوردة
                    for (const key in data) {
                        const element = document.getElementById(key);
                        if (element && key !== 'formNumber') {
                            element.value = data[key];
                        }
                    }
                    // تحديث العمليات الحسابية والعدادات
                    calculateIncomeRemaining();
                    toggleRentField();
                    updateCharacterCounter(document.getElementById('caseDescription'), document.getElementById('descriptionCounter'), 400);
                    updateCharacterCounter(document.getElementById('notes'), document.getElementById('notesCounter'), 300);
                    showToast('تم استيراد البيانات بنجاح', 'success');
                } catch (error) {
                    console.error('خطأ في استيراد البيانات:', error);
                    showToast('حدث خطأ أثناء استيراد البيانات', 'error');
                }
            };
            reader.readAsText(file);
        }

        // دالة للطباعة المباشرة بدون معاينة
        function directPrint() {
            const formData = getFormData();
            const printContent = createEnhancedPrintTemplate(formData);
            // إنشاء نافذة طباعة جديدة
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>طباعة الاستمارة</title>
                    <style>
                        @media print {
                            @page { size: A4 portrait; margin: 0; }
                            body { margin: 0; padding: 0; }
                        }
                        ${document.querySelector('style').innerHTML}
                    </style>
                </head>
                <body>
                    ${printContent.outerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // دالة لحفظ الاستمارة كـ PDF (يتطلب مكتبة إضافية)
        function saveToPDF() {
            showToast('ميزة حفظ PDF ستكون متاحة قريباً', 'info');
        }

        // دالة لإضافة مستمعي الأحداث للوحة المفاتيح
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+S للحفظ
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveForm();
                }
                // Ctrl+P للطباعة
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    enhancedPrintPreview();
                }
                // Ctrl+R لإعادة التعيين
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    if (confirm('هل أنت متأكد من إعادة تعيين النموذج؟')) {
                        resetForm();
                    }
                }
            });
        }

        // دالة للتحقق من حالة الاتصال بالإنترنت
        function checkInternetConnection() {
            if (!navigator.onLine) {
                showToast('لا يوجد اتصال بالإنترنت', 'error');
                return false;
            }
            return true;
        }

        // دالة لحفظ نسخة احتياطية تلقائية
        function autoSave() {
            const formData = getFormData();
            window.autoSavedData = formData;
            console.log('تم الحفظ التلقائي:', new Date().toLocaleTimeString());
        }

        // إعداد الحفظ التلقائي كل 5 دقائق
        function setupAutoSave() {
            setInterval(autoSave, 5 * 60 * 1000); // 5 دقائق
        }

        // دالة لاستعادة البيانات المحفوظة تلقائياً
        function restoreAutoSavedData() {
            if (window.autoSavedData) {
                if (confirm('تم العثور على بيانات محفوظة تلقائياً. هل تريد استعادتها؟')) {
                    const data = window.autoSavedData;
                    for (const key in data) {
                        const element = document.getElementById(key);
                        if (element && key !== 'formNumber') {
                            element.value = data[key];
                        }
                    }
                    calculateIncomeRemaining();
                    toggleRentField();
                    updateCharacterCounter(document.getElementById('caseDescription'), document.getElementById('descriptionCounter'), 400);
                    updateCharacterCounter(document.getElementById('notes'), document.getElementById('notesCounter'), 300);
                    showToast('تم استعادة البيانات المحفوظة تلقائياً', 'success');
                }
            }
        }

        // دالة لإضافة أزرار إضافية للوظائف المتقدمة
        function addAdvancedButtons() {
            const buttonContainer = document.querySelector('.action-buttons');
            // زر التصدير
            const exportBtn = document.createElement('button');
            exportBtn.type = 'button';
            exportBtn.className = 'btn btn-info';
            exportBtn.onclick = exportFormData;
            exportBtn.innerHTML = '<i class="fas fa-download"></i> تصدير البيانات';
            // زر الاستيراد
            const importBtn = document.createElement('button');
            importBtn.type = 'button';
            importBtn.className = 'btn btn-info';
            importBtn.onclick = () => document.getElementById('import-file').click();
            importBtn.innerHTML = '<i class="fas fa-upload"></i> استيراد البيانات';
            // إنشاء حقل الاستيراد المخفي
            const importInput = document.createElement('input');
            importInput.type = 'file';
            importInput.id = 'import-file';
            importInput.accept = '.json';
            importInput.style.display = 'none';
            importInput.onchange = importFormData;
            // زر الطباعة المباشرة
            const directPrintBtn = document.createElement('button');
            directPrintBtn.type = 'button';
            directPrintBtn.className = 'btn btn-success';
            directPrintBtn.onclick = directPrint;
            directPrintBtn.innerHTML = '<i class="fas fa-print"></i> طباعة مباشرة';
            // إضافة الأزرار
            buttonContainer.appendChild(exportBtn);
            buttonContainer.appendChild(importBtn);
            buttonContainer.appendChild(directPrintBtn);
            document.body.appendChild(importInput);
        }

        // دالة للتهيئة الكاملة للتطبيق
        function initializeApp() {
            setupKeyboardShortcuts();
            setupAutoSave();
            addAdvancedButtons();
            // التحقق من وجود بيانات محفوظة تلقائياً عند بدء التطبيق
            setTimeout(restoreAutoSavedData, 1000);
            console.log('تم تهيئة التطبيق بنجاح');
        }

        // تشغيل التهيئة الكاملة بعد تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // دالة لمعالجة الأخطاء العامة
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('خطأ في التطبيق:', msg, 'في السطر:', lineNo);
            showToast('حدث خطأ غير متوقع في التطبيق', 'error');
            return false;
        };

        // دالة لتنظيف الذاكرة عند إغلاق الصفحة
        window.addEventListener('beforeunload', function(e) {
            // حفظ تلقائي قبل الإغلاق
            autoSave();
            // تحذير إذا كانت هناك بيانات غير محفوظة
            const formData = getFormData();
            let hasData = false;
            for (const key in formData) {
                if (formData[key] && key !== 'formNumber') {
                    hasData = true;
                    break;
                }
            }
            if (hasData && !window.savedFormData) {
                e.preventDefault();
                e.returnValue = 'لديك بيانات غير محفوظة. هل أنت متأكد من المغادرة؟';
                return e.returnValue;
            }
        });

        // دوال إضافية للتحسينات

        // دالة لتكبير/تصغير النص
        function adjustFontSize(increase = true) {
            const container = document.querySelector('.container');
            const currentSize = parseInt(window.getComputedStyle(container).fontSize);
            const newSize = increase ? currentSize + 1 : currentSize - 1;
            if (newSize >= 12 && newSize <= 24) {
                container.style.fontSize = newSize + 'px';
            }
        }

        // دالة للتبديل بين الوضع المظلم والفاتح
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            showToast(isDark ? 'تم تفعيل الوضع المظلم' : 'تم تفعيل الوضع الفاتح', 'info');
        }

        // إضافة أنماط الوضع المظلم
        const darkModeStyles = `
            .dark-mode {
                background-color: #2c3e50 !important;
                color: #ecf0f1 !important;
            }
            .dark-mode .form-container {
                background-color: #34495e !important;
                color: #ecf0f1 !important;
            }
            .dark-mode .form-control {
                background-color: #3c4d5c !important;
                color: #ecf0f1 !important;
                border-color: #5a6c7d !important;
            }
        `;

        // إضافة أنماط الوضع المظلم للصفحة
        const styleSheet = document.createElement('style');
        styleSheet.textContent = darkModeStyles;
        document.head.appendChild(styleSheet);

        // تحديث دالة showToast لدعم المزيد من الخيارات
        function showAdvancedToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = 'info-circle';
            switch (type) {
                case 'success': icon = 'check-circle'; break;
                case 'error': icon = 'exclamation-circle'; break;
                case 'warning': icon = 'exclamation-triangle'; break;
            }
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        console.log('تم تحميل جميع وظائف النظام بنجاح');
    </script>
</body>
</html>
