<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الحالات الخيرية المتكامل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- إصلاح مكتبة QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-size: 16px;
            color: #333;
        }

        /* ==============================
           شريط العنوان المحدث - أقل ارتفاعاً
        ============================== */
        .top-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 10px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px; /* تقليل الارتفاع من 70px إلى 60px */
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header-title h1 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .header-title p {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .sidebar-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .user-info:hover {
            background: rgba(255,255,255,0.2);
        }

        /* ==============================
           تخطيط الصفحة الرئيسي
        ============================== */
        .main-layout {
            display: flex;
            margin-top: 60px; /* تحديث ليتناسب مع الهيدر الجديد */
            min-height: calc(100vh - 60px);
        }

        /* ==============================
           الشريط الجانبي المُحسن - يظهر من جهة اليمين
        ============================== */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #34495e 0%, #2c3e50 100%);
            color: white;
            box-shadow: -4px 0 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: fixed;
            right: 0;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
            z-index: 999;
            left: auto;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-content {
            padding: 20px 0;
        }

        .search-section {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .search-box input:focus {
            outline: none;
            background: rgba(255,255,255,0.2);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.5);
        }

        .search-box i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.7);
        }

        .qr-scanner-btn {
            width: 100%;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .qr-scanner-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .nav-menu {
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 20px;
        }

        .nav-section-title {
            padding: 0 20px 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.6);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 8px;
        }

        .nav-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 25px;
        }

        .nav-item.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-right: 4px solid #ecf0f1;
            border-left: none;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ecf0f1;
        }

        .nav-item i {
            font-size: 16px;
            width: 18px;
            text-align: center;
        }

        .nav-item .badge {
            background: #e74c3c;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: auto;
        }

        /* ==============================
           المحتوى الرئيسي المُحدث
        ============================== */
        .main-content {
            flex: 1;
            background: #f8f9fa;
            min-height: calc(100vh - 60px);
            transition: all 0.3s ease;
            margin-right: 280px; /* إضافة مارجن للشريط الجانبي الثابت */
        }

        .sidebar.collapsed ~ .main-content {
            margin-right: 70px;
        }

        .content-header {
            background: white;
            padding: 20px 25px;
            border-bottom: 1px solid #e3e6f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .content-header h2 {
            font-size: 26px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .content-header p {
            color: #6c757d;
            font-size: 15px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 13px;
            color: #6c757d;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .content-body {
            padding: 25px;
        }

        /* ==============================
           بطاقات الإحصائيات
        ============================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e3e6f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card.success::before { background: linear-gradient(135deg, #27ae60, #229954); }
        .stat-card.warning::before { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .stat-card.danger::before { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stat-card.info::before { background: linear-gradient(135deg, #3498db, #2980b9); }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .stat-title {
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
        }

        .stat-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .stat-icon.success { background: linear-gradient(135deg, #27ae60, #229954); }
        .stat-icon.warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .stat-icon.danger { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stat-icon.info { background: linear-gradient(135deg, #3498db, #2980b9); }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 13px;
            font-weight: 600;
        }

        .stat-change.positive { color: #27ae60; }
        .stat-change.negative { color: #e74c3c; }

        /* ==============================
           النماذج والحقول المُحسنة
        ============================== */
        .form-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
        }

        .form-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e3e6f0;
        }

        .form-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .form-header p {
            color: #6c757d;
            font-size: 13px;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #3498db;
            padding-right: 8px;
            border-right: 3px solid #3498db;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #2c3e50;
            font-size: 13px;
        }

        .form-control {
            padding: 10px 12px;
            border: 2px solid #e3e6f0;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-control:invalid {
            border-color: #e74c3c;
        }

        /* ==============================
           الأزرار المُحسنة
        ============================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }

        .btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-light {
            background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
            color: #2c3e50;
        }

        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
            justify-content: center;
        }

        /* ==============================
           الجداول المُحسنة
        ============================== */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 25px;
        }

        .table-header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e3e6f0;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            font-size: 13px;
        }

        .data-table td {
            font-size: 13px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active { background: #d4edda; color: #155724; }
        .status-badge.pending { background: #fff3cd; color: #856404; }
        .status-badge.completed { background: #d1ecf1; color: #0c5460; }

        /* ==============================
           النوافذ المنبثقة المُحسنة
        ============================== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e3e6f0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            color: #e74c3c;
            transform: scale(1.1);
        }

        /* ==============================
           نظام الإشعارات المُحسن
        ============================== */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }

        .toast {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border-left: 4px solid #3498db;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInToast 0.3s ease;
        }

        .toast.success { border-left-color: #27ae60; }
        .toast.error { border-left-color: #e74c3c; }
        .toast.warning { border-left-color: #f39c12; }

        .toast-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .toast-icon.success { background: #27ae60; }
        .toast-icon.error { background: #e74c3c; }
        .toast-icon.warning { background: #f39c12; }
        .toast-icon.info { background: #3498db; }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 3px;
            color: #2c3e50;
            font-size: 13px;
        }

        .toast-message {
            font-size: 12px;
            color: #6c757d;
        }

        @keyframes slideInToast {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        /* ==============================
           نظام الطباعة المُحسن - إطار خطي يحيط الورقة بالكامل
           الهيدر يلامس الأطراف (يمين/يسار/أعلى) مع مسافة بسيطة من الأطراف
           الخط سميك جداً خاصة من الأعلى
        ============================== */

        #print-preview-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9990;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: auto;
        }

        #print-preview-content {
            background-color: white;
            max-width: 21cm;
            width: 100vw;
            min-width: 21cm;
            min-height: 29.7cm;
            height: auto;
            max-height: 90vh;
            position: relative;
            overflow: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            line-height: 1.3;
        }

        #print-preview-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 18px;
            z-index: 9995;
        }

        #print-preview-actions {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9995;
        }

        /* قالب الطباعة مع إطار خطي يحيط الورقة بالكامل */
        .print-container {
            width: 20.3cm; /* أقل من 21cm لإعطاء مسافة من الأطراف */
            min-height: 29cm;
            max-width: 20.3cm;
            max-height: 29cm;
            margin: 0.35cm 0.35cm 0.35cm 0.35cm; /* مسافة من جميع الأطراف */
            background-color: white;
            position: relative;
            padding: 38px 18px 18px 18px; /* رفع المحتوى عن الهيدر من الأعلى */
            font-family: 'Traditional Arabic', Arial, sans-serif;
            direction: rtl;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            font-size: 17px;
            font-weight: 900;
            line-height: 1.4;
            overflow: hidden;
        }

        /* الإطار الخطي حول الورقة */
        .print-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-top: 6px solid #000;      /* سميك جداً من الأعلى */
            border-bottom: 3.5px solid #000; /* سميك من الأسفل */
            border-right: 3.5px solid #000;  /* سميك من اليمين */
            border-left: 3.5px solid #000;   /* سميك من اليسار */
            border-radius: 12px;
            pointer-events: none;
            z-index: 10;
        }

        /* الهيدر يلامس الأطراف (يمين/يسار/أعلى) */
        .print-header {
            background-color: #ffeb3b;
            display: flex;
            padding: 10px 0 10px 0;
            border-top: none;
            border-bottom: 3.5px solid #000;
            border-right: none;
            border-left: none;
            border-radius: 12px 12px 0 0;
            min-height: 90px;
            flex-shrink: 0;
            margin-bottom: 15px;
            margin-top: 0;
            margin-left: -18px; /* يمتد حتى طرف الورقة */
            margin-right: -18px;
            margin-top: -38px; /* رفع الهيدر للأعلى ليبتعد عن الإطار */
            font-size: 16px;
            position: relative;
            z-index: 20;
            box-sizing: border-box;
        }

        .header-right {
            width: 25%;
            text-align: center;
            padding: 5px 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: 700;
        }

        .header-qr {
            width: 15%;
            text-align: center;
            padding: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 1.5px solid #000;
        }

        .header-qr canvas {
            max-width: 65px !important;
            max-height: 65px !important;
            border: 1px solid #000;
        }

        .header-center {
            width: 25%;
            text-align: center;
            padding: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: 700;
            border-right: 1.5px solid #000;
        }

        .header-center img {
            width: 70px !important;
            height: 70px !important;
            margin-bottom: 4px;
        }

        .header-left {
            width: 35%;
            padding: 5px;
            border-right: 1.5px solid #000;
            font-size: 18px;
            font-weight: 700;
        }

        .header-table {
            width: 100%;
            border-collapse: collapse;
            height: 100%;
            font-size: 18px;
        }

        .header-table tr {
            border-bottom: 1px solid #000;
        }

        .header-table tr:last-child {
            border-bottom: none;
        }

        .header-table td {
            padding: 3px 6px;
            text-align: right;
            font-size: 18px;
            font-weight: 700;
            vertical-align: middle;
            line-height: 1.2;
            display: flex;
            align-items: center;
        }

        .org-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1.1;
        }

        .charity-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1.1;
        }

        .form-number {
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            margin-top: 4px;
            color: #333;
            line-height: 1.1;
        }

        /* محتوى الطباعة */
        .print-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            margin-bottom: 15px;
            margin-left: 0;
            margin-right: 0;
            max-height: calc(29cm - 180px);
            overflow: hidden;
            flex-shrink: 1;
            padding-top: 4px;
            position: relative;
            z-index: 3;
        }

        .print-content > .content-row:not(:first-child) {
            margin-top: 10px;
        }

        .print-content > .thick-divider {
            margin-top: 18px;
            margin-bottom: 18px;
        }

        .content-row {
            display: flex;
            border-bottom: none;
            min-height: 28px;
            padding: 2px 0;
            align-items: center;
            margin-top: 2px;
            margin-bottom: 1px;
            page-break-inside: avoid !important;
        }

        .content-cell {
            padding: 2px 6px;
            text-align: right;
            display: flex;
            align-items: center;
            word-break: break-word;
            white-space: pre-line;
            overflow-wrap: break-word;
            box-sizing: border-box;
            font-size: 17px;
            font-weight: 900;
            line-height: 1.2;
            vertical-align: baseline;
        }

        /* زيادة سمك الخط في قسم المعلومات */
        .print-content .content-cell,
        .print-content .label,
        .print-content .value,
        .print-content .parentheses-value {
            font-weight: 1200 !important;
        }

        .content-cell-full { flex: 1; }
        .content-cell-half { flex: 0.5; }
        .content-cell-third { flex: 0.33; }
        .content-cell-quarter { flex: 0.25; }

        .label {
            color: #0066cc;
            font-weight: 900;
            margin-left: 6px;
            font-size: 17px;
            line-height: 1.2;
            display: inline-flex;
            align-items: center;
            vertical-align: baseline;
            margin: 0 6px 0 0;
            padding: 0;
            height: auto;
        }

        .value {
            font-size: 17px;
            flex: 1;
            line-height: 1.2;
            font-weight: 900;
            color: #2c1a1a;
            display: inline-flex;
            align-items: center;
            vertical-align: baseline;
            margin: 0;
            padding: 0;
        }

        .parentheses-value {
            margin: 0 8px;
            font-size: 17px;
            display: inline-flex;
            align-items: center;
            min-width: 45px;
            justify-content: center;
            line-height: 1.2;
            font-weight: 900;
            color: #2c1a1a;
            vertical-align: baseline;
            height: auto;
            padding: 0;
        }

        .parentheses-value::before {
            content: '(';
            margin-left: 3px;
            font-size: 17px;
        }

        .parentheses-value::after {
            content: ')';
            margin-right: 3px;
            font-size: 17px;
        }

        .thick-divider {
            height: 2px;
            background-color: #000;
            margin: 6px 0;
            width: 100%;
        }

        /* التذييل */
        .print-footer {
            margin-top: auto;
            padding: 15px 0 10px 0;
            margin-left: 0;
            margin-right: 0;
            margin-bottom: 0;
            flex-shrink: 0;
            page-break-inside: avoid !important;
            position: relative;
            z-index: 3;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-top: 6px;
        }

        .footer-left, .footer-right {
            flex: 1;
            text-align: center;
        }

        .footer-title {
            font-weight: 900;
            font-size: 17px;
            margin-bottom: 2px;
            line-height: 1.2;
        }

        .admin-names {
            font-weight: 900;
            font-size: 17px;
            margin-bottom: 3px;
            display: inline-block;
            vertical-align: middle;
            line-height: 1.2;
        }

        .admin-date {
            font-size: 17px;
            font-weight: 900;
            line-height: 1.2;
        }

        .payment-info {
            font-size: 17px;
            font-weight: 900;
            display: inline-block;
            vertical-align: middle;
            margin-left: 25px;
            line-height: 1.2;
        }

        .assistance-amount {
            margin-top: 18px;
            margin-bottom: 0;
            padding: 0;
            text-align: right;
            padding-right: 2%;
        }

        /* ألوان الهيدر المختلفة */
        .header-sayed {
            background-color: #b9f6ca !important;
            border-bottom: 3.5px solid #000 !important;
        }

        .header-aam {
            background-color: #b3e5fc !important;
            border-bottom: 3.5px solid #000 !important;
        }

        .header-expenses {
            background-color: #ffeb3b !important;
            border-bottom: 3.5px solid #000 !important;
        }

        .print-footer::after {
            content: "تم التنسيق بواسطة GitHub Copilot";
            display: block;
            text-align: left;
            font-size: 13px;
            color: #888;
            margin-top: 8px;
            font-family: Arial, sans-serif;
            letter-spacing: 1px;
        }

        @media print {
            .print-container,
            .print-container *,
            .print-border-backup {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            }

            .print-container {
            width: 20.3cm !important;
            min-height: 29cm !important;
            max-width: 20.3cm !important;
            max-height: 29cm !important;
            margin: 0.35cm !important;
            padding: 38px 18px 18px 18px !important;
            background: white !important;
            box-sizing: border-box !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
            font-size: 16px !important;
            font-weight: 800 !important;
            line-height: 1.2 !important;
            position: relative !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            page-break-after: avoid !important;
            page-break-inside: avoid !important;
            }

            .print-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-top: 6px solid #000 !important;
            border-bottom: 3.5px solid #000 !important;
            border-right: 3.5px solid #000 !important;
            border-left: 3.5px solid #000 !important;
            border-radius: 12px !important;
            pointer-events: none;
            z-index: 10;
            display: block !important;
            }

            body * {
            visibility: hidden !important;
            }

            #print-preview-content, 
            #print-preview-content * {
            visibility: visible !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            }

            body > :not(#print-preview-container) {
            display: none !important;
            }

            #print-preview-container {
            display: block !important;
            position: static !important;
            background: none !important;
            width: 100% !important;
            height: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            z-index: 1 !important;
            }

            #print-preview-actions,
            #print-preview-close,
            .toast-container {
            display: none !important;
            }

            @page {
            size: A4 portrait !important;
            margin: 0 !important;
            padding: 0 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            orphans: 1 !important;
            widows: 1 !important;
            }
        }



        /* ==============================
           التجاوب مع الشاشات المختلفة
        ============================== */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                height: calc(100vh - 60px);
                z-index: 999;
            }

            .sidebar.show {
                left: 0;
            }

            .sidebar.collapsed {
                left: -280px;
            }

            .main-content {
                margin-right: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn-group .btn {
                width: 100%;
            }

            .content-header {
                padding: 15px;
            }

            .content-body {
                padding: 15px;
            }
        }

        /* ==============================
           تأثيرات حديثة وتحسينات بصرية
        ============================== */
        .floating-action {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .floating-action:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(231, 76, 60, 0.4);
        }

        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .slide-in {
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- شريط العنوان العلوي المُحسن -->
    <header class="top-header">
        <div class="header-logo">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/%D9%85%D9%84%D9%81%20%D8%B5%D9%88%D8%B1%20%D8%AA%D8%B7%D8%A8%D9%82%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B1%20%D8%B3%D9%85%D8%A7%20%D8%A8%D8%A7%D8%A8%D9%84%2Ffile_0000000077b4622f9294f80fafefb564%20(1).png?alt=media&token=d79da964-2f40-4edd-a17e-6f9c71816b49" alt="شعار المؤسسة">
            <div class="header-title">
                <h1>نظام إدارة الحالات الخيرية</h1>
                <p>مؤسسة أولاد الحسن (ع) الثقافية الخيرية</p>
            </div>
        </div>
        
        <div class="header-actions">
            <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="current-user">أبو كرار</span>
                <i class="fas fa-chevron-down"></i>
            </div>
        </div>
    </header>

    <!-- التخطيط الرئيسي -->
    <div class="main-layout">
        <!-- الشريط الجانبي المُحسن -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-content">
                <!-- قسم البحث والـ QR -->
                <div class="search-section">
                    <div class="search-box">
                        <input type="text" id="globalSearch" placeholder="البحث عن حالة..." onkeyup="performSearch()">
                        <i class="fas fa-search"></i>
                    </div>
                    <button class="qr-scanner-btn" onclick="openQRScanner()">
                        <i class="fas fa-qrcode"></i>
                        <span id="qr-text">مسح رمز QR</span>
                    </button>
                </div>

                <!-- قائمة التنقل -->
                <nav class="nav-menu">
                    <div class="nav-section">
                        <div class="nav-section-title">القائمة الرئيسية</div>
                        <div class="nav-item active" onclick="showSection('dashboard')">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>لوحة التحكم</span>
                        </div>
                        <div class="nav-item" onclick="showSection('create-case')">
                            <i class="fas fa-plus-circle"></i>
                            <span>إنشاء حالة جديدة</span>
                        </div>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">إدارة الحالات</div>
                        <div class="nav-item" onclick="showSection('cases-sayed')">
                            <i class="fas fa-hand-holding-heart"></i>
                            <span>حالات السيد</span>
                            <span class="badge" id="sayed-count">0</span>
                        </div>
                        <div class="nav-item" onclick="showSection('cases-expenses')">
                            <i class="fas fa-receipt"></i>
                            <span>حالات المصاريف</span>
                            <span class="badge" id="expenses-count">0</span>
                        </div>
                        <div class="nav-item" onclick="showSection('cases-general')">
                            <i class="fas fa-users"></i>
                            <span>الحالات العامة</span>
                            <span class="badge" id="general-count">0</span>
                        </div>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">التقارير والأدوات</div>
                        <div class="nav-item" onclick="showSection('reports')">
                            <i class="fas fa-chart-bar"></i>
                            <span>التقارير</span>
                        </div>
                        <div class="nav-item" onclick="showSection('export')">
                            <i class="fas fa-download"></i>
                            <span>التصدير والاستيراد</span>
                        </div>
                        <div class="nav-item" onclick="showSection('analytics')">
                            <i class="fas fa-analytics"></i>
                            <span>الإحصائيات المتقدمة</span>
                        </div>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">النظام</div>
                        <div class="nav-item" onclick="showSection('settings')">
                            <i class="fas fa-cog"></i>
                            <span>الإعدادات</span>
                        </div>
                        <div class="nav-item" onclick="showSection('backup')">
                            <i class="fas fa-shield-alt"></i>
                            <span>النسخ الاحتياطي</span>
                        </div>
                    </div>
                </nav>
            </div>
        </aside>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <!-- لوحة التحكم -->
            <section id="dashboard-section" class="content-section active">
                <div class="content-header">
                    <h2>لوحة التحكم</h2>
                    <p>إحصائيات شاملة ونظرة عامة على النظام</p>
                    <div class="breadcrumb">
                        <a href="#" onclick="showSection('dashboard')">الرئيسية</a>
                        <i class="fas fa-chevron-left"></i>
                        <span>لوحة التحكم</span>
                    </div>
                </div>

                <div class="content-body">
                    <!-- بطاقات الإحصائيات -->
                    <div class="stats-grid">
                        <div class="stat-card info">
                            <div class="stat-header">
                                <div class="stat-title">إجمالي الحالات</div>
                                <div class="stat-icon info">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="total-cases">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +12% من الشهر الماضي
                            </div>
                        </div>

                        <div class="stat-card success">
                            <div class="stat-header">
                                <div class="stat-title">الحالات المكتملة</div>
                                <div class="stat-icon success">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="completed-cases">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +8% من الشهر الماضي
                            </div>
                        </div>

                        <div class="stat-card warning">
                            <div class="stat-header">
                                <div class="stat-title">إجمالي المبالغ</div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="total-amount">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +15% من الشهر الماضي
                            </div>
                        </div>

                        <div class="stat-card danger">
                            <div class="stat-header">
                                <div class="stat-title">الحالات النشطة</div>
                                <div class="stat-icon danger">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="active-cases">0</div>
                            <div class="stat-change negative">
                                <i class="fas fa-arrow-down"></i>
                                -5% من الشهر الماضي
                            </div>
                        </div>
                    </div>

                    <!-- الأنشطة الحديثة -->
                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">آخر الحالات المضافة</div>
                            <div class="table-actions">
                                <button class="btn btn-primary" onclick="showSection('create-case')">
                                    <i class="fas fa-plus"></i>
                                    إضافة حالة جديدة
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم الاستمارة</th>
                                        <th>اسم الحالة</th>
                                        <th>نوع الحالة</th>
                                        <th>المبلغ</th>
                                        <th>التاريخ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-cases-table">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 40px;">
                                            <i class="fas fa-inbox" style="font-size: 40px; color: #ccc; margin-bottom: 15px;"></i>
                                            <p style="color: #6c757d;">لا توجد حالات مضافة بعد</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- قسم إنشاء حالة جديدة -->
            <section id="create-case-section" class="content-section">
                <div class="content-header">
                    <h2>إنشاء حالة جديدة</h2>
                    <p>إضافة حالة خيرية جديدة إلى النظام</p>
                    <div class="breadcrumb">
                        <a href="#" onclick="showSection('dashboard')">الرئيسية</a>
                        <i class="fas fa-chevron-left"></i>
                        <span>إنشاء حالة جديدة</span>
                    </div>
                </div>

                <div class="content-body">
                    <div class="form-container">
                        <form id="case-form">
                            <div class="form-header">
                                <h3>معلومات الحالة</h3>
                                <p>يرجى ملء جميع البيانات المطلوبة بدقة</p>
                            </div>

                            <div class="form-section">
                                <div class="form-section-title">معلومات الحالة الأساسية</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">رمز الحالة</label>
                                        <select class="form-control" id="caseCode">
                                            <option value="مصاريف">مصاريف</option>
                                            <option value="سيد">سيد</option>
                                            <option value="عام">عام</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">نوع الحالة</label>
                                        <input type="text" class="form-control" id="caseType" placeholder="مهرجان استشهاد امير المؤمنين">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">التاريخ</label>
                                        <input type="date" class="form-control" id="caseDate">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">المنظم</label>
                                        <input type="text" class="form-control" id="organizer" value="">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">رقم الاستمارة</label>
                                        <input type="text" class="form-control" id="formNumber" placeholder="001" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">البيانات الشخصية</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">الاسم الكامل</label>
                                        <input type="text" class="form-control" id="fullName">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">اللقب</label>
                                        <input type="text" class="form-control" id="lastName">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">أبو / أم</label>
                                        <input type="text" class="form-control" id="parentName">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">العمر</label>
                                        <input type="number" class="form-control" id="age">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">الحالة الاجتماعية</label>
                                        <select class="form-control" id="socialStatus">
                                            <option value="متزوج/ة">متزوج/ة</option>
                                            <option value="أعزب/عزباء">أعزب/عزباء</option>
                                            <option value="مطلق/ة">مطلق/ة</option>
                                            <option value="أرمل/ة">أرمل/ة</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">العنوان وأقرب نقطة دالة</label>
                                        <input type="text" class="form-control" id="address">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">الموثق</label>
                                        <input type="text" class="form-control" id="verifier">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">اسم المختار</label>
                                        <input type="text" class="form-control" id="mukhtarName">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">شرح الحالة</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">شرح الحالة</label>
                                        <textarea class="form-control" id="caseDescription" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">المعلومات المالية</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">راتب حكومي</label>
                                        <input type="number" class="form-control" id="govSalary" onchange="calculateIncomeRemaining()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">راتب مؤسسة</label>
                                        <input type="number" class="form-control" id="orgSalary" onchange="calculateIncomeRemaining()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">مقدار الدخل</label>
                                        <input type="number" class="form-control" id="incomeAmount" onchange="calculateIncomeRemaining()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">المصروفات</label>
                                        <input type="number" class="form-control" id="expenses" onchange="calculateIncomeRemaining()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">باقي الدخل</label>
                                        <input type="number" class="form-control" id="incomeRemaining" readonly>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">معلومات السكن والعائلة</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">نوع السكن</label>
                                        <select class="form-control" id="housingType" onchange="toggleRentAmount()">
                                            <option value="ملك">ملك</option>
                                            <option value="إيجار">إيجار</option>
                                            <option value="إرث">إرث</option>
                                            <option value="مشترك">مشترك</option>
                                            <option value="أخر">أخر</option>
                                            <option value="تجاوز">تجاوز</option>
                                        </select>
                                    </div>
                                    <div class="form-group" id="rentAmountGroup" style="display: none;">
                                        <label class="form-label">مقدار الإيجار</label>
                                        <input type="number" class="form-control" id="rentAmount" placeholder="مقدار الإيجار بالدينار">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">عدد أفراد الأسرة</label>
                                        <input type="number" class="form-control" id="totalFamilyMembers" onchange="updateFamilyFields()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">بنين</label>
                                        <input type="number" class="form-control" id="maleChildren" onchange="updateFamilyFields()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">بنات</label>
                                        <input type="number" class="form-control" id="femaleChildren" onchange="updateFamilyFields()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">متزوجين</label>
                                        <input type="number" class="form-control" id="married" onchange="updateFamilyFields()">
                                    </div>
                                </div>
                                
                                <!-- الحقول الديناميكية لأعمار ووظائف أفراد العائلة -->
                                <div id="familyDynamicFields" style="display:none; background: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 15px;">
                                    <h4 style="color: #3498db; margin-bottom: 12px;">أعمار ووظائف أفراد العائلة</h4>
                                    <div id="dynamicFieldsContainer"></div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">المعلومات الطبية</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">اسم المستشفى</label>
                                        <input type="text" class="form-control" id="hospitalName">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">عنوان المستشفى</label>
                                        <input type="text" class="form-control" id="hospitalAddress">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">نوع الحالة الطبية</label>
                                        <input type="text" class="form-control" id="caseTypeDetail">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">اسم الدكتور</label>
                                        <input type="text" class="form-control" id="doctorName">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">المبلغ رقماً</label>
                                        <input type="number" class="form-control" id="amountNumeric" value="150">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">المبلغ كتابة</label>
                                        <input type="text" class="form-control" id="amountWritten">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">المجموع</label>
                                        <input type="number" class="form-control" id="totalAmount">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">معلومات الاتصال</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">رقم الهاتف الأول</label>
                                        <input type="text" class="form-control" id="phoneFirst" value="00000000000">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">رقم الهاتف الثاني</label>
                                        <input type="text" class="form-control" id="phoneSecond" value="00000000000">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">الجهات التي تقوم بالمساعدة</label>
                                        <input type="text" class="form-control" id="supportingAgencies">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">معلومات الزوج/ة</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">الزوج/ة</label>
                                        <input type="text" class="form-control" id="spouseName">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">اللقب</label>
                                        <input type="text" class="form-control" id="spouseLastName">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">المهنة</label>
                                        <input type="text" class="form-control" id="spouseJob">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">الراتب</label>
                                        <input type="number" class="form-control" id="spouseSalary">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">معلومات إضافية</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">هل يوجد معيل آخر</label>
                                        <select class="form-control" id="hasOtherSupport">
                                            <option value="لا">لا</option>
                                            <option value="نعم">نعم</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">اسم المعيل</label>
                                        <input type="text" class="form-control" id="supporterName">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">صلة القرابة</label>
                                        <input type="text" class="form-control" id="supporterRelation">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">الملاحظات</label>
                                        <textarea class="form-control" id="notes" rows="3"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-section">
                                <div class="form-section-title">مبلغ المساعدة</div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">يصرف مبلغ المساعدة المقدر</label>
                                        <input type="text" class="form-control" id="estimatedAssistance">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="btn-group">
                                <button type="button" class="btn btn-success" onclick="saveForm()">
                                    <i class="fas fa-save"></i>
                                    حفظ البيانات
                                </button>
                                <button type="button" class="btn btn-primary" onclick="enhancedPrintPreview()">
                                    <i class="fas fa-print"></i>
                                    معاينة الطباعة
                                </button>
                                <button type="button" class="btn btn-light" onclick="resetForm()">
                                    <i class="fas fa-redo"></i>
                                    إعادة تعيين
                                </button>
                                <button type="button" class="btn btn-warning" onclick="fillFakeData()">
                                    <i class="fas fa-magic"></i>
                                    معلومات وهمية
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- أقسام الحالات -->
            <section id="cases-sayed-section" class="content-section">
                <div class="content-header">
                    <h2>حالات السيد</h2>
                    <p>جميع الحالات الخاصة بالسيد</p>
                </div>
                <div class="content-body">
                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">حالات السيد</div>
                            <div class="table-actions">
                                <button class="btn btn-primary" onclick="filterCases('سيد')">
                                    <i class="fas fa-filter"></i>
                                    تطبيق الفلتر
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم الاستمارة</th>
                                        <th>اسم الحالة</th>
                                        <th>المبلغ</th>
                                        <th>التاريخ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="sayed-cases-table">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px;">
                                            <i class="fas fa-hand-holding-heart" style="font-size: 40px; color: #ccc; margin-bottom: 15px;"></i>
                                            <p style="color: #6c757d;">لا توجد حالات سيد</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="cases-expenses-section" class="content-section">
                <div class="content-header">
                    <h2>حالات المصاريف</h2>
                    <p>جميع حالات المصاريف والتكاليف</p>
                </div>
                <div class="content-body">
                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">حالات المصاريف</div>
                            <div class="table-actions">
                                <button class="btn btn-primary" onclick="filterCases('مصاريف')">
                                    <i class="fas fa-filter"></i>
                                    تطبيق الفلتر
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم الاستمارة</th>
                                        <th>اسم الحالة</th>
                                        <th>المبلغ</th>
                                        <th>التاريخ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="expenses-cases-table">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px;">
                                            <i class="fas fa-receipt" style="font-size: 40px; color: #ccc; margin-bottom: 15px;"></i>
                                            <p style="color: #6c757d;">لا توجد حالات مصاريف</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="cases-general-section" class="content-section">
                <div class="content-header">
                    <h2>الحالات العامة</h2>
                    <p>جميع الحالات العامة والمساعدات المتنوعة</p>
                </div>
                <div class="content-body">
                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">الحالات العامة</div>
                            <div class="table-actions">
                                <button class="btn btn-primary" onclick="filterCases('عام')">
                                    <i class="fas fa-filter"></i>
                                    تطبيق الفلتر
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>رقم الاستمارة</th>
                                        <th>اسم الحالة</th>
                                        <th>المبلغ</th>
                                        <th>التاريخ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="general-cases-table">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px;">
                                            <i class="fas fa-users" style="font-size: 40px; color: #ccc; margin-bottom: 15px;"></i>
                                            <p style="color: #6c757d;">لا توجد حالات عامة</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- قسم التقارير -->
            <section id="reports-section" class="content-section">
                <div class="content-header">
                    <h2>التقارير والإحصائيات</h2>
                    <p>تقارير شاملة وإحصائيات مفصلة</p>
                </div>
                <div class="content-body">
                    <div class="stats-grid">
                        <div class="stat-card success">
                            <div class="stat-header">
                                <div class="stat-title">تقرير شهري</div>
                                <div class="stat-icon success">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="generateMonthlyReport()">
                                <i class="fas fa-file-pdf"></i>
                                إنشاء تقرير
                            </button>
                        </div>

                        <div class="stat-card info">
                            <div class="stat-header">
                                <div class="stat-title">تقرير سنوي</div>
                                <div class="stat-icon info">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="generateYearlyReport()">
                                <i class="fas fa-file-excel"></i>
                                إنشاء تقرير
                            </button>
                        </div>

                        <div class="stat-card warning">
                            <div class="stat-header">
                                <div class="stat-title">تقرير مخصص</div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-cogs"></i>
                                </div>
                            </div>
                            <button class="btn btn-warning" onclick="openCustomReport()">
                                <i class="fas fa-filter"></i>
                                تخصيص
                            </button>
                        </div>
                    </div>

                    <!-- رسم بياني للإحصائيات -->
                    <div class="form-container">
                        <div class="form-header">
                            <h3>الإحصائيات البيانية</h3>
                            <p>رسوم بيانية تفاعلية لأداء النظام</p>
                        </div>
                        <canvas id="statisticsChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </section>

            <!-- قسم التصدير والاستيراد -->
            <section id="export-section" class="content-section">
                <div class="content-header">
                    <h2>التصدير والاستيراد</h2>
                    <p>أدوات إدارة البيانات والنسخ الاحتياطي</p>
                </div>
                <div class="content-body">
                    <div class="stats-grid">
                        <div class="form-container">
                            <div class="form-header">
                                <h3>تصدير البيانات</h3>
                                <p>تصدير البيانات بصيغ مختلفة</p>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i>
                                    تصدير إلى Excel
                                </button>
                                <button class="btn btn-danger" onclick="exportToPDF()">
                                    <i class="fas fa-file-pdf"></i>
                                    تصدير إلى PDF
                                </button>
                                <button class="btn btn-primary" onclick="exportToJSON()">
                                    <i class="fas fa-file-code"></i>
                                    تصدير إلى JSON
                                </button>
                            </div>
                        </div>

                        <div class="form-container">
                            <div class="form-header">
                                <h3>استيراد البيانات</h3>
                                <p>استيراد البيانات من ملفات خارجية</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">اختر ملف للاستيراد</label>
                                <input type="file" class="form-control" id="importFile" accept=".json,.csv,.xlsx">
                            </div>
                            <button class="btn btn-warning" onclick="importData()">
                                <i class="fas fa-upload"></i>
                                استيراد البيانات
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- قسم الإحصائيات المتقدمة -->
            <section id="analytics-section" class="content-section">
                <div class="content-header">
                    <h2>الإحصائيات المتقدمة</h2>
                    <p>تحليلات عميقة ومؤشرات الأداء</p>
                </div>
                <div class="content-body">
                    <div class="stats-grid">
                        <div class="stat-card info">
                            <div class="stat-header">
                                <div class="stat-title">متوسط المبلغ</div>
                                <div class="stat-icon info">
                                    <i class="fas fa-calculator"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="avg-amount">0</div>
                            <div class="stat-change">دينار عراقي</div>
                        </div>

                        <div class="stat-card success">
                            <div class="stat-header">
                                <div class="stat-title">الحالات هذا الشهر</div>
                                <div class="stat-icon success">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="month-cases">0</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +20% من الشهر الماضي
                            </div>
                        </div>

                        <div class="stat-card warning">
                            <div class="stat-header">
                                <div class="stat-title">أكثر الأنواع طلباً</div>
                                <div class="stat-icon warning">
                                    <i class="fas fa-trophy"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="top-category">مصاريف</div>
                            <div class="stat-change">النوع الأكثر شيوعاً</div>
                        </div>

                        <div class="stat-card danger">
                            <div class="stat-header">
                                <div class="stat-title">معدل النمو</div>
                                <div class="stat-icon danger">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="growth-rate">+15%</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i>
                                نمو إيجابي
                            </div>
                        </div>
                    </div>

                    <div class="form-container">
                        <div class="form-header">
                            <h3>توزيع الحالات</h3>
                            <p>رسم بياني دائري لتوزيع أنواع الحالات</p>
                        </div>
                        <canvas id="pieChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </section>

            <!-- قسم الإعدادات -->
            <section id="settings-section" class="content-section">
                <div class="content-header">
                    <h2>إعدادات النظام</h2>
                    <p>تخصيص وإعداد النظام حسب احتياجاتك</p>
                </div>
                <div class="content-body">
                    <div class="form-container">
                        <div class="form-header">
                            <h3>الإعدادات العامة</h3>
                            <p>إعدادات أساسية للنظام</p>
                        </div>
                        
                        <div class="form-section">
                            <div class="form-section-title">معلومات المؤسسة</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">اسم المؤسسة</label>
                                    <input type="text" class="form-control" id="orgName" value="مؤسسة أولاد الحسن (ع) الثقافية الخيرية">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">المدير الأول</label>
                                    <input type="text" class="form-control" id="manager1" value="السيد أسامة السعبري">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">المدير الثاني</label>
                                    <input type="text" class="form-control" id="manager2" value="السيد فؤاد السعبري">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">المنظم الافتراضي</label>
                                    <input type="text" class="form-control" id="defaultOrganizer" value="أبو كرار">
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">إعدادات الطباعة</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">حجم الخط الافتراضي</label>
                                    <select class="form-control" id="defaultFontSize">
                                        <option value="14">صغير (14px)</option>
                                        <option value="16" selected>متوسط (16px)</option>
                                        <option value="18">كبير (18px)</option>
                                        <option value="20">كبير جداً (20px)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">تلقائية رقم الاستمارة</label>
                               <!-- إكمال الكود من حيث توقف -->
                                    <select class="form-control" id="autoFormNumber">
                                        <option value="yes" selected>نعم</option>
                                        <option value="no">لا</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">إظهار QR Code</label>
                                    <select class="form-control" id="showQRCode">
                                        <option value="yes" selected>نعم</option>
                                        <option value="no">لا</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="btn-group">
                            <button class="btn btn-success" onclick="saveSettings()">
                                <i class="fas fa-save"></i>
                                حفظ الإعدادات
                            </button>
                            <button class="btn btn-light" onclick="resetSettings()">
                                <i class="fas fa-undo"></i>
                                إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- قسم النسخ الاحتياطي -->
            <section id="backup-section" class="content-section">
                <div class="content-header">
                    <h2>النسخ الاحتياطي والاستعادة</h2>
                    <p>أدوات حماية البيانات والاستعادة</p>
                </div>
                <div class="content-body">
                    <div class="stats-grid">
                        <div class="form-container">
                            <div class="form-header">
                                <h3>إنشاء نسخة احتياطية</h3>
                                <p>حفظ جميع البيانات في ملف احتياطي</p>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-success" onclick="createFullBackup()">
                                    <i class="fas fa-database"></i>
                                    نسخة احتياطية كاملة
                                </button>
                                <button class="btn btn-primary" onclick="createPartialBackup()">
                                    <i class="fas fa-file-archive"></i>
                                    نسخة احتياطية جزئية
                                </button>
                            </div>
                        </div>

                        <div class="form-container">
                            <div class="form-header">
                                <h3>استعادة البيانات</h3>
                                <p>استعادة البيانات من نسخة احتياطية</p>
                            </div>
                            <div class="form-group">
                                <label class="form-label">اختر ملف النسخة الاحتياطية</label>
                                <input type="file" class="form-control" id="backupFile" accept=".json,.bak">
                            </div>
                            <button class="btn btn-warning" onclick="restoreBackup()">
                                <i class="fas fa-upload"></i>
                                استعادة البيانات
                            </button>
                        </div>
                    </div>

                    <div class="form-container">
                        <div class="form-header">
                            <h3>النسخ الاحتياطية التلقائية</h3>
                            <p>جدولة النسخ الاحتياطية التلقائية</p>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">تكرار النسخ الاحتياطي</label>
                                <select class="form-control" id="backupFrequency">
                                    <option value="daily">يومياً</option>
                                    <option value="weekly" selected>أسبوعياً</option>
                                    <option value="monthly">شهرياً</option>
                                    <option value="manual">يدوي</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">وقت النسخ الاحتياطي</label>
                                <input type="time" class="form-control" id="backupTime" value="02:00">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveBackupSettings()">
                            <i class="fas fa-clock"></i>
                            حفظ الجدولة
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- النوافذ المنبثقة -->
    
    <!-- نافذة البحث المتقدم -->
    <div class="modal" id="advancedSearchModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">البحث المتقدم</h3>
                <button class="modal-close" onclick="closeModal('advancedSearchModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">رقم الاستمارة</label>
                        <input type="text" class="form-control" id="searchFormNumber">
                    </div>
                    <div class="form-group">
                        <label class="form-label">اسم الحالة</label>
                        <input type="text" class="form-control" id="searchName">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">نوع الحالة</label>
                        <select class="form-control" id="searchCaseType">
                            <option value="">جميع الأنواع</option>
                            <option value="سيد">سيد</option>
                            <option value="مصاريف">مصاريف</option>
                            <option value="عام">عام</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">من تاريخ</label>
                        <input type="date" class="form-control" id="searchFromDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">إلى تاريخ</label>
                        <input type="date" class="form-control" id="searchToDate">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="performAdvancedSearch()">
                        <i class="fas fa-search"></i>
                        بحث
                    </button>
                    <button class="btn btn-light" onclick="clearSearch()">
                        <i class="fas fa-eraser"></i>
                        مسح
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة QR Scanner -->
    <div class="modal" id="qrScannerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">مسح رمز QR</h3>
                <button class="modal-close" onclick="closeModal('qrScannerModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-qrcode" style="font-size: 80px; color: #3498db; margin-bottom: 15px;"></i>
                    <h3>مسح رمز QR</h3>
                    <p>قم بتوجيه الكاميرا نحو رمز QR للبحث عن الحالة</p>
                    <div id="qr-reader" style="margin-top: 15px;"></div>
                    <button class="btn btn-primary" onclick="startQRScanner()">
                        <i class="fas fa-camera"></i>
                        تشغيل الكاميرا
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة معاينة الطباعة المحسنة -->
    <div id="print-preview-container">
        <div id="print-preview-content">
            <!-- سيتم إنشاء المحتوى ديناميكياً -->
        </div>
        <div id="print-preview-close" onclick="closePrintPreview()">
            <i class="fas fa-times"></i>
        </div>
        <div id="print-preview-actions">
            <button class="btn btn-primary" onclick="printFromPreview()">
                <i class="fas fa-print"></i>
                <span>طباعة</span>
            </button>
            <button class="btn btn-light" onclick="closePrintPreview()">
                <i class="fas fa-times"></i>
                <span>إلغاء</span>
            </button>
        </div>
    </div>

    <!-- حاوية الإشعارات -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- الزر العائم -->
    <div class="floating-action" onclick="showSection('create-case')" title="إنشاء حالة جديدة">
        <i class="fas fa-plus"></i>
    </div>

    <script>
        // متغيرات النظام الأساسية المُحسنة
        let casesData = [];
        let currentSection = 'dashboard';
        let sidebarCollapsed = false;
        let chartInstances = {};
        let systemSettings = {
            orgName: 'مؤسسة أولاد الحسن (ع) الثقافية الخيرية',
            manager1: 'السيد أسامة السعبري',
            manager2: 'السيد فؤاد السعبري',
            defaultOrganizer: 'أبو كرار',
            defaultFontSize: '16',
            autoFormNumber: 'yes',
            showQRCode: 'yes'
        };

        // تهيئة النظام عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            loadSavedData();
            updateStatistics();
            setupEventListeners();
        });

        // تهيئة النظام المُحسنة
        function initializeSystem() {
            // تحميل الإعدادات المحفوظة
            loadSavedSettings();
            
            // تعيين المنظم من الإعدادات
            updateOrganizerFromSettings();
            
            // تعيين تاريخ اليوم
            const today = new Date();
            const formattedDate = today.toISOString().substr(0, 10);
            const dateInput = document.getElementById('caseDate');
            if (dateInput) {
                dateInput.value = formattedDate;
            }
            
            // توليد رقم الاستمارة
            generateFormNumber();
            
            // تهيئة الرسوم البيانية
            initializeCharts();
            
            showToast('تم تحميل النظام بنجاح!', 'success', 'مرحباً بك');
        }

        // تحديث المنظم من الإعدادات
        function updateOrganizerFromSettings() {
            const organizerInput = document.getElementById('organizer');
            const currentUserElement = document.getElementById('current-user');
            
            if (organizerInput && systemSettings.defaultOrganizer) {
                organizerInput.value = systemSettings.defaultOrganizer;
            }
            
            if (currentUserElement && systemSettings.defaultOrganizer) {
                currentUserElement.textContent = systemSettings.defaultOrganizer;
            }
        }

        // إعداد مستمعي الأحداث المُحسنة
        function setupEventListeners() {
            // البحث السريع
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(performSearch, 300));
            }

            // حفظ البيانات تلقائياً كل 30 ثانية
            setInterval(autoSave, 30000);

            // مراقبة تغييرات النموذج
            const form = document.getElementById('case-form');
            if (form) {
                form.addEventListener('input', markFormDirty);
            }

            // إعداد أحداث لوحة المفاتيح
            setupKeyboardShortcuts();
        }

        // إعداد اختصارات لوحة المفاتيح
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + S للحفظ
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (currentSection === 'create-case') {
                        saveForm();
                    }
                }
                
                // Ctrl/Cmd + N لحالة جديدة
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    showSection('create-case');
                    resetForm();
                }
                
                // Ctrl/Cmd + P للطباعة
                if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                    e.preventDefault();
                    if (currentSection === 'create-case') {
                        enhancedPrintPreview();
                    }
                }
                
                // Escape لإغلاق النوافذ المنبثقة
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        }

        // إغلاق جميع النوافذ المنبثقة
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(modal => {
                modal.classList.remove('show');
            });
            
            const printPreview = document.getElementById('print-preview-container');
            if (printPreview.style.display === 'flex') {
                closePrintPreview();
            }
            
            document.body.style.overflow = 'auto';
        }

        // توليد رقم الاستمارة التلقائي المُحسن
        function generateFormNumber() {
            if (systemSettings.autoFormNumber === 'no') return;
            
            const today = new Date();
            const year = today.getFullYear().toString().slice(-2);
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            const hour = today.getHours().toString().padStart(2, '0');
            const minute = today.getMinutes().toString().padStart(2, '0');
            
            const formNumber = `${year}${month}${day}${hour}${minute}`;
            const formNumberInput = document.getElementById('formNumber');
            if (formNumberInput) {
                formNumberInput.value = formNumber;
            }
        }

        // إدارة الشريط الجانبي المُحسن
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                sidebar.classList.toggle('show');
            } else {
                sidebar.classList.toggle('collapsed');
                sidebarCollapsed = !sidebarCollapsed;
                
                // تحديث المحتوى الرئيسي
                if (sidebarCollapsed) {
                    mainContent.style.marginRight = '70px';
                } else {
                    mainContent.style.marginRight = '280px';
                }
                
                // تحديث نص الأزرار عند الانطوي
                const qrText = document.getElementById('qr-text');
                if (qrText) {
                    qrText.style.display = sidebarCollapsed ? 'none' : 'inline';
                }
            }
        }

        // إدارة الأقسام المُحسنة
        function showSection(sectionName) {
            // إخفاء جميع الأقسام
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });

            // إظهار القسم المطلوب
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'block';
                currentSection = sectionName;
            }

            // تحديث حالة عناصر التنقل
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
            });

            // تفعيل عنصر التنقل الحالي
            const activeNavItem = document.querySelector(`[onclick="showSection('${sectionName}')"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // تحديث المحتوى حسب القسم
            switch(sectionName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'reports':
                    updateReportsCharts();
                    break;
                case 'analytics':
                    updateAnalyticsCharts();
                    break;
                case 'cases-sayed':
                    loadCasesByType('سيد');
                    break;
                case 'cases-expenses':
                    loadCasesByType('مصاريف');
                    break;
                case 'cases-general':
                    loadCasesByType('عام');
                    break;
                case 'settings':
                    loadSettingsToForm();
                    break;
            }

            // إخفاء الشريط الجانبي في الأجهزة المحمولة
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.remove('show');
            }
        }

        // حفظ النموذج المُحسن
        function saveForm() {
            try {
                const formData = getFormData();
                
                // التحقق من صحة البيانات
                if (!validateFormData(formData)) {
                    return;
                }
                
                const form = document.getElementById('case-form');
                const editId = form.getAttribute('data-edit-id');
                
                if (editId) {
                    // وضع التعديل
                    if (updateExistingCase(editId, formData)) {
                        showToast('تم تحديث الحالة بنجاح!', 'success', 'نجح التحديث');
                        setTimeout(() => {
                            resetForm();
                            form.removeAttribute('data-edit-id');
                            document.querySelector('#create-case-section .content-header h2').textContent = 'إنشاء حالة جديدة';
                        }, 1000);
                    } else {
                        showToast('فشل في تحديث الحالة', 'error');
                    }
                } else {
                    // وضع الإنشاء الجديد
                    formData.id = generateUniqueId();
                    formData.createdAt = new Date().toISOString();
                    formData.updatedAt = new Date().toISOString();
                    formData.status = 'active';
                    
                    // إضافة إلى قاعدة البيانات
                    casesData.push(formData);
                    
                    // حفظ في التخزين المحلي
                    saveToStorage();
                    
                    // تحديث الإحصائيات
                    updateStatistics();
                    updateDashboard();
                    
                    showToast('تم حفظ الحالة بنجاح!', 'success', 'نجح الحفظ');
                    
                    // إعادة تعيين النموذج
                    setTimeout(() => {
                        resetForm();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
                showToast('حدث خطأ أثناء حفظ البيانات', 'error', 'خطأ في الحفظ');
            }
        }

        // التحقق من صحة البيانات المُحسن
        function validateFormData(data) {
            const requiredFields = ['fullName', 'caseCode', 'caseType'];
            
            for (let field of requiredFields) {
                if (!data[field] || data[field].trim() === '') {
                    showToast(`يرجى ملء حقل ${getFieldLabel(field)}`, 'error', 'بيانات ناقصة');
                    
                    // التركيز على الحقل المفقود
                    const fieldElement = document.getElementById(field);
                    if (fieldElement) {
                        fieldElement.focus();
                        fieldElement.style.borderColor = '#e74c3c';
                        setTimeout(() => {
                            fieldElement.style.borderColor = '';
                        }, 3000);
                    }
                    
                    return false;
                }
            }
            
            return true;
        }

        // الحصول على تسمية الحقل باللغة العربية
        function getFieldLabel(fieldName) {
            const labels = {
                'fullName': 'الاسم الكامل',
                'caseCode': 'رمز الحالة',
                'caseType': 'نوع الحالة'
            };
            return labels[fieldName] || fieldName;
        }

        // إنشاء معرف فريد محسن
        function generateUniqueId() {
            return 'case_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // الحصول على بيانات النموذج المُحسن
        function getFormData() {
            const formData = {};
            
            // الحصول على جميع عناصر الإدخال
            const inputs = document.querySelectorAll('#case-form input, #case-form select, #case-form textarea');
            
            inputs.forEach(input => {
                if (input.id) {
                    formData[input.id] = input.value;
                }
            });
            
            // إضافة بيانات أفراد العائلة الديناميكية
            formData.familyMembers = getFamilyMembersData();
            
            return formData;
        }

        // الحصول على بيانات أفراد العائلة المُحسن
        function getFamilyMembersData() {
            const familyData = {
                males: [],
                females: [],
                married: []
            };
            
            const maleCount = parseInt(document.getElementById('maleChildren')?.value) || 0;
            const femaleCount = parseInt(document.getElementById('femaleChildren')?.value) || 0;
            const marriedCount = parseInt(document.getElementById('married')?.value) || 0;
            
            // جمع بيانات البنين
            for (let i = 1; i <= maleCount; i++) {
                const ageElement = document.getElementById(`maleAge${i}`);
                const jobElement = document.getElementById(`maleJob${i}`);
                if (ageElement && jobElement) {
                    familyData.males.push({
                        age: ageElement.value,
                        job: jobElement.value
                    });
                }
            }
            
            // جمع بيانات البنات
            for (let i = 1; i <= femaleCount; i++) {
                const ageElement = document.getElementById(`femaleAge${i}`);
                const jobElement = document.getElementById(`femaleJob${i}`);
                if (ageElement && jobElement) {
                    familyData.females.push({
                        age: ageElement.value,
                        job: jobElement.value
                    });
                }
            }
            
            // جمع بيانات المتزوجين
            for (let i = 1; i <= marriedCount; i++) {
                const ageElement = document.getElementById(`marriedAge${i}`);
                const jobElement = document.getElementById(`marriedJob${i}`);
                if (ageElement && jobElement) {
                    familyData.married.push({
                        age: ageElement.value,
                        job: jobElement.value
                    });
                }
            }
            
            return familyData;
        }

        // حفظ البيانات في التخزين المحلي المُحسن
        function saveToStorage() {
            try {
                // حفظ في ذاكرة المتصفح
                window.charitySystemData = {
                    cases: casesData,
                    settings: systemSettings,
                    lastUpdate: new Date().toISOString(),
                    version: '2.0.0'
                };
                
                // حفظ إضافي محدود
                if (casesData.length > 0) {
                    console.log(`تم حفظ ${casesData.length} حالة في الذاكرة`);
                }
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
            }
        }

        // تحميل البيانات المحفوظة المُحسن
        function loadSavedData() {
            try {
                // التحميل من ذاكرة المتصفح
                if (window.charitySystemData && window.charitySystemData.cases) {
                    casesData = window.charitySystemData.cases;
                    if (window.charitySystemData.settings) {
                        systemSettings = { ...systemSettings, ...window.charitySystemData.settings };
                    }
                    console.log('تم تحميل البيانات من الذاكرة');
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                casesData = [];
            }
        }

        // تحديث الإحصائيات المُحسن
        function updateStatistics() {
            const totalCases = casesData.length;
            const completedCases = casesData.filter(c => c.status === 'completed').length;
            const activeCases = casesData.filter(c => c.status === 'active').length;
            
            // حساب المبلغ الإجمالي
            const totalAmount = casesData.reduce((sum, c) => {
                const amount = parseFloat(c.estimatedAssistance) || 0;
                return sum + amount;
            }, 0);
            
            // حساب حالات كل نوع
            const sayedCases = casesData.filter(c => c.caseCode === 'سيد').length;
            const expensesCases = casesData.filter(c => c.caseCode === 'مصاريف').length;
            const generalCases = casesData.filter(c => c.caseCode === 'عام').length;
            
            // تحديث العناصر في الواجهة
            updateElement('total-cases', totalCases);
            updateElement('completed-cases', completedCases);
            updateElement('active-cases', activeCases);
            updateElement('total-amount', formatCurrency(totalAmount));
            
            // تحديث أرقام الشارات
            updateElement('sayed-count', sayedCases);
            updateElement('expenses-count', expensesCases);
            updateElement('general-count', generalCases);
            
            // تحديث الإحصائيات المتقدمة
            updateAdvancedStats();
            
            // تحديث الرسوم البيانية
            updateChartsData();
        }

        // تحديث الإحصائيات المتقدمة
        function updateAdvancedStats() {
            if (casesData.length === 0) return;
            
            // متوسط المبلغ
            const totalAmount = casesData.reduce((sum, c) => {
                return sum + (parseFloat(c.estimatedAssistance) || 0);
            }, 0);
            const avgAmount = Math.round(totalAmount / casesData.length);
            
            // حالات هذا الشهر
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthCases = casesData.filter(c => {
                const caseDate = new Date(c.createdAt);
                return caseDate.getMonth() === currentMonth && caseDate.getFullYear() === currentYear;
            }).length;
            
            // أكثر الأنواع طلباً
            const typeCounts = {};
            casesData.forEach(c => {
                typeCounts[c.caseCode] = (typeCounts[c.caseCode] || 0) + 1;
            });
            const topCategory = Object.keys(typeCounts).reduce((a, b) => 
                typeCounts[a] > typeCounts[b] ? a : b, 'مصاريف'
            );
            
            updateElement('avg-amount', formatCurrency(avgAmount));
            updateElement('month-cases', monthCases);
            updateElement('top-category', topCategory);
        }

        // تحديث لوحة التحكم
        function updateDashboard() {
            updateRecentCasesTable();
            updateStatistics();
        }

        // تحديث جدول الحالات الأخيرة
        function updateRecentCasesTable() {
            const tableBody = document.getElementById('recent-cases-table');
            if (!tableBody) return;
            
            const recentCases = casesData.slice(-10).reverse(); // آخر 10 حالات
            
            if (recentCases.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 40px; color: #ccc; margin-bottom: 15px;"></i>
                            <p style="color: #6c757d;">لا توجد حالات مضافة بعد</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = recentCases.map(caseItem => {
                const amount = formatCurrency(caseItem.estimatedAssistance || 0);
                const date = formatDate(caseItem.createdAt);
                const status = getStatusBadge(caseItem.status);
                
                return `
                    <tr>
                        <td>${caseItem.formNumber || 'غير محدد'}</td>
                        <td>${caseItem.fullName || 'غير محدد'}</td>
                        <td>${caseItem.caseCode || 'غير محدد'}</td>
                        <td>${amount}</td>
                        <td>${date}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;" onclick="viewCaseDetails('${caseItem.id}')">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                            <button class="btn btn-success" style="padding: 4px 8px; font-size: 11px;" onclick="printCase('${caseItem.id}')">
                                <i class="fas fa-print"></i>
                                طباعة
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // تحميل الحالات حسب النوع
        function loadCasesByType(caseType) {
            const filteredCases = casesData.filter(c => c.caseCode === caseType);
            
            let tableId;
            switch(caseType) {
                case 'سيد':
                    tableId = 'sayed-cases-table';
                    break;
                case 'مصاريف':
                    tableId = 'expenses-cases-table';
                    break;
                case 'عام':
                    tableId = 'general-cases-table';
                    break;
                default:
                    return;
            }
            
            const tableBody = document.getElementById(tableId);
            if (!tableBody) return;
            
            if (filteredCases.length === 0) {
                const iconClass = caseType === 'سيد' ? 'fa-hand-holding-heart' : 
                                caseType === 'مصاريف' ? 'fa-receipt' : 'fa-users';
                
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            <i class="fas ${iconClass}" style="font-size: 40px; color: #ccc; margin-bottom: 15px;"></i>
                            <p style="color: #6c757d;">لا توجد حالات ${caseType}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = filteredCases.map(caseItem => {
                const amount = formatCurrency(caseItem.estimatedAssistance || 0);
                const date = formatDate(caseItem.createdAt);
                const status = getStatusBadge(caseItem.status);
                
                return `
                    <tr>
                        <td>${caseItem.formNumber || 'غير محدد'}</td>
                        <td>${caseItem.fullName || 'غير محدد'}</td>
                        <td>${amount}</td>
                        <td>${date}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;" onclick="viewCaseDetails('${caseItem.id}')">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                            <button class="btn btn-success" style="padding: 4px 8px; font-size: 11px;" onclick="printCase('${caseItem.id}')">
                                <i class="fas fa-print"></i>
                                طباعة
                            </button>
                            <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="deleteCase('${caseItem.id}')">
                                <i class="fas fa-trash"></i>
                                حذف
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // عرض تفاصيل الحالة المُحسن - يعرض الاستمارة مباشرة
        function viewCaseDetails(caseId) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) {
                showToast('لم يتم العثور على الحالة', 'error');
                return;
            }
            
            // تحويل بيانات العائلة للتوافق مع نظام الطباعة
            if (caseData.familyMembers) {
                if (caseData.familyMembers.males) {
                    caseData.maleChildrenData = caseData.familyMembers.males;
                }
                if (caseData.familyMembers.females) {
                    caseData.femaleChildrenData = caseData.familyMembers.females;
                }
                if (caseData.familyMembers.married) {
                    caseData.marriedData = caseData.familyMembers.married;
                }
            }
            
            // عرض معاينة الطباعة مباشرة
            enhancedPrintPreview(caseData);
        }

        // طباعة حالة معينة
        function printCase(caseId) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) {
                showToast('لم يتم العثور على الحالة', 'error');
                return;
            }
            
            // تحويل بيانات العائلة للتوافق مع نظام الطباعة
            if (caseData.familyMembers) {
                if (caseData.familyMembers.males) {
                    caseData.maleChildrenData = caseData.familyMembers.males;
                }
                if (caseData.familyMembers.females) {
                    caseData.femaleChildrenData = caseData.familyMembers.females;
                }
                if (caseData.familyMembers.married) {
                    caseData.marriedData = caseData.familyMembers.married;
                }
            }
            
            enhancedPrintPreview(caseData);
        }

        // حذف حالة
        function deleteCase(caseId) {
            if (!confirm('هل أنت متأكد من حذف هذه الحالة؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }
            
            const index = casesData.findIndex(c => c.id === caseId);
            if (index !== -1) {
                casesData.splice(index, 1);
                saveToStorage();
                updateStatistics();
                updateDashboard();
                
                // تحديث الجدول الحالي
                if (currentSection.startsWith('cases-')) {
                    const caseType = currentSection.split('-')[1];
                    const typeMap = {
                        'sayed': 'سيد',
                        'expenses': 'مصاريف',
                        'general': 'عام'
                    };
                    loadCasesByType(typeMap[caseType]);
                }
                
                showToast('تم حذف الحالة بنجاح', 'success');
            }
        }

        // وظائف البحث المُحسنة
        function performSearch() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase().trim();
            
            if (searchTerm === '') {
                updateDashboard();
                return;
            }
            
            const filteredCases = casesData.filter(caseItem => {
                return (
                    (caseItem.fullName && caseItem.fullName.toLowerCase().includes(searchTerm)) ||
                    (caseItem.formNumber && caseItem.formNumber.toLowerCase().includes(searchTerm)) ||
                    (caseItem.caseCode && caseItem.caseCode.toLowerCase().includes(searchTerm)) ||
                    (caseItem.address && caseItem.address.toLowerCase().includes(searchTerm))
                );
            });
            
            updateSearchResults(filteredCases);
        }

        // تحديث نتائج البحث
        function updateSearchResults(results) {
            const tableBody = document.getElementById('recent-cases-table');
            if (!tableBody) return;
            
            if (results.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px;">
                            <i class="fas fa-search" style="font-size: 40px; color: #ccc; margin-bottom: 15px;"></i>
                            <p style="color: #6c757d;">لم يتم العثور على نتائج</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = results.map(caseItem => {
                const amount = formatCurrency(caseItem.estimatedAssistance || 0);
                const date = formatDate(caseItem.createdAt);
                const status = getStatusBadge(caseItem.status);
                
                return `
                    <tr>
                        <td>${highlightText(caseItem.formNumber || 'غير محدد')}</td>
                        <td>${highlightText(caseItem.fullName || 'غير محدد')}</td>
                        <td>${caseItem.caseCode || 'غير محدد'}</td>
                        <td>${amount}</td>
                        <td>${date}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;" onclick="viewCaseDetails('${caseItem.id}')">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                            <button class="btn btn-success" style="padding: 4px 8px; font-size: 11px;" onclick="printCase('${caseItem.id}')">
                                <i class="fas fa-print"></i>
                                طباعة
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // إبراز النص في نتائج البحث
        function highlightText(text) {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase().trim();
            if (!searchTerm || !text) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        // فتح ماسح QR
        function openQRScanner() {
            showModal('qrScannerModal');
        }

        // بدء ماسح QR
        function startQRScanner() {
            showToast('ماسح QR قيد التطوير...', 'info', 'قريباً');
        }

        // إدارة النوافذ المنبثقة
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }

        // إظهار معاينة الطباعة المُحسنة مع إصلاح QR Code
        async function enhancedPrintPreview(caseData = null) {
            showToast('جاري تحضير المعاينة...', 'info', 'معاينة الطباعة');
            
            const formData = caseData || getFormData();
            
            try {
                const printContent = await createEnhancedPrintTemplate(formData);
                
                const printPreviewContent = document.getElementById('print-preview-content');
                printPreviewContent.innerHTML = '';
                printPreviewContent.appendChild(printContent);

                document.getElementById('print-preview-container').style.display = 'flex';
            } catch (error) {
                console.error('خطأ في معاينة الطباعة:', error);
                showToast('حدث خطأ في معاينة الطباعة', 'error');
            }
        }
        
        // إنشاء قالب الطباعة المُحسن مع QR Code صحيح وهيدر أقل ارتفاعاً
        async function createEnhancedPrintTemplate(data) {
            const container = document.createElement('div');
            container.className = 'print-container';

            // تنسيق التاريخ
            const caseDate = data.caseDate ? new Date(data.caseDate) : new Date();
            const formattedDate = `${caseDate.getDate()} / ${caseDate.getMonth() + 1} / ${caseDate.getFullYear()} م`;

            // إنشاء رأس الصفحة المُحسن - أقل ارتفاعاً
            const header = document.createElement('div');
            header.className = 'print-header';
            
            // تطبيق اللون والحدود حسب نوع الحالة
            if (data.caseCode === 'سيد') {
                header.classList.add('header-sayed');
            } else if (data.caseCode === 'عام') {
                header.classList.add('header-aam');
            } else {
                header.classList.add('header-expenses');
            }

            // الجهة اليمنى للهيدر
            const headerRight = document.createElement('div');
            headerRight.className = 'header-right';
            headerRight.innerHTML = `
                <div class="org-name">${systemSettings.orgName || 'مؤسسة أولاد الحسن ع'}</div>
                <div class="charity-name">الثقافية الخيرية</div>
            `;

            // إنشاء QR Code المُصحح
            const headerQR = document.createElement('div');
            headerQR.className = 'header-qr';
            
            try {
                if (systemSettings.showQRCode === 'yes') {
                    const qrText = generateFormDataText(data);
                    const qrCanvas = await generateQRCode(qrText, 120);
                    if (qrCanvas) {
                        qrCanvas.style.maxWidth = '60px';
                        qrCanvas.style.maxHeight = '60px';
                        qrCanvas.style.border = '1px solid #000';
                        headerQR.appendChild(qrCanvas);
                    } else {
                        headerQR.innerHTML = '<div style="font-size:10px; text-align:center;">QR<br>Code</div>';
                    }
                } else {
                    headerQR.innerHTML = '<div style="font-size:10px; text-align:center;">QR<br>مُعطل</div>';
                }
            } catch (error) {
                console.error('خطأ في إنشاء QR Code:', error);
                headerQR.innerHTML = '<div style="font-size:10px; text-align:center;">QR<br>خطأ</div>';
            }

            // الجهة الوسطى للهيدر
            const headerCenter = document.createElement('div');
            headerCenter.className = 'header-center';
            headerCenter.innerHTML = `
                <img src="https://firebasestorage.googleapis.com/v0/b/messageemeapp.appspot.com/o/%D9%85%D9%84%D9%81%20%D8%B5%D9%88%D8%B1%20%D8%AA%D8%B7%D8%A8%D9%82%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B1%20%D8%B3%D9%85%D8%A7%20%D8%A8%D8%A7%D8%A8%D9%84%2Ffile_0000000077b4622f9294f80fafefb564%20(1).png?alt=media&token=d79da964-2f40-4edd-a17e-6f9c71816b49" alt="شعار المؤسسة" style="width:65px;height:65px;">
                <div style="font-size: 16px; font-weight: bold; margin-top: 3px;">استمارة معلومات الحالة</div>
                <div class="form-number">رقم المعاملة: ${data.formNumber || '001'}</div>
            `;

            // الجهة اليسرى - معلومات الحالة بنمط أفقي (النصوص أمام الأرقام)
            const headerLeft = document.createElement('div');
            headerLeft.className = 'header-left';

            const headerTable = document.createElement('table');
            headerTable.className = 'header-table';

            // بيانات الحالة بشكل أفقي
            const headerRows = [
                { label: 'رمز الحالة:', value: data.caseCode || 'مصاريف' },
                { label: 'نوع الحالة:', value: data.caseType || 'مهرجان استشهاد امير المؤمنين' },
                { label: 'التاريخ:', value: formattedDate },
                { label: 'المنظم:', value: data.organizer || systemSettings.defaultOrganizer || 'أبو كرار' }
            ];

            headerRows.forEach(row => {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.innerHTML = `<span class="label">${row.label}</span> <span class="value">${row.value}</span>`;
                tr.appendChild(td);
                headerTable.appendChild(tr);
            });

            headerLeft.appendChild(headerTable);

            // إضافة الأقسام إلى الهيدر
            header.appendChild(headerRight);
            header.appendChild(headerQR);
            header.appendChild(headerCenter);
            header.appendChild(headerLeft);

            container.appendChild(header);

            // إنشاء محتوى الاستمارة المُحسن
            const content = document.createElement('div');
            content.className = 'print-content';

            const contentHTML = generatePrintContentHTML(data);
            content.innerHTML = contentHTML;

            container.appendChild(content);

            // تذييل الصفحة
            const footer = document.createElement('div');
            footer.className = 'print-footer';

            const today = new Date();
            const footerDate = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;

            footer.innerHTML = `
                <div class="footer-content">
                    <div class="footer-right">
                        <div class="payment-info">
                            تم صرف مبلغ <span class="parentheses-value">${data.estimatedAssistance || ''}</span> بتاريخ ${footerDate}
                        </div>
                    </div>
                    <div class="footer-left">
                        <div class="footer-title">إدارة المؤسسة</div>
                        <div class="admin-names">${systemSettings.manager1 || 'السيد أسامة السعبري'} &nbsp;&nbsp;&nbsp; ${systemSettings.manager2 || 'السيد فؤاد السعبري'}</div>
                        <div class="admin-date">${footerDate}</div>
                    </div>
                </div>
            `;

            container.appendChild(footer);

            return container;
        }

        // إنشاء محتوى الطباعة المُحسن - النصوص أمام الأرقام
        function generatePrintContentHTML(data) {
            return `
                <!-- سطر 1: المعلومات الأساسية -->
                <div class="content-row">
                    <div class="content-cell content-cell-quarter">
                        <span class="label">الاسم الكامل:</span>
                        <span class="value">${data.fullName || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter">
                        <span class="label">اللقب:</span>
                        <span class="value">${data.lastName || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter">
                        <span class="label">أبو / أم:</span>
                        <span class="parentheses-value">${data.parentName || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter">
                        <span class="label">العمر:</span>
                        <span class="parentheses-value">${data.age || ''}</span>
                    </div>
                </div>

                <!-- سطر 2: معلومات إضافية -->
                <div class="content-row">
                    <div class="content-cell content-cell-quarter">
                        <span class="label">الحالة الاجتماعية:</span>
                        <span class="value">${data.socialStatus || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter">
                        <span class="label">الموثق:</span>
                        <span class="value">${data.verifier || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter">
                        <span class="label">اسم المختار:</span>
                        <span class="value">${data.mukhtarName || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter">
                        <span class="label">العنوان:</span>
                        <span class="value">${data.address || ''}</span>
                    </div>
                </div>

                ${data.caseDescription ? `
                <!-- سطر شرح الحالة -->
                <div class="content-row">
                    <div class="content-cell content-cell-full">
                        <span class="label">شرح الحالة:</span>
                        <span class="value">${data.caseDescription}</span>
                    </div>
                </div>
                ` : ''}

                <!-- سطر المعلومات المالية المُحسن - النصوص أمام الأرقام -->
                <div class="content-row">
                    <div class="content-cell" style="flex: 0.2;">
                        <span class="label">راتب حكومي:</span>
                        <span class="value">${formatNumber(data.govSalary)}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.2;">
                        <span class="label">راتب مؤسسة:</span>
                        <span class="value">${formatNumber(data.orgSalary)}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.2;">
                        <span class="label">مقدار الدخل:</span>
                        <span class="value">${formatNumber(data.incomeAmount)}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.2;">
                        <span class="label">المصروفات:</span>
                        <span class="value">${formatNumber(data.expenses)}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.2;">
                        <span class="label">باقي الدخل:</span>
                        <span class="value">${formatNumber(data.incomeRemaining)}</span>
                    </div>
                </div>

                <!-- معلومات العائلة -->
                ${generateFamilyRowsHTML(data)}

                <div class="thick-divider"></div>

                <!-- المعلومات الطبية -->
                <div class="content-row">
                    <div class="content-cell content-cell-quarter">
                        <span class="label">اسم المستشفى:</span>
                        <span class="value">${data.hospitalName || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter">
                        <span class="label">العنوان:</span>
                        <span class="value">${data.hospitalAddress || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter">
                        <span class="label">نوع الحالة:</span>
                        <span class="value">${data.caseTypeDetail || ''}</span>
                    </div>
                    <div class="content-cell content-cell-quarter">
                        <span class="label">اسم الدكتور:</span>
                        <span class="value">${data.doctorName || ''}</span>
                    </div>
                </div>

                <!-- المبالغ المالية -->
                <div class="content-row">
                    <div class="content-cell content-cell-third">
                        <span class="label">المبلغ رقماً:</span>
                        <span class="value">${formatNumber(data.amountNumeric)}</span>
                    </div>
                    <div class="content-cell content-cell-third">
                        <span class="label">المبلغ كتابة:</span>
                        <span class="value">${data.amountWritten || ''}</span>
                    </div>
                    <div class="content-cell content-cell-third">
                        <span class="label">المجموع:</span>
                        <span class="value">${formatNumber(data.totalAmount)}</span>
                    </div>
                </div>

                <div class="thick-divider"></div>

                <!-- معلومات الاتصال -->
                <div class="content-row">
                    <div class="content-cell content-cell-third">
                        <span class="label">رقم الهاتف الأول:</span>
                        <span class="value">${data.phoneFirst || ''}</span>
                    </div>
                    <div class="content-cell content-cell-third">
                        <span class="label">رقم الهاتف الثاني:</span>
                        <span class="value">${data.phoneSecond || ''}</span>
                    </div>
                    <div class="content-cell content-cell-third">
                        <span class="label">الجهات المساعدة:</span>
                        <span class="value">${data.supportingAgencies || ''}</span>
                    </div>
                </div>

                ${generateAdditionalRowsHTML(data)}

                <!-- مبلغ المساعدة -->
                <div class="assistance-amount">
                    <span class="label">يصرف مبلغ المساعدة المقدر:</span>
                    <span class="parentheses-value">${data.estimatedAssistance || ''}</span>
                </div>
            `;
        }

        // إنشاء صفوف العائلة المُحسنة
        function generateFamilyRowsHTML(data) {
            const housingType = data.housingType || '';
            const rentAmount = data.rentAmount || '';
            
            let familyHTML = `
                <div class="content-row">
                    <div class="content-cell" style="flex: 0.16;">
                        <span class="label">نوع السكن:</span>
                        <span class="value">${housingType}</span>
                    </div>
            `;
            
            if (housingType === 'إيجار' && rentAmount) {
                familyHTML += `
                    <div class="content-cell" style="flex: 0.16;">
                        <span class="label">الإيجار:</span>
                        <span class="value">${formatNumber(rentAmount)}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.17;">
                        <span class="label">أفراد الأسرة:</span>
                        <span class="value">${data.totalFamilyMembers || ''}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.17;">
                        <span class="label">بنين:</span>
                        <span class="value">${data.maleChildren || ''}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.17;">
                        <span class="label">بنات:</span>
                        <span class="value">${data.femaleChildren || ''}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.17;">
                        <span class="label">متزوجين:</span>
                        <span class="value">${data.married || ''}</span>
                    </div>
                `;
            } else {
                familyHTML += `
                    <div class="content-cell" style="flex: 0.21;">
                        <span class="label">أفراد الأسرة:</span>
                        <span class="value">${data.totalFamilyMembers || ''}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.21;">
                        <span class="label">بنين:</span>
                        <span class="value">${data.maleChildren || ''}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.21;">
                        <span class="label">بنات:</span>
                        <span class="value">${data.femaleChildren || ''}</span>
                    </div>
                    <div class="content-cell" style="flex: 0.21;">
                        <span class="label">متزوجين:</span>
                        <span class="value">${data.married || ''}</span>
                    </div>
                `;
            }
            
            familyHTML += '</div>';
            
            // إضافة صفوف الأعمار والوظائف
            const familyDataHTML = generateFamilyDataRowsHTML(data);
            if (familyDataHTML) {
                familyHTML += familyDataHTML;
            }
            
            return familyHTML;
        }

        // إنشاء صفوف بيانات العائلة المُحسنة
        function generateFamilyDataRowsHTML(data) {
            // التحقق من وجود بيانات العائلة
            const hasFamilyData = 
                (data.familyMembers && (
                    (data.familyMembers.males && data.familyMembers.males.length > 0) ||
                    (data.familyMembers.females && data.familyMembers.females.length > 0) ||
                    (data.familyMembers.married && data.familyMembers.married.length > 0)
                )) ||
                (data.maleChildrenData && data.maleChildrenData.length > 0) ||
                (data.femaleChildrenData && data.femaleChildrenData.length > 0) ||
                (data.marriedData && data.marriedData.length > 0);
            
            if (!hasFamilyData) return '';
            
            // استخدام البيانات الموجودة
            let malesData = data.familyMembers?.males || data.maleChildrenData || [];
            let femalesData = data.familyMembers?.females || data.femaleChildrenData || [];
            let marriedData = data.familyMembers?.married || data.marriedData || [];
            
            let agesHTML = '';
            let jobsHTML = '';
            
            // صف الأعمار مع نصوص أمام الأرقام
            if (malesData.length > 0 || femalesData.length > 0 || marriedData.length > 0) {
                agesHTML = '<div class="content-row"><div class="content-cell" style="flex: 0.15; font-weight: bold;"><span class="label">الأعمار:</span></div>';
                
                let totalItems = malesData.length + femalesData.length + marriedData.length;
                let itemFlex = 0.85 / totalItems;
                
                malesData.forEach((child, index) => {
                    agesHTML += `<div class="content-cell" style="flex: ${itemFlex};"><span class="label">ب${index + 1}:</span><span class="value">${child.age || ''}</span></div>`;
                });
                
                femalesData.forEach((child, index) => {
                    agesHTML += `<div class="content-cell" style="flex: ${itemFlex};"><span class="label">ن${index + 1}:</span><span class="value">${child.age || ''}</span></div>`;
                });
                
                marriedData.forEach((person, index) => {
                    agesHTML += `<div class="content-cell" style="flex: ${itemFlex};"><span class="label">م${index + 1}:</span><span class="value">${person.age || ''}</span></div>`;
                });
                
                agesHTML += '</div>';
                
                // صف الوظائف مع نصوص أمام الأرقام
                jobsHTML = '<div class="content-row"><div class="content-cell" style="flex: 0.15; font-weight: bold;"><span class="label">الوظائف:</span></div>';
                
                malesData.forEach((child, index) => {
                    jobsHTML += `<div class="content-cell" style="flex: ${itemFlex};"><span class="label">ب${index + 1}:</span><span class="value">${child.job || ''}</span></div>`;
                });
                
                femalesData.forEach((child, index) => {
                    jobsHTML += `<div class="content-cell" style="flex: ${itemFlex};"><span class="label">ن${index + 1}:</span><span class="value">${child.job || ''}</span></div>`;
                });
                
                marriedData.forEach((person, index) => {
                    jobsHTML += `<div class="content-cell" style="flex: ${itemFlex};"><span class="label">م${index + 1}:</span><span class="value">${person.job || ''}</span></div>`;
                });
                
                jobsHTML += '</div>';
            }
            
            return agesHTML + jobsHTML;
        }

        // إنشاء الصفوف الإضافية
        function generateAdditionalRowsHTML(data) {
            let additionalHTML = '';
            
            // معلومات الزوج/ة
            if (data.spouseName || data.spouseLastName || data.spouseJob || data.spouseSalary) {
                additionalHTML += `
                    <div class="content-row">
                        <div class="content-cell content-cell-quarter">
                            <span class="label">الزوج/ة:</span>
                            <span class="value">${data.spouseName || ''}</span>
                        </div>
                        <div class="content-cell content-cell-quarter">
                            <span class="label">اللقب:</span>
                            <span class="value">${data.spouseLastName || ''}</span>
                        </div>
                        <div class="content-cell content-cell-quarter">
                            <span class="label">المهنة:</span>
                            <span class="value">${data.spouseJob || ''}</span>
                        </div>
                        <div class="content-cell content-cell-quarter">
                            <span class="label">الراتب:</span>
                            <span class="value">${formatNumber(data.spouseSalary)}</span>
                        </div>
                    </div>
                `;
            }
            
            // المعيل الآخر
            if (data.hasOtherSupport === 'نعم' || data.supporterName || data.supporterRelation) {
                additionalHTML += `
                    <div class="content-row">
                        <div class="content-cell content-cell-third">
                            <span class="label">هل يوجد معيل آخر:</span>
                            <span class="value">${data.hasOtherSupport || 'لا'}</span>
                        </div>
                        <div class="content-cell content-cell-third">
                            <span class="label">اسم المعيل:</span>
                            <span class="value">${data.supporterName || ''}</span>
                        </div>
                        <div class="content-cell content-cell-third">
                            <span class="label">صلة القرابة:</span>
                            <span class="value">${data.supporterRelation || ''}</span>
                        </div>
                    </div>
                `;
            }
            
            // الملاحظات
            if (data.notes) {
                additionalHTML += `
                    <div class="content-row">
                        <div class="content-cell content-cell-full">
                            <span class="label">الملاحظات:</span>
                            <span class="value">${data.notes}</span>
                        </div>
                    </div>
                `;
            }
            
            return additionalHTML;
        }

        // إنشاء نص QR Code من بيانات النموذج المُحسن
        function generateFormDataText(data) {
            const today = new Date();
            const formattedDate = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
            
            let familyDetails = '';
            
            // إضافة تفاصيل أفراد العائلة المُحسنة
            if (data.familyMembers) {
                if (data.familyMembers.males && data.familyMembers.males.length > 0) {
                    familyDetails += '\n👦 البنين:\n';
                    data.familyMembers.males.forEach((child, index) => {
                        familyDetails += `  ${index + 1}. العمر: ${child.age || 'غير محدد'} - المهنة: ${child.job || 'غير محدد'}\n`;
                    });
                }
                
                if (data.familyMembers.females && data.familyMembers.females.length > 0) {
                    familyDetails += '\n👧 البنات:\n';
                    data.familyMembers.females.forEach((child, index) => {
                        familyDetails += `  ${index + 1}. العمر: ${child.age || 'غير محدد'} - المهنة: ${child.job || 'غير محدد'}\n`;
                    });
                }
                
                if (data.familyMembers.married && data.familyMembers.married.length > 0) {
                    familyDetails += '\n💑 المتزوجين:\n';
                    data.familyMembers.married.forEach((person, index) => {
                        familyDetails += `  ${index + 1}. العمر: ${person.age || 'غير محدد'} - المهنة: ${person.job || 'غير محدد'}\n`;
                    });
                }
            }
            
            const qrText = `
=== ${systemSettings.orgName || 'مؤسسة أولاد الحسن (ع) الثقافية الخيرية'} ===

📋 معلومات الحالة:
• رقم الاستمارة: ${data.formNumber || 'غير محدد'}
• رمز الحالة: ${data.caseCode || 'غير محدد'}
• نوع الحالة: ${data.caseType || 'غير محدد'}
• التاريخ: ${data.caseDate || formattedDate}
• المنظم: ${data.organizer || systemSettings.defaultOrganizer || 'غير محدد'}

👤 البيانات الشخصية:
• الاسم: ${data.fullName || 'غير محدد'} ${data.lastName || ''}
• أبو/أم: ${data.parentName || 'غير محدد'}
• العمر: ${data.age || 'غير محدد'}
• الحالة الاجتماعية: ${data.socialStatus || 'غير محدد'}
• العنوان: ${data.address || 'غير محدد'}

📝 شرح الحالة:
${data.caseDescription || 'لا توجد تفاصيل'}

💰 المعلومات المالية:
• راتب حكومي: ${formatNumber(data.govSalary)} دينار
• راتب مؤسسة: ${formatNumber(data.orgSalary)} دينار  
• مقدار الدخل: ${formatNumber(data.incomeAmount)} دينار
• المصروفات: ${formatNumber(data.expenses)} دينار
• باقي الدخل: ${formatNumber(data.incomeRemaining)} دينار

🏠 معلومات العائلة:
• نوع السكن: ${data.housingType || 'غير محدد'}
${data.housingType === 'إيجار' && data.rentAmount ? `• مقدار الإيجار: ${formatNumber(data.rentAmount)} دينار` : ''}
• أفراد الأسرة: ${data.totalFamilyMembers || '0'}
• بنين: ${data.maleChildren || '0'}
• بنات: ${data.femaleChildren || '0'}
• متزوجين: ${data.married || '0'}
${familyDetails}

💸 مبلغ المساعدة المقدر:
${data.estimatedAssistance || 'غير محدد'} دينار

📅 تاريخ الإصدار: ${formattedDate}
            `.trim();
            
            return qrText;
        }

        // إنشاء QR Code باستخدام مكتبة qrcode.js المُصححة
        async function generateQRCode(text, size = 200) {
            try {
                // التأكد من وجود مكتبة QRCode
                if (typeof QRCode === 'undefined') {
                    console.error('مكتبة QRCode غير متاحة');
                    return null;
                }

                const canvas = document.createElement('canvas');
                await QRCode.toCanvas(canvas, text, {
                    width: size,
                    height: size,
                    margin: 1,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    },
                    errorCorrectionLevel: 'M'
                });
                return canvas;
            } catch (error) {
                console.error('خطأ في إنشاء QR Code:', error);
                return null;
            }
        }

        // تحويل الأرقام إلى إنجليزية
        function toEnglishDigits(str) {
            if (typeof str !== 'string') str = String(str);
            return str.replace(/[\u0660-\u0669\u06F0-\u06F9]/g, function(c) {
                return String.fromCharCode(c.charCodeAt(0) & 0xf);
            });
        }

        // تنسيق الأرقام بالإنجليزية للطباعة
        function formatNumber(value) {
            if (value === undefined || value === null || value === '') {
                return '';
            }
            if (parseInt(value) === 0) {
                return '0';
            }
            if (!isNaN(value)) {
                return toEnglishDigits(parseInt(value).toLocaleString('en-US'));
            }
            return toEnglishDigits(value);
        }
        
        // إغلاق معاينة الطباعة
        function closePrintPreview() {
            document.getElementById('print-preview-container').style.display = 'none';
        }
        
        // الطباعة من المعاينة
        function printFromPreview() {
            window.print();
        }

        // إظهار/إخفاء حقل مقدار الإيجار
        function toggleRentAmount() {
            const housingType = document.getElementById('housingType').value;
            const rentAmountGroup = document.getElementById('rentAmountGroup');
            
            if (housingType === 'إيجار') {
                rentAmountGroup.style.display = 'block';
            } else {
                rentAmountGroup.style.display = 'none';
                document.getElementById('rentAmount').value = '';
            }
        }
        
        // تحديث الحقول الديناميكية للعائلة
        function updateFamilyFields() {
            const maleChildren = parseInt(document.getElementById('maleChildren').value) || 0;
            const femaleChildren = parseInt(document.getElementById('femaleChildren').value) || 0;
            const married = parseInt(document.getElementById('married').value) || 0;
            
            const totalMembers = maleChildren + femaleChildren + married;
            
            const dynamicFieldsContainer = document.getElementById('familyDynamicFields');
            const fieldsContainer = document.getElementById('dynamicFieldsContainer');
            
            // مسح الحقول الموجودة
            fieldsContainer.innerHTML = '';
            
            if (totalMembers > 0) {
                dynamicFieldsContainer.style.display = 'block';
                
                // إنشاء حقول البنين
                if (maleChildren > 0) {
                    createMemberFields('بنين', maleChildren, 'male');
                }
                
                // إنشاء حقول البنات
                if (femaleChildren > 0) {
                    createMemberFields('بنات', femaleChildren, 'female');
                }
                
                // إنشاء حقول المتزوجين
                if (married > 0) {
                    createMemberFields('متزوجين', married, 'married');
                }
            } else {
                dynamicFieldsContainer.style.display = 'none';
            }
        }
        
        // إنشاء حقول لمجموعة من أفراد العائلة
        function createMemberFields(groupTitle, count, groupType) {
            const fieldsContainer = document.getElementById('dynamicFieldsContainer');
            
            const memberGroup = document.createElement('div');
            memberGroup.style.marginBottom = '15px';
            memberGroup.style.padding = '12px';
            memberGroup.style.backgroundColor = 'white';
            memberGroup.style.borderRadius = '6px';
            memberGroup.style.border = '1px solid #e3e6f0';
            
            const groupTitleDiv = document.createElement('h5');
            groupTitleDiv.textContent = groupTitle;
            groupTitleDiv.style.color = '#3498db';
            groupTitleDiv.style.marginBottom = '12px';
            groupTitleDiv.style.fontSize = '14px';
            memberGroup.appendChild(groupTitleDiv);
            
            for (let i = 1; i <= count; i++) {
                const memberRow = document.createElement('div');
                memberRow.style.display = 'grid';
                memberRow.style.gridTemplateColumns = '1fr 1fr';
                memberRow.style.gap = '12px';
                memberRow.style.marginBottom = '8px';
                
                // حقل العمر
                const ageGroup = document.createElement('div');
                ageGroup.innerHTML = `
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px;">عمر ${groupTitle} ${i}</label>
                    <input type="number" id="${groupType}Age${i}" class="form-control" placeholder="العمر" style="padding: 8px 10px; font-size: 12px;">
                `;
                
                // حقل المهنة
                const jobGroup = document.createElement('div');
                jobGroup.innerHTML = `
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; font-size: 12px;">مهنة ${groupTitle} ${i}</label>
                    <input type="text" id="${groupType}Job${i}" class="form-control" placeholder="المهنة" style="padding: 8px 10px; font-size: 12px;">
                `;
                
                memberRow.appendChild(ageGroup);
                memberRow.appendChild(jobGroup);
                memberGroup.appendChild(memberRow);
            }
            
            fieldsContainer.appendChild(memberGroup);
        }
        
        // حساب باقي الدخل
        function calculateIncomeRemaining() {
            const govSalary = parseInt(document.getElementById('govSalary').value) || 0;
            const orgSalary = parseInt(document.getElementById('orgSalary').value) || 0;
            const incomeAmount = parseInt(document.getElementById('incomeAmount').value) || 0;
            const expenses = parseInt(document.getElementById('expenses').value) || 0;
            
            const totalIncome = govSalary + orgSalary + incomeAmount;
            const remaining = totalIncome - expenses;
            
            document.getElementById('incomeRemaining').value = remaining;
        }
        
        // إعادة تعيين النموذج
        function resetForm() {
            try {
                const form = document.getElementById('case-form');
                if (form) {
                    form.reset();
                    form.removeAttribute('data-edit-id');
                }
                
                // تعيين تاريخ اليوم
                const today = new Date();
                const formattedDate = today.toISOString().substr(0, 10);
                const dateInput = document.getElementById('caseDate');
                if (dateInput) {
                    dateInput.value = formattedDate;
                }
                
                // تعيين القيم الافتراضية من الإعدادات
                updateOrganizerFromSettings();
                
                const amountNumeric = document.getElementById('amountNumeric');
                if (amountNumeric) amountNumeric.value = '150';
                
                const phoneFirst = document.getElementById('phoneFirst');
                if (phoneFirst) phoneFirst.value = '00000000000';
                
                const phoneSecond = document.getElementById('phoneSecond');
                if (phoneSecond) phoneSecond.value = '00000000000';
                
                // إعادة توليد رقم الاستمارة
                generateFormNumber();
                
                // إخفاء حقل الإيجار والحقول الديناميكية
                const rentAmountGroup = document.getElementById('rentAmountGroup');
                if (rentAmountGroup) {
                    rentAmountGroup.style.display = 'none';
                }
                
                const familyDynamicFields = document.getElementById('familyDynamicFields');
                if (familyDynamicFields) {
                    familyDynamicFields.style.display = 'none';
                }
                
                // إعادة تعيين عنوان القسم
                document.querySelector('#create-case-section .content-header h2').textContent = 'إنشاء حالة جديدة';
                
                showToast('تم إعادة تعيين النموذج', 'info');
            } catch (error) {
                console.error('خطأ في إعادة تعيين النموذج:', error);
                showToast('حدث خطأ أثناء إعادة تعيين النموذج', 'error');
            }
        }
        
        // تعبئة النموذج بمعلومات وهمية
        function fillFakeData() {
            const fake = {
                caseCode: "سيد",
                caseType: "مساعدة علاجية",
                fullName: "حسن علي محمد",
                lastName: "السعبري",
                parentName: "أم حسين",
                age: "45",
                socialStatus: "متزوج/ة",
                address: "حي الحسن - قرب جامع الإمام علي",
                verifier: "محمد عبد الله",
                mukhtarName: "الحاج فاضل",
                caseDescription: "يعاني من مرض مزمن ويحتاج إلى علاج مكلف بشكل شهري",
                notes: "يعاني من مرض مزمن ويحتاج إلى علاج مكلف بشكل شهري",
                govSalary: "500000",
                orgSalary: "150000",
                incomeAmount: "200000",
                expenses: "700000",
                housingType: "إيجار",
                rentAmount: "300000",
                totalFamilyMembers: "6",
                maleChildren: "2",
                femaleChildren: "2",
                married: "1",
                hospitalName: "مستشفى الكفيل",
                hospitalAddress: "كربلاء المقدسة",
                caseTypeDetail: "عملية جراحية",
                doctorName: "د. أحمد كريم",
                amountNumeric: "1200000",
                amountWritten: "مليون ومئتان ألف دينار",
                totalAmount: "1200000",
                phoneFirst: "07801234567",
                phoneSecond: "07709876543",
                supportingAgencies: "مؤسسة العين، مؤسسة اليتيم",
                spouseName: "فاطمة حسن",
                spouseLastName: "الشمري",
                spouseJob: "ربة بيت",
                spouseSalary: "0",
                hasOtherSupport: "نعم",
                supporterName: "أخ الزوج",
                supporterRelation: "أخ",
                estimatedAssistance: "500000"
            };
            
            for (const key in fake) {
                const el = document.getElementById(key);
                if (el) el.value = fake[key];
            }
            
            calculateIncomeRemaining();
            toggleRentAmount();
            updateFamilyFields();
            
            // تعبئة بيانات وهمية لأفراد العائلة
            setTimeout(() => {
                const maleAge1 = document.getElementById('maleAge1');
                const maleJob1 = document.getElementById('maleJob1');
                const maleAge2 = document.getElementById('maleAge2');
                const maleJob2 = document.getElementById('maleJob2');
                
                if (maleAge1) maleAge1.value = "20";
                if (maleJob1) maleJob1.value = "طالب";
                if (maleAge2) maleAge2.value = "18";
                if (maleJob2) maleJob2.value = "طالب";
                
                const femaleAge1 = document.getElementById('femaleAge1');
                const femaleJob1 = document.getElementById('femaleJob1');
                const femaleAge2 = document.getElementById('femaleAge2');
                const femaleJob2 = document.getElementById('femaleJob2');
                
                if (femaleAge1) femaleAge1.value = "22";
                if (femaleJob1) femaleJob1.value = "معلمة";
                if (femaleAge2) femaleAge2.value = "16";
                if (femaleJob2) femaleJob2.value = "طالبة";
                
                const marriedAge1 = document.getElementById('marriedAge1');
                const marriedJob1 = document.getElementById('marriedJob1');
                
                if (marriedAge1) marriedAge1.value = "28";
                if (marriedJob1) marriedJob1.value = "مهندس";
            }, 500);
            
            showToast('تمت إضافة معلومات وهمية مع بيانات العائلة', 'info');
        }

        // تعديل حالة موجودة
        function editCase(caseId) {
            const caseData = casesData.find(c => c.id === caseId);
            if (!caseData) {
                showToast('لم يتم العثور على الحالة', 'error');
                return;
            }
            
            // تعبئة النموذج بالبيانات الموجودة
            fillFormWithData(caseData);
            
            // الانتقال لقسم التعديل
            showSection('create-case');
            
            // تغيير النموذج لوضع التعديل
            const form = document.getElementById('case-form');
            form.setAttribute('data-edit-id', caseId);
            
            // تغيير عنوان الصفحة
            document.querySelector('#create-case-section .content-header h2').textContent = 'تعديل الحالة';
            
            showToast('يمكنك الآن تعديل بيانات الحالة', 'info');
        }

    // تعبئة النموذج بالبيانات
    function fillFormWithData(data) {
        // تعبئة الحقول الأساسية
        Object.keys(data).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                element.value = data[key] || '';
            }
        });
        
        // تعبئة بيانات العائلة إذا كانت متوفرة
        if (data.familyMembers) {
            updateFamilyFields();
            
            setTimeout(() => {
                // تعبئة بيانات البنين
                if (data.familyMembers.males) {
                    data.familyMembers.males.forEach((male, index) => {
                        const ageEl = document.getElementById(`maleAge${index + 1}`);
                        const jobEl = document.getElementById(`maleJob${index + 1}`);
                        if (ageEl) ageEl.value = male.age || '';
                        if (jobEl) jobEl.value = male.job || '';
                    });
                }
                
                // تعبئة بيانات البنات
                if (data.familyMembers.females) {
                    data.familyMembers.females.forEach((female, index) => {
                        const ageEl = document.getElementById(`femaleAge${index + 1}`);
                        const jobEl = document.getElementById(`femaleJob${index + 1}`);
                        if (ageEl) ageEl.value = female.age || '';
                        if (jobEl) jobEl.value = female.job || '';
                    });
                }
                
                // تعبئة بيانات المتزوجين
                if (data.familyMembers.married) {
                    data.familyMembers.married.forEach((married, index) => {
                        const ageEl = document.getElementById(`marriedAge${index + 1}`);
                        const jobEl = document.getElementById(`marriedJob${index + 1}`);
                        if (ageEl) ageEl.value = married.age || '';
                        if (jobEl) jobEl.value = married.job || '';
                    });
                }
            }, 500);
        }
        
        // تطبيق التحديثات
        calculateIncomeRemaining();
        toggleRentAmount();
    }

        // تحديث حالة موجودة
        function updateExistingCase(caseId, newData) {
            const index = casesData.findIndex(c => c.id === caseId);
            if (index !== -1) {
                // الاحتفاظ بالبيانات الأصلية المهمة
                newData.id = caseId;
                newData.createdAt = casesData[index].createdAt;
                newData.updatedAt = new Date().toISOString();
                
                // استبدال البيانات
                casesData[index] = newData;
                
                // حفظ التحديثات
                saveToStorage();
                updateStatistics();
                updateDashboard();
                
                return true;
            }
            return false;
        }

        // تهيئة الرسوم البيانية المُحسنة
        function initializeCharts() {
            // رسم بياني للإحصائيات العامة
            const ctx1 = document.getElementById('statisticsChart');
            if (ctx1) {
                chartInstances.statistics = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['سيد', 'مصاريف', 'عام'],
                        datasets: [{
                            label: 'عدد الحالات',
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(39, 174, 96, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(243, 156, 18, 0.8)'
                            ],
                            borderColor: [
                                'rgba(39, 174, 96, 1)',
                                'rgba(52, 152, 219, 1)',
                                'rgba(243, 156, 18, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'توزيع الحالات حسب النوع'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // رسم بياني دائري
            const ctx2 = document.getElementById('pieChart');
            if (ctx2) {
                chartInstances.pie = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['سيد', 'مصاريف', 'عام'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(39, 174, 96, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(243, 156, 18, 0.8)'
                            ],
                            borderColor: [
                                'rgba(39, 174, 96, 1)',
                                'rgba(52, 152, 219, 1)',
                                'rgba(243, 156, 18, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            title: {
                                display: true,
                                text: 'نسب توزيع الحالات'
                            }
                        }
                    }
                });
            }
        }

        // تحديث الرسوم البيانية
        function updateReportsCharts() {
            updateChartsData();
        }

        function updateAnalyticsCharts() {
            updateChartsData();
        }

        function updateChartsData() {
            const sayedCount = casesData.filter(c => c.caseCode === 'سيد').length;
            const expensesCount = casesData.filter(c => c.caseCode === 'مصاريف').length;
            const generalCount = casesData.filter(c => c.caseCode === 'عام').length;
            
            // تحديث الرسم البياني الشريطي
            if (chartInstances.statistics) {
                chartInstances.statistics.data.datasets[0].data = [sayedCount, expensesCount, generalCount];
                chartInstances.statistics.update();
            }
            
            // تحديث الرسم البياني الدائري
            if (chartInstances.pie) {
                chartInstances.pie.data.datasets[0].data = [sayedCount, expensesCount, generalCount];
                chartInstances.pie.update();
            }
        }

        // وظائف التقارير المتقدمة المُحسنة
        function generateMonthlyReport() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const monthlyCases = casesData.filter(c => {
                const caseDate = new Date(c.createdAt);
                return caseDate.getMonth() === currentMonth && caseDate.getFullYear() === currentYear;
            });
            
            const reportData = {
                month: currentMonth + 1,
                year: currentYear,
                totalCases: monthlyCases.length,
                totalAmount: monthlyCases.reduce((sum, c) => sum + (parseFloat(c.estimatedAssistance) || 0), 0),
                casesByType: {
                    sayed: monthlyCases.filter(c => c.caseCode === 'سيد').length,
                    expenses: monthlyCases.filter(c => c.caseCode === 'مصاريف').length,
                    general: monthlyCases.filter(c => c.caseCode === 'عام').length
                },
                cases: monthlyCases
            };
            
            generateReportFile(reportData, 'monthly');
            showToast('تم إنشاء التقرير الشهري بنجاح', 'success');
        }

        function generateYearlyReport() {
            const currentYear = new Date().getFullYear();
            
            const yearlyCases = casesData.filter(c => {
                const caseDate = new Date(c.createdAt);
                return caseDate.getFullYear() === currentYear;
            });
            
            const reportData = {
                year: currentYear,
                totalCases: yearlyCases.length,
                totalAmount: yearlyCases.reduce((sum, c) => sum + (parseFloat(c.estimatedAssistance) || 0), 0),
                monthlyBreakdown: generateMonthlyBreakdown(yearlyCases),
                casesByType: {
                    sayed: yearlyCases.filter(c => c.caseCode === 'سيد').length,
                    expenses: yearlyCases.filter(c => c.caseCode === 'مصاريف').length,
                    general: yearlyCases.filter(c => c.caseCode === 'عام').length
                },
                cases: yearlyCases
            };
            
            generateReportFile(reportData, 'yearly');
            showToast('تم إنشاء التقرير السنوي بنجاح', 'success');
        }

        function generateMonthlyBreakdown(cases) {
            const breakdown = {};
            for (let i = 0; i < 12; i++) {
                breakdown[i] = {
                    count: 0,
                    amount: 0
                };
            }
            
            cases.forEach(c => {
                const month = new Date(c.createdAt).getMonth();
                breakdown[month].count++;
                breakdown[month].amount += parseFloat(c.estimatedAssistance) || 0;
            });
            
            return breakdown;
        }

        function generateReportFile(data, type) {
            const reportContent = `
تقرير ${type === 'monthly' ? 'شهري' : 'سنوي'} - ${systemSettings.orgName}
===================================================

📊 ملخص الإحصائيات:
• إجمالي الحالات: ${data.totalCases}
• إجمالي المبالغ: ${formatCurrency(data.totalAmount)}

📈 توزيع الحالات:
• حالات السيد: ${data.casesByType.sayed}
• حالات المصاريف: ${data.casesByType.expenses}  
• الحالات العامة: ${data.casesByType.general}

📅 تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}
📋 عدد الحالات المدرجة: ${data.cases.length}

تفاصيل الحالات:
${data.cases.map((c, index) => `
${index + 1}. ${c.fullName || 'غير محدد'} - ${c.caseCode} - ${formatCurrency(c.estimatedAssistance)}
   رقم الاستمارة: ${c.formNumber}
   التاريخ: ${formatDate(c.createdAt)}
   العنوان: ${c.address || 'غير محدد'}
`).join('')}

تم إنشاء هذا التقرير بواسطة نظام إدارة الحالات الخيرية
${systemSettings.orgName}
            `;
            
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `تقرير_${type}_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
        }

        function openCustomReport() {
            showModal('advancedSearchModal');
        }

        function performAdvancedSearch() {
            const formNumber = document.getElementById('searchFormNumber').value;
            const name = document.getElementById('searchName').value;
            const caseType = document.getElementById('searchCaseType').value;
            const fromDate = document.getElementById('searchFromDate').value;
            const toDate = document.getElementById('searchToDate').value;
            
            let filteredCases = casesData.filter(c => {
                let matches = true;
                
                if (formNumber && !c.formNumber.includes(formNumber)) matches = false;
                if (name && !c.fullName.toLowerCase().includes(name.toLowerCase())) matches = false;
                if (caseType && c.caseCode !== caseType) matches = false;
                
                if (fromDate) {
                    const caseDate = new Date(c.createdAt);
                    const searchFromDate = new Date(fromDate);
                    if (caseDate < searchFromDate) matches = false;
                }
                
                if (toDate) {
                    const caseDate = new Date(c.createdAt);
                    const searchToDate = new Date(toDate);
                    if (caseDate > searchToDate) matches = false;
                }
                
                return matches;
            });
            
            closeModal('advancedSearchModal');
            showSection('dashboard');
            updateSearchResults(filteredCases);
            
            showToast(`تم العثور على ${filteredCases.length} نتيجة`, 'info');
        }

        function clearSearch() {
            document.getElementById('searchFormNumber').value = '';
            document.getElementById('searchName').value = '';
            document.getElementById('searchCaseType').value = '';
            document.getElementById('searchFromDate').value = '';
            document.getElementById('searchToDate').value = '';
        }

        // وظائف التصدير والاستيراد المُحسنة والمُفعلة بالكامل
        function exportToExcel() {
            if (casesData.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            // تحضير البيانات للتصدير
            const exportData = casesData.map(caseItem => ({
                'رقم الاستمارة': caseItem.formNumber,
                'اسم الحالة': caseItem.fullName,
                'نوع الحالة': caseItem.caseCode,
                'العمر': caseItem.age,
                'العنوان': caseItem.address,
                'رقم الهاتف': caseItem.phoneFirst,
                'راتب حكومي': caseItem.govSalary,
                'راتب مؤسسة': caseItem.orgSalary,
                'مبلغ المساعدة': caseItem.estimatedAssistance,
                'تاريخ الإنشاء': formatDate(caseItem.createdAt)
            }));
            
            // إنشاء CSV
            const csvContent = convertToCSV(exportData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `charity_cases_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('تم تصدير البيانات إلى Excel بنجاح', 'success');
        }

        function exportToPDF() {
            if (casesData.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'warning');
                return;
            }

            // إنشاء تقرير PDF نصي
            const pdfContent = `
تقرير شامل - ${systemSettings.orgName}
========================================

📊 إحصائيات عامة:
• إجمالي الحالات: ${casesData.length}
• الحالات النشطة: ${casesData.filter(c => c.status === 'active').length}
• إجمالي المبالغ: ${formatCurrency(casesData.reduce((sum, c) => sum + (parseFloat(c.estimatedAssistance) || 0), 0))}

📈 توزيع الحالات:
• حالات السيد: ${casesData.filter(c => c.caseCode === 'سيد').length}
• حالات المصاريف: ${casesData.filter(c => c.caseCode === 'مصاريف').length}
• الحالات العامة: ${casesData.filter(c => c.caseCode === 'عام').length}

📋 تفاصيل الحالات:
${casesData.map((c, index) => `
${index + 1}. الاسم: ${c.fullName || 'غير محدد'}
   رقم الاستمارة: ${c.formNumber}
   نوع الحالة: ${c.caseCode}
   المبلغ: ${formatCurrency(c.estimatedAssistance)}
   العنوان: ${c.address || 'غير محدد'}
   التاريخ: ${formatDate(c.createdAt)}
   الموثق: ${c.verifier || 'غير محدد'}
   ---
`).join('')}

📅 تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}
تم إنشاء هذا التقرير بواسطة نظام إدارة الحالات الخيرية
            `;

            const blob = new Blob([pdfContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `تقرير_PDF_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();

            showToast('تم تصدير التقرير بصيغة نصية', 'success');
        }

        function exportToJSON() {
            const exportData = {
                cases: casesData,
                settings: systemSettings,
                exportDate: new Date().toISOString(),
                version: '2.0.0',
                organization: systemSettings.orgName
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `charity_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('تم تصدير البيانات إلى JSON بنجاح', 'success');
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('يرجى اختيار ملف للاستيراد', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.cases && Array.isArray(importedData.cases)) {
                        // دمج البيانات المستوردة مع البيانات الموجودة
                        const newCases = importedData.cases.filter(importedCase => 
                            !casesData.some(existingCase => existingCase.formNumber === importedCase.formNumber)
                        );
                        
                        casesData.push(...newCases);
                        
                        // استيراد الإعدادات إذا كانت متوفرة
                        if (importedData.settings) {
                            systemSettings = { ...systemSettings, ...importedData.settings };
                            loadSettingsToForm();
                        }
                        
                        saveToStorage();
                        updateStatistics();
                        updateDashboard();
                        
                        showToast(`تم استيراد ${newCases.length} حالة جديدة بنجاح`, 'success');
                        
                        // مسح اختيار الملف
                        fileInput.value = '';
                    } else {
                        showToast('تنسيق الملف غير صحيح', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في استيراد البيانات:', error);
                    showToast('خطأ في قراءة الملف', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function convertToCSV(data) {
            if (!data.length) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
            ].join('\n');
            
            return '\uFEFF' + csvContent; // إضافة BOM للدعم العربي
        }

        // وظائف النسخ الاحتياطي المُفعلة بالكامل
        function createFullBackup() {
            const backupData = {
                cases: casesData,
                settings: systemSettings,
                timestamp: new Date().toISOString(),
                version: '2.0.0',
                type: 'full_backup',
                organization: systemSettings.orgName
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `charity_backup_full_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('تم إنشاء النسخة الاحتياطية الكاملة بنجاح', 'success');
        }

        function createPartialBackup() {
            const recentCases = casesData.slice(-50); // آخر 50 حالة
            
            const backupData = {
                cases: recentCases,
                settings: systemSettings,
                timestamp: new Date().toISOString(),
                version: '2.0.0',
                type: 'partial_backup',
                organization: systemSettings.orgName
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `charity_backup_partial_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast(`تم إنشاء نسخة احتياطية جزئية (${recentCases.length} حالة)`, 'success');
        }

        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('يرجى اختيار ملف النسخة الاحتياطية', 'warning');
                return;
            }
            
            if (!confirm('هل أنت متأكد من استعادة النسخة الاحتياطية؟ سيتم استبدال جميع البيانات الحالية.')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (backupData.cases && Array.isArray(backupData.cases)) {
                        casesData = backupData.cases;
                        
                        if (backupData.settings) {
                            systemSettings = { ...systemSettings, ...backupData.settings };
                            loadSettingsToForm();
                        }
                        
                        saveToStorage();
                        updateStatistics();
                        updateDashboard();
                        updateOrganizerFromSettings();
                        
                        showToast(`تم استعادة ${casesData.length} حالة بنجاح`, 'success');
                        
                        // مسح اختيار الملف
                        fileInput.value = '';
                    } else {
                        showToast('تنسيق ملف النسخة الاحتياطية غير صحيح', 'error');
                    }
                } catch (error) {
                    console.error('خطأ في استعادة النسخة الاحتياطية:', error);
                    showToast('خطأ في قراءة ملف النسخة الاحتياطية', 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function saveBackupSettings() {
            const frequency = document.getElementById('backupFrequency').value;
            const time = document.getElementById('backupTime').value;
            
            // حفظ إعدادات النسخ الاحتياطي
            systemSettings.backupFrequency = frequency;
            systemSettings.backupTime = time;
            systemSettings.lastBackup = new Date().toISOString();
            
            saveToStorage();
            
            showToast('تم حفظ إعدادات النسخ الاحتياطي', 'success');
        }

        // وظائف الإعدادات المُفعلة بالكامل
        function saveSettings() {
            const orgName = document.getElementById('orgName').value;
            const manager1 = document.getElementById('manager1').value;
            const manager2 = document.getElementById('manager2').value;
            const defaultOrganizer = document.getElementById('defaultOrganizer').value;
            const defaultFontSize = document.getElementById('defaultFontSize').value;
            const autoFormNumber = document.getElementById('autoFormNumber').value;
            const showQRCode = document.getElementById('showQRCode').value;
            
            systemSettings = {
                ...systemSettings,
                orgName,
                manager1,
                manager2,
                defaultOrganizer,
                defaultFontSize,
                autoFormNumber,
                showQRCode,
                updatedAt: new Date().toISOString()
            };
            
            saveToStorage();
            updateOrganizerFromSettings();
            
            showToast('تم حفظ الإعدادات بنجاح', 'success');
        }

        function resetSettings() {
            systemSettings = {
                orgName: 'مؤسسة أولاد الحسن (ع) الثقافية الخيرية',
                manager1: 'السيد أسامة السعبري',
                manager2: 'السيد فؤاد السعبري',
                defaultOrganizer: 'أبو كرار',
                defaultFontSize: '16',
                autoFormNumber: 'yes',
                showQRCode: 'yes'
            };
            
            loadSettingsToForm();
            saveToStorage();
            updateOrganizerFromSettings();
            
            showToast('تم إعادة تعيين الإعدادات إلى القيم الافتراضية', 'info');
        }

        function loadSettingsToForm() {
            if (document.getElementById('orgName')) document.getElementById('orgName').value = systemSettings.orgName || '';
            if (document.getElementById('manager1')) document.getElementById('manager1').value = systemSettings.manager1 || '';
            if (document.getElementById('manager2')) document.getElementById('manager2').value = systemSettings.manager2 || '';
            if (document.getElementById('defaultOrganizer')) document.getElementById('defaultOrganizer').value = systemSettings.defaultOrganizer || '';
            if (document.getElementById('defaultFontSize')) document.getElementById('defaultFontSize').value = systemSettings.defaultFontSize || '16';
            if (document.getElementById('autoFormNumber')) document.getElementById('autoFormNumber').value = systemSettings.autoFormNumber || 'yes';
            if (document.getElementById('showQRCode')) document.getElementById('showQRCode').value = systemSettings.showQRCode || 'yes';
        }

        function loadSavedSettings() {
            // تحميل الإعدادات من البيانات المحفوظة
            if (window.charitySystemData && window.charitySystemData.settings) {
                systemSettings = { ...systemSettings, ...window.charitySystemData.settings };
            }
        }

        // وظائف مساعدة محسنة
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }

        function formatCurrency(amount) {
            if (!amount || amount === '0') return '0';
            const num = parseFloat(amount);
            return isNaN(num) ? '0' : num.toLocaleString('en-US') + ' د.ع';
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }

        function getStatusBadge(status) {
            const badges = {
                'active': '<span class="status-badge active">نشط</span>',
                'completed': '<span class="status-badge completed">مكتمل</span>',
                'pending': '<span class="status-badge pending">قيد المراجعة</span>'
            };
            return badges[status] || badges['active'];
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // حفظ تلقائي محسن
        function autoSave() {
            if (casesData.length > 0) {
                saveToStorage();
                console.log('تم الحفظ التلقائي');
            }
        }

        function markFormDirty() {
            // إشارة لوجود تغييرات غير محفوظة
        }

        // إظهار إشعار محسن
        function showToast(message, type = 'info', title = '') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            toast.innerHTML = `
                <div class="toast-icon ${type}">
                    <i class="fas ${icons[type]}"></i>
                </div>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            // إزالة الإشعار بعد 4 ثوان
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // فلترة الحالات
        function filterCases(caseType) {
            loadCasesByType(caseType);
            showToast(`تم تطبيق فلتر ${caseType}`, 'info');
        }

        // إعدادات التجاوب مع الشاشات
        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                sidebar.classList.remove('collapsed');
                sidebar.classList.remove('show');
                mainContent.style.marginRight = '0';
            } else {
                sidebar.classList.remove('show');
                if (sidebar.classList.contains('collapsed')) {
                    mainContent.style.marginRight = '70px';
                } else {
                    mainContent.style.marginRight = '280px';
                }
            }
        }

        // مراقبة تغيير حجم الشاشة
        window.addEventListener('resize', handleResize);

        // إغلاق الشريط الجانبي عند النقر خارجه في الأجهزة المحمولة
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(e.target) && 
                !sidebarToggle.contains(e.target) &&
                sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
            }
        });

        // تشغيل البحث عند الضغط على Enter
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.id === 'globalSearch') {
                    performSearch();
                }
            }
        });

        // إعدادات الطباعة المحسنة
        window.addEventListener('beforeprint', function() {
            document.body.classList.add('printing');
        });

        window.addEventListener('afterprint', function() {
            document.body.classList.remove('printing');
        });

        // معالجة الأخطاء
        window.addEventListener('error', function(e) {
            console.error('خطأ في التطبيق:', e.error);
            showToast('حدث خطأ غير متوقع. يرجى إعادة تحميل الصفحة.', 'error');
        });

        // تحسين الأداء
        function optimizePerformance() {
            if (casesData.length > 1000) {
                const oldCount = casesData.length;
                casesData = casesData.slice(-1000);
                saveToStorage();
                showToast(`تم تنظيف ${oldCount - 1000} حالة قديمة لتحسين الأداء`, 'info');
            }
        }

        // تشغيل تحسين الأداء كل ساعة
        setInterval(optimizePerformance, 3600000);

        // تهيئة عند تحميل الصفحة
        window.addEventListener('load', function() {
            handleResize();
            console.log('تم تحميل نظام إدارة الحالات الخيرية المُحسن بنجاح');
            
            // رسالة ترحيب محسنة
            console.log(`
🎉 مرحباً بك في النظام المُحدث
📋 جميع الميزات مُفعلة ومُحسنة
🔧 QR Code يعمل بشكل صحيح
💾 التصدير والاستيراد مُفعل
⚙️ الإعدادات مُفعلة بالكامل
📊 التقارير متاحة
🔒 النسخ الاحتياطي يعمل
📱 تصميم متجاوب ومُحسن
            `);
        });

        // مساعدة للمطورين
        function debugInfo() {
            return {
                totalCases: casesData.length,
                settings: systemSettings,
                charts: Object.keys(chartInstances),
                version: '2.0.0',
                lastUpdate: new Date().toISOString()
            };
        }

        // إتاحة المساعدة في وحدة التحكم
        window.charityDebug = debugInfo;
    </script>
</body>
</html>
