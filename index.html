<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الكاشير المتكامل المتطور</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --info-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --border-radius: 15px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --gradient-success: linear-gradient(135deg, #56ab2f, #a8e6cf);
            --gradient-warning: linear-gradient(135deg, #f7971e, #ffd200);
            --gradient-error: linear-gradient(135deg, #ff416c, #ff4b2b);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: var(--dark-color);
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(20px);
            overflow: hidden;
        }

        .top-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .top-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .live-time {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            font-weight: bold;
        }

        .nav-container {
            background: white;
            padding: 0 20px;
            border-bottom: 1px solid #e1e8ed;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            padding: 15px 0;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 20px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .tab-btn:hover::before {
            left: 100%;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .tab-btn.active {
            background: var(--gradient-success);
            transform: translateY(-2px);
        }

        .content-container {
            padding: 20px;
            min-height: calc(100vh - 300px);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--gradient-primary);
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .stat-change {
            font-size: 0.9em;
            margin-top: 5px;
            opacity: 0.8;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            border: 1px solid #e1e8ed;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
        }

        .card-title {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--dark-color);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .form-section {
            background: #f8f9fb;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid #e1e8ed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark-color);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 14px;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }

        .btn-danger {
            background: var(--gradient-error);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #5dade2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 15px 30px;
            font-size: 16px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        th, td {
            padding: 15px 12px;
            text-align: right;
            border-bottom: 1px solid #e1e8ed;
            font-size: 14px;
        }

        th {
            background: var(--gradient-primary);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        tr:nth-child(even) {
            background: rgba(248, 249, 251, 0.5);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 25px;
            border-radius: var(--border-radius);
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--error-color);
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 18px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            border: 2px solid #e1e8ed;
            border-radius: var(--border-radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .product-card:hover::before {
            left: 100%;
        }

        .product-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .product-card.selected {
            border-color: var(--success-color);
            background: rgba(39, 174, 96, 0.05);
        }

        .product-image {
            width: 100%;
            height: 150px;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: var(--primary-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 3000;
            animation: slideInLeft 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-active { background: var(--success-color); color: white; }
        .status-pending { background: var(--warning-color); color: white; }
        .status-completed { background: var(--info-color); color: white; }
        .status-cancelled { background: var(--error-color); color: white; }
        .status-low-stock { background: var(--error-color); color: white; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .currency {
            color: var(--success-color);
            font-weight: bold;
        }

        .progress-container {
            background: #e1e8ed;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-success);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .tabs-secondary {
            display: flex;
            border-bottom: 1px solid #e1e8ed;
            margin-bottom: 20px;
        }

        .tab-secondary {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #666;
        }

        .tab-secondary.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .analytics-chart {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .filter-section {
            background: #f8f9fb;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #e1e8ed;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1500;
            overflow-y: auto;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .sidebar-content {
            padding: 20px;
        }

        .floating-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 5px;
                border-radius: 10px;
            }
            
            .content-container {
                padding: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tab-btn {
                margin: 2px 0;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 98%;
                margin: 2% auto;
            }
            
            .user-info,
            .live-time {
                position: static;
                display: inline-block;
                margin: 5px;
            }
            
            .top-header {
                text-align: center;
            }
            
            .sidebar {
                width: 100%;
                right: -100%;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-color);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .badge-primary { background: var(--primary-color); color: white; }
        .badge-success { background: var(--success-color); color: white; }
        .badge-warning { background: var(--warning-color); color: white; }
        .badge-danger { background: var(--error-color); color: white; }
        .badge-info { background: var(--info-color); color: white; }

        .accordion {
            border: 1px solid #e1e8ed;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .accordion-header {
            background: #f8f9fb;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid #e1e8ed;
            font-weight: bold;
        }

        .accordion-header:hover {
            background: #e9ecef;
        }

        .accordion-content {
            padding: 20px;
            display: none;
        }

        .accordion-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- رأس الصفحة -->
        <div class="top-header">
            <div class="user-info">
                <span id="currentUser">👤 المدير العام</span>
            </div>
            <h1>🏪 نظام الكاشير المتكامل المتطور</h1>
            <div class="live-time" id="liveTime"></div>
        </div>

        <!-- شريط التنقل -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="showTab('dashboard')">📊 لوحة التحكم</button>
                <button class="tab-btn" onclick="showTab('pos')">💰 نقطة البيع</button>
                <button class="tab-btn" onclick="showTab('products')">📦 إدارة المنتجات</button>
                <button class="tab-btn" onclick="showTab('inventory')">🏬 المخازن</button>
                <button class="tab-btn" onclick="showTab('customers')">👥 العملاء</button>
                <button class="tab-btn" onclick="showTab('suppliers')">🚚 الموردين</button>
                <button class="tab-btn" onclick="showTab('installments')">📅 الأقساط</button>
                <button class="tab-btn" onclick="showTab('sales')">📈 المبيعات</button>
                <button class="tab-btn" onclick="showTab('returns')">↩️ المرتجعات</button>
                <button class="tab-btn" onclick="showTab('expenses')">💸 المصروفات</button>
                <button class="tab-btn" onclick="showTab('reports')">📋 التقارير</button>
                <button class="tab-btn" onclick="showTab('accounting')">💼 المحاسبة</button>
                <button class="tab-btn" onclick="showTab('users')">👨‍💼 المستخدمين</button>
                <button class="tab-btn" onclick="showTab('settings')">⚙️ الإعدادات</button>
            </div>
        </div>

        <div class="content-container">
            <!-- لوحة التحكم -->
            <div id="dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="todaySales">0</div>
                        <div class="stat-label">مبيعات اليوم</div>
                        <div class="stat-change">+12% من أمس</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthSales">0</div>
                        <div class="stat-label">مبيعات الشهر</div>
                        <div class="stat-change">+8% من الشهر الماضي</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">إجمالي المنتجات</div>
                        <div class="stat-change">تم إضافة 5 منتجات جديدة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lowStockAlert">0</div>
                        <div class="stat-label">تنبيهات المخزون</div>
                        <div class="stat-change">يحتاج إلى تجديد</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeCustomers">0</div>
                        <div class="stat-label">العملاء النشطون</div>
                        <div class="stat-change">+15 عميل جديد</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingInstallments">0</div>
                        <div class="stat-label">أقساط معلقة</div>
                        <div class="stat-change">استحقاق هذا الأسبوع</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📈 الرسم البياني للمبيعات</h3>
                        </div>
                        <div class="analytics-chart">
                            <p>سيتم عرض الرسم البياني للمبيعات هنا</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🔔 التنبيهات والإشعارات</h3>
                        </div>
                        <div id="alertsList">
                            <div class="alert alert-warning">⚠️ منتج "لابتوب ديل" وصل إلى الحد الأدنى للمخزون</div>
                            <div class="alert alert-info">ℹ️ موعد استحقاق قسط العميل "أحمد محمد" غداً</div>
                            <div class="alert alert-success">✅ تم استلام شحنة جديدة من المورد "شركة التقنية"</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🏆 أفضل المنتجات مبيعاً</h3>
                    </div>
                    <div class="table-container">
                        <table id="topProductsTable">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الكمية المباعة</th>
                                    <th>الإيرادات</th>
                                    <th>النسبة</th>
                                </tr>
                            </thead>
                            <tbody id="topProductsBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- نقطة البيع -->
            <div id="pos" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🏪 اختيار نوع المتجر</h3>
                        </div>
                        <div class="form-group">
                            <select id="storeType" onchange="updateStoreSettings()">
                                <option value="general">متجر عام</option>
                                <option value="clothes">متجر ملابس</option>
                                <option value="supermarket">سوبر ماركت</option>
                                <option value="electronics">أجهزة كهربائية</option>
                                <option value="mobile">متجر هواتف</option>
                                <option value="pharmacy">صيدلية</option>
                                <option value="books">مكتبة</option>
                                <option value="furniture">أثاث</option>
                                <option value="jewelry">مجوهرات</option>
                                <option value="cosmetics">مستحضرات تجميل</option>
                                <option value="sports">أدوات رياضية</option>
                                <option value="toys">ألعاب أطفال</option>
                            </select>
                        </div>

                        <div class="card-header">
                            <h3 class="card-title">🔍 البحث عن المنتجات</h3>
                        </div>
                        <div class="search-container">
                            <input type="text" id="productSearch" class="search-input" placeholder="ابحث بالاسم، الباركود، أو الفئة..." oninput="searchProducts()">
                            <span class="search-icon">🔍</span>
                        </div>

                        <div class="filter-section">
                            <div class="filter-row">
                                <div class="form-group">
                                    <label>الفئة</label>
                                    <select id="categoryFilter" onchange="filterProductsByCategory()">
                                        <option value="">جميع الفئات</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>نطاق السعر</label>
                                    <select id="priceRange" onchange="filterProductsByPrice()">
                                        <option value="">جميع الأسعار</option>
                                        <option value="0-50000">أقل من 50,000 د.ع</option>
                                        <option value="50000-200000">50,000 - 200,000 د.ع</option>
                                        <option value="200000-500000">200,000 - 500,000 د.ع</option>
                                        <option value="500000+">أكثر من 500,000 د.ع</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>الحالة</label>
                                    <select id="stockFilter" onchange="filterProductsByStock()">
                                        <option value="">جميع المنتجات</option>
                                        <option value="available">متوفر</option>
                                        <option value="low">مخزون منخفض</option>
                                        <option value="out">غير متوفر</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="product-grid" id="productGrid">
                            <!-- سيتم ملء المنتجات هنا -->
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🛒 عربة التسوق</h3>
                            <button class="btn btn-warning btn-sm" onclick="openCustomerModal()">اختيار عميل</button>
                        </div>
                        
                        <div id="selectedCustomer" class="customer-info" style="display: none;">
                            <div class="alert alert-info">
                                <strong>العميل المحدد:</strong> <span id="customerName"></span>
                                <button class="btn btn-sm btn-danger" onclick="clearSelectedCustomer()">إلغاء</button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>المنتج</th>
                                        <th>الكمية</th>
                                        <th>السعر</th>
                                        <th>الخصم</th>
                                        <th>المجموع</th>
                                        <th>حذف</th>
                                    </tr>
                                </thead>
                                <tbody id="cartItems">
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 20px;">
                            <div class="form-section">
                                <div class="form-group">
                                    <label>خصم إضافي (%)</label>
                                    <input type="number" id="totalDiscount" value="0" min="0" max="100" oninput="updateCartTotal()">
                                </div>
                                <div class="form-group">
                                    <label>الضريبة (%)</label>
                                    <input type="number" id="taxRate" value="0" min="0" max="50" oninput="updateCartTotal()">
                                </div>
                            </div>

                            <div style="background: #f8f9fb; padding: 20px; border-radius: 10px; margin: 15px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>المجموع الفرعي:</span>
                                    <span id="subtotal" class="currency">0 د.ع</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>الخصم:</span>
                                    <span id="discountAmount" class="currency">0 د.ع</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>الضريبة:</span>
                                    <span id="taxAmount" class="currency">0 د.ع</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 1.2em; font-weight: bold; border-top: 2px solid #e1e8ed; padding-top: 10px;">
                                    <span>المجموع الكلي:</span>
                                    <span id="totalAmount" class="currency">0 د.ع</span>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-success btn-lg" onclick="processCashSale()">💰 بيع نقدي</button>
                                <button class="btn btn-warning btn-lg" onclick="showInstallmentModal()">📅 بيع بالأقساط</button>
                                <button class="btn btn-info btn-lg" onclick="saveQuote()">📄 حفظ كعرض سعر</button>
                                <button class="btn btn-danger" onclick="clearCart()">🗑️ مسح العربة</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- إدارة المنتجات -->
            <div id="products" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">➕ إضافة منتج جديد</h3>
                        <button class="btn btn-info" onclick="showBulkAddModal()">إضافة متعددة</button>
                    </div>
                    
                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            المعلومات الأساسية
                        </div>
                        <div class="accordion-content active">
                            <div class="grid">
                                <div class="form-group">
                                    <label>اسم المنتج *</label>
                                    <input type="text" id="productName" required>
                                </div>
                                <div class="form-group">
                                    <label>الباركود</label>
                                    <input type="text" id="productBarcode">
                                    <small>سيتم إنشاء باركود تلقائي إذا تُرك فارغاً</small>
                                </div>
                                <div class="form-group">
                                    <label>الفئة الرئيسية *</label>
                                    <select id="mainCategory" onchange="updateSubCategories()">
                                        <option value="">اختر الفئة</option>
                                        <option value="electronics">إلكترونيات</option>
                                        <option value="clothes">ملابس</option>
                                        <option value="food">طعام ومشروبات</option>
                                        <option value="health">صحة وجمال</option>
                                        <option value="home">منزل وحديقة</option>
                                        <option value="sports">رياضة</option>
                                        <option value="books">كتب</option>
                                        <option value="toys">ألعاب</option>
                                        <option value="automotive">سيارات</option>
                                        <option value="jewelry">مجوهرات</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>الفئة الفرعية</label>
                                    <select id="subCategory">
                                        <option value="">اختر الفئة الفرعية</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>العلامة التجارية</label>
                                    <input type="text" id="productBrand">
                                </div>
                                <div class="form-group">
                                    <label>الموديل</label>
                                    <input type="text" id="productModel">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            التسعير والمخزون
                        </div>
                        <div class="accordion-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>سعر الشراء *</label>
                                    <input type="number" id="costPrice" oninput="calculateProfitMargin()">
                                </div>
                                <div class="form-group">
                                    <label>سعر البيع *</label>
                                    <input type="number" id="salePrice" oninput="calculateProfitMargin()">
                                </div>
                                <div class="form-group">
                                    <label>هامش الربح (%)</label>
                                    <input type="number" id="profitMargin" readonly>
                                </div>
                                <div class="form-group">
                                    <label>الحد الأدنى للسعر</label>
                                    <input type="number" id="minPrice">
                                </div>
                                <div class="form-group">
                                    <label>المخزن الثابت</label>
                                    <input type="number" id="fixedStock" value="0">
                                </div>
                                <div class="form-group">
                                    <label>المخزن المتحرك *</label>
                                    <input type="number" id="movingStock" required>
                                </div>
                                <div class="form-group">
                                    <label>الحد الأدنى للمخزون</label>
                                    <input type="number" id="minStock" value="5">
                                </div>
                                <div class="form-group">
                                    <label>الحد الأقصى للمخزون</label>
                                    <input type="number" id="maxStock">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="accordion">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            معلومات إضافية
                        </div>
                        <div class="accordion-content">
                            <div class="grid">
                                <div class="form-group">
                                    <label>الوزن (كجم)</label>
                                    <input type="number" id="productWeight" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>الأبعاد (الطول × العرض × الارتفاع)</label>
                                    <input type="text" id="productDimensions" placeholder="10 × 20 × 5 سم">
                                </div>
                                <div class="form-group">
                                    <label>تاريخ الانتهاء</label>
                                    <input type="date" id="expiryDate">
                                </div>
                                <div class="form-group">
                                    <label>رقم المورد</label>
                                    <select id="supplierId">
                                        <option value="">اختر المورد</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>موقع التخزين</label>
                                    <input type="text" id="storageLocation" placeholder="رقم الرف أو المنطقة">
                                </div>
                                <div class="form-group">
                                    <label>حالة المنتج</label>
                                    <select id="productStatus">
                                        <option value="active">نشط</option>
                                        <option value="inactive">غير نشط</option>
                                        <option value="discontinued">متوقف</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>وصف المنتج</label>
                                <textarea id="productDescription" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ملاحظات</label>
                                <textarea id="productNotes" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-lg" onclick="addProduct()">💾 حفظ المنتج</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📋 قائمة المنتجات</h3>
                        <div class="quick-actions">
                            <button class="btn btn-success btn-sm" onclick="exportProducts()">📤 تصدير</button>
                            <button class="btn btn-info btn-sm" onclick="showImportModal()">📥 استيراد</button>
                            <button class="btn btn-warning btn-sm" onclick="bulkEdit()">✏️ تعديل متعدد</button>
                        </div>
                    </div>

                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="form-group">
                                <label>البحث</label>
                                <input type="text" id="productFilter" placeholder="ابحث في المنتجات..." oninput="filterProducts()">
                            </div>
                            <div class="form-group">
                                <label>الفئة</label>
                                <select id="categoryFilterProducts" onchange="filterProducts()">
                                    <option value="">جميع الفئات</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>الحالة</label>
                                <select id="statusFilterProducts" onchange="filterProducts()">
                                    <option value="">جميع الحالات</option>
                                    <option value="active">نشط</option>
                                    <option value="inactive">غير نشط</option>
                                    <option value="low-stock">مخزون منخفض</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label></label>
                                <button class="btn btn-primary" onclick="applyFilters()">تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                    <th>الصورة</th>
                                    <th>الاسم</th>
                                    <th>الباركود</th>
                                    <th>الفئة</th>
                                    <th>سعر الشراء</th>
                                    <th>سعر البيع</th>
                                    <th>المخزن الثابت</th>
                                    <th>المخزن المتحرك</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- العملاء -->
            <div id="customers" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">👤 إضافة عميل جديد</h3>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label>الاسم الكامل *</label>
                            <input type="text" id="customerFullName" required>
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف *</label>
                            <input type="tel" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="customerEmail">
                        </div>
                        <div class="form-group">
                            <label>تاريخ الميلاد</label>
                            <input type="date" id="customerBirthdate">
                        </div>
                        <div class="form-group">
                            <label>الجنس</label>
                            <select id="customerGender">
                                <option value="">غير محدد</option>
                                <option value="male">ذكر</option>
                                <option value="female">أنثى</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>نوع العميل</label>
                            <select id="customerType">
                                <option value="regular">عادي</option>
                                <option value="vip">مميز</option>
                                <option value="wholesale">تاجر جملة</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>العنوان</label>
                        <textarea id="customerAddress" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ملاحظات</label>
                        <textarea id="customerNotes" rows="2"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addCustomer()">💾 حفظ العميل</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📋 قائمة العملاء</h3>
                    </div>
                    <div class="search-container">
                        <input type="text" id="customerSearch" class="search-input" placeholder="ابحث عن عميل..." oninput="searchCustomers()">
                        <span class="search-icon">🔍</span>
                    </div>
                    <div class="table-container">
                        <table id="customersTable">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>الهاتف</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>النوع</th>
                                    <th>نقاط الولاء</th>
                                    <th>إجمالي المشتريات</th>
                                    <th>آخر زيارة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- الموردين -->
            <div id="suppliers" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🚚 إضافة مورد جديد</h3>
                    </div>
                    <div class="grid">
                        <div class="form-group">
                            <label>اسم الشركة *</label>
                            <input type="text" id="supplierCompany" required>
                        </div>
                        <div class="form-group">
                            <label>اسم المسؤول</label>
                            <input type="text" id="supplierContact">
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف *</label>
                            <input type="tel" id="supplierPhone" required>
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="supplierEmail">
                        </div>
                        <div class="form-group">
                            <label>الرقم الضريبي</label>
                            <input type="text" id="supplierTaxNumber">
                        </div>
                        <div class="form-group">
                            <label>تقييم المورد</label>
                            <select id="supplierRating">
                                <option value="5">⭐⭐⭐⭐⭐ ممتاز</option>
                                <option value="4">⭐⭐⭐⭐ جيد جداً</option>
                                <option value="3" selected>⭐⭐⭐ جيد</option>
                                <option value="2">⭐⭐ مقبول</option>
                                <option value="1">⭐ ضعيف</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>العنوان</label>
                        <textarea id="supplierAddress" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ملاحظات</label>
                        <textarea id="supplierNotes" rows="2"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="addSupplier()">💾 حفظ المورد</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📋 قائمة الموردين</h3>
                    </div>
                    <div class="table-container">
                        <table id="suppliersTable">
                            <thead>
                                <tr>
                                    <th>الشركة</th>
                                    <th>المسؤول</th>
                                    <th>الهاتف</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>التقييم</th>
                                    <th>آخر طلبية</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="suppliersTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- باقي التبويبات ستكون مشابهة بنفس التصميم المتطور -->
            <!-- سأضيف المزيد من التبويبات حسب الحاجة -->

            <!-- الإعدادات -->
            <div id="settings" class="tab-content">
                <div class="tabs-secondary">
                    <button class="tab-secondary active" onclick="showSettingsTab('general')">عام</button>
                    <button class="tab-secondary" onclick="showSettingsTab('pos')">نقطة البيع</button>
                    <button class="tab-secondary" onclick="showSettingsTab('inventory')">المخزون</button>
                    <button class="tab-secondary" onclick="showSettingsTab('financial')">مالي</button>
                    <button class="tab-secondary" onclick="showSettingsTab('notifications')">التنبيهات</button>
                    <button class="tab-secondary" onclick="showSettingsTab('backup')">النسخ الاحتياطي</button>
                    <button class="tab-secondary" onclick="showSettingsTab('advanced')">متقدم</button>
                </div>

                <!-- الإعدادات العامة -->
                <div id="general-settings" class="settings-content active">
                    <div class="grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">🏪 معلومات المتجر</h3>
                            </div>
                            <div class="form-group">
                                <label>اسم المتجر</label>
                                <input type="text" id="storeName" value="متجري">
                            </div>
                            <div class="form-group">
                                <label>شعار المتجر (URL)</label>
                                <input type="url" id="storeLogo">
                            </div>
                            <div class="form-group">
                                <label>العنوان</label>
                                <textarea id="storeAddress" rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>رقم الهاتف</label>
                                <input type="tel" id="storePhone">
                            </div>
                            <div class="form-group">
                                <label>البريد الإلكتروني</label>
                                <input type="email" id="storeEmail">
                            </div>
                            <div class="form-group">
                                <label>الموقع الإلكتروني</label>
                                <input type="url" id="storeWebsite">
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">🌍 الإعدادات الإقليمية</h3>
                            </div>
                            <div class="form-group">
                                <label>العملة</label>
                                <select id="currency">
                                    <option value="IQD">دينار عراقي (د.ع)</option>
                                    <option value="USD">دولار أمريكي ($)</option>
                                    <option value="EUR">يورو (€)</option>
                                    <option value="SAR">ريال سعودي (ر.س)</option>
                                    <option value="AED">درهم إماراتي (د.إ)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>اللغة</label>
                                <select id="language">
                                    <option value="ar">العربية</option>
                                    <option value="en">English</option>
                                    <option value="ku">کوردی</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>المنطقة الزمنية</label>
                                <select id="timezone">
                                    <option value="Asia/Baghdad">بغداد (UTC+3)</option>
                                    <option value="Asia/Riyadh">الرياض (UTC+3)</option>
                                    <option value="Asia/Dubai">دبي (UTC+4)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>تنسيق التاريخ</label>
                                <select id="dateFormat">
                                    <option value="DD/MM/YYYY">يوم/شهر/سنة</option>
                                    <option value="MM/DD/YYYY">شهر/يوم/سنة</option>
                                    <option value="YYYY-MM-DD">سنة-شهر-يوم</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- باقي إعدادات نقطة البيع والمخزون والمالي -->
                <!-- سأضيف المزيد من الإعدادات المتقدمة -->
            </div>
        </div>
    </div>

    <!-- الأزرار العائمة -->
    <button class="floating-btn" onclick="showQuickActions()" title="إجراءات سريعة">⚡</button>

    <!-- النوافذ المنبثقة -->
    <!-- نافذة اختيار العميل -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('customerModal')">&times;</span>
            <h2>اختيار عميل</h2>
            <div class="search-container">
                <input type="text" id="customerModalSearch" class="search-input" placeholder="ابحث عن عميل..." oninput="searchCustomersModal()">
                <span class="search-icon">🔍</span>
            </div>
            <div id="customersList" style="max-height: 400px; overflow-y: auto;">
                <!-- قائمة العملاء -->
            </div>
            <button class="btn btn-primary" onclick="openNewCustomerModal()">إضافة عميل جديد</button>
        </div>
    </div>

    <!-- نافذة الأقساط -->
    <div id="installmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('installmentModal')">&times;</span>
            <h2>بيع بالأقساط</h2>
            <!-- محتوى نافذة الأقساط -->
        </div>
    </div>

    <script>
        // المتغيرات العامة
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let installmentSales = JSON.parse(localStorage.getItem('installmentSales')) || [];
        let returns = JSON.parse(localStorage.getItem('returns')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let cart = [];
        let selectedCustomer = null;
        let currentStoreType = 'general';
        let settings = JSON.parse(localStorage.getItem('settings')) || {};

        // الفئات والفئات الفرعية
        const categoryStructure = {
            electronics: {
                name: 'إلكترونيات',
                subcategories: ['هواتف ذكية', 'أجهزة كمبيوتر', 'تلفزيونات', 'أجهزة صوت', 'كاميرات', 'إكسسوارات']
            },
            clothes: {
                name: 'ملابس',
                subcategories: ['ملابس رجالي', 'ملابس نسائي', 'ملابس أطفال', 'أحذية', 'حقائب', 'إكسسوارات']
            },
            food: {
                name: 'طعام ومشروبات',
                subcategories: ['مواد غذائية', 'مشروبات', 'حلويات', 'منتجات مجمدة', 'خضار وفواكه', 'لحوم']
            },
            health: {
                name: 'صحة وجمال',
                subcategories: ['أدوية', 'مستحضرات تجميل', 'عناية شخصية', 'فيتامينات', 'أعشاب طبية', 'أجهزة طبية']
            },
            home: {
                name: 'منزل وحديقة',
                subcategories: ['أثاث', 'أدوات منزلية', 'ديكور', 'أدوات حديقة', 'إضاءة', 'منسوجات']
            },
            sports: {
                name: 'رياضة',
                subcategories: ['ملابس رياضية', 'أجهزة تمارين', 'كرة قدم', 'كرة سلة', 'سباحة', 'رياضات أخرى']
            },
            books: {
                name: 'كتب',
                subcategories: ['كتب دينية', 'كتب علمية', 'روايات', 'كتب أطفال', 'قواميس', 'مجلات']
            },
            toys: {
                name: 'ألعاب',
                subcategories: ['ألعاب تعليمية', 'ألعاب إلكترونية', 'دمى', 'ألعاب رياضية', 'ألعاب بناء', 'ألعاب فنية']
            },
            automotive: {
                name: 'سيارات',
                subcategories: ['قطع غيار', 'زيوت ومواد التشحيم', 'إطارات', 'بطاريات', 'إكسسوارات', 'أدوات']
            },
            jewelry: {
                name: 'مجوهرات',
                subcategories: ['ذهب', 'فضة', 'ألماس', 'ساعات', 'مجوهرات مقلدة', 'هدايا']
            }
        };

        // تهيئة التطبيق
        window.onload = function() {
            updateLiveTime();
            setInterval(updateLiveTime, 1000);
            loadAllData();
            updateDashboard();
            applySettings();
            loadCategories();
        };

        // تحديث الوقت المباشر
        function updateLiveTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ar-IQ', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('liveTime').textContent = timeString;
        }

        // تبديل التبويبات
        function showTab(tabName) {
            // إخفاء جميع التبويبات
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // إزالة التحديد من جميع الأزرار
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // عرض التبويب المحدد
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // تحديث البيانات حسب التبويب
            switch(tabName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'pos':
                    loadProductsForPOS();
                    break;
                case 'products':
                    loadProductsTable();
                    break;
                case 'customers':
                    loadCustomersTable();
                    break;
                case 'suppliers':
                    loadSuppliersTable();
                    break;
            }
        }

        // تحميل جميع البيانات
        function loadAllData() {
            loadProductsForPOS();
            loadProductsTable();
            loadCustomersTable();
            loadSuppliersTable();
        }

        // تحديث لوحة التحكم
        function updateDashboard() {
            // حساب إحصائيات اليوم
            const today = new Date().toDateString();
            const todaySales = sales
                .filter(sale => new Date(sale.date).toDateString() === today)
                .reduce((sum, sale) => sum + sale.total, 0);

            // حساب إحصائيات الشهر
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthSales = sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === thisMonth && saleDate.getFullYear() === thisYear;
                })
                .reduce((sum, sale) => sum + sale.total, 0);

            // تحديث الإحصائيات
            document.getElementById('todaySales').textContent = formatCurrency(todaySales);
            document.getElementById('monthSales').textContent = formatCurrency(monthSales);
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('lowStockAlert').textContent = products.filter(p => p.movingStock <= (p.minStock || 5)).length;
            document.getElementById('activeCustomers').textContent = customers.length;
            document.getElementById('pendingInstallments').textContent = installmentSales.filter(s => s.status === 'active').length;
        }

        // تحميل المنتجات لنقطة البيع
        function loadProductsForPOS() {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = '';

            const filteredProducts = products.filter(p => 
                p.storeType === currentStoreType || currentStoreType === 'general'
            );

            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.onclick = () => addToCart(product);
                
                const stockStatus = product.movingStock <= 0 ? 'نفذ المخزون' : 
                                  product.movingStock <= (product.minStock || 5) ? 'مخزون منخفض' : 'متوفر';
                
                const stockClass = product.movingStock <= 0 ? 'status-cancelled' : 
                                 product.movingStock <= (product.minStock || 5) ? 'status-low-stock' : 'status-active';

                productCard.innerHTML = `
                    <div class="product-image">📦</div>
                    <h4>${product.name}</h4>
                    <p><strong>الفئة:</strong> ${categoryStructure[product.mainCategory]?.name || product.mainCategory}</p>
                    <p><strong>السعر:</strong> <span class="currency">${formatCurrency(product.salePrice)}</span></p>
                    <p><strong>المخزون:</strong> ${product.movingStock}</p>
                    <span class="status-badge ${stockClass}">${stockStatus}</span>
                    ${product.brand ? `<p><strong>العلامة:</strong> ${product.brand}</p>` : ''}
                `;

                productGrid.appendChild(productCard);
            });
        }

        // إضافة منتج جديد
        function addProduct() {
            const name = document.getElementById('productName').value.trim();
            const barcode = document.getElementById('productBarcode').value.trim() || generateBarcode();
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const brand = document.getElementById('productBrand').value.trim();
            const model = document.getElementById('productModel').value.trim();
            const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            const fixedStock = parseInt(document.getElementById('fixedStock').value) || 0;
            const movingStock = parseInt(document.getElementById('movingStock').value) || 0;
            const minStock = parseInt(document.getElementById('minStock').value) || 5;
            const maxStock = parseInt(document.getElementById('maxStock').value) || 1000;
            const weight = parseFloat(document.getElementById('productWeight').value) || 0;
            const dimensions = document.getElementById('productDimensions').value.trim();
            const expiryDate = document.getElementById('expiryDate').value;
            const supplierId = document.getElementById('supplierId').value;
            const storageLocation = document.getElementById('storageLocation').value.trim();
            const status = document.getElementById('productStatus').value;
            const description = document.getElementById('productDescription').value.trim();
            const notes = document.getElementById('productNotes').value.trim();

            if (!name || !salePrice || !mainCategory) {
                showNotification('يرجى ملء الحقول المطلوبة', 'error');
                return;
            }

            const product = {
                id: Date.now(),
                name,
                barcode,
                mainCategory,
                subCategory,
                brand,
                model,
                costPrice,
                salePrice,
                minPrice,
                fixedStock,
                movingStock,
                minStock,
                maxStock,
                weight,
                dimensions,
                expiryDate,
                supplierId,
                storageLocation,
                status,
                description,
                notes,
                storeType: currentStoreType,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            products.push(product);
            saveProducts();
            loadAllData();
            clearProductForm();
            updateDashboard();
            showNotification('تم إضافة المنتج بنجاح', 'success');
        }

        // إضافة عميل جديد
        function addCustomer() {
            const fullName = document.getElementById('customerFullName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const birthdate = document.getElementById('customerBirthdate').value;
            const gender = document.getElementById('customerGender').value;
            const type = document.getElementById('customerType').value;
            const address = document.getElementById('customerAddress').value.trim();
            const notes = document.getElementById('customerNotes').value.trim();

            if (!fullName || !phone) {
                showNotification('يرجى ملء الحقول المطلوبة', 'error');
                return;
            }

            const customer = {
                id: Date.now(),
                fullName,
                phone,
                email,
                birthdate,
                gender,
                type,
                address,
                notes,
                loyaltyPoints: 0,
                totalPurchases: 0,
                lastVisit: null,
                createdAt: new Date().toISOString()
            };

            customers.push(customer);
            saveCustomers();
            loadCustomersTable();
            clearCustomerForm();
            updateDashboard();
            showNotification('تم إضافة العميل بنجاح', 'success');
        }

        // إضافة مورد جديد
        function addSupplier() {
            const company = document.getElementById('supplierCompany').value.trim();
            const contact = document.getElementById('supplierContact').value.trim();
            const phone = document.getElementById('supplierPhone').value.trim();
            const email = document.getElementById('supplierEmail').value.trim();
            const taxNumber = document.getElementById('supplierTaxNumber').value.trim();
            const rating = document.getElementById('supplierRating').value;
            const address = document.getElementById('supplierAddress').value.trim();
            const notes = document.getElementById('supplierNotes').value.trim();

            if (!company || !phone) {
                showNotification('يرجى ملء الحقول المطلوبة', 'error');
                return;
            }

            const supplier = {
                id: Date.now(),
                company,
                contact,
                phone,
                email,
                taxNumber,
                rating: parseInt(rating),
                address,
                notes,
                totalOrders: 0,
                lastOrder: null,
                createdAt: new Date().toISOString()
            };

            suppliers.push(supplier);
            saveSuppliers();
            loadSuppliersTable();
            clearSupplierForm();
            showNotification('تم إضافة المورد بنجاح', 'success');
        }

        // إضافة منتج إلى العربة
        function addToCart(product) {
            if (product.movingStock <= 0) {
                showNotification('المنتج غير متوفر في المخزون', 'error');
                return;
            }

            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                if (existingItem.quantity < product.movingStock) {
                    existingItem.quantity++;
                } else {
                    showNotification('الكمية المطلوبة غير متوفرة في المخزون', 'error');
                    return;
                }
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.salePrice,
                    quantity: 1,
                    discount: 0,
                    maxStock: product.movingStock
                });
            }
            
            updateCartDisplay();
            showNotification('تم إضافة المنتج إلى العربة', 'success');
        }

        // تحديث عرض العربة
        function updateCartDisplay() {
            const tbody = document.getElementById('cartItems');
            tbody.innerHTML = '';
            
            cart.forEach((item, index) => {
                const itemTotal = (item.price * item.quantity) * (1 - item.discount / 100);
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <button onclick="changeQuantity(${index}, -1)" class="btn btn-sm">-</button>
                            <span style="min-width: 30px; text-align: center;">${item.quantity}</span>
                            <button onclick="changeQuantity(${index}, 1)" class="btn btn-sm">+</button>
                        </div>
                    </td>
                    <td class="currency">${formatCurrency(item.price)}</td>
                    <td>
                        <input type="number" value="${item.discount}" min="0" max="100" 
                               onchange="updateItemDiscount(${index}, this.value)"
                               style="width: 70px;">%
                    </td>
                    <td class="currency">${formatCurrency(itemTotal)}</td>
                    <td><button onclick="removeFromCart(${index})" class="btn btn-danger btn-sm">🗑️</button></td>
                `;
            });
            
            updateCartTotal();
        }

        // تحديث إجمالي العربة
        function updateCartTotal() {
            const subtotal = cart.reduce((sum, item) => 
                sum + (item.price * item.quantity * (1 - item.discount / 100)), 0);
            
            const discountRate = parseFloat(document.getElementById('totalDiscount').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            
            const discountAmount = subtotal * (discountRate / 100);
            const afterDiscount = subtotal - discountAmount;
            const taxAmount = afterDiscount * (taxRate / 100);
            const total = afterDiscount + taxAmount;

            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('discountAmount').textContent = formatCurrency(discountAmount);
            document.getElementById('taxAmount').textContent = formatCurrency(taxAmount);
            document.getElementById('totalAmount').textContent = formatCurrency(total);
        }

        // معالجة البيع النقدي
        function processCashSale() {
            if (cart.length === 0) {
                showNotification('العربة فارغة', 'error');
                return;
            }

            const total = getTotalAmount();
            
            // تحديث المخزون
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    product.movingStock -= cartItem.quantity;
                }
            });

            // تحديث نقاط ولاء العميل
            if (selectedCustomer) {
                const customer = customers.find(c => c.id === selectedCustomer.id);
                if (customer) {
                    customer.loyaltyPoints += Math.floor(total / 1000); // نقطة لكل 1000 د.ع
                    customer.totalPurchases += total;
                    customer.lastVisit = new Date().toISOString();
                }
            }

            // حفظ البيع
            const sale = {
                id: Date.now(),
                customerId: selectedCustomer?.id || null,
                customerName: selectedCustomer?.fullName || 'عميل مجهول',
                items: [...cart],
                subtotal: getSubtotal(),
                discount: getTotalDiscount(),
                tax: getTaxAmount(),
                total: total,
                type: 'cash',
                date: new Date().toISOString(),
                cashier: 'المدير العام' // يمكن تحديثه حسب المستخدم الحالي
            };

            sales.push(sale);
            localStorage.setItem('sales', JSON.stringify(sales));
            
            saveProducts();
            saveCustomers();
            loadAllData();
            clearCart();
            clearSelectedCustomer();
            updateDashboard();
            
            showNotification('تم إتمام البيع بنجاح', 'success');
            printReceipt(sale);
        }

        // طباعة الإيصال
        function printReceipt(sale) {
            const receiptWindow = window.open('', '_blank');
            const receiptHTML = `
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>إيصال البيع</title>
                    <style>
                        body { font-family: Arial; text-align: center; }
                        .receipt { max-width: 300px; margin: auto; }
                        .header { border-bottom: 1px solid #000; padding-bottom: 10px; }
                        .items { margin: 20px 0; }
                        .total { border-top: 1px solid #000; padding-top: 10px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="header">
                            <h2>${settings.storeName || 'متجري'}</h2>
                            <p>التاريخ: ${new Date(sale.date).toLocaleDateString('ar-IQ')}</p>
                            <p>رقم الفاتورة: ${sale.id}</p>
                            <p>العميل: ${sale.customerName}</p>
                        </div>
                        <div class="items">
                            ${sale.items.map(item => `
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${item.name} × ${item.quantity}</span>
                                    <span>${formatCurrency(item.price * item.quantity)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="total">
                            <div style="display: flex; justify-content: space-between;">
                                <span>المجموع:</span>
                                <span>${formatCurrency(sale.total)}</span>
                            </div>
                        </div>
                        <p>شكراً لتسوقكم معنا</p>
                    </div>
                </body>
                </html>
            `;
            receiptWindow.document.write(receiptHTML);
            receiptWindow.document.close();
            receiptWindow.print();
        }

        // مساعدات ووظائف عامة
        function formatCurrency(amount) {
            const currency = settings.currency || 'IQD';
            const symbol = currency === 'IQD' ? 'د.ع' : 
                          currency === 'USD' ? '$' : 
                          currency === 'EUR' ? '€' : 'د.ع';
            return `${amount.toLocaleString()} ${symbol}`;
        }

        function generateBarcode() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.background = 
                type === 'success' ? '#27ae60' : 
                type === 'error' ? '#e74c3c' : 
                type === 'warning' ? '#f39c12' : '#3498db';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // حفظ البيانات
        function saveProducts() {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function saveCustomers() {
            localStorage.setItem('customers', JSON.stringify(customers));
        }

        function saveSuppliers() {
            localStorage.setItem('suppliers', JSON.stringify(suppliers));
        }

        function saveSettings() {
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        // تحميل الفئات
        function loadCategories() {
            const categorySelects = ['mainCategory', 'categoryFilter', 'categoryFilterProducts'];
            categorySelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    Object.keys(categoryStructure).forEach(key => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = categoryStructure[key].name;
                        select.appendChild(option);
                    });
                }
            });
        }

        // تحديث الفئات الفرعية
        function updateSubCategories() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategorySelect = document.getElementById('subCategory');
            
            subCategorySelect.innerHTML = '<option value="">اختر الفئة الفرعية</option>';
            
            if (mainCategory && categoryStructure[mainCategory]) {
                categoryStructure[mainCategory].subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subCategorySelect.appendChild(option);
                });
            }
        }

        // تطبيق الإعدادات
        function applySettings() {
            const savedSettings = localStorage.getItem('settings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
                
                // تطبيق الإعدادات على النماذج
                Object.keys(settings).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = settings[key];
                    }
                });
            }
        }

        // المزيد من الوظائف ستتم إضافتها حسب الحاجة...

        // أحداث إغلاق النوافذ المنبثقة
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // حساب هامش الربح
        function calculateProfitMargin() {
            const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            
            if (costPrice > 0) {
                const margin = ((salePrice - costPrice) / costPrice) * 100;
                document.getElementById('profitMargin').value = margin.toFixed(2);
            }
        }

        // تغيير الكمية في العربة
        function changeQuantity(index, change) {
            const item = cart[index];
            const newQuantity = item.quantity + change;
            
            if (newQuantity <= 0) {
                removeFromCart(index);
                return;
            }
            
            if (newQuantity > item.maxStock) {
                showNotification('الكمية المطلوبة غير متوفرة في المخزون', 'error');
                return;
            }
            
            item.quantity = newQuantity;
            updateCartDisplay();
        }

        // حذف من العربة
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
        }

        // مسح العربة
        function clearCart() {
            cart = [];
            updateCartDisplay();
        }

        // تحديث خصم العنصر
        function updateItemDiscount(index, discount) {
            cart[index].discount = parseFloat(discount) || 0;
            updateCartDisplay();
        }

        // مسح نماذج الإدخال
        function clearProductForm() {
            const form = document.querySelector('#products');
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'number') {
                    input.value = '0';
                } else {
                    input.value = '';
                }
            });
        }

        function clearCustomerForm() {
            const form = document.querySelector('#customers');
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => input.value = '');
        }

        function clearSupplierForm() {
            const form = document.querySelector('#suppliers');
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => input.value = '');
        }

        // البحث في المنتجات
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const productCards = document.querySelectorAll('.product-card');
            
            productCards.forEach(card => {
                const productName = card.querySelector('h4').textContent.toLowerCase();
                const isVisible = productName.includes(searchTerm) || searchTerm === '';
                card.style.display = isVisible ? 'block' : 'none';
            });
        }

        // فلترة المنتجات حسب الفئة
        function filterProductsByCategory() {
            const category = document.getElementById('categoryFilter').value;
            loadProductsForPOS();
        }

        // فلترة المنتجات حسب السعر
        function filterProductsByPrice() {
            const priceRange = document.getElementById('priceRange').value;
            const productCards = document.querySelectorAll('.product-card');
            
            productCards.forEach(card => {
                const priceText = card.querySelector('.currency').textContent;
                const price = parseFloat(priceText.replace(/[^\d.]/g, ''));
                let show = true;

                if (priceRange) {
                    if (priceRange === '0-50000') show = price < 50000;
                    else if (priceRange === '50000-200000') show = price >= 50000 && price <= 200000;
                    else if (priceRange === '200000-500000') show = price >= 200000 && price <= 500000;
                    else if (priceRange === '500000+') show = price > 500000;
                }

                card.style.display = show ? 'block' : 'none';
            });
        }

        // فلترة المنتجات حسب المخزون
        function filterProductsByStock() {
            const stockFilter = document.getElementById('stockFilter').value;
            const productCards = document.querySelectorAll('.product-card');
            
            productCards.forEach(card => {
                const statusBadge = card.querySelector('.status-badge');
                let show = true;

                if (stockFilter === 'available') {
                    show = statusBadge.classList.contains('status-active');
                } else if (stockFilter === 'low') {
                    show = statusBadge.classList.contains('status-low-stock');
                } else if (stockFilter === 'out') {
                    show = statusBadge.classList.contains('status-cancelled');
                }

                card.style.display = show ? 'block' : 'none';
            });
        }

        // تحميل جدول المنتجات
        function loadProductsTable() {
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';
            
            products.forEach(product => {
                const row = tbody.insertRow();
                const stockStatus = product.movingStock <= 0 ? 'نفذ' : 
                                  product.movingStock <= (product.minStock || 5) ? 'منخفض' : 'متوفر';
                
                const stockClass = product.movingStock <= 0 ? 'status-cancelled' : 
                                 product.movingStock <= (product.minStock || 5) ? 'status-low-stock' : 'status-active';

                row.innerHTML = `
                    <td><input type="checkbox" class="product-checkbox" value="${product.id}"></td>
                    <td>📦</td>
                    <td>${product.name}</td>
                    <td>${product.barcode || 'غير محدد'}</td>
                    <td>${categoryStructure[product.mainCategory]?.name || product.mainCategory || 'غير محدد'}</td>
                    <td class="currency">${formatCurrency(product.costPrice || 0)}</td>
                    <td class="currency">${formatCurrency(product.salePrice)}</td>
                    <td>${product.fixedStock}</td>
                    <td class="${product.movingStock <= (product.minStock || 5) ? 'low-stock' : ''}">${product.movingStock}</td>
                    <td><span class="status-badge ${stockClass}">${stockStatus}</span></td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editProduct(${product.id})" title="تعديل">✏️</button>
                        <button class="btn btn-info btn-sm" onclick="duplicateProduct(${product.id})" title="نسخ">📋</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})" title="حذف">🗑️</button>
                    </td>
                `;
            });
        }

        // تحميل جدول العملاء
        function loadCustomersTable() {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';
            
            customers.forEach(customer => {
                const row = tbody.insertRow();
                const lastVisit = customer.lastVisit ? 
                    new Date(customer.lastVisit).toLocaleDateString('ar-IQ') : 'لم يزر بعد';
                
                const customerType = customer.type === 'vip' ? 'مميز' : 
                                   customer.type === 'wholesale' ? 'تاجر جملة' : 'عادي';

                row.innerHTML = `
                    <td>${customer.fullName}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email || 'غير محدد'}</td>
                    <td><span class="badge badge-${customer.type === 'vip' ? 'warning' : customer.type === 'wholesale' ? 'info' : 'primary'}">${customerType}</span></td>
                    <td>${customer.loyaltyPoints || 0}</td>
                    <td class="currency">${formatCurrency(customer.totalPurchases || 0)}</td>
                    <td>${lastVisit}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editCustomer(${customer.id})" title="تعديل">✏️</button>
                        <button class="btn btn-info btn-sm" onclick="viewCustomerHistory(${customer.id})" title="السجل">📊</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${customer.id})" title="حذف">🗑️</button>
                    </td>
                `;
            });
        }

        // تحميل جدول الموردين
        function loadSuppliersTable() {
            const tbody = document.getElementById('suppliersTableBody');
            tbody.innerHTML = '';
            
            suppliers.forEach(supplier => {
                const row = tbody.insertRow();
                const stars = '⭐'.repeat(supplier.rating);
                const lastOrder = supplier.lastOrder ? 
                    new Date(supplier.lastOrder).toLocaleDateString('ar-IQ') : 'لا توجد طلبيات';

                row.innerHTML = `
                    <td>${supplier.company}</td>
                    <td>${supplier.contact || 'غير محدد'}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.email || 'غير محدد'}</td>
                    <td>${stars}</td>
                    <td>${lastOrder}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editSupplier(${supplier.id})" title="تعديل">✏️</button>
                        <button class="btn btn-info btn-sm" onclick="createPurchaseOrder(${supplier.id})" title="طلبية جديدة">📋</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSupplier(${supplier.id})" title="حذف">🗑️</button>
                    </td>
                `;
            });
        }

        // فتح نافذة اختيار العميل
        function openCustomerModal() {
            document.getElementById('customerModal').style.display = 'block';
            loadCustomersList();
        }

        // تحميل قائمة العملاء في النافذة المنبثقة
        function loadCustomersList() {
            const customersList = document.getElementById('customersList');
            customersList.innerHTML = '';
            
            customers.forEach(customer => {
                const customerCard = document.createElement('div');
                customerCard.className = 'product-card';
                customerCard.onclick = () => selectCustomer(customer);
                customerCard.innerHTML = `
                    <h4>${customer.fullName}</h4>
                    <p>📞 ${customer.phone}</p>
                    <p>🏷️ ${customer.type === 'vip' ? 'مميز' : customer.type === 'wholesale' ? 'تاجر جملة' : 'عادي'}</p>
                    <p>⭐ نقاط الولاء: ${customer.loyaltyPoints || 0}</p>
                `;
                customersList.appendChild(customerCard);
            });
        }

        // اختيار عميل
        function selectCustomer(customer) {
            selectedCustomer = customer;
            document.getElementById('selectedCustomer').style.display = 'block';
            document.getElementById('customerName').textContent = customer.fullName;
            closeModal('customerModal');
            showNotification(`تم اختيار العميل: ${customer.fullName}`, 'success');
        }

        // مسح العميل المحدد
        function clearSelectedCustomer() {
            selectedCustomer = null;
            document.getElementById('selectedCustomer').style.display = 'none';
        }

        // البحث في العملاء
        function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#customersTableBody tr');
            
            rows.forEach(row => {
                const customerName = row.cells[0].textContent.toLowerCase();
                const customerPhone = row.cells[1].textContent.toLowerCase();
                const isVisible = customerName.includes(searchTerm) || customerPhone.includes(searchTerm);
                row.style.display = isVisible ? 'table-row' : 'none';
            });
        }

        // البحث في العملاء في النافذة المنبثقة
        function searchCustomersModal() {
            const searchTerm = document.getElementById('customerModalSearch').value.toLowerCase();
            const customerCards = document.querySelectorAll('#customersList .product-card');
            
            customerCards.forEach(card => {
                const customerName = card.querySelector('h4').textContent.toLowerCase();
                const isVisible = customerName.includes(searchTerm) || searchTerm === '';
                card.style.display = isVisible ? 'block' : 'none';
            });
        }

        // حفظ كعرض سعر
        function saveQuote() {
            if (cart.length === 0) {
                showNotification('العربة فارغة', 'error');
                return;
            }

            const quote = {
                id: Date.now(),
                customerId: selectedCustomer?.id || null,
                customerName: selectedCustomer?.fullName || 'عميل مجهول',
                items: [...cart],
                subtotal: getSubtotal(),
                discount: getTotalDiscount(),
                tax: getTaxAmount(),
                total: getTotalAmount(),
                status: 'pending',
                validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // صالح لمدة 30 يوم
                createdAt: new Date().toISOString()
            };

            const quotes = JSON.parse(localStorage.getItem('quotes')) || [];
            quotes.push(quote);
            localStorage.setItem('quotes', JSON.stringify(quotes));

            showNotification('تم حفظ عرض السعر بنجاح', 'success');
            clearCart();
            clearSelectedCustomer();
        }

        // عرض نافذة الأقساط
        function showInstallmentModal() {
            if (cart.length === 0) {
                showNotification('العربة فارغة', 'error');
                return;
            }

            if (!selectedCustomer) {
                showNotification('يرجى اختيار عميل أولاً', 'error');
                return;
            }

            const total = getTotalAmount();
            document.getElementById('originalAmount').value = total;
            document.getElementById('installmentModal').style.display = 'block';
            
            // ملء نافذة الأقساط
            const modalContent = document.querySelector('#installmentModal .modal-content');
            modalContent.innerHTML = `
                <span class="close" onclick="closeModal('installmentModal')">&times;</span>
                <h2>💳 بيع بالأقساط</h2>
                
                <div class="card">
                    <h3>معلومات العميل</h3>
                    <p><strong>الاسم:</strong> ${selectedCustomer.fullName}</p>
                    <p><strong>الهاتف:</strong> ${selectedCustomer.phone}</p>
                    <p><strong>النوع:</strong> ${selectedCustomer.type === 'vip' ? 'مميز' : 'عادي'}</p>
                </div>

                <div class="grid">
                    <div class="form-group">
                        <label>المبلغ الأصلي</label>
                        <input type="number" id="originalAmount" value="${total}" readonly>
                    </div>
                    <div class="form-group">
                        <label>نسبة الفائدة (%)</label>
                        <input type="number" id="interestRate" value="${settings.defaultInterestRate || 4}" 
                               min="0" max="50" step="0.1" oninput="calculateInstallments()">
                    </div>
                    <div class="form-group">
                        <label>عدد الأقساط (شهر)</label>
                        <input type="number" id="installmentCount" value="${settings.defaultInstallments || 12}" 
                               min="1" max="60" oninput="calculateInstallments()">
                    </div>
                    <div class="form-group">
                        <label>المبلغ مع الفائدة</label>
                        <input type="number" id="totalWithInterest" readonly>
                    </div>
                    <div class="form-group">
                        <label>قيمة القسط الشهري</label>
                        <input type="number" id="monthlyPayment" readonly>
                    </div>
                    <div class="form-group">
                        <label>تاريخ أول قسط</label>
                        <input type="date" id="firstPaymentDate" value="${new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}">
                    </div>
                </div>

                <div id="installmentSchedule" class="installment-table"></div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-success btn-lg" onclick="createInstallmentSale()">💾 إتمام البيع بالأقساط</button>
                    <button class="btn btn-danger" onclick="closeModal('installmentModal')">❌ إلغاء</button>
                </div>
            `;

            calculateInstallments();
        }

        // حساب الأقساط
        function calculateInstallments() {
            const originalAmount = parseFloat(document.getElementById('originalAmount').value) || 0;
            const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
            const installmentCount = parseInt(document.getElementById('installmentCount').value) || 1;

            const totalWithInterest = originalAmount + (originalAmount * interestRate / 100);
            const monthlyPayment = totalWithInterest / installmentCount;

            document.getElementById('totalWithInterest').value = totalWithInterest.toFixed(2);
            document.getElementById('monthlyPayment').value = monthlyPayment.toFixed(2);

            displayInstallmentSchedule(totalWithInterest, monthlyPayment, installmentCount);
        }

        // عرض جدولة الأقساط
        function displayInstallmentSchedule(totalAmount, monthlyPayment, count) {
            const scheduleDiv = document.getElementById('installmentSchedule');
            const firstPaymentDate = new Date(document.getElementById('firstPaymentDate').value || Date.now());
            
            let scheduleHTML = `
                <h4>📅 جدولة الأقساط:</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>القسط</th>
                                <th>تاريخ الاستحقاق</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            for (let i = 1; i <= count; i++) {
                const dueDate = new Date(firstPaymentDate);
                dueDate.setMonth(dueDate.getMonth() + i - 1);
                
                scheduleHTML += `
                    <tr>
                        <td>${i}</td>
                        <td>${dueDate.toLocaleDateString('ar-IQ')}</td>
                        <td class="currency">${formatCurrency(monthlyPayment)}</td>
                        <td><span class="status-badge status-pending">معلق</span></td>
                    </tr>
                `;
            }

            scheduleHTML += '</tbody></table></div>';
            scheduleDiv.innerHTML = scheduleHTML;
        }

        // إنشاء بيع بالأقساط
        function createInstallmentSale() {
            const originalAmount = parseFloat(document.getElementById('originalAmount').value);
            const interestRate = parseFloat(document.getElementById('interestRate').value);
            const installmentCount = parseInt(document.getElementById('installmentCount').value);
            const totalWithInterest = parseFloat(document.getElementById('totalWithInterest').value);
            const monthlyPayment = parseFloat(document.getElementById('monthlyPayment').value);
            const firstPaymentDate = document.getElementById('firstPaymentDate').value;

            // إنشاء جدولة الأقساط
            const installments = [];
            const startDate = new Date(firstPaymentDate);
            
            for (let i = 1; i <= installmentCount; i++) {
                const dueDate = new Date(startDate);
                dueDate.setMonth(dueDate.getMonth() + i - 1);
                
                installments.push({
                    number: i,
                    amount: monthlyPayment,
                    dueDate: dueDate.toISOString(),
                    paid: false,
                    paidDate: null,
                    paidAmount: 0,
                    status: 'pending'
                });
            }

            // تحديث المخزون
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    product.movingStock -= cartItem.quantity;
                }
            });

            // تحديث بيانات العميل
            const customer = customers.find(c => c.id === selectedCustomer.id);
            if (customer) {
                customer.totalPurchases += totalWithInterest;
                customer.lastVisit = new Date().toISOString();
            }

            // حفظ بيع الأقساط
            const installmentSale = {
                id: Date.now(),
                customerId: selectedCustomer.id,
                customerName: selectedCustomer.fullName,
                customerPhone: selectedCustomer.phone,
                items: [...cart],
                originalAmount,
                interestRate,
                totalWithInterest,
                monthlyPayment,
                installmentCount,
                installments,
                totalPaid: 0,
                remainingAmount: totalWithInterest,
                createdDate: new Date().toISOString(),
                status: 'active',
                cashier: 'المدير العام'
            };

            installmentSales.push(installmentSale);
            localStorage.setItem('installmentSales', JSON.stringify(installmentSales));

            saveProducts();
            saveCustomers();
            loadAllData();
            clearCart();
            clearSelectedCustomer();
            updateDashboard();
            closeModal('installmentModal');

            showNotification('تم إنشاء بيع الأقساط بنجاح', 'success');
            printInstallmentContract(installmentSale);
        }

        // طباعة عقد الأقساط
        function printInstallmentContract(installmentSale) {
            const contractWindow = window.open('', '_blank');
            const contractHTML = `
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>عقد البيع بالأقساط</title>
                    <style>
                        body { font-family: Arial; margin: 20px; line-height: 1.6; }
                        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 20px; }
                        .content { margin: 20px 0; }
                        .signature { margin-top: 50px; display: flex; justify-content: space-between; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #000; padding: 10px; text-align: center; }
                        th { background: #f0f0f0; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>عقد البيع بالأقساط</h1>
                        <h2>${settings.storeName || 'متجري'}</h2>
                        <p>رقم العقد: ${installmentSale.id}</p>
                        <p>التاريخ: ${new Date(installmentSale.createdDate).toLocaleDateString('ar-IQ')}</p>
                    </div>
                    
                    <div class="content">
                        <h3>بيانات العميل:</h3>
                        <p><strong>الاسم:</strong> ${installmentSale.customerName}</p>
                        <p><strong>رقم الهاتف:</strong> ${installmentSale.customerPhone}</p>
                        
                        <h3>تفاصيل البيع:</h3>
                        <table>
                            <thead>
                                <tr><th>المنتج</th><th>الكمية</th><th>السعر</th><th>المجموع</th></tr>
                            </thead>
                            <tbody>
                                ${installmentSale.items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>${formatCurrency(item.price)}</td>
                                        <td>${formatCurrency(item.price * item.quantity)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <p><strong>المبلغ الأصلي:</strong> ${formatCurrency(installmentSale.originalAmount)}</p>
                        <p><strong>نسبة الفائدة:</strong> ${installmentSale.interestRate}%</p>
                        <p><strong>المبلغ الإجمالي:</strong> ${formatCurrency(installmentSale.totalWithInterest)}</p>
                        <p><strong>عدد الأقساط:</strong> ${installmentSale.installmentCount} قسط</p>
                        <p><strong>قيمة القسط الشهري:</strong> ${formatCurrency(installmentSale.monthlyPayment)}</p>
                        
                        <h3>جدولة الأقساط:</h3>
                        <table>
                            <thead>
                                <tr><th>رقم القسط</th><th>تاريخ الاستحقاق</th><th>المبلغ</th></tr>
                            </thead>
                            <tbody>
                                ${installmentSale.installments.map(inst => `
                                    <tr>
                                        <td>${inst.number}</td>
                                        <td>${new Date(inst.dueDate).toLocaleDateString('ar-IQ')}</td>
                                        <td>${formatCurrency(inst.amount)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="signature">
                        <div>
                            <p>توقيع العميل</p>
                            <p>_________________</p>
                        </div>
                        <div>
                            <p>توقيع المتجر</p>
                            <p>_________________</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            contractWindow.document.write(contractHTML);
            contractWindow.document.close();
            contractWindow.print();
        }

        // حذف منتج
        function deleteProduct(productId) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                products = products.filter(p => p.id !== productId);
                saveProducts();
                loadAllData();
                updateDashboard();
                showNotification('تم حذف المنتج بنجاح', 'success');
            }
        }

        // حذف عميل
        function deleteCustomer(customerId) {
            if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                customers = customers.filter(c => c.id !== customerId);
                saveCustomers();
                loadCustomersTable();
                updateDashboard();
                showNotification('تم حذف العميل بنجاح', 'success');
            }
        }

        // حذف مورد
        function deleteSupplier(supplierId) {
            if (confirm('هل أنت متأكد من حذف هذا المورد؟')) {
                suppliers = suppliers.filter(s => s.id !== supplierId);
                saveSuppliers();
                loadSuppliersTable();
                showNotification('تم حذف المورد بنجاح', 'success');
            }
        }

        // نسخ منتج
        function duplicateProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                const newProduct = {
                    ...product,
                    id: Date.now(),
                    name: product.name + ' (نسخة)',
                    barcode: generateBarcode(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                products.push(newProduct);
                saveProducts();
                loadProductsTable();
                showNotification('تم نسخ المنتج بنجاح', 'success');
            }
        }

        // تحديث إعدادات المتجر
        function updateStoreSettings() {
            currentStoreType = document.getElementById('storeType').value;
            loadProductsForPOS();
        }

        // تبديل جميع صناديق الاختيار
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // تبديل الأكورديون
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const isActive = content.classList.contains('active');
            
            // إغلاق جميع الأكورديونات
            document.querySelectorAll('.accordion-content').forEach(acc => {
                acc.classList.remove('active');
            });
            
            // فتح الأكورديون المحدد إذا لم يكن مفتوحاً
            if (!isActive) {
                content.classList.add('active');
            }
        }

        // عرض تبويبات الإعدادات
        function showSettingsTab(tabName) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.settings-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // إزالة التحديد من جميع الأزرار
            document.querySelectorAll('.tab-secondary').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // عرض المحتوى المحدد
            document.getElementById(tabName + '-settings').classList.add('active');
            event.target.classList.add('active');
        }

        // عرض الإجراءات السريعة
        function showQuickActions() {
            const actions = [
                'إضافة منتج سريع',
                'بحث في المخزون',
                'عرض المبيعات اليومية',
                'إنشاء تقرير سريع',
                'نسخ احتياطية',
                'إعدادات سريعة'
            ];
            
            const actionsList = actions.map(action => `<li onclick="executeQuickAction('${action}')">${action}</li>`).join('');
            
            showNotification(`
                <div style="background: white; color: black; padding: 15px; border-radius: 10px; max-width: 300px;">
                    <h4>الإجراءات السريعة</h4>
                    <ul style="list-style: none; padding: 0;">
                        ${actionsList}
                    </ul>
                </div>
            `, 'info');
        }

        // تنفيذ إجراء سريع
        function executeQuickAction(action) {
            switch(action) {
                case 'إضافة منتج سريع':
                    showTab('products');
                    break;
                case 'بحث في المخزون':
                    showTab('inventory');
                    break;
                case 'عرض المبيعات اليومية':
                    showTab('sales');
                    break;
                case 'إنشاء تقرير سريع':
                    generateQuickReport();
                    break;
                case 'نسخ احتياطية':
                    createBackup();
                    break;
                case 'إعدادات سريعة':
                    showTab('settings');
                    break;
            }
        }

        // إنشاء تقرير سريع
        function generateQuickReport() {
            const today = new Date().toDateString();
            const todaySales = sales.filter(sale => new Date(sale.date).toDateString() === today);
            const todayRevenue = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const lowStockProducts = products.filter(p => p.movingStock <= (p.minStock || 5));
            
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>التقرير السريع</title>
                    <style>
                        body { font-family: Arial; margin: 20px; }
                        .stat { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    <h1>التقرير السريع - ${new Date().toLocaleDateString('ar-IQ')}</h1>
                    <div class="stat">
                        <h3>مبيعات اليوم: ${formatCurrency(todayRevenue)}</h3>
                        <p>عدد المعاملات: ${todaySales.length}</p>
                    </div>
                    <div class="stat">
                        <h3>إجمالي المنتجات: ${products.length}</h3>
                        <p>منتجات بمخزون منخفض: ${lowStockProducts.length}</p>
                    </div>
                    <div class="stat">
                        <h3>العملاء: ${customers.length}</h3>
                        <p>أقساط نشطة: ${installmentSales.filter(s => s.status === 'active').length}</p>
                    </div>
                </body>
                </html>
            `);
            reportWindow.document.close();
            reportWindow.print();
        }

        // إنشاء نسخة احتياطية
        function createBackup() {
            const backupData = {
                products,
                customers,
                suppliers,
                sales,
                installmentSales,
                returns,
                expenses,
                settings,
                timestamp: new Date().toISOString(),
                version: '2.0'
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('تم إنشاء النسخة الاحتياطية بنجاح', 'success');
        }

        // الحصول على المجاميع
        function getSubtotal() {
            return cart.reduce((sum, item) => sum + (item.price * item.quantity * (1 - item.discount / 100)), 0);
        }

        function getTotalDiscount() {
            const subtotal = getSubtotal();
            const discountRate = parseFloat(document.getElementById('totalDiscount').value) || 0;
            return subtotal * (discountRate / 100);
        }

        function getTaxAmount() {
            const afterDiscount = getSubtotal() - getTotalDiscount();
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            return afterDiscount * (taxRate / 100);
        }

        function getTotalAmount() {
            return getSubtotal() - getTotalDiscount() + getTaxAmount();
        }

        // حفظ الإعدادات تلقائياً عند التغيير
        document.addEventListener('change', function(e) {
            if (e.target.closest('#settings')) {
                const setting = e.target.id;
                const value = e.target.value;
                settings[setting] = value;
                saveSettings();
                showNotification('تم حفظ الإعدادات', 'success');
            }
        });

        // إضافة أحداث لوحة المفاتيح للإجراءات السريعة
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case 'n': // Ctrl+N لإضافة منتج جديد
                        e.preventDefault();
                        showTab('products');
                        break;
                    case 's': // Ctrl+S للحفظ السريع
                        e.preventDefault();
                        createBackup();
                        break;
                    case 'f': // Ctrl+F للبحث
                        e.preventDefault();
                        document.getElementById('productSearch').focus();
                        break;
                }
            }
        });

    </script>
</body>
</html>
