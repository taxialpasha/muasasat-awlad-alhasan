<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الكاشير المتكامل المتطور</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --info-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --border-radius: 15px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --gradient-success: linear-gradient(135deg, #56ab2f, #a8e6cf);
            --gradient-warning: linear-gradient(135deg, #f7971e, #ffd200);
            --gradient-error: linear-gradient(135deg, #ff416c, #ff4b2b);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: var(--dark-color);
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(20px);
            overflow: hidden;
        }

        .top-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .top-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .live-time {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            font-weight: bold;
        }

        .nav-container {
            background: white;
            padding: 0 20px;
            border-bottom: 1px solid #e1e8ed;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            padding: 15px 0;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 12px 20px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .tab-btn:hover::before {
            left: 100%;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .tab-btn.active {
            background: var(--gradient-success);
            transform: translateY(-2px);
        }

        .content-container {
            padding: 20px;
            min-height: calc(100vh - 300px);
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--gradient-primary);
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .stat-change {
            font-size: 0.9em;
            margin-top: 5px;
            opacity: 0.8;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            border: 1px solid #e1e8ed;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e8ed;
        }

        .card-title {
            font-size: 1.4em;
            font-weight: bold;
            color: var(--dark-color);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .form-section {
            background: #f8f9fb;
            padding: 20px;
            border-radius: var(--border-radius);
            border: 1px solid #e1e8ed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--dark-color);
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 14px;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }

        .btn-danger {
            background: var(--gradient-error);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #5dade2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 15px 30px;
            font-size: 16px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        th, td {
            padding: 15px 12px;
            text-align: right;
            border-bottom: 1px solid #e1e8ed;
            font-size: 14px;
        }

        th {
            background: var(--gradient-primary);
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        tr:nth-child(even) {
            background: rgba(248, 249, 251, 0.5);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 25px;
            border-radius: var(--border-radius);
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: var(--error-color);
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 18px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .product-card {
            border: 2px solid #e1e8ed;
            border-radius: var(--border-radius);
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .product-card:hover::before {
            left: 100%;
        }

        .product-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .product-card.selected {
            border-color: var(--success-color);
            background: rgba(39, 174, 96, 0.05);
        }

        .product-image {
            width: 100%;
            height: 100px;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            color: var(--primary-color);
        }

        .product-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .product-info h4 {
            margin-bottom: 8px;
            font-size: 16px;
            line-height: 1.3;
        }

        .product-info p {
            margin: 3px 0;
            font-size: 13px;
        }

        .product-price {
            color: var(--success-color);
            font-weight: bold;
            margin-top: 5px;
            font-size: 16px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            margin-top: 5px;
        }

        .status-active { background: var(--success-color); color: white; }
        .status-pending { background: var(--warning-color); color: white; }
        .status-completed { background: var(--info-color); color: white; }
        .status-cancelled { background: var(--error-color); color: white; }
        .status-low-stock { background: var(--warning-color); color: white; animation: pulse 2s infinite; }
        .status-out-of-stock { background: var(--error-color); color: white; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .currency {
            color: var(--success-color);
            font-weight: bold;
        }

        .progress-container {
            background: #e1e8ed;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin-top: 10px;
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-success);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .tabs-secondary {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid #e1e8ed;
            margin-bottom: 20px;
        }

        .tab-secondary {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            color: #666;
        }

        .tab-secondary.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .analytics-chart {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .filter-section {
            background: #f8f9fb;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #e1e8ed;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1500;
            overflow-y: auto;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .sidebar-content {
            padding: 20px;
        }

        .floating-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        .accordion {
            border: 1px solid #e1e8ed;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .accordion-header {
            background: #f8f9fb;
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            border-bottom: 1px solid #e1e8ed;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .accordion-header:hover {
            background: #e9ecef;
        }

        .accordion-header:after {
            content: '+';
            font-size: 20px;
        }

        .accordion-header.active:after {
            content: '-';
        }

        .accordion-content {
            padding: 20px;
            display: none;
            border-bottom: 1px solid #e1e8ed;
        }

        .accordion-content.active {
            display: block;
        }

        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: center;
        }

        .cart-quantity {
            display: inline-block;
            min-width: 30px;
            text-align: center;
        }

        .cart-summary {
            background: #f8f9fb;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 15px 0;
        }

        .cart-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.2em;
            font-weight: bold;
            border-top: 2px solid #e1e8ed;
            padding-top: 10px;
            margin-top: 10px;
        }

        .customer-info {
            background: var(--info-color);
            color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: bold;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .badge-primary { background: var(--primary-color); color: white; }
        .badge-success { background: var(--success-color); color: white; }
        .badge-warning { background: var(--warning-color); color: white; }
        .badge-danger { background: var(--error-color); color: white; }
        .badge-info { background: var(--info-color); color: white; }

        .product-actions {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 5px;
                border-radius: 10px;
            }
            
            .content-container {
                padding: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tab-btn {
                margin: 2px 0;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .modal-content {
                width: 98%;
                margin: 2% auto;
            }
            
            .user-info,
            .live-time {
                position: static;
                display: inline-block;
                margin: 5px;
            }
            
            .top-header {
                text-align: center;
                padding: 10px;
            }
            
            .top-header h1 {
                font-size: 1.8em;
            }
            
            .sidebar {
                width: 100%;
                right: -100%;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-color);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        .required-field::after {
            content: " *";
            color: var(--error-color);
        }

        .centered-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .flex-space-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .receipt {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .receipt-items {
            margin: 20px 0;
        }

        .receipt-footer {
            text-align: center;
            border-top: 1px dashed #000;
            padding-top: 10px;
            margin-top: 10px;
        }

        .panel-tabs {
            margin-bottom: 20px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }
        
        .product-form {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- رأس الصفحة -->
        <div class="top-header">
            <div class="user-info">
                <span id="currentUser">👤 المدير العام</span>
            </div>
            <h1>🏪 نظام الكاشير المتكامل المتطور</h1>
            <div class="live-time" id="liveTime"></div>
        </div>

        <!-- شريط التنقل -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="tab-btn" id="btn-pos" onclick="showTab('pos')">💰 نقطة البيع</button>
                <button class="tab-btn" id="btn-products" onclick="showTab('products')">📦 إدارة المنتجات</button>
                <button class="tab-btn" id="btn-customers" onclick="showTab('customers')">👥 العملاء</button>
                <button class="tab-btn" id="btn-suppliers" onclick="showTab('suppliers')">🚚 الموردين</button>
                <button class="tab-btn" id="btn-installments" onclick="showTab('installments')">📅 الأقساط</button>
                <button class="tab-btn" id="btn-sales" onclick="showTab('sales')">📈 المبيعات</button>
                <button class="tab-btn" id="btn-returns" onclick="showTab('returns')">↩️ المرتجعات</button>
                <button class="tab-btn" id="btn-expenses" onclick="showTab('expenses')">💸 المصروفات</button>
                <button class="tab-btn" id="btn-reports" onclick="showTab('reports')">📋 التقارير</button>
                <button class="tab-btn" id="btn-dashboard" onclick="showTab('dashboard')">📊 لوحة التحكم</button>
                <button class="tab-btn" id="btn-settings" onclick="showTab('settings')">⚙️ الإعدادات</button>
            </div>
        </div>

        <div class="content-container">
            <!-- نقطة البيع -->
            <div id="pos" class="tab-content">
                <div class="grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🔍 البحث عن المنتجات</h3>
                        </div>
                        <div class="search-container">
                            <input type="text" id="productSearch" class="search-input" placeholder="ابحث بالاسم، الباركود، أو الفئة..." oninput="searchProducts()">
                            <span class="search-icon">🔍</span>
                        </div>

                        <div class="filter-section">
                            <div class="filter-row">
                                <div class="form-group">
                                    <label>الفئة</label>
                                    <select id="categoryFilter" onchange="filterProducts()">
                                        <option value="">جميع الفئات</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>نطاق السعر</label>
                                    <select id="priceRange" onchange="filterProducts()">
                                        <option value="">جميع الأسعار</option>
                                        <option value="0-50000">أقل من 50,000 د.ع</option>
                                        <option value="50000-200000">50,000 - 200,000 د.ع</option>
                                        <option value="200000-500000">200,000 - 500,000 د.ع</option>
                                        <option value="500000+">أكثر من 500,000 د.ع</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>الحالة</label>
                                    <select id="stockFilter" onchange="filterProducts()">
                                        <option value="">جميع المنتجات</option>
                                        <option value="available">متوفر</option>
                                        <option value="low">مخزون منخفض</option>
                                        <option value="out">غير متوفر</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="product-grid" id="productGrid">
                            <!-- سيتم ملء المنتجات هنا ديناميكيًا -->
                            <div class="centered-content">
                                <p>جاري تحميل المنتجات...</p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🛒 عربة التسوق</h3>
                            <button class="btn btn-warning btn-sm" onclick="openCustomerModal()">اختيار عميل</button>
                        </div>
                        
                        <div id="selectedCustomer" class="customer-info" style="display: none;">
                            <div>
                                <strong>العميل المحدد:</strong> <span id="customerName"></span>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="clearSelectedCustomer()">إلغاء</button>
                        </div>

                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>المنتج</th>
                                        <th>الكمية</th>
                                        <th>السعر</th>
                                        <th>الخصم</th>
                                        <th>المجموع</th>
                                        <th>حذف</th>
                                    </tr>
                                </thead>
                                <tbody id="cartItems">
                                    <tr>
                                        <td colspan="6" class="centered-content">لا توجد منتجات في العربة</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 20px;">
                            <div class="form-section">
                                <div class="form-group">
                                    <label>خصم إضافي (%)</label>
                                    <input type="number" id="totalDiscount" value="0" min="0" max="100" oninput="updateCartTotal()">
                                </div>
                                <div class="form-group">
                                    <label>الضريبة (%)</label>
                                    <input type="number" id="taxRate" value="0" min="0" max="50" oninput="updateCartTotal()">
                                </div>
                            </div>

                            <div class="cart-summary">
                                <div class="cart-row">
                                    <span>المجموع الفرعي:</span>
                                    <span id="subtotal" class="currency">0 د.ع</span>
                                </div>
                                <div class="cart-row">
                                    <span>الخصم:</span>
                                    <span id="discountAmount" class="currency">0 د.ع</span>
                                </div>
                                <div class="cart-row">
                                    <span>الضريبة:</span>
                                    <span id="taxAmount" class="currency">0 د.ع</span>
                                </div>
                                <div class="cart-total">
                                    <span>المجموع الكلي:</span>
                                    <span id="totalAmount" class="currency">0 د.ع</span>
                                </div>
                            </div>

                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-success btn-lg" onclick="processCashSale()">💰 بيع نقدي</button>
                                <button class="btn btn-warning btn-lg" onclick="showInstallmentModal()">📅 بيع بالأقساط</button>
                                <button class="btn btn-info btn-lg" onclick="saveQuote()">📄 حفظ كعرض سعر</button>
                                <button class="btn btn-danger" onclick="clearCart()">🗑️ مسح العربة</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- إدارة المنتجات -->
            <div id="products" class="tab-content">
                <div class="panel-tabs">
                    <ul class="tabs-secondary">
                        <li><button class="tab-secondary active" onclick="showProductTab('product-list')">قائمة المنتجات</button></li>
                        <li><button class="tab-secondary" onclick="showProductTab('add-product')">إضافة منتج جديد</button></li>
                    </ul>
                </div>

                <!-- قائمة المنتجات -->
                <div id="product-list" class="tab-pane active">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📋 قائمة المنتجات</h3>
                            <div class="quick-actions">
                                <button class="btn btn-success btn-sm" onclick="exportProducts()">📤 تصدير</button>
                                <button class="btn btn-info btn-sm" onclick="showImportModal()">📥 استيراد</button>
                                <button class="btn btn-primary btn-sm" onclick="showProductTab('add-product')">➕ إضافة منتج</button>
                            </div>
                        </div>

                        <div class="filter-section">
                            <div class="filter-row">
                                <div class="form-group">
                                    <label>البحث</label>
                                    <input type="text" id="productFilterInput" placeholder="ابحث في المنتجات..." oninput="filterProductsList()">
                                </div>
                                <div class="form-group">
                                    <label>الفئة</label>
                                    <select id="categoryFilterProducts" onchange="filterProductsList()">
                                        <option value="">جميع الفئات</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>الحالة</label>
                                    <select id="statusFilterProducts" onchange="filterProductsList()">
                                        <option value="">جميع الحالات</option>
                                        <option value="active">نشط</option>
                                        <option value="inactive">غير نشط</option>
                                        <option value="low-stock">مخزون منخفض</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="table-container">
                            <table id="productsTable">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                        <th>الاسم</th>
                                        <th>الباركود</th>
                                        <th>الفئة</th>
                                        <th>سعر الشراء</th>
                                        <th>سعر البيع</th>
                                        <th>المخزون</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- سيتم ملؤها ديناميكيًا -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- إضافة منتج -->
                <div id="add-product" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">➕ إضافة منتج جديد</h3>
                        </div>
                        
                        <div class="product-form">
                            <div class="accordion">
                                <div class="accordion-header active" onclick="toggleAccordion(this)">
                                    المعلومات الأساسية
                                </div>
                                <div class="accordion-content active">
                                    <div class="grid">
                                        <div class="form-group">
                                            <label class="required-field">اسم المنتج</label>
                                            <input type="text" id="productName" required>
                                        </div>
                                        <div class="form-group">
                                            <label>الباركود</label>
                                            <input type="text" id="productBarcode" placeholder="سيتم إنشاء باركود تلقائي إذا تُرك فارغاً">
                                        </div>
                                        <div class="form-group">
                                            <label class="required-field">الفئة الرئيسية</label>
                                            <select id="mainCategory" onchange="updateSubCategories()" required>
                                                <option value="">اختر الفئة</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>الفئة الفرعية</label>
                                            <select id="subCategory">
                                                <option value="">اختر الفئة الفرعية</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion">
                                <div class="accordion-header active" onclick="toggleAccordion(this)">
                                    التسعير والمخزون
                                </div>
                                <div class="accordion-content active">
                                    <div class="grid">
                                        <div class="form-group">
                                            <label class="required-field">سعر الشراء</label>
                                            <input type="number" id="costPrice" oninput="calculateProfitMargin()" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="required-field">سعر البيع</label>
                                            <input type="number" id="salePrice" oninput="calculateProfitMargin()" required>
                                        </div>
                                        <div class="form-group">
                                            <label>هامش الربح (%)</label>
                                            <input type="number" id="profitMargin" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label>الحد الأدنى للسعر</label>
                                            <input type="number" id="minPrice" value="0">
                                        </div>
                                        <div class="form-group">
                                            <label class="required-field">المخزون</label>
                                            <input type="number" id="productStock" required value="0">
                                        </div>
                                        <div class="form-group">
                                            <label>الحد الأدنى للمخزون</label>
                                            <input type="number" id="minStock" value="5">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion">
                                <div class="accordion-header" onclick="toggleAccordion(this)">
                                    معلومات إضافية (اختياري)
                                </div>
                                <div class="accordion-content">
                                    <div class="grid">
                                        <div class="form-group">
                                            <label>العلامة التجارية</label>
                                            <input type="text" id="productBrand">
                                        </div>
                                        <div class="form-group">
                                            <label>الموديل</label>
                                            <input type="text" id="productModel">
                                        </div>
                                        <div class="form-group">
                                            <label>رقم المورد</label>
                                            <select id="supplierId">
                                                <option value="">اختر المورد</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>تاريخ الانتهاء</label>
                                            <input type="date" id="expiryDate">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>وصف المنتج</label>
                                        <textarea id="productDescription" rows="3"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>ملاحظات</label>
                                        <textarea id="productNotes" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions" style="margin-top: 20px;">
                                <button class="btn btn-primary btn-lg" onclick="addProduct()">💾 حفظ المنتج</button>
                                <button class="btn btn-danger" onclick="clearProductForm()">🗑️ مسح النموذج</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- العملاء -->
            <div id="customers" class="tab-content">
                <div class="panel-tabs">
                    <ul class="tabs-secondary">
                        <li><button class="tab-secondary active" onclick="showCustomerTab('customer-list')">قائمة العملاء</button></li>
                        <li><button class="tab-secondary" onclick="showCustomerTab('add-customer')">إضافة عميل جديد</button></li>
                    </ul>
                </div>

                <!-- قائمة العملاء -->
                <div id="customer-list" class="tab-pane active">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📋 قائمة العملاء</h3>
                            <button class="btn btn-primary btn-sm" onclick="showCustomerTab('add-customer')">➕ إضافة عميل</button>
                        </div>
                        <div class="search-container">
                            <input type="text" id="customerSearch" class="search-input" placeholder="ابحث عن عميل..." oninput="searchCustomers()">
                            <span class="search-icon">🔍</span>
                        </div>
                        <div class="table-container">
                            <table id="customersTable">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>الهاتف</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>النوع</th>
                                        <th>نقاط الولاء</th>
                                        <th>إجمالي المشتريات</th>
                                        <th>آخر زيارة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="customersTableBody">
                                    <!-- سيتم ملؤها ديناميكيًا -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- إضافة عميل -->
                <div id="add-customer" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">👤 إضافة عميل جديد</h3>
                        </div>
                        <div class="grid">
                            <div class="form-group">
                                <label class="required-field">الاسم الكامل</label>
                                <input type="text" id="customerFullName" required>
                            </div>
                            <div class="form-group">
                                <label class="required-field">رقم الهاتف</label>
                                <input type="tel" id="customerPhone" required>
                            </div>
                            <div class="form-group">
                                <label>البريد الإلكتروني</label>
                                <input type="email" id="customerEmail">
                            </div>
                            <div class="form-group">
                                <label>نوع العميل</label>
                                <select id="customerType">
                                    <option value="regular">عادي</option>
                                    <option value="vip">مميز</option>
                                    <option value="wholesale">تاجر جملة</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>العنوان</label>
                            <textarea id="customerAddress" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea id="customerNotes" rows="2"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="addCustomer()">💾 حفظ العميل</button>
                            <button class="btn btn-danger" onclick="clearCustomerForm()">🗑️ مسح النموذج</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- الموردين -->
            <div id="suppliers" class="tab-content">
                <div class="panel-tabs">
                    <ul class="tabs-secondary">
                        <li><button class="tab-secondary active" onclick="showSupplierTab('supplier-list')">قائمة الموردين</button></li>
                        <li><button class="tab-secondary" onclick="showSupplierTab('add-supplier')">إضافة مورد جديد</button></li>
                    </ul>
                </div>

                <!-- قائمة الموردين -->
                <div id="supplier-list" class="tab-pane active">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📋 قائمة الموردين</h3>
                            <button class="btn btn-primary btn-sm" onclick="showSupplierTab('add-supplier')">➕ إضافة مورد</button>
                        </div>
                        <div class="search-container">
                            <input type="text" id="supplierSearch" class="search-input" placeholder="ابحث عن مورد..." oninput="searchSuppliers()">
                            <span class="search-icon">🔍</span>
                        </div>
                        <div class="table-container">
                            <table id="suppliersTable">
                                <thead>
                                    <tr>
                                        <th>الشركة</th>
                                        <th>المسؤول</th>
                                        <th>الهاتف</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>التقييم</th>
                                        <th>آخر طلبية</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="suppliersTableBody">
                                    <!-- سيتم ملؤها ديناميكيًا -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- إضافة مورد -->
                <div id="add-supplier" class="tab-pane">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🚚 إضافة مورد جديد</h3>
                        </div>
                        <div class="grid">
                            <div class="form-group">
                                <label class="required-field">اسم الشركة</label>
                                <input type="text" id="supplierCompany" required>
                            </div>
                            <div class="form-group">
                                <label>اسم المسؤول</label>
                                <input type="text" id="supplierContact">
                            </div>
                            <div class="form-group">
                                <label class="required-field">رقم الهاتف</label>
                                <input type="tel" id="supplierPhone" required>
                            </div>
                            <div class="form-group">
                                <label>البريد الإلكتروني</label>
                                <input type="email" id="supplierEmail">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>العنوان</label>
                            <textarea id="supplierAddress" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea id="supplierNotes" rows="2"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="addSupplier()">💾 حفظ المورد</button>
                            <button class="btn btn-danger" onclick="clearSupplierForm()">🗑️ مسح النموذج</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- لوحة التحكم -->
            <div id="dashboard" class="tab-content">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="todaySales">0</div>
                        <div class="stat-label">مبيعات اليوم</div>
                        <div class="stat-change">+12% من أمس</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="monthSales">0</div>
                        <div class="stat-label">مبيعات الشهر</div>
                        <div class="stat-change">+8% من الشهر الماضي</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalProducts">0</div>
                        <div class="stat-label">إجمالي المنتجات</div>
                        <div class="stat-change">تم إضافة 5 منتجات جديدة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lowStockAlert">0</div>
                        <div class="stat-label">تنبيهات المخزون</div>
                        <div class="stat-change">يحتاج إلى تجديد</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeCustomers">0</div>
                        <div class="stat-label">العملاء النشطون</div>
                        <div class="stat-change">+15 عميل جديد</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingInstallments">0</div>
                        <div class="stat-label">أقساط معلقة</div>
                        <div class="stat-change">استحقاق هذا الأسبوع</div>
                    </div>
                </div>

                <div class="grid">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📈 الرسم البياني للمبيعات</h3>
                        </div>
                        <div class="analytics-chart">
                            <p>سيتم عرض الرسم البياني للمبيعات هنا</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🔔 التنبيهات والإشعارات</h3>
                        </div>
                        <div id="alertsList">
                            <div class="alert alert-warning">⚠️ منتج "لابتوب ديل" وصل إلى الحد الأدنى للمخزون</div>
                            <div class="alert alert-info">ℹ️ موعد استحقاق قسط العميل "أحمد محمد" غداً</div>
                            <div class="alert alert-success">✅ تم استلام شحنة جديدة من المورد "شركة التقنية"</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">🏆 أفضل المنتجات مبيعاً</h3>
                    </div>
                    <div class="table-container">
                        <table id="topProductsTable">
                            <thead>
                                <tr>
                                    <th>المنتج</th>
                                    <th>الكمية المباعة</th>
                                    <th>الإيرادات</th>
                                    <th>النسبة</th>
                                </tr>
                            </thead>
                            <tbody id="topProductsBody">
                                <!-- سيتم ملؤها ديناميكيًا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- المبيعات -->
            <div id="sales" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📊 سجل المبيعات</h3>
                    </div>
                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="form-group">
                                <label>من تاريخ</label>
                                <input type="date" id="salesFromDate">
                            </div>
                            <div class="form-group">
                                <label>إلى تاريخ</label>
                                <input type="date" id="salesToDate">
                            </div>
                            <div class="form-group">
                                <label>نوع البيع</label>
                                <select id="saleTypeFilter">
                                    <option value="">الكل</option>
                                    <option value="cash">نقدي</option>
                                    <option value="installment">أقساط</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label></label>
                                <button class="btn btn-primary" onclick="filterSales()">تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="salesTable">
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>العميل</th>
                                    <th>عدد المنتجات</th>
                                    <th>المجموع</th>
                                    <th>نوع البيع</th>
                                    <th>الكاشير</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- سيتم ملؤها ديناميكيًا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- الأقساط -->
            <div id="installments" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📅 سجل الأقساط</h3>
                    </div>
                    <div class="filter-section">
                        <div class="filter-row">
                            <div class="form-group">
                                <label>حالة القسط</label>
                                <select id="installmentStatusFilter">
                                    <option value="">الكل</option>
                                    <option value="pending">معلق</option>
                                    <option value="paid">مدفوع</option>
                                    <option value="overdue">متأخر</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>العميل</label>
                                <select id="installmentCustomerFilter">
                                    <option value="">جميع العملاء</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label></label>
                                <button class="btn btn-primary" onclick="filterInstallments()">تطبيق الفلتر</button>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="installmentsTable">
                            <thead>
                                <tr>
                                    <th>رقم العقد</th>
                                    <th>العميل</th>
                                    <th>المبلغ الكلي</th>
                                    <th>المبلغ المدفوع</th>
                                    <th>المبلغ المتبقي</th>
                                    <th>عدد الأقساط</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="installmentsTableBody">
                                <!-- سيتم ملؤها ديناميكيًا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- المرتجعات -->
            <div id="returns" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">↩️ المرتجعات</h3>
                        <button class="btn btn-warning btn-sm" onclick="showNewReturnModal()">➕ إضافة مرتجع</button>
                    </div>
                    <div class="table-container">
                        <table id="returnsTable">
                            <thead>
                                <tr>
                                    <th>رقم المرتجع</th>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>العميل</th>
                                    <th>المنتجات</th>
                                    <th>المبلغ المسترد</th>
                                    <th>سبب الإرجاع</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="returnsTableBody">
                                <!-- سيتم ملؤها ديناميكيًا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- المصروفات -->
            <div id="expenses" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">💸 المصروفات</h3>
                        <button class="btn btn-warning btn-sm" onclick="showNewExpenseModal()">➕ إضافة مصروف</button>
                    </div>
                    <div class="table-container">
                        <table id="expensesTable">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>الوصف</th>
                                    <th>الفئة</th>
                                    <th>المبلغ</th>
                                    <th>ملاحظات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody">
                                <!-- سيتم ملؤها ديناميكيًا -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- التقارير -->
            <div id="reports" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">📋 التقارير</h3>
                    </div>
                    <div class="grid">
                        <div class="card">
                            <h3>📊 تقرير المبيعات</h3>
                            <p>عرض تقارير المبيعات حسب الفترة المحددة</p>
                            <button class="btn btn-primary" onclick="generateSalesReport()">إنشاء التقرير</button>
                        </div>
                        <div class="card">
                            <h3>📦 تقرير المخزون</h3>
                            <p>عرض حالة المخزون والمنتجات المنخفضة</p>
                            <button class="btn btn-primary" onclick="generateInventoryReport()">إنشاء التقرير</button>
                        </div>
                        <div class="card">
                            <h3>💰 تقرير الأرباح</h3>
                            <p>عرض تقرير الأرباح والخسائر</p>
                            <button class="btn btn-primary" onclick="generateProfitReport()">إنشاء التقرير</button>
                        </div>
                        <div class="card">
                            <h3>👥 تقرير العملاء</h3>
                            <p>عرض تقرير العملاء الأكثر شراءً</p>
                            <button class="btn btn-primary" onclick="generateCustomerReport()">إنشاء التقرير</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- الإعدادات -->
            <div id="settings" class="tab-content">
                <div class="tabs-secondary">
                    <button class="tab-secondary active" onclick="showSettingsTab('general')">عام</button>
                    <button class="tab-secondary" onclick="showSettingsTab('pos')">نقطة البيع</button>
                    <button class="tab-secondary" onclick="showSettingsTab('backup')">النسخ الاحتياطي</button>
                </div>

                <!-- الإعدادات العامة -->
                <div id="general-settings" class="settings-content active">
                    <div class="grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">🏪 معلومات المتجر</h3>
                            </div>
                            <div class="form-group">
                                <label>اسم المتجر</label>
                                <input type="text" id="storeName" value="متجري">
                            </div>
                            <div class="form-group">
                                <label>العنوان</label>
                                <textarea id="storeAddress" rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label>رقم الهاتف</label>
                                <input type="tel" id="storePhone">
                            </div>
                            <div class="form-group">
                                <label>البريد الإلكتروني</label>
                                <input type="email" id="storeEmail">
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">🌍 الإعدادات الإقليمية</h3>
                            </div>
                            <div class="form-group">
                                <label>العملة</label>
                                <select id="currency">
                                    <option value="IQD">دينار عراقي (د.ع)</option>
                                    <option value="USD">دولار أمريكي ($)</option>
                                    <option value="EUR">يورو (€)</option>
                                    <option value="SAR">ريال سعودي (ر.س)</option>
                                    <option value="AED">درهم إماراتي (د.إ)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>اللغة</label>
                                <select id="language">
                                    <option value="ar">العربية</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>تنسيق التاريخ</label>
                                <select id="dateFormat">
                                    <option value="DD/MM/YYYY">يوم/شهر/سنة</option>
                                    <option value="MM/DD/YYYY">شهر/يوم/سنة</option>
                                    <option value="YYYY-MM-DD">سنة-شهر-يوم</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="saveSettings()">حفظ الإعدادات</button>
                        </div>
                    </div>
                </div>

                <!-- إعدادات نقطة البيع -->
                <div id="pos-settings" class="settings-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">💰 إعدادات نقطة البيع</h3>
                        </div>
                        <div class="grid">
                            <div class="form-group">
                                <label>الضريبة الافتراضية (%)</label>
                                <input type="number" id="defaultTaxRate" value="0" min="0" max="50">
                            </div>
                            <div class="form-group">
                                <label>نسبة الفائدة الافتراضية للأقساط (%)</label>
                                <input type="number" id="defaultInterestRate" value="5" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>عدد الأقساط الافتراضي</label>
                                <input type="number" id="defaultInstallments" value="12" min="1" max="60">
                            </div>
                            <div class="form-group">
                                <label>عرض صورة المنتج</label>
                                <select id="showProductImage">
                                    <option value="1">نعم</option>
                                    <option value="0">لا</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">حفظ الإعدادات</button>
                    </div>
                </div>

                <!-- إعدادات النسخ الاحتياطي -->
                <div id="backup-settings" class="settings-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">💾 النسخ الاحتياطي</h3>
                        </div>
                        <div class="grid">
                            <div class="card">
                                <h3>📤 إنشاء نسخة احتياطية</h3>
                                <p>قم بإنشاء وتنزيل نسخة احتياطية من جميع بيانات النظام</p>
                                <button class="btn btn-primary" onclick="createBackup()">إنشاء نسخة احتياطية</button>
                            </div>
                            <div class="card">
                                <h3>📥 استعادة من نسخة احتياطية</h3>
                                <p>استعادة البيانات من ملف نسخة احتياطية سابق</p>
                                <input type="file" id="backupFile" accept=".json" style="display: none;" onchange="restoreBackup(this)">
                                <button class="btn btn-warning" onclick="document.getElementById('backupFile').click()">اختيار ملف</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- النوافذ المنبثقة -->
    <!-- نافذة اختيار العميل -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('customerModal')">&times;</span>
            <h2>اختيار عميل</h2>
            <div class="search-container">
                <input type="text" id="customerModalSearch" class="search-input" placeholder="ابحث عن عميل..." oninput="searchCustomersModal()">
                <span class="search-icon">🔍</span>
            </div>
            <div id="customersList" style="max-height: 400px; overflow-y: auto; margin-top: 20px;">
                <!-- قائمة العملاء -->
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="showCustomerTab('add-customer'); closeModal('customerModal')">إضافة عميل جديد</button>
            </div>
        </div>
    </div>

    <!-- نافذة الأقساط -->
    <div id="installmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('installmentModal')">&times;</span>
            <h2>بيع بالأقساط</h2>
            <div id="installmentContent">
                <!-- محتوى نافذة الأقساط سيتم إضافته ديناميكيًا -->
            </div>
        </div>
    </div>
    
    <!-- نافذة عرض تفاصيل الفاتورة -->
    <div id="invoiceDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('invoiceDetailsModal')">&times;</span>
            <h2>تفاصيل الفاتورة</h2>
            <div id="invoiceContent">
                <!-- محتوى تفاصيل الفاتورة سيتم إضافته ديناميكيًا -->
            </div>
        </div>
    </div>
    
    <!-- نافذة تعديل المنتج -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editProductModal')">&times;</span>
            <h2>تعديل المنتج</h2>
            <div id="editProductContent">
                <!-- محتوى نموذج تعديل المنتج سيتم إضافته ديناميكيًا -->
            </div>
        </div>
    </div>

    <script>
        // المتغيرات العامة
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];
        let installmentSales = JSON.parse(localStorage.getItem('installmentSales')) || [];
        let returns = JSON.parse(localStorage.getItem('returns')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let cart = [];
        let selectedCustomer = null;
        let settings = JSON.parse(localStorage.getItem('settings')) || {};
        let currentEditProductId = null;

        // الفئات والفئات الفرعية
        const categoryStructure = {
            electronics: {
                name: 'إلكترونيات',
                subcategories: ['هواتف ذكية', 'أجهزة كمبيوتر', 'تلفزيونات', 'أجهزة صوت', 'كاميرات', 'إكسسوارات']
            },
            clothes: {
                name: 'ملابس',
                subcategories: ['ملابس رجالي', 'ملابس نسائي', 'ملابس أطفال', 'أحذية', 'حقائب', 'إكسسوارات']
            },
            food: {
                name: 'طعام ومشروبات',
                subcategories: ['مواد غذائية', 'مشروبات', 'حلويات', 'منتجات مجمدة', 'خضار وفواكه', 'لحوم']
            },
            health: {
                name: 'صحة وجمال',
                subcategories: ['أدوية', 'مستحضرات تجميل', 'عناية شخصية', 'فيتامينات', 'أعشاب طبية', 'أجهزة طبية']
            },
            home: {
                name: 'منزل وحديقة',
                subcategories: ['أثاث', 'أدوات منزلية', 'ديكور', 'أدوات حديقة', 'إضاءة', 'منسوجات']
            },
            sports: {
                name: 'رياضة',
                subcategories: ['ملابس رياضية', 'أجهزة تمارين', 'كرة قدم', 'كرة سلة', 'سباحة', 'رياضات أخرى']
            },
            books: {
                name: 'كتب',
                subcategories: ['كتب دينية', 'كتب علمية', 'روايات', 'كتب أطفال', 'قواميس', 'مجلات']
            },
            toys: {
                name: 'ألعاب',
                subcategories: ['ألعاب تعليمية', 'ألعاب إلكترونية', 'دمى', 'ألعاب رياضية', 'ألعاب بناء', 'ألعاب فنية']
            },
            automotive: {
                name: 'سيارات',
                subcategories: ['قطع غيار', 'زيوت ومواد التشحيم', 'إطارات', 'بطاريات', 'إكسسوارات', 'أدوات']
            },
            jewelry: {
                name: 'مجوهرات',
                subcategories: ['ذهب', 'فضة', 'ألماس', 'ساعات', 'مجوهرات مقلدة', 'هدايا']
            }
        };

        // تهيئة التطبيق عند التحميل
        window.onload = function() {
            updateLiveTime();
            setInterval(updateLiveTime, 1000);
            loadAllData();
            loadCategories();
            applySettings();
            
            // بدء التطبيق بنقطة البيع كتبويب افتراضي
            showTab('pos');
        };

        // تحديث الوقت المباشر
        function updateLiveTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ar-IQ', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('liveTime').textContent = timeString;
        }

        // تبديل التبويبات
        function showTab(tabName) {
            // إخفاء جميع التبويبات
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // إزالة التحديد من جميع الأزرار
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // عرض التبويب المحدد
            document.getElementById(tabName).classList.add('active');
            document.getElementById('btn-' + tabName).classList.add('active');

            // تحديث البيانات حسب التبويب
            switch(tabName) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'pos':
                    loadProductsForPOS();
                    updateCartDisplay();
                    break;
                case 'products':
                    loadProductsTable();
                    break;
                case 'customers':
                    loadCustomersTable();
                    break;
                case 'suppliers':
                    loadSuppliersTable();
                    break;
                case 'sales':
                    loadSalesTable();
                    break;
                case 'installments':
                    loadInstallmentsTable();
                    break;
                case 'returns':
                    loadReturnsTable();
                    break;
                case 'expenses':
                    loadExpensesTable();
                    break;
            }
        }

        // تبديل تبويبات داخلية
        function showProductTab(tabName) {
            const tabs = document.querySelectorAll('#products .tab-pane');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const buttons = document.querySelectorAll('#products .tab-secondary');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="showProductTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'product-list') {
                loadProductsTable();
            }
        }

        function showCustomerTab(tabName) {
            const tabs = document.querySelectorAll('#customers .tab-pane');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const buttons = document.querySelectorAll('#customers .tab-secondary');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="showCustomerTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'customer-list') {
                loadCustomersTable();
            }
        }

        function showSupplierTab(tabName) {
            const tabs = document.querySelectorAll('#suppliers .tab-pane');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const buttons = document.querySelectorAll('#suppliers .tab-secondary');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="showSupplierTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'supplier-list') {
                loadSuppliersTable();
            }
        }

        function showSettingsTab(tabName) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.settings-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // إزالة التحديد من جميع الأزرار
            document.querySelectorAll('.tab-secondary').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // عرض المحتوى المحدد
            document.getElementById(tabName + '-settings').classList.add('active');
            event.target.classList.add('active');
        }

        // تحميل جميع البيانات
        function loadAllData() {
            loadProductsForPOS();
            loadProductsTable();
            loadCustomersTable();
            loadSuppliersTable();
            loadSalesTable();
            loadInstallmentsTable();
            updateDashboard();
        }

        // تحديث لوحة التحكم
        function updateDashboard() {
            // حساب إحصائيات اليوم
            const today = new Date().toDateString();
            const todaySales = sales
                .filter(sale => new Date(sale.date).toDateString() === today)
                .reduce((sum, sale) => sum + sale.total, 0);

            // حساب إحصائيات الشهر
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthSales = sales
                .filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === thisMonth && saleDate.getFullYear() === thisYear;
                })
                .reduce((sum, sale) => sum + sale.total, 0);

            // تحديث الإحصائيات
            document.getElementById('todaySales').textContent = formatCurrency(todaySales);
            document.getElementById('monthSales').textContent = formatCurrency(monthSales);
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('lowStockAlert').textContent = products.filter(p => p.productStock <= (p.minStock || 5)).length;
            document.getElementById('activeCustomers').textContent = customers.length;
            document.getElementById('pendingInstallments').textContent = installmentSales.filter(s => s.status === 'active').length;
            
            // تحميل أفضل المنتجات
            loadTopProducts();
        }

        // تحميل أفضل المنتجات
        function loadTopProducts() {
            const tbody = document.getElementById('topProductsBody');
            tbody.innerHTML = '';
            
            // جمع المنتجات المباعة
            const soldProducts = {};
            sales.forEach(sale => {
                sale.items.forEach(item => {
                    if (!soldProducts[item.id]) {
                        soldProducts[item.id] = {
                            id: item.id,
                            name: item.name,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    soldProducts[item.id].quantity += item.quantity;
                    soldProducts[item.id].revenue += item.price * item.quantity * (1 - item.discount / 100);
                });
            });
            
            // تحويل إلى مصفوفة وترتيب
            const topProducts = Object.values(soldProducts)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);
            
            // حساب الإجمالي للنسب المئوية
            const totalRevenue = topProducts.reduce((sum, product) => sum + product.revenue, 0);
            
            // إضافة المنتجات إلى الجدول
            topProducts.forEach(product => {
                const percentage = totalRevenue > 0 ? (product.revenue / totalRevenue * 100).toFixed(1) : 0;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${product.quantity}</td>
                    <td class="currency">${formatCurrency(product.revenue)}</td>
                    <td>${percentage}%</td>
                `;
            });
            
            // تحميل المنتجات لنقطة البيع
function loadProductsForPOS() {
    const productGrid = document.getElementById('productGrid');
    productGrid.innerHTML = '';

    if (products.length === 0) {
        productGrid.innerHTML = '<div class="centered-content"><p>لا توجد منتجات. يرجى إضافة منتجات أولاً.</p></div>';
        return;
    }

    // فلترة المنتجات حسب البحث والفلاتر المطبقة
    let filteredProducts = filterProductsForPOS();
    
    if (filteredProducts.length === 0) {
        productGrid.innerHTML = '<div class="centered-content"><p>لا توجد نتائج للبحث.</p></div>';
        return;
    }

    // عرض المنتجات في الشبكة
    filteredProducts.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'product-card';
        productCard.onclick = () => addToCart(product);
        
        // تحديد حالة المخزون
        let stockStatus, stockClass;
        if (product.productStock <= 0) {
            stockStatus = 'نفذ المخزون';
            stockClass = 'status-out-of-stock';
        } else if (product.productStock <= (product.minStock || 5)) {
            stockStatus = 'مخزون منخفض';
            stockClass = 'status-low-stock';
        } else {
            stockStatus = 'متوفر';
            stockClass = 'status-active';
        }
        
        productCard.innerHTML = `
            <div class="product-image">📦</div>
            <div class="product-info">
                <h4>${product.name}</h4>
                <p class="product-price">${formatCurrency(product.salePrice)}</p>
                <p>المخزون: ${product.productStock}</p>
                <span class="status-badge ${stockClass}">${stockStatus}</span>
            </div>
        `;

        // تعطيل المنتج إذا كان المخزون صفر
        if (product.productStock <= 0) {
            productCard.style.opacity = '0.6';
            productCard.style.cursor = 'not-allowed';
            productCard.onclick = () => showNotification('المنتج غير متوفر في المخزون', 'error');
        }

        productGrid.appendChild(productCard);
    });
}

// فلترة المنتجات لنقطة البيع
function filterProductsForPOS() {
    const searchTerm = document.getElementById('productSearch').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const priceRange = document.getElementById('priceRange').value;
    const stockFilter = document.getElementById('stockFilter').value;
    
    return products.filter(product => {
        // فلترة حسب البحث
        const nameMatch = product.name.toLowerCase().includes(searchTerm);
        const barcodeMatch = product.barcode && product.barcode.toLowerCase().includes(searchTerm);
        const searchMatch = nameMatch || barcodeMatch;
        
        // فلترة حسب الفئة
        const categoryMatch = !categoryFilter || product.mainCategory === categoryFilter;
        
        // فلترة حسب السعر
        let priceMatch = true;
        if (priceRange) {
            const price = product.salePrice;
            if (priceRange === '0-50000') priceMatch = price < 50000;
            else if (priceRange === '50000-200000') priceMatch = price >= 50000 && price <= 200000;
            else if (priceRange === '200000-500000') priceMatch = price >= 200000 && price <= 500000;
            else if (priceRange === '500000+') priceMatch = price > 500000;
        }
        
        // فلترة حسب المخزون
        let stockMatch = true;
        if (stockFilter) {
            if (stockFilter === 'available') stockMatch = product.productStock > (product.minStock || 5);
            else if (stockFilter === 'low') stockMatch = product.productStock > 0 && product.productStock <= (product.minStock || 5);
            else if (stockFilter === 'out') stockMatch = product.productStock <= 0;
        }
        
        return searchMatch && categoryMatch && priceMatch && stockMatch;
    });
}

// البحث في المنتجات
function searchProducts() {
    loadProductsForPOS();
}

// فلترة المنتجات
function filterProducts() {
    loadProductsForPOS();
}

// إضافة منتج إلى العربة
function addToCart(product) {
    if (product.productStock <= 0) {
        showNotification('المنتج غير متوفر في المخزون', 'error');
        return;
    }

    const existingItem = cart.find(item => item.id === product.id);
    
    if (existingItem) {
        if (existingItem.quantity < product.productStock) {
            existingItem.quantity++;
            showNotification(`تم زيادة كمية ${product.name}`, 'success');
        } else {
            showNotification('الكمية المطلوبة غير متوفرة في المخزون', 'error');
            return;
        }
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.salePrice,
            quantity: 1,
            discount: 0,
            maxStock: product.productStock,
            costPrice: product.costPrice || 0
        });
        showNotification(`تم إضافة ${product.name} إلى العربة`, 'success');
    }
    
    updateCartDisplay();
}

// تحديث عرض العربة
function updateCartDisplay() {
    const tbody = document.getElementById('cartItems');
    tbody.innerHTML = '';
    
    if (cart.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="centered-content">لا توجد منتجات في العربة</td></tr>';
        updateCartTotal();
        return;
    }
    
    cart.forEach((item, index) => {
        const itemTotal = (item.price * item.quantity) * (1 - item.discount / 100);
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${item.name}</td>
            <td>
                <div class="cart-item-actions">
                    <button onclick="changeQuantity(${index}, -1)" class="btn btn-sm">-</button>
                    <span class="cart-quantity">${item.quantity}</span>
                    <button onclick="changeQuantity(${index}, 1)" class="btn btn-sm">+</button>
                </div>
            </td>
            <td class="currency">${formatCurrency(item.price)}</td>
            <td>
                <input type="number" value="${item.discount}" min="0" max="100" 
                       onchange="updateItemDiscount(${index}, this.value)"
                       style="width: 70px;">%
            </td>
            <td class="currency">${formatCurrency(itemTotal)}</td>
            <td><button onclick="removeFromCart(${index})" class="btn btn-danger btn-sm">🗑️</button></td>
        `;
    });
    
    updateCartTotal();
}

// تحديث إجمالي العربة
function updateCartTotal() {
    const subtotal = getSubtotal();
    
    const discountRate = parseFloat(document.getElementById('totalDiscount').value) || 0;
    const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
    
    const discountAmount = subtotal * (discountRate / 100);
    const afterDiscount = subtotal - discountAmount;
    const taxAmount = afterDiscount * (taxRate / 100);
    const total = afterDiscount + taxAmount;

    document.getElementById('subtotal').textContent = formatCurrency(subtotal);
    document.getElementById('discountAmount').textContent = formatCurrency(discountAmount);
    document.getElementById('taxAmount').textContent = formatCurrency(taxAmount);
    document.getElementById('totalAmount').textContent = formatCurrency(total);
}

// تغيير الكمية في العربة
function changeQuantity(index, change) {
    const item = cart[index];
    const newQuantity = item.quantity + change;
    
    if (newQuantity <= 0) {
        removeFromCart(index);
        return;
    }
    
    if (newQuantity > item.maxStock) {
        showNotification('الكمية المطلوبة غير متوفرة في المخزون', 'error');
        return;
    }
    
    item.quantity = newQuantity;
    updateCartDisplay();
    showNotification(`تم تعديل كمية ${item.name} إلى ${newQuantity}`, 'success');
}

// تحديث خصم العنصر
function updateItemDiscount(index, discount) {
    cart[index].discount = parseFloat(discount) || 0;
    updateCartDisplay();
}

// حذف من العربة
function removeFromCart(index) {
    const removedItem = cart[index];
    cart.splice(index, 1);
    updateCartDisplay();
    showNotification(`تم حذف ${removedItem.name} من العربة`, 'success');
}

// مسح العربة
function clearCart() {
    if (cart.length === 0) return;
    
    if (confirm('هل أنت متأكد من مسح جميع العناصر من العربة؟')) {
        cart = [];
        updateCartDisplay();
        showNotification('تم مسح العربة', 'success');
    }
}

// معالجة البيع النقدي
function processCashSale() {
    if (cart.length === 0) {
        showNotification('العربة فارغة', 'error');
        return;
    }

    const total = getTotalAmount();
    
    // تحديث المخزون
    const updatedProducts = [...products];
    cart.forEach(cartItem => {
        const productIndex = updatedProducts.findIndex(p => p.id === cartItem.id);
        if (productIndex !== -1) {
            updatedProducts[productIndex].productStock -= cartItem.quantity;
        }
    });

    // تحديث نقاط ولاء العميل
    if (selectedCustomer) {
        const customerIndex = customers.findIndex(c => c.id === selectedCustomer.id);
        if (customerIndex !== -1) {
            customers[customerIndex].loyaltyPoints = (customers[customerIndex].loyaltyPoints || 0) + Math.floor(total / 1000); // نقطة لكل 1000 د.ع
            customers[customerIndex].totalPurchases = (customers[customerIndex].totalPurchases || 0) + total;
            customers[customerIndex].lastVisit = new Date().toISOString();
            localStorage.setItem('customers', JSON.stringify(customers));
        }
    }

    // حساب إجمالي التكلفة للمنتجات المباعة
    const totalCost = cart.reduce((sum, item) => sum + (item.costPrice * item.quantity), 0);
    const profit = total - totalCost;

    // حفظ البيع
    const sale = {
        id: Date.now(),
        invoiceNumber: generateInvoiceNumber(),
        customerId: selectedCustomer?.id || null,
        customerName: selectedCustomer?.fullName || 'عميل مجهول',
        items: JSON.parse(JSON.stringify(cart)), // نسخة عميقة من العربة
        subtotal: getSubtotal(),
        discount: getTotalDiscount(),
        tax: getTaxAmount(),
        total: total,
        cost: totalCost,
        profit: profit,
        type: 'cash',
        date: new Date().toISOString(),
        cashier: document.getElementById('currentUser').textContent.replace('👤 ', '') || 'المدير العام'
    };

    // تحديث البيانات
    sales.push(sale);
    products = updatedProducts;
    
    // حفظ البيانات
    localStorage.setItem('sales', JSON.stringify(sales));
    localStorage.setItem('products', JSON.stringify(products));
    
    // تنظيف العربة والعميل
    clearCart();
    clearSelectedCustomer();
    
    // تحديث الواجهة
    loadProductsForPOS();
    updateDashboard();
    
    showNotification('تم إتمام البيع بنجاح', 'success');
    printReceipt(sale);
}

// طباعة الإيصال
function printReceipt(sale) {
    const receiptWindow = window.open('', '_blank');
    
    // الحصول على معلومات المتجر من الإعدادات
    const storeName = settings.storeName || 'متجري';
    const storeAddress = settings.storeAddress || '';
    const storePhone = settings.storePhone || '';
    
    const receiptHTML = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>إيصال البيع</title>
            <style>
                body { 
                    font-family: 'Courier New', monospace; 
                    width: 300px; 
                    margin: 0 auto; 
                    padding: 10px;
                }
                .receipt-header, .receipt-footer { 
                    text-align: center; 
                    margin: 10px 0; 
                    padding: 5px; 
                    border-bottom: 1px dashed #000; 
                }
                .receipt-footer { 
                    border-top: 1px dashed #000; 
                    border-bottom: none; 
                }
                .item { 
                    display: flex; 
                    justify-content: space-between; 
                    margin: 5px 0; 
                }
                .receipt-total { 
                    font-weight: bold; 
                    text-align: right; 
                    border-top: 1px dashed #000; 
                    margin-top: 10px; 
                    padding-top: 10px; 
                }
                .print-button { 
                    display: block; 
                    margin: 20px auto; 
                    padding: 10px; 
                    background: #4CAF50; 
                    color: white; 
                    border: none; 
                    border-radius: 5px; 
                    cursor: pointer; 
                }
                @media print {
                    .print-button { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="receipt">
                <div class="receipt-header">
                    <h2>${storeName}</h2>
                    ${storeAddress ? `<p>${storeAddress}</p>` : ''}
                    ${storePhone ? `<p>هاتف: ${storePhone}</p>` : ''}
                    <p>تاريخ: ${new Date(sale.date).toLocaleDateString('ar-IQ')}</p>
                    <p>الوقت: ${new Date(sale.date).toLocaleTimeString('ar-IQ')}</p>
                    <p>رقم الفاتورة: ${sale.invoiceNumber || sale.id}</p>
                    <p>العميل: ${sale.customerName}</p>
                </div>
                <div class="receipt-items">
                    ${sale.items.map(item => `
                        <div class="item">
                            <div>
                                <span>${item.name} × ${item.quantity}</span>
                                ${item.discount > 0 ? `<br><small>خصم: ${item.discount}%</small>` : ''}
                            </div>
                            <span>${formatCurrency(item.price * item.quantity * (1 - item.discount / 100))}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="receipt-total">
                    <div class="item">
                        <span>المجموع الفرعي:</span>
                        <span>${formatCurrency(sale.subtotal)}</span>
                    </div>
                    ${sale.discount > 0 ? `
                        <div class="item">
                            <span>الخصم:</span>
                            <span>${formatCurrency(sale.discount)}</span>
                        </div>
                    ` : ''}
                    ${sale.tax > 0 ? `
                        <div class="item">
                            <span>الضريبة:</span>
                            <span>${formatCurrency(sale.tax)}</span>
                        </div>
                    ` : ''}
                    <div class="item" style="font-weight: bold; font-size: 1.2em;">
                        <span>المجموع:</span>
                        <span>${formatCurrency(sale.total)}</span>
                    </div>
                </div>
                <div class="receipt-footer">
                    <p>شكراً لتسوقكم معنا</p>
                    ${settings.receiptFooter ? `<p>${settings.receiptFooter}</p>` : ''}
                </div>
            </div>
            <button class="print-button" onclick="window.print()">طباعة الإيصال</button>
        </body>
        </html>
    `;
    
    receiptWindow.document.write(receiptHTML);
    receiptWindow.document.close();
}

// عرض نافذة الأقساط
function showInstallmentModal() {
    if (cart.length === 0) {
        showNotification('العربة فارغة', 'error');
        return;
    }

    if (!selectedCustomer) {
        showNotification('يرجى اختيار عميل أولاً', 'error');
        return;
    }

    const total = getTotalAmount();
    const defaultInterestRate = settings.defaultInterestRate || 5;
    const defaultInstallments = settings.defaultInstallments || 12;
    
    // إنشاء تاريخ أول قسط (بعد شهر من اليوم)
    const firstPaymentDate = new Date();
    firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 1);
    const formattedFirstPaymentDate = firstPaymentDate.toISOString().split('T')[0];
    
    document.getElementById('installmentModal').style.display = 'block';
    
    // ملء نافذة الأقساط
    const modalContent = document.getElementById('installmentContent');
    modalContent.innerHTML = `
        <div class="card">
            <h3>معلومات العميل</h3>
            <p><strong>الاسم:</strong> ${selectedCustomer.fullName}</p>
            <p><strong>الهاتف:</strong> ${selectedCustomer.phone}</p>
            <p><strong>النوع:</strong> ${
                selectedCustomer.type === 'vip' ? 'مميز' : 
                selectedCustomer.type === 'wholesale' ? 'تاجر جملة' : 
                'عادي'
            }</p>
        </div>

        <div class="grid">
            <div class="form-group">
                <label>المبلغ الأصلي</label>
                <input type="number" id="originalAmount" value="${total}" readonly>
            </div>
            <div class="form-group">
                <label>نسبة الفائدة (%)</label>
                <input type="number" id="interestRate" value="${defaultInterestRate}" 
                       min="0" max="50" step="0.1" oninput="calculateInstallments()">
            </div>
            <div class="form-group">
                <label>عدد الأقساط (شهر)</label>
                <input type="number" id="installmentCount" value="${defaultInstallments}" 
                       min="1" max="60" oninput="calculateInstallments()">
            </div>
            <div class="form-group">
                <label>المبلغ مع الفائدة</label>
                <input type="number" id="totalWithInterest" readonly>
            </div>
            <div class="form-group">
                <label>قيمة القسط الشهري</label>
                <input type="number" id="monthlyPayment" readonly>
            </div>
            <div class="form-group">
                <label>تاريخ أول قسط</label>
                <input type="date" id="firstPaymentDate" value="${formattedFirstPaymentDate}">
            </div>
        </div>

        <div id="installmentSchedule" class="installment-table"></div>
        
        <div style="margin-top: 20px;">
            <button class="btn btn-success btn-lg" onclick="createInstallmentSale()">💾 إتمام البيع بالأقساط</button>
            <button class="btn btn-danger" onclick="closeModal('installmentModal')">❌ إلغاء</button>
        </div>
    `;

    calculateInstallments();
}

// حساب الأقساط
function calculateInstallments() {
    const originalAmount = parseFloat(document.getElementById('originalAmount').value) || 0;
    const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
    const installmentCount = parseInt(document.getElementById('installmentCount').value) || 1;

    const totalWithInterest = originalAmount + (originalAmount * interestRate / 100);
    const monthlyPayment = totalWithInterest / installmentCount;

    document.getElementById('totalWithInterest').value = totalWithInterest.toFixed(2);
    document.getElementById('monthlyPayment').value = monthlyPayment.toFixed(2);

    displayInstallmentSchedule(totalWithInterest, monthlyPayment, installmentCount);
}

// عرض جدولة الأقساط
function displayInstallmentSchedule(totalAmount, monthlyPayment, count) {
    const scheduleDiv = document.getElementById('installmentSchedule');
    const firstPaymentDate = new Date(document.getElementById('firstPaymentDate').value || Date.now());
    
    let scheduleHTML = `
        <h4>📅 جدولة الأقساط:</h4>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>القسط</th>
                        <th>تاريخ الاستحقاق</th>
                        <th>المبلغ</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody>
    `;

    for (let i = 1; i <= count; i++) {
        const dueDate = new Date(firstPaymentDate);
        dueDate.setMonth(dueDate.getMonth() + i - 1);
        
        scheduleHTML += `
            <tr>
                <td>${i}</td>
                <td>${dueDate.toLocaleDateString('ar-IQ')}</td>
                <td class="currency">${formatCurrency(monthlyPayment)}</td>
                <td><span class="status-badge status-pending">معلق</span></td>
            </tr>
        `;
    }

    scheduleHTML += '</tbody></table></div>';
    scheduleDiv.innerHTML = scheduleHTML;
}

// إنشاء بيع بالأقساط
function createInstallmentSale() {
    const originalAmount = parseFloat(document.getElementById('originalAmount').value);
    const interestRate = parseFloat(document.getElementById('interestRate').value);
    const installmentCount = parseInt(document.getElementById('installmentCount').value);
    const totalWithInterest = parseFloat(document.getElementById('totalWithInterest').value);
    const monthlyPayment = parseFloat(document.getElementById('monthlyPayment').value);
    const firstPaymentDate = document.getElementById('firstPaymentDate').value;

    // إنشاء جدولة الأقساط
    const installments = [];
    const startDate = new Date(firstPaymentDate);
    
    for (let i = 1; i <= installmentCount; i++) {
        const dueDate = new Date(startDate);
        dueDate.setMonth(dueDate.getMonth() + i - 1);
        
        installments.push({
            number: i,
            amount: monthlyPayment,
            dueDate: dueDate.toISOString(),
            paid: false,
            paidDate: null,
            paidAmount: 0,
            status: 'pending'
        });
    }

    // تحديث المخزون
    const updatedProducts = [...products];
    cart.forEach(cartItem => {
        const productIndex = updatedProducts.findIndex(p => p.id === cartItem.id);
        if (productIndex !== -1) {
            updatedProducts[productIndex].productStock -= cartItem.quantity;
        }
    });

    // تحديث بيانات العميل
    const customerIndex = customers.findIndex(c => c.id === selectedCustomer.id);
    if (customerIndex !== -1) {
        customers[customerIndex].totalPurchases = (customers[customerIndex].totalPurchases || 0) + totalWithInterest;
        customers[customerIndex].lastVisit = new Date().toISOString();
    }

    // حساب إجمالي التكلفة للمنتجات المباعة
    const totalCost = cart.reduce((sum, item) => sum + (item.costPrice * item.quantity), 0);
    const profit = totalWithInterest - totalCost;

    // حفظ بيع الأقساط
    const installmentSale = {
        id: Date.now(),
        invoiceNumber: generateInvoiceNumber(),
        customerId: selectedCustomer.id,
        customerName: selectedCustomer.fullName,
        customerPhone: selectedCustomer.phone,
        items: JSON.parse(JSON.stringify(cart)), // نسخة عميقة من العربة
        originalAmount,
        interestRate,
        totalWithInterest,
        monthlyPayment,
        installmentCount,
        installments,
        totalPaid: 0,
        remainingAmount: totalWithInterest,
        cost: totalCost,
        profit: profit,
        createdDate: new Date().toISOString(),
        status: 'active',
        cashier: document.getElementById('currentUser').textContent.replace('👤 ', '') || 'المدير العام'
    };

    // تحديث البيانات وحفظها
    installmentSales.push(installmentSale);
    products = updatedProducts;
    
    localStorage.setItem('installmentSales', JSON.stringify(installmentSales));
    localStorage.setItem('products', JSON.stringify(products));
    localStorage.setItem('customers', JSON.stringify(customers));

    // تنظيف العربة والعميل
    clearCart();
    clearSelectedCustomer();
    
    // تحديث الواجهة
    loadProductsForPOS();
    updateDashboard();
    closeModal('installmentModal');

    showNotification('تم إنشاء بيع الأقساط بنجاح', 'success');
    printInstallmentContract(installmentSale);
}

// طباعة عقد الأقساط
function printInstallmentContract(installmentSale) {
    const contractWindow = window.open('', '_blank');
    
    // الحصول على معلومات المتجر من الإعدادات
    const storeName = settings.storeName || 'متجري';
    const storeAddress = settings.storeAddress || '';
    const storePhone = settings.storePhone || '';
    
    const contractHTML = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>عقد البيع بالأقساط</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    line-height: 1.6; 
                }
                .header { 
                    text-align: center; 
                    border-bottom: 2px solid #000; 
                    padding-bottom: 20px; 
                }
                .content { 
                    margin: 20px 0; 
                }
                .signature { 
                    margin-top: 50px; 
                    display: flex; 
                    justify-content: space-between; 
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 20px 0; 
                }
                th, td { 
                    border: 1px solid #000; 
                    padding: 10px; 
                    text-align: center; 
                }
                th { 
                    background: #f0f0f0; 
                }
                .print-button { 
                    display: block; 
                    margin: 20px auto; 
                    padding: 10px; 
                    background: #4CAF50; 
                    color: white; 
                    border: none; 
                    border-radius: 5px; 
                    cursor: pointer; 
                }
                @media print {
                    .print-button { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>عقد البيع بالأقساط</h1>
                <h2>${storeName}</h2>
                ${storeAddress ? `<p>${storeAddress}</p>` : ''}
                ${storePhone ? `<p>هاتف: ${storePhone}</p>` : ''}
                <p>رقم العقد: ${installmentSale.invoiceNumber || installmentSale.id}</p>
                <p>التاريخ: ${new Date(installmentSale.createdDate).toLocaleDateString('ar-IQ')}</p>
            </div>
            
            <div class="content">
                <h3>بيانات العميل:</h3>
                <p><strong>الاسم:</strong> ${installmentSale.customerName}</p>
                <p><strong>رقم الهاتف:</strong> ${installmentSale.customerPhone}</p>
                
                <h3>تفاصيل البيع:</h3>
                <table>
                    <thead>
                        <tr><th>المنتج</th><th>الكمية</th><th>السعر</th><th>المجموع</th></tr>
                    </thead>
                    <tbody>
                        ${installmentSale.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>${formatCurrency(item.price)}</td>
                                <td>${formatCurrency(item.price * item.quantity * (1 - item.discount / 100))}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <p><strong>المبلغ الأصلي:</strong> ${formatCurrency(installmentSale.originalAmount)}</p>
                <p><strong>نسبة الفائدة:</strong> ${installmentSale.interestRate}%</p>
                <p><strong>المبلغ الإجمالي:</strong> ${formatCurrency(installmentSale.totalWithInterest)}</p>
                <p><strong>عدد الأقساط:</strong> ${installmentSale.installmentCount} قسط</p>
                <p><strong>قيمة القسط الشهري:</strong> ${formatCurrency(installmentSale.monthlyPayment)}</p>
                
                <h3>جدولة الأقساط:</h3>
                <table>
                    <thead>
                        <tr><th>رقم القسط</th><th>تاريخ الاستحقاق</th><th>المبلغ</th></tr>
                    </thead>
                    <tbody>
                        ${installmentSale.installments.map(inst => `
                            <tr>
                                <td>${inst.number}</td>
                                <td>${new Date(inst.dueDate).toLocaleDateString('ar-IQ')}</td>
                                <td>${formatCurrency(inst.amount)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <div class="signature">
                <div>
                    <p>توقيع العميل</p>
                    <p>_________________</p>
                </div>
                <div>
                    <p>توقيع المتجر</p>
                    <p>_________________</p>
                </div>
            </div>
            <button class="print-button" onclick="window.print()">طباعة العقد</button>
        </body>
        </html>
    `;
    
    contractWindow.document.write(contractHTML);
    contractWindow.document.close();
}

// حفظ كعرض سعر
function saveQuote() {
    if (cart.length === 0) {
        showNotification('العربة فارغة', 'error');
        return;
    }

    const quote = {
        id: Date.now(),
        invoiceNumber: generateInvoiceNumber('Q'),
        customerId: selectedCustomer?.id || null,
        customerName: selectedCustomer?.fullName || 'عميل مجهول',
        items: JSON.parse(JSON.stringify(cart)),
        subtotal: getSubtotal(),
        discount: getTotalDiscount(),
        tax: getTaxAmount(),
        total: getTotalAmount(),
        status: 'pending',
        validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // صالح لمدة 30 يوم
        createdAt: new Date().toISOString(),
        cashier: document.getElementById('currentUser').textContent.replace('👤 ', '') || 'المدير العام'
    };

    const quotes = JSON.parse(localStorage.getItem('quotes')) || [];
    quotes.push(quote);
    localStorage.setItem('quotes', JSON.stringify(quotes));

    showNotification('تم حفظ عرض السعر بنجاح', 'success');
    printQuote(quote);
}

// طباعة عرض السعر
function printQuote(quote) {
    const quoteWindow = window.open('', '_blank');
    
    // الحصول على معلومات المتجر من الإعدادات
    const storeName = settings.storeName || 'متجري';
    const storeAddress = settings.storeAddress || '';
    const storePhone = settings.storePhone || '';
    
    const validUntil = new Date(quote.validUntil).toLocaleDateString('ar-IQ');
    
    const quoteHTML = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>عرض سعر</title>
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    margin: 20px; 
                    line-height: 1.6; 
                }
                .header { 
                    text-align: center; 
                    border-bottom: 2px solid #000; 
                    padding-bottom: 20px; 
                }
                .content { 
                    margin: 20px 0; 
                }
                .quote-info { 
                    display: flex; 
                    justify-content: space-between; 
                    margin-bottom: 20px; 
                }
                table { 
                    width: 100%; 
                    border-collapse: collapse; 
                    margin: 20px 0; 
                }
                th, td { 
                    border: 1px solid #000; 
                    padding: 10px; 
                    text-align: center; 
                }
                th { 
                    background: #f0f0f0; 
                }
                .total { 
                    text-align: left; 
                    margin-top: 20px; 
                }
                .note { 
                    margin-top: 30px; 
                    font-style: italic; 
                }
                .print-button { 
                    display: block; 
                    margin: 20px auto; 
                    padding: 10px; 
                    background: #4CAF50; 
                    color: white; 
                    border: none; 
                    border-radius: 5px; 
                    cursor: pointer; 
                }
                @media print {
                    .print-button { display: none; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>عرض سعر</h1>
                <h2>${storeName}</h2>
                ${storeAddress ? `<p>${storeAddress}</p>` : ''}
                ${storePhone ? `<p>هاتف: ${storePhone}</p>` : ''}
            </div>
            
            <div class="content">
                <div class="quote-info">
                    <div>
                        <p><strong>العميل:</strong> ${quote.customerName}</p>
                        <p><strong>تاريخ العرض:</strong> ${new Date(quote.createdAt).toLocaleDateString('ar-IQ')}</p>
                    </div>
                    <div>
                        <p><strong>رقم العرض:</strong> ${quote.invoiceNumber || quote.id}</p>
                        <p><strong>صالح لغاية:</strong> ${validUntil}</p>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>المنتج</th>
                            <th>السعر</th>
                            <th>الكمية</th>
                            <th>الخصم</th>
                            <th>المجموع</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${quote.items.map((item, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.name}</td>
                                <td>${formatCurrency(item.price)}</td>
                                <td>${item.quantity}</td>
                                <td>${item.discount}%</td>
                                <td>${formatCurrency(item.price * item.quantity * (1 - item.discount / 100))}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="total">
                    <p><strong>المجموع الفرعي:</strong> ${formatCurrency(quote.subtotal)}</p>
                    ${quote.discount > 0 ? `<p><strong>الخصم:</strong> ${formatCurrency(quote.discount)}</p>` : ''}
                    ${quote.tax > 0 ? `<p><strong>الضريبة:</strong> ${formatCurrency(quote.tax)}</p>` : ''}
                    <p style="font-size: 1.2em;"><strong>المجموع الكلي:</strong> ${formatCurrency(quote.total)}</p>
                </div>
                
                <div class="note">
                    <p>ملاحظة: هذا العرض صالح لمدة 30 يوم من تاريخ الإصدار.</p>
                    <p>للاستفسار يرجى الاتصال على الرقم: ${storePhone || '_________'}</p>
                </div>
            </div>
            <button class="print-button" onclick="window.print()">طباعة عرض السعر</button>
        </body>
        </html>
    `;
    
    quoteWindow.document.write(quoteHTML);
    quoteWindow.document.close();
}

// إضافة منتج جديد
function addProduct() {
    // التحقق من الحقول الإلزامية
    const name = document.getElementById('productName').value.trim();
    const mainCategory = document.getElementById('mainCategory').value;
    const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
    const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
    const productStock = parseInt(document.getElementById('productStock').value) || 0;
    
    if (!name || !mainCategory || salePrice <= 0) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
    }
    
    // جمع البيانات الأساسية والإضافية
    const barcode = document.getElementById('productBarcode').value.trim() || generateBarcode();
    const subCategory = document.getElementById('subCategory').value;
    const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;
    const minStock = parseInt(document.getElementById('minStock').value) || 5;
    
    // البيانات الاختيارية
    const brand = document.getElementById('productBrand').value.trim();
    const model = document.getElementById('productModel').value.trim();
    const supplierId = document.getElementById('supplierId').value;
    const expiryDate = document.getElementById('expiryDate').value;
    const description = document.getElementById('productDescription').value.trim();
    const notes = document.getElementById('productNotes').value.trim();
    
    // إنشاء كائن المنتج
    const product = {
        id: Date.now(),
        name,
        barcode,
        mainCategory,
        subCategory,
        brand,
        model,
        costPrice,
        salePrice,
        minPrice,
        productStock,
        minStock,
        supplierId,
        expiryDate,
        description,
        notes,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    
    // إضافة المنتج وحفظه
    products.push(product);
    saveProducts();
    
    // تحديث الواجهة
    loadProductsTable();
    loadProductsForPOS();
    clearProductForm();
    updateDashboard();
    
    // عرض تبويب قائمة المنتجات
    showProductTab('product-list');
    
    showNotification('تم إضافة المنتج بنجاح', 'success');
}

// تحميل جدول المنتجات
function loadProductsTable() {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';
    
    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="centered-content">لا توجد منتجات. يرجى إضافة منتجات جديدة.</td></tr>';
        return;
    }
    
    // فلترة المنتجات حسب البحث والفلاتر
    const filteredProducts = filterProductsList();
    
    if (filteredProducts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="centered-content">لا توجد نتائج للبحث.</td></tr>';
        return;
    }
    
    filteredProducts.forEach(product => {
        const row = tbody.insertRow();
        
        // تحديد حالة المخزون
        let stockStatus, stockClass;
        if (product.productStock <= 0) {
            stockStatus = 'نفذ المخزون';
            stockClass = 'status-out-of-stock';
        } else if (product.productStock <= (product.minStock || 5)) {
            stockStatus = 'مخزون منخفض';
            stockClass = 'status-low-stock';
        } else {
            stockStatus = 'متوفر';
            stockClass = 'status-active';
        }
        
        row.innerHTML = `
            <td><input type="checkbox" class="product-checkbox" value="${product.id}"></td>
            <td>${product.name}</td>
            <td>${product.barcode || 'غير محدد'}</td>
            <td>${getCategoryName(product.mainCategory)}</td>
            <td class="currency">${formatCurrency(product.costPrice || 0)}</td>
            <td class="currency">${formatCurrency(product.salePrice)}</td>
            <td>${product.productStock}</td>
            <td><span class="status-badge ${stockClass}">${stockStatus}</span></td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editProduct(${product.id})" title="تعديل">✏️</button>
                <button class="btn btn-info btn-sm" onclick="duplicateProduct(${product.id})" title="نسخ">📋</button>
                <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})" title="حذف">🗑️</button>
            </td>
        `;
    });
}

// فلترة قائمة المنتجات
function filterProductsList() {
    const searchTerm = document.getElementById('productFilterInput')?.value?.toLowerCase() || '';
    const categoryFilter = document.getElementById('categoryFilterProducts')?.value || '';
    const statusFilter = document.getElementById('statusFilterProducts')?.value || '';
    
    return products.filter(product => {
        // فلترة حسب البحث
        const nameMatch = product.name.toLowerCase().includes(searchTerm);
        const barcodeMatch = product.barcode && product.barcode.toLowerCase().includes(searchTerm);
        const searchMatch = nameMatch || barcodeMatch;
        
        // فلترة حسب الفئة
        const categoryMatch = !categoryFilter || product.mainCategory === categoryFilter;
        
        // فلترة حسب الحالة
        let statusMatch = true;
        if (statusFilter) {
            if (statusFilter === 'active') statusMatch = product.productStock > (product.minStock || 5);
            else if (statusFilter === 'inactive') statusMatch = product.productStock <= 0;
            else if (statusFilter === 'low-stock') statusMatch = product.productStock > 0 && product.productStock <= (product.minStock || 5);
        }
        
        return searchMatch && categoryMatch && statusMatch;
    });
}

// تعديل منتج
function editProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) {
        showNotification('المنتج غير موجود', 'error');
        return;
    }
    
    currentEditProductId = productId;
    
    const modal = document.getElementById('editProductModal');
    const content = document.getElementById('editProductContent');
    
    content.innerHTML = `
        <div class="grid">
            <div class="form-group">
                <label class="required-field">اسم المنتج</label>
                <input type="text" id="editProductName" value="${product.name}" required>
            </div>
            <div class="form-group">
                <label>الباركود</label>
                <input type="text" id="editProductBarcode" value="${product.barcode || ''}">
            </div>
            <div class="form-group">
                <label class="required-field">الفئة الرئيسية</label>
                <select id="editMainCategory" onchange="updateEditSubCategories()" required>
                    <option value="">اختر الفئة</option>
                </select>
            </div>
            <div class="form-group">
                <label>الفئة الفرعية</label>
                <select id="editSubCategory">
                    <option value="">اختر الفئة الفرعية</option>
                </select>
            </div>
            <div class="form-group">
                <label class="required-field">سعر الشراء</label>
                <input type="number" id="editCostPrice" value="${product.costPrice || 0}" oninput="calculateEditProfitMargin()" required>
            </div>
            <div class="form-group">
                <label class="required-field">سعر البيع</label>
                <input type="number" id="editSalePrice" value="${product.salePrice}" oninput="calculateEditProfitMargin()" required>
            </div>
            <div class="form-group">
                <label>هامش الربح (%)</label>
                <input type="number" id="editProfitMargin" readonly>
            </div>
            <div class="form-group">
                <label>الحد الأدنى للسعر</label>
                <input type="number" id="editMinPrice" value="${product.minPrice || 0}">
            </div>
            <div class="form-group">
                <label class="required-field">المخزون</label>
                <input type="number" id="editProductStock" value="${product.productStock}" required>
            </div>
            <div class="form-group">
                <label>الحد الأدنى للمخزون</label>
                <input type="number" id="editMinStock" value="${product.minStock || 5}">
            </div>
            <div class="form-group">
                <label>العلامة التجارية</label>
                <input type="text" id="editProductBrand" value="${product.brand || ''}">
            </div>
            <div class="form-group">
                <label>الموديل</label>
                <input type="text" id="editProductModel" value="${product.model || ''}">
            </div>
        </div>
        <div class="form-group">
            <label>وصف المنتج</label>
            <textarea id="editProductDescription" rows="3">${product.description || ''}</textarea>
        </div>
        <div class="form-group">
            <label>ملاحظات</label>
            <textarea id="editProductNotes" rows="2">${product.notes || ''}</textarea>
        </div>
        <div class="form-actions" style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="updateProduct()">💾 حفظ التغييرات</button>
            <button class="btn btn-danger" onclick="closeModal('editProductModal')">❌ إلغاء</button>
        </div>
    `;
    
    // تحميل الفئات
    const editMainCategory = document.getElementById('editMainCategory');
    Object.keys(categoryStructure).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = categoryStructure[key].name;
        option.selected = key === product.mainCategory;
        editMainCategory.appendChild(option);
    });
    
    // تحميل الفئات الفرعية
    updateEditSubCategories(product.subCategory);
    
    // حساب هامش الربح
    calculateEditProfitMargin();
    
    modal.style.display = 'block';
}

// تحديث الفئات الفرعية في نموذج التعديل
function updateEditSubCategories(selectedSubCategory = null) {
    const mainCategory = document.getElementById('editMainCategory').value;
    const subCategorySelect = document.getElementById('editSubCategory');
    
    subCategorySelect.innerHTML = '<option value="">اختر الفئة الفرعية</option>';
    
    if (mainCategory && categoryStructure[mainCategory]) {
        categoryStructure[mainCategory].subcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            option.selected = sub === selectedSubCategory;
            subCategorySelect.appendChild(option);
        });
    }
}

// حساب هامش الربح في نموذج التعديل
function calculateEditProfitMargin() {
    const costPrice = parseFloat(document.getElementById('editCostPrice').value) || 0;
    const salePrice = parseFloat(document.getElementById('editSalePrice').value) || 0;
    
    if (costPrice > 0) {
        const margin = ((salePrice - costPrice) / costPrice) * 100;
        document.getElementById('editProfitMargin').value = margin.toFixed(2);
    } else {
        document.getElementById('editProfitMargin').value = '0';
    }
}

// تحديث منتج
function updateProduct() {
    if (!currentEditProductId) {
        showNotification('خطأ في تحديد المنتج', 'error');
        return;
    }
    
    // التحقق من الحقول الإلزامية
    const name = document.getElementById('editProductName').value.trim();
    const mainCategory = document.getElementById('editMainCategory').value;
    const costPrice = parseFloat(document.getElementById('editCostPrice').value) || 0;
    const salePrice = parseFloat(document.getElementById('editSalePrice').value) || 0;
    const productStock = parseInt(document.getElementById('editProductStock').value) || 0;
    
    if (!name || !mainCategory || salePrice <= 0) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
    }
    
    // جمع باقي البيانات
    const barcode = document.getElementById('editProductBarcode').value.trim();
    const subCategory = document.getElementById('editSubCategory').value;
    const minPrice = parseFloat(document.getElementById('editMinPrice').value) || 0;
    const minStock = parseInt(document.getElementById('editMinStock').value) || 5;
    const brand = document.getElementById('editProductBrand').value.trim();
    const model = document.getElementById('editProductModel').value.trim();
    const description = document.getElementById('editProductDescription').value.trim();
    const notes = document.getElementById('editProductNotes').value.trim();
    
    // تحديث المنتج
    const productIndex = products.findIndex(p => p.id === currentEditProductId);
    if (productIndex === -1) {
        showNotification('المنتج غير موجود', 'error');
        return;
    }
    
    // الحفاظ على البيانات التي لم يتم تعديلها
    const originalProduct = products[productIndex];
    products[productIndex] = {
        ...originalProduct,
        name,
        barcode,
        mainCategory,
        subCategory,
        brand,
        model,
        costPrice,
        salePrice,
        minPrice,
        productStock,
        minStock,
        description,
        notes,
        updatedAt: new Date().toISOString()
    };
    
    // حفظ التغييرات
    saveProducts();
    
    // تحديث الواجهة
    loadProductsTable();
    loadProductsForPOS();
    updateDashboard();
    
    closeModal('editProductModal');
    showNotification('تم تحديث المنتج بنجاح', 'success');
}

// حذف منتج
function deleteProduct(productId) {
    if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
        return;
    }
    
    const productIndex = products.findIndex(p => p.id === productId);
    if (productIndex === -1) {
        showNotification('المنتج غير موجود', 'error');
        return;
    }
    
    // حذف المنتج
    const productName = products[productIndex].name;
    products.splice(productIndex, 1);
    
    // حفظ التغييرات
    saveProducts();
    
    // تحديث الواجهة
    loadProductsTable();
    loadProductsForPOS();
    updateDashboard();
    
    showNotification(`تم حذف المنتج "${productName}" بنجاح`, 'success');
}

// نسخ منتج
function duplicateProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) {
        showNotification('المنتج غير موجود', 'error');
        return;
    }
    
    const newProduct = {
        ...product,
        id: Date.now(),
        name: `${product.name} (نسخة)`,
        barcode: generateBarcode(),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
    };
    
    products.push(newProduct);
    saveProducts();
    
    loadProductsTable();
    loadProductsForPOS();
    updateDashboard();
    
    showNotification(`تم نسخ المنتج "${product.name}" بنجاح`, 'success');
}

// إضافة عميل جديد
function addCustomer() {
    // التحقق من الحقول الإلزامية
    const fullName = document.getElementById('customerFullName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    
    if (!fullName || !phone) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
    }
    
    // جمع البيانات الأساسية
    const email = document.getElementById('customerEmail').value.trim();
    const type = document.getElementById('customerType').value;
    const address = document.getElementById('customerAddress').value.trim();
    const notes = document.getElementById('customerNotes').value.trim();
    
    // إنشاء كائن العميل
    const customer = {
        id: Date.now(),
        fullName,
        phone,
        email,
        type,
        address,
        notes,
        loyaltyPoints: 0,
        totalPurchases: 0,
        lastVisit: null,
        createdAt: new Date().toISOString()
    };
    
    // إضافة العميل وحفظه
    customers.push(customer);
    saveCustomers();
    
    // تحديث الواجهة
    loadCustomersTable();
    clearCustomerForm();
    updateDashboard();
    
    // عرض تبويب قائمة العملاء
    showCustomerTab('customer-list');
    
    showNotification('تم إضافة العميل بنجاح', 'success');
}

// تحميل جدول العملاء
function loadCustomersTable() {
    const tbody = document.getElementById('customersTableBody');
    tbody.innerHTML = '';
    
    if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="centered-content">لا يوجد عملاء. يرجى إضافة عملاء جدد.</td></tr>';
        return;
    }
    
    customers.forEach(customer => {
        const row = tbody.insertRow();
        const lastVisit = customer.lastVisit ? 
            new Date(customer.lastVisit).toLocaleDateString('ar-IQ') : 'لم يزر بعد';
        
        const customerType = customer.type === 'vip' ? 'مميز' : 
                           customer.type === 'wholesale' ? 'تاجر جملة' : 'عادي';
        
        const typeClass = customer.type === 'vip' ? 'badge-warning' : 
                         customer.type === 'wholesale' ? 'badge-info' : 'badge-primary';

        row.innerHTML = `
            <td>${customer.fullName}</td>
            <td>${customer.phone}</td>
            <td>${customer.email || 'غير محدد'}</td>
            <td><span class="badge ${typeClass}">${customerType}</span></td>
            <td>${customer.loyaltyPoints || 0}</td>
            <td class="currency">${formatCurrency(customer.totalPurchases || 0)}</td>
            <td>${lastVisit}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editCustomer(${customer.id})" title="تعديل">✏️</button>
                <button class="btn btn-info btn-sm" onclick="viewCustomerHistory(${customer.id})" title="السجل">📊</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCustomer(${customer.id})" title="حذف">🗑️</button>
            </td>
        `;
    });
}

// البحث في العملاء
function searchCustomers() {
    const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#customersTableBody tr');
    
    rows.forEach(row => {
        if (row.cells.length < 2) return; // تجاهل الصفوف الخاصة برسائل "لا يوجد عملاء"
        
        const customerName = row.cells[0].textContent.toLowerCase();
        const customerPhone = row.cells[1].textContent.toLowerCase();
        const isVisible = customerName.includes(searchTerm) || customerPhone.includes(searchTerm);
        row.style.display = isVisible ? 'table-row' : 'none';
    });
}

// تعديل عميل
function editCustomer(customerId) {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// عرض سجل العميل
function viewCustomerHistory(customerId) {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// حذف عميل
function deleteCustomer(customerId) {
    if (!confirm('هل أنت متأكد من حذف هذا العميل؟')) {
        return;
    }
    
    const customerIndex = customers.findIndex(c => c.id === customerId);
    if (customerIndex === -1) {
        showNotification('العميل غير موجود', 'error');
        return;
    }
    
    // التحقق من وجود مبيعات مرتبطة بالعميل
    const hasRelatedSales = sales.some(sale => sale.customerId === customerId);
    const hasRelatedInstallments = installmentSales.some(sale => sale.customerId === customerId);
    
    if (hasRelatedSales || hasRelatedInstallments) {
        if (!confirm('هذا العميل لديه مبيعات أو أقساط مرتبطة به. هل تريد الاستمرار في الحذف؟')) {
            return;
        }
    }
    
    // حذف العميل
    const customerName = customers[customerIndex].fullName;
    customers.splice(customerIndex, 1);
    
    // حفظ التغييرات
    saveCustomers();
    
    // تحديث الواجهة
    loadCustomersTable();
    updateDashboard();
    
    showNotification(`تم حذف العميل "${customerName}" بنجاح`, 'success');
}

// إضافة مورد جديد
function addSupplier() {
    // التحقق من الحقول الإلزامية
    const company = document.getElementById('supplierCompany').value.trim();
    const phone = document.getElementById('supplierPhone').value.trim();
    
    if (!company || !phone) {
        showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
        return;
    }
    
    // جمع البيانات الأساسية
    const contact = document.getElementById('supplierContact').value.trim();
    const email = document.getElementById('supplierEmail').value.trim();
    const address = document.getElementById('supplierAddress').value.trim();
    const notes = document.getElementById('supplierNotes').value.trim();
    
    // إنشاء كائن المورد
    const supplier = {
        id: Date.now(),
        company,
        contact,
        phone,
        email,
        address,
        notes,
        rating: 3, // تقييم افتراضي
        totalOrders: 0,
        lastOrder: null,
        createdAt: new Date().toISOString()
    };
    
    // إضافة المورد وحفظه
    suppliers.push(supplier);
    saveSuppliers();
    
    // تحديث الواجهة
    loadSuppliersTable();
    clearSupplierForm();
    
    // عرض تبويب قائمة الموردين
    showSupplierTab('supplier-list');
    
    showNotification('تم إضافة المورد بنجاح', 'success');
}

// تحميل جدول الموردين
function loadSuppliersTable() {
    const tbody = document.getElementById('suppliersTableBody');
    tbody.innerHTML = '';
    
    if (suppliers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="centered-content">لا يوجد موردين. يرجى إضافة موردين جدد.</td></tr>';
        return;
    }
    
    suppliers.forEach(supplier => {
        const row = tbody.insertRow();
        const stars = '⭐'.repeat(supplier.rating || 3);
        const lastOrder = supplier.lastOrder ? 
            new Date(supplier.lastOrder).toLocaleDateString('ar-IQ') : 'لا توجد طلبيات';

        row.innerHTML = `
            <td>${supplier.company}</td>
            <td>${supplier.contact || 'غير محدد'}</td>
            <td>${supplier.phone}</td>
            <td>${supplier.email || 'غير محدد'}</td>
            <td>${stars}</td>
            <td>${lastOrder}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editSupplier(${supplier.id})" title="تعديل">✏️</button>
                <button class="btn btn-info btn-sm" onclick="createPurchaseOrder(${supplier.id})" title="طلبية جديدة">📋</button>
                <button class="btn btn-danger btn-sm" onclick="deleteSupplier(${supplier.id})" title="حذف">🗑️</button>
            </td>
        `;
    });
}

// البحث في الموردين
function searchSuppliers() {
    const searchTerm = document.getElementById('supplierSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#suppliersTableBody tr');
    
    rows.forEach(row => {
        if (row.cells.length < 3) return; // تجاهل الصفوف الخاصة برسائل "لا يوجد موردين"
        
        const companyName = row.cells[0].textContent.toLowerCase();
        const contactName = row.cells[1].textContent.toLowerCase();
        const phone = row.cells[2].textContent.toLowerCase();
        const isVisible = companyName.includes(searchTerm) || contactName.includes(searchTerm) || phone.includes(searchTerm);
        row.style.display = isVisible ? 'table-row' : 'none';
    });
}

// تعديل مورد
function editSupplier(supplierId) {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// إنشاء طلبية جديدة
function createPurchaseOrder(supplierId) {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// حذف مورد
function deleteSupplier(supplierId) {
    if (!confirm('هل أنت متأكد من حذف هذا المورد؟')) {
        return;
    }
    
    const supplierIndex = suppliers.findIndex(s => s.id === supplierId);
    if (supplierIndex === -1) {
        showNotification('المورد غير موجود', 'error');
        return;
    }
    
    // حذف المورد
    const supplierName = suppliers[supplierIndex].company;
    suppliers.splice(supplierIndex, 1);
    
    // حفظ التغييرات
    saveSuppliers();
    
    // تحديث الواجهة
    loadSuppliersTable();
    
    showNotification(`تم حذف المورد "${supplierName}" بنجاح`, 'success');
}

// تحميل جدول المبيعات
function loadSalesTable() {
    const tbody = document.getElementById('salesTableBody');
    tbody.innerHTML = '';
    
    if (sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="centered-content">لا توجد مبيعات بعد.</td></tr>';
        return;
    }
    
    // ترتيب المبيعات من الأحدث إلى الأقدم
    const sortedSales = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedSales.forEach(sale => {
        const row = tbody.insertRow();
        const saleDate = new Date(sale.date).toLocaleDateString('ar-IQ');
        const itemsCount = sale.items.reduce((sum, item) => sum + item.quantity, 0);
        
        row.innerHTML = `
            <td>${sale.invoiceNumber || sale.id}</td>
            <td>${saleDate}</td>
            <td>${sale.customerName}</td>
            <td>${itemsCount}</td>
            <td class="currency">${formatCurrency(sale.total)}</td>
            <td>${sale.type === 'cash' ? 'نقدي' : 'أقساط'}</td>
            <td>${sale.cashier}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick="viewSaleDetails(${sale.id})" title="التفاصيل">👁️</button>
                <button class="btn btn-success btn-sm" onclick="printSaleReceipt(${sale.id})" title="طباعة">🖨️</button>
                <button class="btn btn-danger btn-sm" onclick="returnSale(${sale.id})" title="مرتجع">↩️</button>
            </td>
        `;
    });
}

// فلترة المبيعات
function filterSales() {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// عرض تفاصيل البيع
function viewSaleDetails(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) {
        showNotification('البيع غير موجود', 'error');
        return;
    }
    
    const modal = document.getElementById('invoiceDetailsModal');
    const content = document.getElementById('invoiceContent');
    
    content.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3>معلومات الفاتورة</h3>
            </div>
            <div>
                <p><strong>رقم الفاتورة:</strong> ${sale.invoiceNumber || sale.id}</p>
                <p><strong>التاريخ:</strong> ${new Date(sale.date).toLocaleDateString('ar-IQ')}</p>
                <p><strong>العميل:</strong> ${sale.customerName}</p>
                <p><strong>الكاشير:</strong> ${sale.cashier}</p>
                <p><strong>نوع البيع:</strong> ${sale.type === 'cash' ? 'نقدي' : 'أقساط'}</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3>المنتجات</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>المنتج</th>
                            <th>الكمية</th>
                            <th>السعر</th>
                            <th>الخصم</th>
                            <th>المجموع</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sale.items.map(item => `
                            <tr>
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td class="currency">${formatCurrency(item.price)}</td>
                                <td>${item.discount || 0}%</td>
                                <td class="currency">${formatCurrency(item.price * item.quantity * (1 - (item.discount || 0) / 100))}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3>الدفع</h3>
            </div>
            <div class="cart-summary">
                <div class="cart-row">
                    <span>المجموع الفرعي:</span>
                    <span class="currency">${formatCurrency(sale.subtotal)}</span>
                </div>
                ${sale.discount > 0 ? `
                    <div class="cart-row">
                        <span>الخصم:</span>
                        <span class="currency">${formatCurrency(sale.discount)}</span>
                    </div>
                ` : ''}
                ${sale.tax > 0 ? `
                    <div class="cart-row">
                        <span>الضريبة:</span>
                        <span class="currency">${formatCurrency(sale.tax)}</span>
                    </div>
                ` : ''}
                <div class="cart-total">
                    <span>المجموع الكلي:</span>
                    <span class="currency">${formatCurrency(sale.total)}</span>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button class="btn btn-success" onclick="printSaleReceipt(${sale.id})">🖨️ طباعة الفاتورة</button>
            <button class="btn btn-danger" onclick="closeModal('invoiceDetailsModal')">❌ إغلاق</button>
        </div>
    `;
    
    modal.style.display = 'block';
}

// طباعة فاتورة البيع
function printSaleReceipt(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) {
        showNotification('البيع غير موجود', 'error');
        return;
    }
    
    printReceipt(sale);
}

// إرجاع بيع
function returnSale(saleId) {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// تحميل جدول الأقساط
function loadInstallmentsTable() {
    const tbody = document.getElementById('installmentsTableBody');
    tbody.innerHTML = '';
    
    if (installmentSales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="centered-content">لا توجد بيوع بالأقساط بعد.</td></tr>';
        return;
    }
    
    // ترتيب الأقساط من الأحدث إلى الأقدم
    const sortedInstallments = [...installmentSales].sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
    
    sortedInstallments.forEach(sale => {
        const row = tbody.insertRow();
        
        // حساب المبلغ المدفوع
        const totalPaid = sale.totalPaid || 0;
        const remainingAmount = sale.totalWithInterest - totalPaid;
        
        // تحديد حالة الأقساط
        let statusText, statusClass;
        if (sale.status === 'completed') {
            statusText = 'مكتمل';
            statusClass = 'status-completed';
        } else if (sale.status === 'cancelled') {
            statusText = 'ملغي';
            statusClass = 'status-cancelled';
        } else {
            // التحقق من وجود أقساط متأخرة
            const hasOverdueInstallments = sale.installments.some(inst => 
                !inst.paid && new Date(inst.dueDate) < new Date()
            );
            
            if (hasOverdueInstallments) {
                statusText = 'متأخر';
                statusClass = 'status-cancelled';
            } else {
                statusText = 'نشط';
                statusClass = 'status-active';
            }
        }
        
        row.innerHTML = `
            <td>${sale.invoiceNumber || sale.id}</td>
            <td>${sale.customerName}</td>
            <td class="currency">${formatCurrency(sale.totalWithInterest)}</td>
            <td class="currency">${formatCurrency(totalPaid)}</td>
            <td class="currency">${formatCurrency(remainingAmount)}</td>
            <td>${sale.installmentCount}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
                <button class="btn btn-info btn-sm" onclick="viewInstallmentDetails(${sale.id})" title="التفاصيل">👁️</button>
                <button class="btn btn-success btn-sm" onclick="addInstallmentPayment(${sale.id})" title="دفع قسط">💰</button>
                <button class="btn btn-warning btn-sm" onclick="printInstallmentContract(${JSON.stringify(sale).replace(/"/g, '&quot;')});" title="طباعة العقد">🖨️</button>
            </td>
        `;
    });
}

// فلترة الأقساط
function filterInstallments() {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// عرض تفاصيل الأقساط
function viewInstallmentDetails(saleId) {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// إضافة دفعة قسط
function addInstallmentPayment(saleId) {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// تحميل جدول المرتجعات
function loadReturnsTable() {
    const tbody = document.getElementById('returnsTableBody');
    tbody.innerHTML = '';
    
    if (returns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="centered-content">لا توجد مرتجعات بعد.</td></tr>';
        return;
    }
    
    // ترتيب المرتجعات من الأحدث إلى الأقدم
    const sortedReturns = [...returns].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedReturns.forEach(returnItem => {
        const row = tbody.insertRow();
        const returnDate = new Date(returnItem.date).toLocaleDateString('ar-IQ');
        
        row.innerHTML = `
            <td>${returnItem.id}</td>
            <td>${returnItem.saleInvoiceNumber || returnItem.saleId}</td>
            <td>${returnDate}</td>
            <td>${returnItem.customerName}</td>
            <td>${returnItem.items.length}</td>
            <td class="currency">${formatCurrency(returnItem.totalAmount)}</td>
            <td>${returnItem.reason || 'غير محدد'}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick="viewReturnDetails(${returnItem.id})" title="التفاصيل">👁️</button>
                <button class="btn btn-success btn-sm" onclick="printReturnReceipt(${returnItem.id})" title="طباعة">🖨️</button>
            </td>
        `;
    });
}

// إضافة مرتجع جديد
function showNewReturnModal() {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// تحميل جدول المصروفات
function loadExpensesTable() {
    const tbody = document.getElementById('expensesTableBody');
    tbody.innerHTML = '';
    
    if (expenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="centered-content">لا توجد مصروفات بعد.</td></tr>';
        return;
    }
    
    // ترتيب المصروفات من الأحدث إلى الأقدم
    const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    sortedExpenses.forEach(expense => {
        const row = tbody.insertRow();
        const expenseDate = new Date(expense.date).toLocaleDateString('ar-IQ');
        
        row.innerHTML = `
            <td>${expenseDate}</td>
            <td>${expense.description}</td>
            <td>${expense.category}</td>
            <td class="currency">${formatCurrency(expense.amount)}</td>
            <td>${expense.notes || '-'}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editExpense(${expense.id})" title="تعديل">✏️</button>
                <button class="btn btn-danger btn-sm" onclick="deleteExpense(${expense.id})" title="حذف">🗑️</button>
            </td>
        `;
    });
}

// إضافة مصروف جديد
function showNewExpenseModal() {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// توليد التقارير
function generateSalesReport() {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

function generateInventoryReport() {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

function generateProfitReport() {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

function generateCustomerReport() {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة هذه الميزة قريبًا', 'info');
}

// فتح نافذة اختيار العميل
function openCustomerModal() {
    document.getElementById('customerModal').style.display = 'block';
    loadCustomersList();
}

// تحميل قائمة العملاء في النافذة المنبثقة
function loadCustomersList() {
    const customersList = document.getElementById('customersList');
    customersList.innerHTML = '';
    
    if (customers.length === 0) {
        customersList.innerHTML = '<div class="centered-content"><p>لا يوجد عملاء. يرجى إضافة عملاء جدد.</p></div>';
        return;
    }
    
    // تحميل العملاء في شبكة من البطاقات
    const customerGrid = document.createElement('div');
    customerGrid.className = 'product-grid';
    
    customers.forEach(customer => {
        const customerCard = document.createElement('div');
        customerCard.className = 'product-card';
        customerCard.onclick = () => selectCustomer(customer);
        
        const customerType = customer.type === 'vip' ? 'مميز' : 
                           customer.type === 'wholesale' ? 'تاجر جملة' : 'عادي';
        
        const typeClass = customer.type === 'vip' ? 'badge-warning' : 
                         customer.type === 'wholesale' ? 'badge-info' : 'badge-primary';
        
        customerCard.innerHTML = `
            <div class="product-info">
                <h4>${customer.fullName}</h4>
                <p>📞 ${customer.phone}</p>
                <p><span class="badge ${typeClass}">${customerType}</span></p>
                <p>⭐ نقاط الولاء: ${customer.loyaltyPoints || 0}</p>
            </div>
        `;
        
        customerGrid.appendChild(customerCard);
    });
    
    customersList.appendChild(customerGrid);
}

// البحث في العملاء في النافذة المنبثقة
function searchCustomersModal() {
    const searchTerm = document.getElementById('customerModalSearch').value.toLowerCase();
    const customerCards = document.querySelectorAll('#customersList .product-card');
    
    customerCards.forEach(card => {
        const customerName = card.querySelector('h4').textContent.toLowerCase();
        const customerPhone = card.querySelector('p').textContent.toLowerCase();
        const isVisible = customerName.includes(searchTerm) || customerPhone.includes(searchTerm) || searchTerm === '';
        card.style.display = isVisible ? 'block' : 'none';
    });
}

// اختيار عميل
function selectCustomer(customer) {
    selectedCustomer = customer;
    document.getElementById('selectedCustomer').style.display = 'block';
    document.getElementById('customerName').textContent = customer.fullName;
    closeModal('customerModal');
    showNotification(`تم اختيار العميل: ${customer.fullName}`, 'success');
}

// مسح العميل المحدد
function clearSelectedCustomer() {
    selectedCustomer = null;
    document.getElementById('selectedCustomer').style.display = 'none';
    showNotification('تم إلغاء اختيار العميل', 'info');
}

// إغلاق النوافذ المنبثقة
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// الحصول على اسم الفئة
function getCategoryName(categoryKey) {
    return categoryStructure[categoryKey]?.name || categoryKey || 'غير محدد';
}

// تبديل الأكورديون
function toggleAccordion(header) {
    header.classList.toggle('active');
    const content = header.nextElementSibling;
    
    if (content.style.display === 'block') {
        content.style.display = 'none';
    } else {
        content.style.display = 'block';
    }
}

// تبديل جميع صناديق الاختيار
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.product-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// حساب هامش الربح
function calculateProfitMargin() {
    const costPrice = parseFloat(document.getElementById('costPrice').value) || 0;
    const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
    
    if (costPrice > 0) {
        const margin = ((salePrice - costPrice) / costPrice) * 100;
        document.getElementById('profitMargin').value = margin.toFixed(2);
    } else {
        document.getElementById('profitMargin').value = '0';
    }
}

// إنشاء نسخة احتياطية
function createBackup() {
    const backupData = {
        products,
        customers,
        suppliers,
        sales,
        installmentSales,
        returns,
        expenses,
        settings,
        timestamp: new Date().toISOString(),
        version: '2.0'
    };

    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);

    showNotification('تم إنشاء النسخة الاحتياطية بنجاح', 'success');
}
// استعادة من نسخة احتياطية (تكملة للدالة السابقة)
function restoreBackup(fileInput) {
    const file = fileInput.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backupData = JSON.parse(e.target.result);
            
            // التحقق من صحة البيانات
            if (!backupData.products || !backupData.customers || !backupData.suppliers) {
                throw new Error('ملف النسخة الاحتياطية غير صالح أو غير مكتمل.');
            }
            
            // عرض تأكيد للمستخدم
            if (!confirm('سيتم استبدال جميع البيانات الحالية بالبيانات من النسخة الاحتياطية. هل أنت متأكد من المتابعة؟')) {
                return;
            }
            
            // استعادة البيانات
            products = backupData.products || [];
            customers = backupData.customers || [];
            suppliers = backupData.suppliers || [];
            sales = backupData.sales || [];
            installmentSales = backupData.installmentSales || [];
            returns = backupData.returns || [];
            expenses = backupData.expenses || [];
            settings = backupData.settings || {};
            
            // حفظ البيانات في التخزين المحلي
            saveProducts();
            saveCustomers();
            saveSuppliers();
            localStorage.setItem('sales', JSON.stringify(sales));
            localStorage.setItem('installmentSales', JSON.stringify(installmentSales));
            localStorage.setItem('returns', JSON.stringify(returns));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('settings', JSON.stringify(settings));
            
            // تحديث الواجهة
            loadAllData();
            applySettings();
            
            showNotification('تم استعادة البيانات بنجاح من النسخة الاحتياطية', 'success');
        } catch (error) {
            showNotification('خطأ في استعادة البيانات: ' + error.message, 'error');
        }
    };
    
    reader.readAsText(file);
}

// حفظ الإعدادات
function saveSettings() {
    // جمع الإعدادات من النموذج
    const storeName = document.getElementById('storeName')?.value;
    const storeAddress = document.getElementById('storeAddress')?.value;
    const storePhone = document.getElementById('storePhone')?.value;
    const storeEmail = document.getElementById('storeEmail')?.value;
    const currency = document.getElementById('currency')?.value;
    const language = document.getElementById('language')?.value;
    const dateFormat = document.getElementById('dateFormat')?.value;
    const defaultTaxRate = parseFloat(document.getElementById('defaultTaxRate')?.value) || 0;
    const defaultInterestRate = parseFloat(document.getElementById('defaultInterestRate')?.value) || 5;
    const defaultInstallments = parseInt(document.getElementById('defaultInstallments')?.value) || 12;
    const showProductImage = document.getElementById('showProductImage')?.value === '1';
    
    // تحديث الإعدادات
    settings = {
        ...settings,
        storeName,
        storeAddress,
        storePhone,
        storeEmail,
        currency,
        language,
        dateFormat,
        defaultTaxRate,
        defaultInterestRate,
        defaultInstallments,
        showProductImage
    };
    
    // حفظ الإعدادات
    localStorage.setItem('settings', JSON.stringify(settings));
    
    // تطبيق الإعدادات
    applySettings();
    
    showNotification('تم حفظ الإعدادات بنجاح', 'success');
}

// تطبيق الإعدادات
function applySettings() {
    // تطبيق اسم المتجر
    if (settings.storeName) {
        document.title = settings.storeName;
    }
    
    // تطبيق الإعدادات على النماذج إذا كانت موجودة
    if (document.getElementById('storeName')) document.getElementById('storeName').value = settings.storeName || '';
    if (document.getElementById('storeAddress')) document.getElementById('storeAddress').value = settings.storeAddress || '';
    if (document.getElementById('storePhone')) document.getElementById('storePhone').value = settings.storePhone || '';
    if (document.getElementById('storeEmail')) document.getElementById('storeEmail').value = settings.storeEmail || '';
    if (document.getElementById('currency')) document.getElementById('currency').value = settings.currency || 'IQD';
    if (document.getElementById('language')) document.getElementById('language').value = settings.language || 'ar';
    if (document.getElementById('dateFormat')) document.getElementById('dateFormat').value = settings.dateFormat || 'DD/MM/YYYY';
    if (document.getElementById('defaultTaxRate')) document.getElementById('defaultTaxRate').value = settings.defaultTaxRate || 0;
    if (document.getElementById('defaultInterestRate')) document.getElementById('defaultInterestRate').value = settings.defaultInterestRate || 5;
    if (document.getElementById('defaultInstallments')) document.getElementById('defaultInstallments').value = settings.defaultInstallments || 12;
    if (document.getElementById('showProductImage')) document.getElementById('showProductImage').value = settings.showProductImage ? '1' : '0';
    
    // تطبيق معدل الضريبة الافتراضي
    if (document.getElementById('taxRate')) document.getElementById('taxRate').value = settings.defaultTaxRate || 0;
    
    // تحديث إجمالي العربة لتطبيق الضريبة الجديدة
    updateCartTotal();
}

// إظهار إشعار
function showNotification(message, type = 'info') {
    // إزالة الإشعارات السابقة
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => {
        notification.remove();
    });
    
    // إنشاء إشعار جديد
    const notification = document.createElement('div');
    notification.className = 'notification';
    
    // تحديد لون الإشعار حسب النوع
    switch (type) {
        case 'success':
            notification.style.background = '#27ae60';
            break;
        case 'error':
            notification.style.background = '#e74c3c';
            break;
        case 'warning':
            notification.style.background = '#f39c12';
            break;
        default:
            notification.style.background = '#3498db';
    }
    
    // إضافة رمز تعبيري حسب النوع
    let icon = '';
    switch (type) {
        case 'success':
            icon = '✅ ';
            break;
        case 'error':
            icon = '❌ ';
            break;
        case 'warning':
            icon = '⚠️ ';
            break;
        default:
            icon = 'ℹ️ ';
    }
    
    notification.textContent = icon + message;
    
    // إضافة الإشعار إلى الصفحة
    document.body.appendChild(notification);
    
    // إخفاء الإشعار بعد 4 ثوانٍ
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 4000);
}

// توليد رقم فاتورة
function generateInvoiceNumber(prefix = 'INV') {
    const date = new Date();
    const year = date.getFullYear().toString().substr(2, 2);
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const random = Math.floor(Math.random() * 9000 + 1000);
    
    return `${prefix}${year}${month}${day}-${random}`;
}

// توليد باركود
function generateBarcode() {
    return Date.now().toString() + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
}

// تنسيق العملة
function formatCurrency(amount) {
    const currency = settings.currency || 'IQD';
    let symbol;
    
    switch (currency) {
        case 'USD':
            symbol = '$';
            break;
        case 'EUR':
            symbol = '€';
            break;
        case 'SAR':
            symbol = 'ر.س';
            break;
        case 'AED':
            symbol = 'د.إ';
            break;
        default:
            symbol = 'د.ع';
    }
    
    return amount.toLocaleString() + ' ' + symbol;
}

// الحصول على المجموع الفرعي
function getSubtotal() {
    return cart.reduce((sum, item) => sum + (item.price * item.quantity * (1 - item.discount / 100)), 0);
}

// الحصول على إجمالي الخصم
function getTotalDiscount() {
    const subtotal = getSubtotal();
    const discountRate = parseFloat(document.getElementById('totalDiscount').value) || 0;
    return subtotal * (discountRate / 100);
}

// الحصول على مبلغ الضريبة
function getTaxAmount() {
    const afterDiscount = getSubtotal() - getTotalDiscount();
    const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
    return afterDiscount * (taxRate / 100);
}

// الحصول على إجمالي المبلغ
function getTotalAmount() {
    const subtotal = getSubtotal();
    const discount = getTotalDiscount();
    const tax = getTaxAmount();
    return subtotal - discount + tax;
}

// حفظ المنتجات
function saveProducts() {
    localStorage.setItem('products', JSON.stringify(products));
}

// حفظ العملاء
function saveCustomers() {
    localStorage.setItem('customers', JSON.stringify(customers));
}

// حفظ الموردين
function saveSuppliers() {
    localStorage.setItem('suppliers', JSON.stringify(suppliers));
}

// تحميل الفئات
function loadCategories() {
    // تحميل الفئات في نماذج البحث والتصفية
    const categorySelects = [
        'categoryFilter', 
        'categoryFilterProducts',
        'mainCategory'
    ];
    
    categorySelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        
        // مسح الخيارات الحالية باستثناء الخيار الافتراضي
        while (select.options.length > 1) {
            select.remove(1);
        }
        
        // إضافة الفئات
        Object.keys(categoryStructure).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = categoryStructure[key].name;
            select.appendChild(option);
        });
    });
    
    // تحديث الفئات الفرعية إذا تم تحديد فئة رئيسية
    updateSubCategories();
}

// تحديث الفئات الفرعية
function updateSubCategories() {
    const mainCategory = document.getElementById('mainCategory').value;
    const subCategorySelect = document.getElementById('subCategory');
    
    if (!subCategorySelect) return;
    
    // مسح الخيارات الحالية باستثناء الخيار الافتراضي
    while (subCategorySelect.options.length > 1) {
        subCategorySelect.remove(1);
    }
    
    // إضافة الفئات الفرعية إذا تم تحديد فئة رئيسية
    if (mainCategory && categoryStructure[mainCategory]) {
        categoryStructure[mainCategory].subcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            subCategorySelect.appendChild(option);
        });
    }
}

// مسح نموذج المنتج
function clearProductForm() {
    const form = document.querySelector('#add-product');
    if (!form) return;
    
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.type === 'number') {
            input.value = '0';
        } else if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else {
            input.value = '';
        }
    });
    
    // إعادة تعيين قيم افتراضية للحقول المحددة
    document.getElementById('minStock').value = '5';
}

// مسح نموذج العميل
function clearCustomerForm() {
    const form = document.querySelector('#add-customer');
    if (!form) return;
    
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else {
            input.value = '';
        }
    });
}

// مسح نموذج المورد
function clearSupplierForm() {
    const form = document.querySelector('#add-supplier');
    if (!form) return;
    
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        if (input.tagName === 'SELECT') {
            input.selectedIndex = 0;
        } else {
            input.value = '';
        }
    });
}

// تصدير المنتجات
function exportProducts() {
    // التحقق من وجود منتجات
    if (products.length === 0) {
        showNotification('لا توجد منتجات للتصدير', 'warning');
        return;
    }
    
    // تحضير بيانات المنتجات للتصدير
    const exportData = products.map(product => ({
        id: product.id,
        name: product.name,
        barcode: product.barcode,
        mainCategory: getCategoryName(product.mainCategory),
        subCategory: product.subCategory,
        costPrice: product.costPrice,
        salePrice: product.salePrice,
        stock: product.productStock,
        minStock: product.minStock,
        brand: product.brand,
        model: product.model,
        description: product.description,
        notes: product.notes
    }));
    
    // تحويل البيانات إلى CSV
    let csv = 'المعرف,الاسم,الباركود,الفئة الرئيسية,الفئة الفرعية,سعر الشراء,سعر البيع,المخزون,الحد الأدنى للمخزون,العلامة التجارية,الموديل,الوصف,ملاحظات\n';
    
    exportData.forEach(product => {
        const row = [
            product.id,
            `"${product.name.replace(/"/g, '""')}"`, // تجنب مشاكل الفواصل في النص
            product.barcode,
            `"${product.mainCategory}"`,
            `"${product.subCategory || ''}"`,
            product.costPrice,
            product.salePrice,
            product.stock,
            product.minStock,
            `"${product.brand || ''}"`,
            `"${product.model || ''}"`,
            `"${(product.description || '').replace(/"/g, '""')}"`,
            `"${(product.notes || '').replace(/"/g, '""')}"`
        ];
        
        csv += row.join(',') + '\n';
    });
    
    // إنشاء ملف للتنزيل
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `products_export_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification(`تم تصدير ${products.length} منتج بنجاح`, 'success');
}

// عرض نافذة استيراد المنتجات
function showImportModal() {
    // يمكن إضافة هذه الوظيفة لاحقًا
    showNotification('سيتم إضافة ميزة استيراد المنتجات قريبًا', 'info');
}

// مراقبة الأحداث عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // إضافة مستمعي الأحداث للأكورديون
    const accordionHeaders = document.querySelectorAll('.accordion-header');
    accordionHeaders.forEach(header => {
        header.addEventListener('click', function() {
            this.classList.toggle('active');
            const content = this.nextElementSibling;
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        });
    });
    
    // مراقبة تغييرات الإعدادات وحفظها تلقائيًا
    document.querySelectorAll('#settings input, #settings select, #settings textarea').forEach(element => {
        element.addEventListener('change', function() {
            saveSettings();
        });
    });
    
    // مراقبة النقر خارج النوافذ المنبثقة لإغلاقها
    window.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // مراقبة مفاتيح لوحة المفاتيح للإجراءات السريعة
    document.addEventListener('keydown', function(event) {
        // Esc لإغلاق النوافذ المنبثقة
        if (event.key === 'Escape') {
            const openModals = document.querySelectorAll('.modal[style*="display: block"]');
            if (openModals.length > 0) {
                openModals.forEach(modal => {
                    modal.style.display = 'none';
                });
                event.preventDefault();
            }
        }
        
        // Ctrl+P للطباعة
        if (event.ctrlKey && event.key === 'p') {
            // التحقق من وجود بيع نشط
            if (cart.length > 0) {
                event.preventDefault();
                if (confirm('هل تريد طباعة فاتورة البيع الحالي؟')) {
                    processCashSale();
                }
            }
        }
        
        // F2 للانتقال السريع إلى نقطة البيع
        if (event.key === 'F2') {
            event.preventDefault();
            showTab('pos');
        }
        
        // F3 للبحث السريع عن المنتجات
        if (event.key === 'F3') {
            event.preventDefault();
            document.getElementById('productSearch')?.focus();
        }
        
        // F4 لإضافة منتج جديد
        if (event.key === 'F4') {
            event.preventDefault();
            showTab('products');
            showProductTab('add-product');
        }
    });
});

// بيانات تجريبية للاختبار (يمكن إزالتها في الإصدار النهائي)
function loadDemoData() {
    // التحقق مما إذا كانت البيانات التجريبية قد تم تحميلها من قبل
    if (localStorage.getItem('demoDataLoaded')) {
        return;
    }
    
    // إضافة منتجات تجريبية
    const demoProducts = [
        {
            id: 1001,
            name: 'هاتف ذكي سامسونج جالاكسي',
            barcode: '1001000001',
            mainCategory: 'electronics',
            subCategory: 'هواتف ذكية',
            brand: 'سامسونج',
            model: 'جالاكسي S21',
            costPrice: 400000,
            salePrice: 450000,
            productStock: 15,
            minStock: 3,
            description: 'هاتف ذكي من سامسونج بشاشة 6.2 بوصة وذاكرة 128 جيجابايت',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 1002,
            name: 'لابتوب ديل انسبايرون',
            barcode: '1002000002',
            mainCategory: 'electronics',
            subCategory: 'أجهزة كمبيوتر',
            brand: 'ديل',
            model: 'انسبايرون 15',
            costPrice: 700000,
            salePrice: 800000,
            productStock: 8,
            minStock: 2,
            description: 'لابتوب بمعالج كور i5 وذاكرة 8 جيجابايت وهارد 512 جيجابايت SSD',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 1003,
            name: 'تلفزيون ال جي سمارت',
            barcode: '1003000003',
            mainCategory: 'electronics',
            subCategory: 'تلفزيونات',
            brand: 'ال جي',
            model: 'سمارت 4K',
            costPrice: 350000,
            salePrice: 400000,
            productStock: 5,
            minStock: 2,
            description: 'تلفزيون ذكي بدقة 4K وحجم 55 بوصة',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 1004,
            name: 'بنطلون جينز رجالي',
            barcode: '1004000004',
            mainCategory: 'clothes',
            subCategory: 'ملابس رجالي',
            brand: 'ليفايس',
            costPrice: 25000,
            salePrice: 35000,
            productStock: 30,
            minStock: 5,
            description: 'بنطلون جينز رجالي أزرق مقاس 32',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 1005,
            name: 'قميص قطن رجالي',
            barcode: '1005000005',
            mainCategory: 'clothes',
            subCategory: 'ملابس رجالي',
            brand: 'زارا',
            costPrice: 15000,
            salePrice: 25000,
            productStock: 25,
            minStock: 5,
            description: 'قميص قطن رجالي أبيض مقاس M',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 1006,
            name: 'حذاء رياضي نايك',
            barcode: '1006000006',
            mainCategory: 'clothes',
            subCategory: 'أحذية',
            brand: 'نايك',
            model: 'اير ماكس',
            costPrice: 40000,
            salePrice: 60000,
            productStock: 12,
            minStock: 3,
            description: 'حذاء رياضي أسود مقاس 42',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 1007,
            name: 'سماعات لاسلكية',
            barcode: '1007000007',
            mainCategory: 'electronics',
            subCategory: 'أجهزة صوت',
            brand: 'جي بي ال',
            model: 'تيون 510BT',
            costPrice: 50000,
            salePrice: 65000,
            productStock: 18,
            minStock: 5,
            description: 'سماعات لاسلكية بتقنية بلوتوث',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 1008,
            name: 'طقم أواني مطبخ',
            barcode: '1008000008',
            mainCategory: 'home',
            subCategory: 'أدوات منزلية',
            brand: 'تيفال',
            costPrice: 80000,
            salePrice: 100000,
            productStock: 7,
            minStock: 2,
            description: 'طقم أواني مطبخ 7 قطع من تيفال',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 1009,
            name: 'خلاط كهربائي',
            barcode: '1009000009',
            mainCategory: 'home',
            subCategory: 'أدوات منزلية',
            brand: 'فيليبس',
            costPrice: 30000,
            salePrice: 45000,
            productStock: 10,
            minStock: 3,
            description: 'خلاط كهربائي بقدرة 500 واط',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        },
        {
            id: 1010,
            name: 'حقيبة ظهر',
            barcode: '1010000010',
            mainCategory: 'clothes',
            subCategory: 'حقائب',
            brand: 'نايك',
            costPrice: 20000,
            salePrice: 30000,
            productStock: 20,
            minStock: 5,
            description: 'حقيبة ظهر سوداء مقاومة للماء',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        }
    ];
    
    // إضافة عملاء تجريبيين
    const demoCustomers = [
        {
            id: 2001,
            fullName: 'أحمد محمد',
            phone: '07701234567',
            email: 'ahmed@example.com',
            type: 'regular',
            address: 'بغداد - الكرادة',
            loyaltyPoints: 120,
            totalPurchases: 250000,
            lastVisit: new Date().toISOString(),
            createdAt: new Date().toISOString()
        },
        {
            id: 2002,
            fullName: 'سارة علي',
            phone: '07709876543',
            email: 'sara@example.com',
            type: 'vip',
            address: 'بغداد - المنصور',
            loyaltyPoints: 350,
            totalPurchases: 850000,
            lastVisit: new Date().toISOString(),
            createdAt: new Date().toISOString()
        },
        {
            id: 2003,
            fullName: 'محمد جاسم',
            phone: '07711223344',
            email: 'mohammed@example.com',
            type: 'wholesale',
            address: 'بغداد - الكاظمية',
            loyaltyPoints: 500,
            totalPurchases: 1500000,
            lastVisit: new Date().toISOString(),
            createdAt: new Date().toISOString()
        }
    ];
    
    // إضافة موردين تجريبيين
    const demoSuppliers = [
        {
            id: 3001,
            company: 'شركة التقنية للإلكترونيات',
            contact: 'علي حسن',
            phone: '07801234567',
            email: 'info@techcompany.com',
            address: 'بغداد - الكرادة',
            rating: 4,
            totalOrders: 15,
            lastOrder: new Date().toISOString(),
            createdAt: new Date().toISOString()
        },
        {
            id: 3002,
            company: 'شركة الأزياء العالمية',
            contact: 'ليلى كريم',
            phone: '07809876543',
            email: 'info@fashioncompany.com',
            address: 'بغداد - المنصور',
            rating: 3,
            totalOrders: 8,
            lastOrder: new Date().toISOString(),
            createdAt: new Date().toISOString()
        },
        {
            id: 3003,
            company: 'شركة المنزل للأجهزة المنزلية',
            contact: 'حسن علي',
            phone: '07711122233',
            email: 'info@homeappliances.com',
            address: 'بغداد - الكاظمية',
            rating: 5,
            totalOrders: 20,
            lastOrder: new Date().toISOString(),
            createdAt: new Date().toISOString()
        }
    ];
    
    // إنشاء مبيعات تجريبية
    const demoSales = [
        {
            id: 4001,
            invoiceNumber: 'INV210501-1234',
            customerId: 2001,
            customerName: 'أحمد محمد',
            items: [
                {
                    id: 1001,
                    name: 'هاتف ذكي سامسونج جالاكسي',
                    price: 450000,
                    quantity: 1,
                    discount: 0,
                    costPrice: 400000
                }
            ],
            subtotal: 450000,
            discount: 0,
            tax: 0,
            total: 450000,
            cost: 400000,
            profit: 50000,
            type: 'cash',
            date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), // قبل أسبوع
            cashier: 'المدير العام'
        },
        {
            id: 4002,
            invoiceNumber: 'INV210502-5678',
            customerId: 2002,
            customerName: 'سارة علي',
            items: [
                {
                    id: 1002,
                    name: 'لابتوب ديل انسبايرون',
                    price: 800000,
                    quantity: 1,
                    discount: 5,
                    costPrice: 700000
                },
                {
                    id: 1007,
                    name: 'سماعات لاسلكية',
                    price: 65000,
                    quantity: 1,
                    discount: 0,
                    costPrice: 50000
                }
            ],
            subtotal: 865000,
            discount: 40000,
            tax: 0,
            total: 825000,
            cost: 750000,
            profit: 75000,
            type: 'cash',
            date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), // قبل 3 أيام
            cashier: 'المدير العام'
        }
    ];
    
    // إنشاء أقساط تجريبية
    const today = new Date();
    const demoInstallmentSales = [
        {
            id: 5001,
            invoiceNumber: 'INV210503-9012',
            customerId: 2003,
            customerName: 'محمد جاسم',
            customerPhone: '07711223344',
            items: [
                {
                    id: 1003,
                    name: 'تلفزيون ال جي سمارت',
                    price: 400000,
                    quantity: 1,
                    discount: 0,
                    costPrice: 350000
                }
            ],
            originalAmount: 400000,
            interestRate: 5,
            totalWithInterest: 420000,
            monthlyPayment: 35000,
            installmentCount: 12,
            installments: Array.from({ length: 12 }, (_, i) => {
                const dueDate = new Date(today);
                dueDate.setMonth(today.getMonth() + i);
                return {
                    number: i + 1,
                    amount: 35000,
                    dueDate: dueDate.toISOString(),
                    paid: i < 3, // الأقساط الثلاثة الأولى مدفوعة
                    paidDate: i < 3 ? new Date(dueDate.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString() : null,
                    paidAmount: i < 3 ? 35000 : 0,
                    status: i < 3 ? 'paid' : 'pending'
                };
            }),
            totalPaid: 105000, // 3 أقساط × 35000
            remainingAmount: 315000,
            cost: 350000,
            profit: 70000,
            createdDate: new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString(), // قبل 3 أشهر
            status: 'active',
            cashier: 'المدير العام'
        }
    ];
    
    // إضافة إعدادات تجريبية
    const demoSettings = {
        storeName: 'متجري الذكي',
        storeAddress: 'الحلة، العراق',
        storePhone: '07701234567',
        storeEmail: 'info@mystore.com',
        currency: 'IQD',
        language: 'ar',
        dateFormat: 'DD/MM/YYYY',
        defaultTaxRate: 0,
        defaultInterestRate: 5,
        defaultInstallments: 12,
        showProductImage: true,
        receiptFooter: 'شكراً لزيارتكم. نتمنى لكم يوماً سعيداً!'
    };
    
    // حفظ البيانات التجريبية
    products = demoProducts;
    customers = demoCustomers;
    suppliers = demoSuppliers;
    sales = demoSales;
    installmentSales = demoInstallmentSales;
    settings = demoSettings;
    
    // حفظ البيانات في التخزين المحلي
    saveProducts();
    saveCustomers();
    saveSuppliers();
    localStorage.setItem('sales', JSON.stringify(sales));
    localStorage.setItem('installmentSales', JSON.stringify(installmentSales));
    localStorage.setItem('settings', JSON.stringify(settings));
    
    // تعليم أن البيانات التجريبية قد تم تحميلها
    localStorage.setItem('demoDataLoaded', 'true');
    
    // تحديث الواجهة
    loadAllData();
    applySettings();
    
    showNotification('تم تحميل البيانات التجريبية بنجاح', 'success');
}

// إضافة زر تحميل البيانات التجريبية إلى لوحة التحكم
function addDemoDataButton() {
    // التحقق من وجود قسم لوحة التحكم
    const dashboard = document.getElementById('dashboard');
    if (!dashboard) return;
    
    // التحقق مما إذا كانت البيانات التجريبية قد تم تحميلها من قبل
    const isDemoLoaded = localStorage.getItem('demoDataLoaded');
    
    // إنشاء زر تحميل البيانات التجريبية
    const demoButton = document.createElement('div');
    demoButton.className = 'card';
    demoButton.innerHTML = `
        <div class="card-header">
            <h3 class="card-title">💾 بيانات تجريبية</h3>
        </div>
        <div style="text-align: center;">
            <p>يمكنك تحميل بيانات تجريبية لاختبار النظام بشكل أفضل.</p>
            ${isDemoLoaded ? 
                '<p style="color: green;">✅ تم تحميل البيانات التجريبية بالفعل.</p>' : 
                '<button class="btn btn-primary" onclick="loadDemoData()">تحميل البيانات التجريبية</button>'
            }
        </div>
    `;
    
    // إضافة الزر إلى لوحة التحكم
    dashboard.appendChild(demoButton);
}

// استدعاء دالة إضافة زر البيانات التجريبية عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        addDemoDataButton();
    }, 1000); // إضافة تأخير لضمان تحميل جميع العناصر
});

// تحديث المنتجات لمنع فقدان البيانات عند تحديث النظام
function migrateData() {
    // تحديث المنتجات: نقل المخزون من النظام القديم إلى النظام الجديد
    const updatedProducts = products.map(product => {
        // إذا كان المنتج يحتوي على movingStock (النظام القديم) ولكن ليس لديه productStock (النظام الجديد)
        if (product.movingStock !== undefined && product.productStock === undefined) {
            return {
                ...product,
                productStock: product.movingStock, // نقل المخزون المتحرك إلى المخزون الجديد
            };
        }
        return product;
    });
    
    // تحديث المنتجات في المتغير والتخزين المحلي
    products = updatedProducts;
    saveProducts();
}

// استدعاء دالة ترحيل البيانات عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    migrateData();
});oad =

// تهيئة التطبيق عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // إضافة وظيفة لتشغيل الوقت المباشر
    updateLiveTime();
    setInterval(updateLiveTime, 1000);
    
    // تهيئة تبويب نقطة البيع
    initializePOS();
    
    // تحميل البيانات وتطبيق الإعدادات
    loadAllData();
    loadCategories();
    applySettings();
    
    // ضبط أحداث النقر لأزرار التبويبات
    setupTabButtons();
    
    // ضبط أحداث النقر للنوافذ المنبثقة
    setupModalEvents();
    
    // إضافة مستمعي الأحداث للأكورديون
    setupAccordions();
    
    // تبدأ الصفحة بعرض تبويب نقطة البيع
    showTab('pos');
});

// تهيئة تبويب نقطة البيع
function initializePOS() {
    // تحميل المنتجات
    loadProductsForPOS();
    
    // تهيئة العربة
    updateCartDisplay();
    
    // تعيين معدل الضريبة الافتراضي
    if (settings.defaultTaxRate !== undefined) {
        document.getElementById('taxRate').value = settings.defaultTaxRate;
    }
}

// ضبط أحداث النقر لأزرار التبويبات
function setupTabButtons() {
    // أزرار التبويبات الرئيسية
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.id.replace('btn-', '');
            showTab(tabId);
        });
    });
    
    // أزرار تبويبات المنتجات
    document.querySelectorAll('#products .tab-secondary').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('onclick').match(/'([^']+)'/)[1];
            showProductTab(tabId);
        });
    });
    
    // أزرار تبويبات العملاء
    document.querySelectorAll('#customers .tab-secondary').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('onclick').match(/'([^']+)'/)[1];
            showCustomerTab(tabId);
        });
    });
    
    // أزرار تبويبات الموردين
    document.querySelectorAll('#suppliers .tab-secondary').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('onclick').match(/'([^']+)'/)[1];
            showSupplierTab(tabId);
        });
    });
    }
    // أزرار تبويبات الإعدادات
    document.querySelectorAll('.tabs-secondary .tab-secondary').forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('onclick').match(/'([^']+)'/)[1];
            showSettingsTab(tabId);
        });
    });
}

// ضبط أحداث النقر للنوافذ المنبثقة
function setupModalEvents() {
    // إغلاق النوافذ المنبثقة عند النقر على زر الإغلاق
    document.querySelectorAll('.close').forEach(closeButton => {
        closeButton.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) {
                modal.style.display = 'none';
            }
        });
    });
    
    // إغلاق النوافذ المنبثقة عند النقر خارجها
    window.addEventListener('click', function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    });
}

// ضبط الأكورديون
function setupAccordions() {
    document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', function() {
            toggleAccordion(this);
        });
    });
}

// إضافة مستمعي الأحداث لحقول الإدخال
function setupInputEvents() {
    // حساب هامش الربح عند تغيير سعر الشراء أو سعر البيع
    document.getElementById('costPrice')?.addEventListener('input', calculateProfitMargin);
    document.getElementById('salePrice')?.addEventListener('input', calculateProfitMargin);
    
    // تحديث الفئات الفرعية عند تغيير الفئة الرئيسية
    document.getElementById('mainCategory')?.addEventListener('change', updateSubCategories);
    
    // تحديث إجمالي العربة عند تغيير الخصم أو الضريبة
    document.getElementById('totalDiscount')?.addEventListener('input', updateCartTotal);
    document.getElementById('taxRate')?.addEventListener('input', updateCartTotal);
    
    // البحث في المنتجات عند الكتابة في حقل البحث
    document.getElementById('productSearch')?.addEventListener('input', searchProducts);
    
    // فلترة المنتجات عند تغيير الفئة أو السعر أو المخزون
    document.getElementById('categoryFilter')?.addEventListener('change', filterProducts);
    document.getElementById('priceRange')?.addEventListener('change', filterProducts);
    document.getElementById('stockFilter')?.addEventListener('change', filterProducts);
    
    // البحث في العملاء عند الكتابة في حقل البحث
    document.getElementById('customerSearch')?.addEventListener('input', searchCustomers);
    
    // البحث في الموردين عند الكتابة في حقل البحث
    document.getElementById('supplierSearch')?.addEventListener('input', searchSuppliers);
}

// إضافة اختصارات لوحة المفاتيح
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(event) {
        // F1: فتح المساعدة
        if (event.key === 'F1') {
            event.preventDefault();
            showHelp();
        }
        
        // F2: الانتقال إلى نقطة البيع
        if (event.key === 'F2') {
            event.preventDefault();
            showTab('pos');
        }
        
        // F3: التركيز على حقل البحث
        if (event.key === 'F3') {
            event.preventDefault();
            if (document.getElementById('productSearch')) {
                document.getElementById('productSearch').focus();
            }
        }
        
        // F4: الانتقال إلى إضافة منتج جديد
        if (event.key === 'F4') {
            event.preventDefault();
            showTab('products');
            showProductTab('add-product');
        }
        
        // F5: الانتقال إلى إضافة عميل جديد
        if (event.key === 'F5') {
            event.preventDefault();
            showTab('customers');
            showCustomerTab('add-customer');
        }
        
        // F8: طباعة الفاتورة
        if (event.key === 'F8') {
            event.preventDefault();
            if (cart.length > 0) {
                processCashSale();
            } else {
                showNotification('العربة فارغة', 'warning');
            }
        }
        
        // F9: فتح نافذة اختيار العميل
        if (event.key === 'F9') {
            event.preventDefault();
            openCustomerModal();
        }
        
        // Esc: إغلاق النوافذ المنبثقة
        if (event.key === 'Escape') {
            const openModals = document.querySelectorAll('.modal[style*="display: block"]');
            if (openModals.length > 0) {
                openModals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        }
        
        // Ctrl+S: حفظ البيانات (نسخة احتياطية)
        if (event.ctrlKey && event.key === 's') {
            event.preventDefault();
            createBackup();
        }
    });
}

// عرض المساعدة
function showHelp() {
    const helpHTML = `
        <h3>اختصارات لوحة المفاتيح</h3>
        <table>
            <tr>
                <td><strong>F1</strong></td>
                <td>عرض المساعدة</td>
            </tr>
            <tr>
                <td><strong>F2</strong></td>
                <td>الانتقال إلى نقطة البيع</td>
            </tr>
            <tr>
                <td><strong>F3</strong></td>
                <td>التركيز على حقل البحث</td>
            </tr>
            <tr>
                <td><strong>F4</strong></td>
                <td>إضافة منتج جديد</td>
            </tr>
            <tr>
                <td><strong>F5</strong></td>
                <td>إضافة عميل جديد</td>
            </tr>
            <tr>
                <td><strong>F8</strong></td>
                <td>طباعة الفاتورة</td>
            </tr>
            <tr>
                <td><strong>F9</strong></td>
                <td>اختيار عميل</td>
            </tr>
            <tr>
                <td><strong>Esc</strong></td>
                <td>إغلاق النوافذ المنبثقة</td>
            </tr>
            <tr>
                <td><strong>Ctrl+S</strong></td>
                <td>حفظ نسخة احتياطية</td>
            </tr>
        </table>
    `;
    
    // إنشاء نافذة منبثقة للمساعدة
    const helpWindow = window.open('', '_blank', 'width=500,height=400');
    helpWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>مساعدة نظام الكاشير</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    padding: 20px;
                    background-color: #f5f5f5;
                }
                h2, h3 {
                    color: #667eea;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }
                th, td {
                    padding: 10px;
                    border: 1px solid #ddd;
                }
                th {
                    background-color: #667eea;
                    color: white;
                }
                tr:nth-child(even) {
                    background-color: #f2f2f2;
                }
            </style>
        </head>
        <body>
            <h2>مساعدة نظام الكاشير المتكامل المتطور</h2>
            ${helpHTML}
        </body>
        </html>
    `);
    helpWindow.document.close();
}

// تنفيذ إعداد مستمعي الأحداث بعد تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setupInputEvents();
    setupKeyboardShortcuts();
    
    // مراقبة تغييرات الإعدادات
    document.querySelectorAll('#settings input, #settings select, #settings textarea').forEach(element => {
        element.addEventListener('change', saveSettings);
    });
});

// استدعاء تحميل البيانات التجريبية عند الحاجة
function checkForDemoData() {
    // التحقق من عدم وجود بيانات
    if (products.length === 0 && !localStorage.getItem('demoDataLoaded')) {
        if (confirm('لم يتم العثور على أي بيانات. هل ترغب في تحميل بيانات تجريبية للاختبار؟')) {
            loadDemoData();
        }
    }
}

// استدعاء التحقق من البيانات التجريبية بعد تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        checkForDemoData();
    }, 2000); // تأخير لضمان تحميل جميع البيانات أولاً
});

// التحقق من وجود أقساط مستحقة وإظهار تنبيه
function checkDueInstallments() {
    if (installmentSales.length === 0) return;
    
    const today = new Date();
    const dueInstallments = [];
    
    installmentSales.forEach(sale => {
        if (sale.status !== 'active') return;
        
        sale.installments.forEach(installment => {
            if (!installment.paid) {
                const dueDate = new Date(installment.dueDate);
                const daysDifference = Math.floor((dueDate - today) / (24 * 60 * 60 * 1000));
                
                // إذا كان موعد استحقاق القسط خلال 7 أيام أو متأخر
                if (daysDifference <= 7 && daysDifference >= -30) {
                    dueInstallments.push({
                        customerName: sale.customerName,
                        amount: installment.amount,
                        dueDate: dueDate,
                        daysDifference: daysDifference,
                        installmentNumber: installment.number,
                        saleId: sale.id
                    });
                }
            }
        });
    });
    
    // إذا كانت هناك أقساط مستحقة، إظهار تنبيه
    if (dueInstallments.length > 0) {
        const alertsList = document.getElementById('alertsList');
        if (alertsList) {
            // إضافة تنبيه لكل قسط مستحق (بحد أقصى 3 تنبيهات)
            dueInstallments.slice(0, 3).forEach(installment => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning';
                
                let message;
                if (installment.daysDifference < 0) {
                    message = `⚠️ القسط رقم ${installment.installmentNumber} للعميل "${installment.customerName}" متأخر بـ ${Math.abs(installment.daysDifference)} يوم`;
                } else if (installment.daysDifference === 0) {
                    message = `ℹ️ موعد استحقاق القسط رقم ${installment.installmentNumber} للعميل "${installment.customerName}" اليوم`;
                } else {
                    message = `ℹ️ موعد استحقاق القسط رقم ${installment.installmentNumber} للعميل "${installment.customerName}" خلال ${installment.daysDifference} يوم`;
                }
                
                alertDiv.innerHTML = `
                    ${message}
                    <button class="btn btn-sm btn-success" onclick="addInstallmentPayment(${installment.saleId})">دفع القسط</button>
                `;
                
                alertsList.prepend(alertDiv);
            });
            
            // إضافة تنبيه إجمالي إذا كان هناك أكثر من 3 أقساط مستحقة
            if (dueInstallments.length > 3) {
                const summaryAlert = document.createElement('div');
                summaryAlert.className = 'alert alert-info';
                summaryAlert.textContent = `ℹ️ هناك ${dueInstallments.length} قسط مستحق. يرجى مراجعة قسم الأقساط للاطلاع على التفاصيل.`;
                alertsList.prepend(summaryAlert);
            }
        }
    }
}

// استدعاء التحقق من الأقساط المستحقة بعد تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        checkDueInstallments();
    }, 3000); // تأخير لضمان تحميل جميع البيانات أولاً
});

// التحقق من المنتجات منخفضة المخزون وإظهار تنبيه
function checkLowStockProducts() {
    if (products.length === 0) return;
    
    const lowStockProducts = products.filter(p => 
        p.productStock > 0 && p.productStock <= (p.minStock || 5)
    );
    
    const outOfStockProducts = products.filter(p => p.productStock <= 0);
    
    // إذا كانت هناك منتجات منخفضة المخزون، إظهار تنبيه
    if (lowStockProducts.length > 0 || outOfStockProducts.length > 0) {
        const alertsList = document.getElementById('alertsList');
        if (alertsList) {
            // إضافة تنبيه للمنتجات منخفضة المخزون
            if (lowStockProducts.length > 0) {
                // إظهار تنبيه لأول 3 منتجات
                lowStockProducts.slice(0, 3).forEach(product => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning';
                    alertDiv.textContent = `⚠️ منتج "${product.name}" وصل إلى الحد الأدنى للمخزون (${product.productStock} وحدة)`;
                    alertsList.prepend(alertDiv);
                });
                
                // إضافة تنبيه إجمالي إذا كان هناك أكثر من 3 منتجات
                if (lowStockProducts.length > 3) {
                    const summaryAlert = document.createElement('div');
                    summaryAlert.className = 'alert alert-info';
                    summaryAlert.textContent = `ℹ️ هناك ${lowStockProducts.length} منتج بمخزون منخفض. يرجى مراجعة قسم المنتجات للاطلاع على التفاصيل.`;
                    alertsList.prepend(summaryAlert);
                }
            }
            
            // إضافة تنبيه للمنتجات غير المتوفرة
            if (outOfStockProducts.length > 0) {
                const outOfStockAlert = document.createElement('div');
                outOfStockAlert.className = 'alert alert-error';
                outOfStockAlert.textContent = `⛔ هناك ${outOfStockProducts.length} منتج غير متوفر في المخزون. يرجى إعادة طلب البضاعة.`;
                alertsList.prepend(outOfStockAlert);
            }
        }
    }
}

// استدعاء التحقق من المنتجات منخفضة المخزون بعد تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        checkLowStockProducts();
    }, 3500); // تأخير لضمان تحميل جميع البيانات أولاً
});



    </script>
</body>
</html>
